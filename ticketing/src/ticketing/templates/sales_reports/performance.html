<%inherit file="/layout_2cols.html"/>
<%namespace file="/common/helpers.html" name="h" />
<div class="breadcrumbs">
  ${h.breadcrumbs(
      names=[u'トップ', u'売上レポート', u'イベント', u'パフォーマンス'],
      urls=[
        request.route_path('index'),
        request.route_path('sales_reports.index'),
        request.route_path('sales_reports.event', event_id=performance.event_id)
      ]
  )}
</div>

<div class="page-header">
  <h2>売上レポート パフォーマンス</h2>
</div>

<div class="content">
  ${h.flash_messages(request)}
</div>

<h3>開催日:${h.safe_strftime(performance.start_on)}　${performance.name}</h3>  
<form id="limitation" action="${request.route_path('sales_reports.performance', performance_id=performance.id)}" method="POST">
  <div class="control-group">
    <div class="controls">
      ${form.limited_from} 〜 ${form.limited_to}
      <input type="submit" class="btn" value="集計期間を絞り込む" >
    </div>
  </div>
</form>

<br />
<%
  report_by_ssg = sorted(report_by_sales_segment_group, key=lambda x:(x.order, x.name))
%>
% for sales_segment in report_by_ssg:
  <%
    performance_reports = report_by_sales_segment_group[sales_segment]
    performance_reports_total = report_by_sales_segment_group_total[sales_segment]
  %>
<h3>${sales_segment.name}</h3>
  % if performance_reports:
<table class="table table-striped table-bordered table-condensed">
    % if form.limited_from.data or form.limited_to.data:
  <tr>
    <th colspan="6"></th>
    <th colspan="4">累計</th>
    <th colspan="4">${h.safe_strftime(form.limited_from.data)} 〜 ${h.safe_strftime(form.limited_to.data)}</th>
  </tr>
    % else:
  <tr>
    <th colspan="6"></th>
    <th colspan="4">累計</th>
  </tr>
    % endif
    % if form.limited_from.data or form.limited_to.data:
  <tr>
    <th style="width: 16%;">席種</th>
    <th style="width: 6%;">配券先</th>
    <th style="width: 13%;">商品</th>
    <th style="width: 5%;">価格</th>
    <th style="width: 4%;">配席数</th>
    <th style="width: 4%;">残数</th>
    <th style="width: 4%;">受付</th>
    <th style="width: 4%;">未入金</th>
    <th style="width: 4%;">入金済み</th>
    <th style="width: 8%;">小計</th>
    <th style="width: 4%;">受付</th>
    <th style="width: 4%;">未入金</th>
    <th style="width: 4%;">入金済み</th>
    <th style="width: 8%;">小計</th>
    % else:
    <th style="width: 18%;">席種</th>
    <th style="width: 6%;">配券先</th>
    <th style="width: 18%;">商品</th>
    <th style="width: 6%;">価格</th>
    <th style="width: 6%;">配席数</th>
    <th style="width: 6%;">残数</th>
    <th style="width: 4%;">受付</th>
    <th style="width: 4%;">未入金</th>
    <th style="width: 4%;">入金済み</th>
    <th style="width: 8%;">小計</th>
    % endif
  </tr>
    <%
      stock_id = None
      performance_sum = {
        'total_quantity':0,
        'vacant_quantity':0,
        'unpaid_quantity':0,
        'paid_quantity':0,
        'price_total':0,
      }
      performance_total_sum = {
        'total_quantity':0,
        'vacant_quantity':0,
        'unpaid_quantity':0,
        'paid_quantity':0,
        'price_total':0,
      }
      stock_reports = {}
      for report in performance_reports:
        t = stock_reports[report['stock_id']] if report['stock_id'] in stock_reports else []
        t.append(report)
        stock_reports[report['stock_id']] = t
      stock_reports_total = {}
      for report_total in performance_reports_total:
        t = stock_reports_total[report_total['stock_id']] if report_total['stock_id'] in stock_reports_total else []
        t.append(report_total)
        stock_reports_total[report_total['stock_id']] = t
      performance_reports = sorted(performance_reports, key=lambda x:(x['sales_segment_group_name'], x['stock_type_id'], x['stock_holder_id'], x['product_id']))
      performance_reports_total = sorted(performance_reports_total, key=lambda x:(x['sales_segment_group_name'], x['stock_type_id'], x['stock_holder_id'], x['product_id']))
    %>
    % for performance_report, performance_report_total in zip(performance_reports, performance_reports_total):
      <%
        if stock_id == performance_report['stock_id']:
          continue
        else:
          stock_id = performance_report['stock_id']
        count = len(stock_reports[stock_id])
      %>
      % for i, report in enumerate(zip(stock_reports[stock_id], stock_reports_total[stock_id])):
  <tr>
        % if i == 0:
    <td rowspan="${count}">${report[0]['stock_type_name']}</td>
        % endif
    <td style="border-left: 1px solid #ddd;">${report[0]['stock_holder_name']}</td>
    <td>${report[0]['product_name']}</td>
    <td class="price">${h.price_format(report[0]['product_price'])}円</td>
        % if i == 0:
    <td rowspan="${count}" class="numeric">${h.price_format(report[0]['total_quantity']) or ''}</td>
    <td rowspan="${count}" class="numeric">${h.price_format(report[0]['vacant_quantity']) or ''}</td>
        <%
          performance_sum['total_quantity'] += report[0]['total_quantity']
          performance_sum['vacant_quantity'] += report[0]['vacant_quantity']
        %>
        % endif
        % if form.limited_from.data or form.limited_to.data:
    <td class="numeric">${h.price_format(report[1]['paid_quantity'] + report[1]['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(report[1]['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(report[1]['paid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format((report[1]['paid_quantity'] + report[1]['unpaid_quantity']) * report[1]['product_price'])}円</td>
        % endif
    <td class="numeric">${h.price_format(report[0]['paid_quantity'] + report[0]['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(report[0]['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(report[0]['paid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format((report[0]['paid_quantity'] + report[0]['unpaid_quantity']) * report[0]['product_price'])}円</td>
    <%
      performance_sum['unpaid_quantity'] += report[0]['unpaid_quantity']
      performance_sum['paid_quantity'] += report[0]['paid_quantity']
      performance_sum['price_total'] += (report[0]['paid_quantity'] + report[0]['unpaid_quantity'])*report[0]['product_price']
      performance_total_sum['unpaid_quantity'] += report[1]['unpaid_quantity']
      performance_total_sum['paid_quantity'] += report[1]['paid_quantity']
      performance_total_sum['price_total'] += (report[1]['paid_quantity'] + report[1]['unpaid_quantity'])*report[1]['product_price']
    %>
  </tr>
      % endfor
    % endfor
  <tr>
    <td colspan="4">合計</td>
    <td class="numeric">${h.price_format(performance_sum['total_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_sum['vacant_quantity']) or ''}</td>
    % if form.limited_from.data or form.limited_to.data:
    <td class="numeric">${h.price_format(performance_total_sum['paid_quantity'] + performance_total_sum['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_total_sum['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_total_sum['paid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_total_sum['price_total']) or ''}円</td>
    % endif
    <td class="numeric">${h.price_format(performance_sum['paid_quantity'] + performance_sum['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_sum['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_sum['paid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_sum['price_total']) or ''}円</td>
  </tr>
</table>
  % else:
<p style="margin-left: 30px; margin-top: 20px;">商品がありません</p>
  % endif
% endfor
