<%inherit file="/layout_2cols.html"/>
<%namespace file="/common/helpers.html" name="h" />

<div class="breadcrumbs">
  ${h.breadcrumbs(
      names=[u'トップ', u'レポート', u'イベント', u'パフォーマンス'],
      urls=[
        request.route_path('index'),
        request.route_path('sales_reports.index'),
        request.route_path('sales_reports.event', event_id=performance.event_id)
      ]
  )}
</div>

<div class="page-header">
  <h2>売上レポート パフォーマンス</h2>
</div>

<div class="content">
  ${h.flash_messages(request)}
</div>

<h3>開催日:${h.safe_strftime(performance.start_on)}　${performance.name}</h3>
<br />
% for sale_segment_name, performance_reports in report_by_sales_segment.items():
<h3>${sale_segment_name}</h3>
<table class="table table-striped table-bordered table-condensed">
  <tr>
    <th colspan="4"></th>
    <th colspan="6">累計</th>
  </tr>
  <tr>
    <th>席種</th>
    <th>配券先</th>
    <th>商品</th>
    <th>価格</th>
    <th>配席数</th>
    <th>残数</th>
    <th>受付</th>
    <th>未入金</th>
    <th>入金済み</th>
    <th>小計</th>
  </tr>
  <%
    stock_id = None
    performance_total = {
      'total_quantity':0,
      'vacant_quantity':0,
      'unpaid_quantity':0,
      'paid_quantity':0,
      'price_total':0,
    }

    stock_reports = {}
    for report in performance_reports:
      t = stock_reports[report['stock_id']] if report['stock_id'] in stock_reports else []
      t.append(report)
      stock_reports[report['stock_id']] = t
  %>
  % for performance_report in sorted(performance_reports, key=lambda x:(x['sales_segment_name'], x['stock_type_id'], x['stock_holder_id'], x['product_id'])):
    <%
      if stock_id == performance_report['stock_id']:
        continue
      count = len(stock_reports[performance_report['stock_id']])
    %>
    % for i, report in enumerate(stock_reports[performance_report['stock_id']]):
  <tr>
      % if i == 0:
    <td rowspan="${count}">${report['stock_type_name']}</td>
      % endif
    <td style="border-left: 1px solid #ddd;">${report['stock_holder_name']}</td>
    <td>${report['product_name']}</td>
    <td class="price">${h.price_format(report['product_price'])}円</td>
      % if i == 0:
    <td rowspan="${count}" class="numeric">${h.price_format(report['total_quantity']) or ''}</td>
    <td rowspan="${count}" class="numeric">${h.price_format(report['vacant_quantity']) or ''}</td>
      <%
        performance_total['total_quantity'] += report['total_quantity']
        performance_total['vacant_quantity'] += report['vacant_quantity']
      %>
      % endif
    <td class="numeric">${h.price_format(report['paid_quantity'] + report['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(report['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(report['paid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format((report['paid_quantity'] + report['unpaid_quantity']) * report['product_price'])}円</td>
    <%
      performance_total['unpaid_quantity'] += report['unpaid_quantity']
      performance_total['paid_quantity'] += report['paid_quantity']
      performance_total['price_total'] += (report['paid_quantity'] + report['unpaid_quantity'])*report['product_price']
    %>
  </tr>
    % endfor
    <% stock_id = performance_report['stock_id'] %>
  % endfor
  <tr>
    <td colspan="4">合計</td>
    <td class="numeric">${h.price_format(performance_total['total_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_total['vacant_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_total['paid_quantity'] + performance_total['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_total['unpaid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_total['paid_quantity']) or ''}</td>
    <td class="numeric">${h.price_format(performance_total['price_total']) or ''}円</td>
  </tr>
</table>
% endfor
