<%namespace file="/common/helpers.html" name="h" />
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
  </head>

  <body>
    <div style="margin-left:40px;">
      <br>
      <p>いつもお世話になっております。</p>
      <br>
      <p>以下の内容で最新の申込状況（速報）をお送りいたします。</p>
      <p>ご査収のほど、宜しくお願いいたします。</p>
      <br>
      <h3 style="color:#004040">申込状況（速報)</h3>
      <br>
      <p>◆集計期間:
      % if form.limited_from.data or form.limited_to.data:
        ${h.safe_strftime(form.limited_from.data)} 〜 ${h.safe_strftime(form.limited_to.data)}
      % else:
        〜本日
      % endif
      </p>
      <h4>全商品名区分集計</h4>
      <table style="width: 95%; border: 1px #DCDCDC solid; background-color: #C0FFFF;"> 
        % if form.limited_from.data or form.limited_to.data:
        <tr>
          <th colspan="6"></th>
          <th colspan="4" style="color:#808080; border:1px #DCDCDC solid">累計</th>
          <th colspan="4" style="color:#808080; border:1px #DCDCDC solid">${h.safe_strftime(form.limited_from.data)} 〜 ${h.safe_strftime(form.limited_to.data)}</th>
        </tr>
        % endif
        <tr>
          <th style="width: 17%; border: 1px #DCDCDC solid;">席種</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">配券先</th>
          <th style="width: 17%; border: 1px #DCDCDC solid;">商品</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">価格</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">配席数</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">残数</th>
          % if form.limited_from.data or form.limited_to.data:
          <th style="width: 4%; border: 1px #DCDCDC solid;">受付数</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">未入金</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">入金済み</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">小計</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">受付数</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">未入金</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">入金済み</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">小計</th>
          % else:
          <th style="width: 8%; border: 1px #DCDCDC solid;">受付数</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">未入金</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">入金済み</th>
          <th style="width: 12%; border: 1px #DCDCDC solid;">小計</th>
          % endif
        </tr>
        <%
          product_reports = {}
          for ep in event_product:
            key = (ep['stock_type_id'], ep['stock_id'], ep['product_name'], ep['product_price'])
            t = product_reports[key] if key in product_reports else []
            t.append(ep)
            product_reports[key] = t

          product_reports_total = {}
          for ep in event_product_total:
            key = (ep['stock_type_id'], ep['stock_id'], ep['product_name'], ep['product_price'])
            t = product_reports_total[key] if key in product_reports_total else []
            t.append(ep)
            product_reports_total[key] = t

          keys = sorted(product_reports, key=lambda x:(x[0], x[1], x[2], x[3]))
          import itertools
          count_by_stock_id = dict([(k, len([i for i in g]))  for k, g in itertools.groupby(sorted([k[1] for k in keys]))])

          product_sum = {}
          product_total_sum = {}
          pre_stock_id = None
        %>
        % for key in keys:
          % for i, (report, report_total) in enumerate(zip(product_reports[key], product_reports_total[key])):
            % if i == 0:
              <%
                product_sum = dict(
                  stock_type_name=report['stock_type_name'],
                  stock_type_id=report['stock_type_id'],
                  stock_holder_name=report['stock_holder_name'],
                  product_id=report['product_id'],
                  product_name=report['product_name'],
                  product_price=report['product_price'],
                  total_quantity=report['total_quantity'],
                  vacant_quantity=report['vacant_quantity'],
                  unpaid_quantity=0,
                  paid_quantity=0,
                )
                product_total_sum = dict(
                  unpaid_quantity=0,
                  paid_quantity=0,
                )
                rowspan = 'rowspan="%s"' % count_by_stock_id[report['stock_id']]
              %>
            % endif
            <%
              product_sum['unpaid_quantity'] += report['unpaid_quantity']
              product_sum['paid_quantity'] += report['paid_quantity']
              product_total_sum['unpaid_quantity'] += report_total['unpaid_quantity']
              product_total_sum['paid_quantity'] += report_total['paid_quantity']
            %>
          % endfor
          <tr>
            % if pre_stock_id != report['stock_id']:
            <td ${rowspan|n} style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px;">${product_sum['stock_type_name']}</td>
            <td ${rowspan|n} style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px;">${product_sum['stock_holder_name']}</td>
            <td ${rowspan|n} style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px;">${product_sum['product_name']}</td>
            % endif
            <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(product_sum['product_price'])}円</td>
            % if pre_stock_id != report['stock_id']:
            <td ${rowspan|n} style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(product_sum['total_quantity']) or ''}</td>
            <td ${rowspan|n} style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(product_sum['vacant_quantity']) or ''}</td>
            % endif
            % if form.limited_from.data or form.limited_to.data:
            <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(product_total_sum['paid_quantity'] + product_total_sum['unpaid_quantity']) or ''}</td>
            <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(product_total_sum['unpaid_quantity']) or ''}</td>
            <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(product_total_sum['paid_quantity']) or ''}</td>
            <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format((product_total_sum['paid_quantity'] + product_total_sum['unpaid_quantity']) * product_sum['product_price'])}円</td>
            % endif
            <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(product_sum['paid_quantity'] + product_sum['unpaid_quantity']) or ''}</td>
            <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(product_sum['unpaid_quantity']) or ''}</td>
            <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(product_sum['paid_quantity']) or ''}</td>
            <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format((product_sum['paid_quantity'] + product_sum['unpaid_quantity']) * product_sum['product_price'])}円</td>
          </tr>
          <% pre_stock_id = report['stock_id'] %>
        % endfor
      </table>

      % for ((id, value), (id2, value_total)) in zip(performances_reports.items(), performances_reports_total.items()):
        <%
          performance = value['performance']
          report_by_sales_segment_group = value['report_by_sales_segment_group']
          report_by_sales_segment_group_total = value_total['report_by_sales_segment_group']
        %>
        % for ((sale_segment_group_name, performance_reports), (sale_segment_group_name_total, performance_reports_total)) in zip(report_by_sales_segment_group.items(), report_by_sales_segment_group_total.items()):
      <h4 style="margin-top: 20px;">開催日:${h.safe_strftime(performance.start_on)}　${performance.name}</h4>
      <h4>${sale_segment_group_name}</h4>
      <table style="width: 95%; border: 1px #DCDCDC solid; background-color: #C0FFFF;">
        % if form.limited_from.data or form.limited_to.data:
        <tr>
          <th colspan="6"></th>
          <th colspan="4" style="color:#808080; border:1px #DCDCDC solid">累計</th>
          <th colspan="4" style="color:#808080; border:1px #DCDCDC solid">${h.safe_strftime(form.limited_from.data)} 〜 ${h.safe_strftime(form.limited_to.data)}</th>
        </tr>
        % else:
        <tr>
          <th style="border: 1px #DCDCDC solid;" colspan="6"></th>
          <th style="border: 1px #DCDCDC solid;" colspan="4">
            累計
          </th>
        </tr>
        % endif
        <tr>
          <th style="width: 17%; border: 1px #DCDCDC solid;">席種</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">配券先</th>
          <th style="width: 17%; border: 1px #DCDCDC solid;">商品</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">価格</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">配席数</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">残数</th>
          % if form.limited_from.data or form.limited_to.data:
          <th style="width: 4%; border: 1px #DCDCDC solid;">受付数</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">未入金</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">入金済み</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">小計</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">受付数</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">未入金</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">入金済み</th>
          <th style="width: 4%; border: 1px #DCDCDC solid;">小計</th>
          % else:
          <th style="width: 8%; border: 1px #DCDCDC solid;">受付数</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">未入金</th>
          <th style="width: 8%; border: 1px #DCDCDC solid;">入金済み</th>
          <th style="width: 12%; border: 1px #DCDCDC solid;">小計</th>
          % endif
        </tr>
        <%
          stock_id = None
          performance_sum = {
            'total_quantity':0,
            'vacant_quantity':0,
            'unpaid_quantity':0,
            'paid_quantity':0,
            'price_total':0,
          }
          performance_total_sum = {
            'total_quantity':0,
            'vacant_quantity':0,
            'unpaid_quantity':0,
            'paid_quantity':0,
            'price_total':0,
          }
          stock_reports = {}
          for report in performance_reports:
            t = stock_reports[report['stock_id']] if report['stock_id'] in stock_reports else []
            t.append(report)
            stock_reports[report['stock_id']] = t
          stock_reports_total = {}
          for report_total in performance_reports_total:
            t = stock_reports_total[report_total['stock_id']] if report_total['stock_id'] in stock_reports_total else []
            t.append(report_total)
            stock_reports_total[report_total['stock_id']] = t
          performance_reports = sorted(performance_reports, key=lambda x:(x['sales_segment_group_name'], x['stock_type_id'], x['stock_holder_id'], x['product_id']))
          performance_reports_total = sorted(performance_reports_total, key=lambda x:(x['sales_segment_group_name'], x['stock_type_id'], x['stock_holder_id'], x['product_id']))
        %>
          % for performance_report, performance_report_total in zip(performance_reports, performance_reports_total):
            <%
              if stock_id == performance_report['stock_id']:
                continue
              else:
                stock_id = performance_report['stock_id']
              count = len(stock_reports[stock_id])
            %>
            % for i, report in enumerate(zip(stock_reports[stock_id], stock_reports_total[stock_id])):
            <tr>
              % if i == 0:
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px;" rowspan="${count}">${report[0]['stock_type_name']}</td>
              % endif
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px;">${report[0]['stock_holder_name']}</td>
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px;">${report[0]['product_name']}</td>
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px;">${h.price_format(report[0]['product_price'])}円</td>
              % if i == 0:
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;" rowspan="${count}">${h.price_format(report[0]['total_quantity']) or ''}</td>
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;" rowspan="${count}">${h.price_format(report[0]['vacant_quantity']) or ''}</td>
                <%
                  performance_sum['total_quantity'] += report[0]['total_quantity']
                  performance_sum['vacant_quantity'] += report[0]['vacant_quantity']
                %>
              % endif
              % if form.limited_from.data or form.limited_to.data:
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(report[1]['paid_quantity'] + report[1]['unpaid_quantity']) or ''}</td>
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(report[1]['unpaid_quantity']) or ''}</td>
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(report[1]['paid_quantity']) or ''}</td>
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format((report[1]['paid_quantity'] + report[1]['unpaid_quantity']) * report[1]['product_price'])}円</td>
              % endif
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(report[0]['paid_quantity'] + report[0]['unpaid_quantity']) or ''}</td>
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(report[0]['unpaid_quantity']) or ''}</td>
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(report[0]['paid_quantity']) or ''}</td>
              <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format((report[0]['paid_quantity'] + report[0]['unpaid_quantity']) * report[0]['product_price'])}円</td>
              <%
                performance_sum['unpaid_quantity'] += report[0]['unpaid_quantity']
                performance_sum['paid_quantity'] += report[0]['paid_quantity']
                performance_sum['price_total'] += (report[0]['paid_quantity'] + report[0]['unpaid_quantity'])*report[0]['product_price']
                performance_total_sum['unpaid_quantity'] += report[1]['unpaid_quantity']
                performance_total_sum['paid_quantity'] += report[1]['paid_quantity']
                performance_total_sum['price_total'] += (report[1]['paid_quantity'] + report[1]['unpaid_quantity'])*report[1]['product_price']
              %>
            </tr>
            % endfor
          % endfor
        <tr>
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px;" colspan="4">合計</td>
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(performance_sum['total_quantity']) or ''}</td>
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(performance_sum['vacant_quantity']) or ''}</td>
          % if form.limited_from.data or form.limited_to.data:
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(performance_total_sum['paid_quantity'] + performance_total_sum['unpaid_quantity']) or ''}</td>
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(performance_total_sum['unpaid_quantity']) or ''}</td>
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(performance_total_sum['paid_quantity']) or ''}</td>
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(performance_total_sum['price_total']) or ''}円</td>
          % endif
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(performance_sum['paid_quantity'] + performance_sum['unpaid_quantity']) or ''}</td>
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(performance_sum['unpaid_quantity']) or ''}</td>
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(performance_sum['paid_quantity']) or ''}</td>
          <td style="border:1px #DCDCDC solid; background-color: #FFFFFF; padding: 5px; text-align: right;">${h.price_format(performance_sum['price_total']) or ''}円</td>
        </tr>
      </table>
        % endfor
      % endfor
    </div>
  </body>
</html>
