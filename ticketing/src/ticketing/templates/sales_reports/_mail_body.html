<%page args="performance_reporter" />
<%namespace file="/common/helpers.html" name="h" />
<%
  form = performance_reporter.form
  performance = performance_reporter.performance
%>

<h3 style="margin-top: 30px;">${performance.name}　開催日:${h.safe_strftime(performance.start_on)}</h3>
<%
  sales_segments = performance_reporter.sort_index()
  if len(sales_segments) > 1:
    sales_segments = [''] + sales_segments
%>
% for ss_idx, sales_segment in enumerate(sales_segments):
  <%
    if ss_idx == 0 and len(sales_segments) > 1:
      reporter = performance_reporter.total
      ss_name = u'公演合計'
    else:
      reporter = performance_reporter.get_reporter(sales_segment)
      ss_name = sales_segment.name
  %>
<h4>${ss_name}</h4>
<table border="1" bordercolor="#888" width="98%" style="border-collapse:collapse;">
  % if form.limited_from.data or form.limited_to.data:
  <tr bgcolor="#ddd">
    <th colspan="6"></th>
    <th colspan="4">累計</th>
    <th colspan="4">${h.safe_strftime(form.limited_from.data)} 〜 ${h.safe_strftime(form.limited_to.data)}</th>
  </tr>
  % endif
  <tr bgcolor="#ddd">
    <th style="width: 16%;">席種</th>
    <th style="width: 8%;">配券先</th>
    <th style="width: 16%;">商品</th>
    <th style="width: 8%;">価格</th>
    <th style="width: 4%;">配席数</th>
    <th style="width: 4%;">残数</th>
    <th style="width: 4%;">受付数</th>
    <th style="width: 4%;">未入金</th>
    <th style="width: 4%;">入金済</th>
    <th style="width: 8%;">小計</th>
  % if form.limited_from.data or form.limited_to.data:
    <th style="width: 4%;">受付数</th>
    <th style="width: 4%;">未入金</th>
    <th style="width: 4%;">入金済</th>
    <th style="width: 8%;">小計</th>
  % endif
  </tr>
  <% group_key = None %>
  % for report in reporter.sort_data():
    <%
      if group_key == report.group_key():
        continue
      group_key = report.group_key()
      count = len(reporter.group_key_to_reports(group_key))
    %>
    % for i, report in enumerate(reporter.group_key_to_reports(group_key)):
    <tr>
      % if i == 0:
      <td style="padding: 5px;" rowspan="${count}">${report.stock_type_name}</td>
      <td style="padding: 5px;" rowspan="${count}">${report.stock_holder_name}</td>
      % endif
      <td style="padding: 5px;">${report.product_name}</td>
      <td style="padding: 5px; text-align: right;">${h.price_format(report.product_price)}円</td>
      % if i == 0:
      <td style="padding: 5px; text-align: right;" rowspan="${count}">${h.price_format(report.stock_quantity) or ''}</td>
      <td style="padding: 5px; text-align: right;" rowspan="${count}">${h.price_format(report.vacant_quantity) or ''}</td>
      % endif
      <td style="padding: 5px; text-align: right;">${h.price_format(report.total_paid_quantity + report.total_unpaid_quantity) or ''}</td>
      <td style="padding: 5px; text-align: right;">${h.price_format(report.total_unpaid_quantity) or ''}</td>
      <td style="padding: 5px; text-align: right;">${h.price_format(report.total_paid_quantity) or ''}</td>
      <td style="padding: 5px; text-align: right;">${h.price_format((report.total_paid_quantity + report.total_unpaid_quantity) * report.product_price)}円</td>
      % if form.limited_from.data or form.limited_to.data:
      <td style="padding: 5px; text-align: right;">${h.price_format(report.paid_quantity + report.unpaid_quantity) or ''}</td>
      <td style="padding: 5px; text-align: right;">${h.price_format(report.unpaid_quantity) or ''}</td>
      <td style="padding: 5px; text-align: right;">${h.price_format(report.paid_quantity) or ''}</td>
      <td style="padding: 5px; text-align: right;">${h.price_format((report.paid_quantity + report.unpaid_quantity) * report.product_price)}円</td>
      % endif
    </tr>
    % endfor
  % endfor
  <% total = reporter.total %>
  <tr>
    <td style="padding: 5px;" colspan="4">合計</td>
    <td style="padding: 5px; text-align: right;">${h.price_format(total.stock_quantity) or ''}</td>
    <td style="padding: 5px; text-align: right;">${h.price_format(total.vacant_quantity) or ''}</td>
    <td style="padding: 5px; text-align: right;">${h.price_format(total.total_paid_quantity + total.total_unpaid_quantity) or ''}</td>
    <td style="padding: 5px; text-align: right;">${h.price_format(total.total_unpaid_quantity) or ''}</td>
    <td style="padding: 5px; text-align: right;">${h.price_format(total.total_paid_quantity) or ''}</td>
    <td style="padding: 5px; text-align: right;">${h.price_format(total.total_sum_amount) or ''}円</td>
  % if form.limited_from.data or form.limited_to.data:
    <td style="padding: 5px; text-align: right;">${h.price_format(total.paid_quantity + total.unpaid_quantity) or ''}</td>
    <td style="padding: 5px; text-align: right;">${h.price_format(total.unpaid_quantity) or ''}</td>
    <td style="padding: 5px; text-align: right;">${h.price_format(total.paid_quantity) or ''}</td>
    <td style="padding: 5px; text-align: right;">${h.price_format(total.sum_amount) or ''}円</td>
  % endif
  </tr>
</table>
% endfor
