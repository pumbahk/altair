<%inherit file="/layout_2cols.html"/>
<% from ticketing.helpers import todatetime %>
<% from datetime import timedelta %>
<%namespace file="/common/helpers.html" name="h" />

<script type="text/javascript">
  function preview(email){
    var params = $('#limitation').serialize();
    if (email) params += '&recipient=' + encodeURIComponent(email);
    $(location).attr('href', '/events/sales_reports/preview/${form.event_id.data}?' + params);
  };
</script>

<div class="breadcrumbs">
  ${h.breadcrumbs(
      names=[u'トップ',u'売上レポート', u'イベント'],
      urls=[
        request.route_path('index'),
        request.route_path('sales_reports.index')]
  )}
</div>

<div class="page-header">
  <h2>売上レポート イベント</h2>
</div>

<div class="content">
  ${h.flash_messages(request)}
</div>

<form id="limitation" action="${request.route_path('sales_reports.event', event_id=form.event_id.data)}" method="POST">
  <div class="control-group">
    <div class="controls">
      ${form.limited_from} 〜 ${form.limited_to}
      <input type="submit" class="btn" value="集計期間を絞り込む" >
    </div>
  </div>
</form>

<table class="table table-striped table-bordered table-condensed">
  <tr>
    <th colspan="4"></th>
    <th colspan="2">累計</th>
    <th colspan="2">
      % if form.limited_from.data or form.limited_to.data:
      <h5>
        % if form.limited_from.data:
        ${h.safe_strftime(form.limited_from.data)}
        % endif
        〜
        % if form.limited_to.data:
        ${h.safe_strftime(todatetime(form.limited_to.data) + timedelta(days=1, seconds=-1))}</h5>
        % endif
      % else:
      <h5>全期間</h5>
      % endif
    </th>
  </tr>
  <tr>
    <th>イベント名</th>
    <th>販売期間</th>
    <th>配席数</th>
    <th>残席数</th>
    <th>販売枚数</th>
    <th>販売金額</th>
    <th>販売枚数</th>
    <th>販売金額</th>
  </tr>
  <tr>
    <td>${event_report['title']}</td>
    <td class="span3">${h.safe_strftime(event_report['sales_start_day'])}〜${h.safe_strftime(event_report['sales_end_day'])}</td>
    <td class="span1 numeric">${h.price_format(event_report['total_quantity'])}</td>
    <td class="span1 numeric">${h.price_format(event_report['vacant_quantity'])}</td>
    <td class="span1 numeric">${h.price_format(event_total_report['product_quantity'])}</td>
    <td class="span1 price">${h.price_format(event_total_report['price_amount'])}</td>
    <td class="span1 numeric">${h.price_format(event_report['product_quantity'])}</td>
    <td class="span1 price">${h.price_format(event_report['price_amount'])}</td>
  </tr>
</table>

<div style="margin-bottom: 50px;">
  <h3>メール送信先</h3>

  <%include file="/sales_reports/_action_button.html" args="event=event" />
  <div id="sales_reports_mail-form">
    <%include file="/sales_reports/_form.html" args="form=form_report_mail" />
  </div>
  <a href="javascript:preview();" class="btn" style="margin-top:15px; margin-bottom:10px;">全送信先に送信 プレビュー</a>

  % if report_settings:
  <table class="table table-striped table-bordered table-condensed">
    <tr>
      <th></th>
      <th>名前</th>
      <th>メールアドレス</th>
      <th>メール通知頻度</th>
      <th></th>
    </tr>
    <%! from ticketing.core.models import ReportFrequencyEnum %>
    % for rs in report_settings:
    <tr>
      <td><input type="radio" name="sales_reports_mail_id" value=${rs.id}></td>
      <td>${rs.operator.name}</td>
      <td>${rs.operator.email}</td>
      <%
        frequency = ''
        for enum in ReportFrequencyEnum:
          if enum.v == rs.frequency:
            frequency = enum.k
            break
      %>
      <td>${frequency}</td>
      <td><input class="btn" type="button" value="メール送信 プレビュー" onclick="javascript:preview('${rs.operator.email}');"></td>
    </tr>
    % endfor
  </table>
  % endif
</div>

<h3>パフォーマンス別レポート</h3>
<%include file="./_list.html" args="form=form, performances_reports=performances_reports, performances_total_reports=performances_total_reports" />
