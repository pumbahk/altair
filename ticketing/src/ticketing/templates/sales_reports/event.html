<%inherit file="/layout_2cols.html"/>
<%namespace file="/common/helpers.html" name="h" />

<script type="text/javascript">
  function preview(email){
    var params = $('#limitation').serialize();
    if (email) params += '&recipient=' + encodeURIComponent(email);
    $(location).attr('href', '/events/sales_reports/preview/${form.event_id.data}?' + params);
  };
</script>

<div class="breadcrumbs">
  ${h.breadcrumbs(
      names=[u'トップ',u'売上レポート', u'イベント'],
      urls=[
        request.route_path('index'),
        request.route_path('sales_reports.index')]
  )}
</div>

<div class="page-header">
  <h2>売上レポート イベント</h2>
</div>

<div class="content">
  ${h.flash_messages(request)}
</div>

<form id="limitation" action="${request.route_path('sales_reports.event', event_id=form.event_id.data)}" method="POST">
  <div class="control-group">
    <div class="controls">
      ${form.limited_from} 〜 ${form.limited_to}
      <input type="submit" class="btn" value="集計期間を絞り込む" >
    </div>
  </div>
</form>

<table class="table table-striped table-bordered table-condensed">
  <tr>
    <th colspan="4"></th>
    <th colspan="2">累計</th>
    <th colspan="2">
    % if form.limited_from.data or form.limited_to.data:
      ${h.safe_strftime(form.limited_from.data)} 〜</br>
      ${h.safe_strftime(form.limited_to.data)}
    % else:
      全期間
    % endif
    </th>
  </tr>
  <tr>
    <th style="width: 40%;">イベント名</th>
    <th style="width: 24%;">販売期間</th>
    <th style="width: 6%;">配席数</th>
    <th style="width: 6%;">残席数</th>
    <th style="width: 6%;">販売枚数</th>
    <th style="width: 6%;">販売金額</th>
    <th style="width: 6%;">販売枚数</th>
    <th style="width: 6%;">販売金額</th>
  </tr>
  <% record = event_total_reporter.pop_data() %>
  <tr>
    <td>${record.title}</td>
    <td>${h.safe_strftime(record.sales_start_day)} 〜 ${h.safe_strftime(record.sales_end_day)}</td>
    <td class="numeric">${h.price_format(record.stock_quantity)}</td>
    <td class="numeric">${h.price_format(record.vacant_quantity)}</td>
    <td class="numeric">${h.price_format(record.total_order_quantity)}</td>
    <td class="price">${h.price_format(record.total_order_amount)}</td>
    <td class="numeric">${h.price_format(record.order_quantity)}</td>
    <td class="price">${h.price_format(record.order_amount)}</td>
  </tr>
</table>

<h3>メール送信先</h3>

<%include file="/sales_reports/_action_button.html" args="event=event" />
<a href="javascript:preview();" class="btn">全送信先に送信 プレビュー</a>
<div id="sales_reports_mail-form" style="margin-bottom:10px;">
  <%include file="/sales_reports/_form.html" args="form=form_report_mail" />
</div>

% if report_settings:
<table class="table table-striped table-bordered table-condensed">
  <tr>
    <th></th>
    <th>名前</th>
    <th>メールアドレス</th>
    <th>メール通知頻度</th>
    <th>送信曜日</th>
    <th>送信時間</th>
    <th>送信期間</th>
    <th></th>
  </tr>
  <%! from ticketing.core.models import ReportFrequencyEnum %>
  % for rs in report_settings:
  <tr>
    <td><input type="radio" name="sales_reports_mail_id" value=${rs.id}></td>
    <td>${rs.operator.name}</td>
    <td>${rs.operator.email}</td>
    <td>${''.join([enum.v[1] for enum in ReportFrequencyEnum if enum.v[0] == rs.frequency])}</td>
    <td>${''.join([dow[1] for dow in form_report_mail.day_of_week.choices if rs.day_of_week == dow[0]])}</td>
    <td>${u'%s時' % rs.time if rs.time else ''}</td>
    <td>
      ${h.safe_strftime(rs.start_on, '%Y-%m-%d %H')}
      ${u' 〜 ' if rs.start_on or rs.end_on else ''}
      ${h.safe_strftime(rs.end_on, '%Y-%m-%d %H')}
    </td>
    <td><input class="btn btn-small" type="button" value="メール送信 プレビュー" onclick="javascript:preview('${rs.operator.email}');"></td>
  </tr>
  % endfor
</table>
% endif

<h3>公演別レポート</h3>

<%include file="./_list.html" args="form=form, reporter=performance_total_reporter" />
