<%inherit file="../../../layout.html" />
<%namespace file="/common/helpers.html" import="breadcrumbs,pager,flash_messages"/>
<% import json %>
<%block name="javascript">
<script type="text/javascript" src="/static/js/fashion.js"></script>
<![if !(lt IE 9)]>
<script type="text/javascript" src="/static/js/fashion.svg.js"></script>
<![endif]>
<!--[if (lt IE 9)]> 
<script type="text/javascript" src="/static/js/fashion.vml.js"></script>
<![endif]-->
<script type="text/javascript" src="/static/js/ticketing.ticket-viewer.js"></script>
</%block>

<div class="page-header">
  <h1>チケット券面Preview</h1>
</div>
<div class="content">
  ${flash_messages(request)}
</div>

<div class="row-fluid">
  <div class="span6">
    <h3>詳細</h3>
    <table class="table table-striped table-bordered">
      <tbody>
        <tr>
          <th class="span2">パフォーマンス</th>
          <td class="span3">${item.performance.name}</td>
        </tr>
        <tr>
          <th class="span2">商品名</th>
          <td class="span3">${item.product.name}</td>
        </tr>
        <tr>
          <th class="span2">商品詳細名</th>
          <td class="span3"></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="row-fluid">
  %for ticket in tickets:
  <form method="POST" action="${request.route_url('events.tickets.bundles.items.enqueue', event_id=request.matchdict["event_id"], bundle_id=request.matchdict["bundle_id"], ticket_id=ticket.id, item_id=request.matchdict["item_id"])}">
    <h3>${ticket.name}</h3> 

    <button class="btn">印刷キューに追加する</button>

	  <div class="wrapbox">
	    <div class="btn-group">
	  	<a class="btn viewer-enlarge" href="#">拡大</a>
	  	<a class="btn viewer-undo" href="#">元の大きさに戻す</a>
	    </div>
        <div class="viewer-box" id="ticket-viewer${ticket.id}" style="height:300px">
	    </div>    
	  </div>
	  <script type="text/javascript">
    var options = ${json.dumps({ 'dataSource': request.route_url('events.tickets.bundles.items.data', event_id=request.matchdict["event_id"], bundle_id=request.matchdict["bundle_id"], item_id=request.matchdict["item_id"],template_id=ticket.id)})|n};
    $('#ticket-viewer${ticket.id}').ticketviewer(options).ticketviewer('load')
	  </script>
  </form>
  %endfor 
</div>

<script>
  var get_viewer = function(elt){
   return $(elt).parents(".wrapbox").find(".viewer-box").data("ticketviewer");
  };
  var change_viewer_box_size = function(elt, size){
    // todo: fixme
    var root = $(elt).parents(".wrapbox").find(".viewer-box")
    root.height(size);
    $(root.find("div").get(0)).height(size);
  };

  $(function(){
    $("a.viewer-enlarge").click(function(){
     viewer = get_viewer(this);
     viewer.drawable.transform(Fashion.Matrix.scale(2));
     change_viewer_box_size(this, 600);
    });
    $("a.viewer-undo").click(function(){
     viewer = get_viewer(this);
     viewer.drawable.transform(Fashion.Matrix.scale(1));
     change_viewer_box_size(this, 300);
    });
  })
</script>
