<%inherit file="../../../layout.html" />
<%namespace file="/common/helpers.html" import="breadcrumbs,pager,flash_messages"/>
<% import json %>
<script type="text/javascript" src="${request.static_url("ticketing:static/js/tickets/preview/preview_api.js")}"></script>

<div class="page-header">
  <h1>チケット券面Preview</h1>
</div>
<div class="content">
  ${flash_messages(request)}
</div>

<div class="row-fluid">
  <div class="span6">
    <h3>詳細</h3>
    <table class="table table-striped table-bordered">
      <tbody>
        <tr>
          <th class="span2">パフォーマンス</th>
          <td class="span3">${item.performance.name}</td>
        </tr>
        <tr>
          <th class="span2">商品名</th>
          <td class="span3">${item.product.name}</td>
        </tr>
        <tr>
          <th class="span2">商品詳細名</th>
          <td class="span3"></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="row-fluid">
  %for ticket in tickets:
  <h3>${ticket.name}</h3> 

  <form method="POST" action="${request.route_url('events.tickets.bundles.items.enqueue', event_id=request.matchdict["event_id"], bundle_id=request.matchdict["bundle_id"], ticket_id=ticket.id, item_id=request.matchdict["item_id"])}">
    <button class="btn">印刷キューに追加する</button>
  </form>
  <form method="POST" action="${request.route_url('events.tickets.bundles.items.download', event_id=request.matchdict["event_id"], bundle_id=request.matchdict["bundle_id"], ticket_id=ticket.id, item_id=request.matchdict["item_id"])}">
    <button class="btn">ダウンロード</button>
  </form>


  <div class="wrapbox">
    <div class="btn-group">
    <a class="btn viewer-enlarge" href="#">拡大</a>
    <a class="btn viewer-undo" href="#">元の大きさに戻す</a>
    </div>
      <div class="viewer-box" id="ticket-viewer${ticket.id}" style="height:300px">
    </div>    
  </div>
  <script type="text/javascript">
    $(function(){
      svg_preview(
        $(".viewer-box#ticket-viewer${ticket.id}"),"${request.route_path("tickets.preview.api", action="preview.base64.withmodels")}", 
         {svg: '${ticket.drawing.replace("\n","")|n}',
          ticket_format: "${ticket.ticket_format_id}",
          model_name: "ProductItem",
          model: "${item.id}"});
    });
  </script>
  %endfor 
</div>

<script>
  var get_viewer = function(elt){
   return $(elt).parents(".wrapbox").find(".viewer-box").data("ticketviewer");
  };
  var change_viewer_box_size = function(elt, size){
    // todo: fixme
    var root = $(elt).parents(".wrapbox").find(".viewer-box")
    root.height(size);
    $(root.find("div").get(0)).height(size);
  };

  $(function(){
    $("a.viewer-enlarge").click(function(){
     viewer = get_viewer(this);
     viewer.drawable.transform(Fashion.Matrix.scale(2));
     change_viewer_box_size(this, 600);
    });
    $("a.viewer-undo").click(function(){
     viewer = get_viewer(this);
     viewer.drawable.transform(Fashion.Matrix.scale(1));
     change_viewer_box_size(this, 300);
    });
  })
</script>
