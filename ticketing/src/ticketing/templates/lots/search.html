<%inherit file="../layout_2cols.html" />
<%namespace file="/common/helpers.html" name="h" />
<%namespace file="_entries_tabs.html" name="tabs" />

<%
from ticketing.cart.helpers import format_currency
%>
<%block name="style">
<link rel="stylesheet" type="text/css" href="/static/css/decentcolorpicker.css" />
<link rel="stylesheet" type="text/css" href="/static/css/performance.css" />
</%block>
<%block name="fulltitle">
Altair Backend -- ${lot.event.title}[${lot.name}]
</%block>
<%block name="javascript">
</%block>
<div class="breadcrumbs">
  ${h.breadcrumbs(
      names=[u'イベント', lot.event.title, u'抽選', lot.name, u'申し込み状況'],
      urls=[
        request.route_path('events.index'),
        request.route_path('events.show', event_id=lot.event.id),
        request.route_path('lots.index', event_id=lot.event.id),
        request.route_path('lots.show', lot_id=lot.id),
      ]
  )}
</div>
<div class="page-header">
  <h1>
    ${lot.event.title}<br />
    <small>${lot.name}</small>
  </h1>
</div>
<div class="content">
  ${h.flash_messages(request)}
</div>
${tabs.tabs(request)}
<div class="well">
  <form id="search" class="form-horizontal" method="POST">
    <fieldset>
      <legend>検索条件</legend>
      <table>
	<tbody>
          <tr>
            <th><label for="entry_no">${form.entry_no.label.text}</label></th>
            <td>${form.entry_no(maxlength=12)}</td>
	  </tr>
          <tr>
            <th><label for="tel">${form.tel.label.text}</label></th>
            <td>${form.tel(maxlength=255)}</td>
	  </tr>
          <tr>
            <th><label for="name">${form.name.label.text}</label></th>
            <td>${form.name(maxlength=255)}</td>
	  </tr>
          <tr>
            <th><label for="email">${form.email.label.text}</label></th>
            <td>${form.email(maxlength=255)}</td>
	  </tr>
          <tr>
            <th><label>${form.entried_from.label.text}</label></th>
            <td>
              ${form.entried_from()} 〜
              ${form.entried_to()}
            </td>
          </tr>
          <tr>
            <th><label for="include_canceled">${form.include_canceled.label.text}</label></th>
            <td>${form.include_canceled()}</td>
	  </tr>
          <tr>
            <th><label for="electing">${form.electing.label.text}</label></th>
            <td>${form.electing()}</td>
	  </tr>
	</tbody>
      </table>
      <button type="submit" name="search" class="btn">検索</button>
    </fieldset>
  </form>
</div>

<div>
%if wishes:
<table border="1" class="table" id="wish-search-results">
<thead>
<tr>
<th>&nbsp;</th>
<th>状態</th>
<th>申し込み番号</th>
<th>希望順序</th>
<th>申し込み日</th>
<th>ユーザー種別</th>
<th>席種</th>
<th>枚数</th>
<th>イベント</th>
<th>会場</th>
<th>公演</th>
<th>公演コード</th>
<th>公演日</th>
<th>商品</th>
<th>決済方法</th>
<th>引取方法</th>
<th>配送先姓</th>
<th>配送先名</th>
<th>配送先姓(カナ)</th>
<th>配送先名(カナ)</th>
<th>郵便番号</th>
<th>国</th>
<th>都道府県</th>
<th>市区町村</th>
<th>住所1</th>
<th>住所2</th>
<th>電話番号1</th>
<th>電話番号2</th>
<th>FAX</th>
<th>メールアドレス1</th>
<th>メールアドレス2</th>
<th>姓</th>
<th>名</th>
<th>姓(カナ)</th>
<th>名(カナ)</th>
<th>ニックネーム</th>
<th>性別</th>
</tr>
</thead>
<tbody>
%for w in wishes:
<%
event = w.lot_entry.lot.event
performance = w.performance
venue = performance.venue
shipping_address = w.lot_entry.shipping_address
pdmp = w.lot_entry.payment_delivery_method_pair
payment_method = pdmp.payment_method
delivery_method = pdmp.delivery_method
user_profile = None
if shipping_address.user:
    user_profile = shipping_address.user.profile

%>
<tr>
<td nowrap="">
<ul>
  <!-- TODO: 状態によるボタンの出し分け -->
  %if not w.canceled_at and not w.is_electing() and not w.is_rejecting():
  <li><button class="btn entry-elect-btn" data-entry-no="${w.lot_entry.entry_no}" data-wish-order="${w.wish_order}">当選</button></li>
  %endif
  %if not w.canceled_at and not w.is_electing() and not w.is_rejecting():
  <li><button class="btn entry-cancel-btn" data-entry-no="${w.lot_entry.entry_no}">キャンセル</button></li>
  %endif
  %if w.is_electing() and not w.elected_at:
  <li><button class="btn cancel-electing-btn" data-entry-no="${w.lot_entry.entry_no}" data-wish-order="${w.wish_order}">当選予定をキャンセル</button></li>
  %endif

  %if not w.canceled_at and not w.is_electing() and not w.is_rejecting():
  <li><button class="btn entry-reject-btn" data-entry-no="${w.lot_entry.entry_no}">落選</button></li>
  %endif
  %if w.is_rejecting() and not w.rejected_at:
  <li><button class="btn cancel-reject-btn" data-entry-no="${w.lot_entry.entry_no}">落選予定をキャンセル</button></li>
  %endif

</ul>
</td>
<td nowrap="">
${w.status}
%if w.lot_entry.ordered_mail_sent_at:
<br>当選メール送信済
%endif
</td>
<td nowrap="">${w.lot_entry.entry_no}</td>
<td nowrap="">${w.wish_order + 1}</td>
<td nowrap="">${"{0:%Y-%m-%d %H:%M}".format(w.created_at)}</td>
<td nowrap="">${w.lot_entry.membergroup}</td>
<td nowrap="">${u",".join([",".join([i.stock_type.name for i in p.product.items]) for p in w.products])}</td>
<td nowrap="">${w.total_quantity}</td>
<td nowrap="">${event.title}</td>
<td nowrap="">${venue.name}</td>
<td nowrap="">${performance.name}</td>
<td nowrap="">${performance.code}</td>
<td nowrap="">${"{0:%Y-%m-%d %H:%M}".format(performance.start_on)}</td>
<td nowrap="">${u",".join([p.product.name for p in w.products])}</td>
<td nowrap="">${payment_method.name}</td>
<td nowrap="">${delivery_method.name}</td>
<td nowrap="">${shipping_address.last_name}</td>
<td nowrap="">${shipping_address.first_name}</td>
<td nowrap="">${shipping_address.last_name_kana}</td>
<td nowrap="">${shipping_address.first_name_kana}</td>
<td nowrap="">${shipping_address.zip}</td>
<td nowrap="">${shipping_address.country}</td>
<td nowrap="">${shipping_address.prefecture}</td>
<td nowrap="">${shipping_address.city}</td>
<td nowrap="">${shipping_address.address_1}</td>
<td nowrap="">${shipping_address.address_2}</td>
<td nowrap="">${shipping_address.tel_1}</td>
<td nowrap="">${shipping_address.tel_2}</td>
<td nowrap="">${shipping_address.fax}</td>
<td nowrap="">${shipping_address.email_1}</td>
<td nowrap="">${shipping_address.email_2}</td>
<td nowrap="">${user_profile.last_name if user_profile else u""}</td>
<td nowrap="">${user_profile.first_name if user_profile else u""}</td>
<td nowrap="">${user_profile.last_name_kana if user_profile else u""}</td>
<td nowrap="">${user_profile.first_name_kana if user_profile else u""}</td>
<td nowrap="">${user_profile.nick_name if user_profile else u""}</td>
<td nowrap="">${user_profile.sex if user_profile else u""}</td>
</tr>
%endfor
</tbody>
</table>
%endif
</div>
<script>
var cancelUrl = "${cancel_url}";
var cancelElectingUrl = "${cancel_electing_url}";
var electingUrl = "${electing_url}";
var rejectingUrl = "${rejecting_url}"
var cancelRejectingUrl = "${cancel_rejecting_url}"

$(function() {
  // 当選
  $('#wish-search-results').on('click', '.entry-elect-btn', function(e) {
     var entryNo = $(this).data("entryNo");
     var wishOrder = Number($(this).data("wishOrder"));
     if (!confirm("申込番号" + entryNo + "-" + (wishOrder + 1) + " を当選予定にします。")) {
       return;
     }
     $.ajax({
       url: electingUrl,
       data: {"entry_no": entryNo, "wish_order": wishOrder},
       dataType: "json",
       type: "POST",
       success: function(data, textStatus, xhr) {
           if (data.result == "OK") {
             alert("申込番号" + entryNo + "-" + (wishOrder + 1) + " を当選予定にしました。");
           }
       }
     });
  });
  // キャンセル
  $('#wish-search-results').on('click', '.entry-cancel-btn', function(e) {
     var entryNo = $(this).data("entryNo");
     // TODO: modalに変更（ボタンが OK キャンセル で紛らわしい)
     if (!confirm("申込番号" + entryNo + "をキャンセルします。")) {
       return;
     }
     $.ajax({
       url: cancelUrl,
       data: {"entry_no": entryNo},
       dataType: "json",
       type: "POST",
       success: function(data, textStatus, xhr) {
           if (data.result == "OK") {
             alert("申込番号" + entryNo + "をキャンセルしました。");
           }
       }
     });
  });
  // 当選予定キャンセル
  $('#wish-search-results').on('click', '.cancel-electing-btn', function(e) {
     var entryNo = $(this).data("entryNo");
     var wishOrder = Number($(this).data("wishOrder"));
     // TODO: modalに変更（ボタンが OK キャンセル で紛らわしい)
     if (!confirm("申込番号" + entryNo + "の当選予定をキャンセルします。")) {
       return;
     }
     $.ajax({
       url: cancelElectingUrl,
       data: {"entry_no": entryNo, "wish_order": wishOrder},
       dataType: "json",
       type: "POST",
       success: function(data, textStatus, xhr) {
           if (data.result == "OK") {
             alert("申込番号" + entryNo + "の当選予定をキャンセルしました。");
           }
       }
     });
  });
  // 落選予定
  $('#wish-search-results').on('click', '.entry-reject-btn', function(e) {
     var entryNo = $(this).data("entryNo");

     // TODO: modalに変更（ボタンが OK キャンセル で紛らわしい)
     if (!confirm("申込番号" + entryNo + "を落選予定にします。")) {
       return;
     }
     $.ajax({
       url: rejectingUrl,
       data: {"entry_no": entryNo},
       dataType: "json",
       type: "POST",
       success: function(data, textStatus, xhr) {
           if (data.result == "OK") {
             alert("申込番号" + entryNo + "を落選予定にしました。");
           }
       }
     });
  });
  // 落選予定
  $('#wish-search-results').on('click', '.cancel-reject-btn', function(e) {
     var entryNo = $(this).data("entryNo");

     // TODO: modalに変更（ボタンが OK キャンセル で紛らわしい)
     if (!confirm("申込番号" + entryNo + "の落選予定をキャンセルします。")) {
       return;
     }
     $.ajax({
       url: cancelRejectingUrl,
       data: {"entry_no": entryNo},
       dataType: "json",
       type: "POST",
       success: function(data, textStatus, xhr) {
           if (data.result == "OK") {
             alert("申込番号" + entryNo + "の落選予定をキャンセルしました。");
           }
       }
     });
  });
});
</script>
