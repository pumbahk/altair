<%inherit file="/layout_2cols.html" />
<%namespace file="/common/helpers.html" name="h" />
<%namespace file="_entries_tabs.html" name="tabs" />

<%
from ticketing.cart.helpers import format_currency
%>


<%def name="lot_wish_row(request, w)">

<%
#performance = w.performance
#performance = performances[w.performance_id]
#venue = performance.venue
#shipping_address = w.lot_entry.shipping_address
#pdmp = w.lot_entry.payment_delivery_method_pair
#payment_method = pdmp.payment_method
#delivery_method = pdmp.delivery_method
%>
<td nowrap="">
<div class="btn-group">
%if not w.closed_at:

  %if not w.canceled_at and not w.is_electing() and not w.is_rejecting() and not w.rejected_at and not w.is_electing() and not w.elected_at:
  <button class="btn entry-elect-btn" data-entry-no="${w.entry_no}" data-wish-order="${w.wish_order}">当選</button>
  %endif
  %if not w.canceled_at and not w.is_electing() and not w.is_rejecting() and not w.rejected_at and not w.is_electing() and not w.elected_at:
  <button class="btn entry-cancel-btn" data-entry-no="${w.entry_no}">キャンセル</button>
  %endif
  %if w.is_electing() and not w.elected_at and not w.rejected_at:
  <button class="btn cancel-electing-btn" data-entry-no="${w.entry_no}" data-wish-order="${w.wish_order}">当選予定をキャンセル</button>
  %endif

  %if not w.canceled_at and not w.is_electing() and not w.is_rejecting() and not w.rejected_at and not w.is_electing() and not w.elected_at:
  <button class="btn entry-reject-btn" data-entry-no="${w.entry_no}">落選</button>
  %endif
  %if w.is_rejecting() and not w.rejected_at and not w.rejected_at and not w.is_electing():
  <button class="btn cancel-reject-btn" data-entry-no="${w.entry_no}">落選予定をキャンセル</button>
  %endif

%endif
</div>
</td>
<td nowrap="">
${w.status}
%if w.ordered_mail_sent_at:
<br>メール送信済
%endif
</td>
<td nowrap="">${w.payment_method_name}<br>${view.payment_status(w)}</td>
<td nowrap="">${w.delivery_method_name}<br>${view.delivery_status(w)}</td>
<td nowrap=""><a href="${request.route_path("lots.entries.show", lot_id=w.lot_id, entry_no=w.entry_no)}">${w.entry_no}</a></td>
<td nowrap="">${w.wish_order + 1}</td>
<td nowrap="">${"{0:%Y-%m-%d %H:%M}".format(w.created_at)}</td>
<td nowrap="">${u",".join([",".join([i.stock_type.name for i in p.product.items]) for p in w.products])}</td>
<td nowrap="">${w.total_quantity}</td>
<td nowrap="">${w.venue_name}</td>
<td nowrap="">${w.performance_code}</td>
<td nowrap="">${"{0:%Y-%m-%d %H:%M}".format(w.performance_start_on) if w.performance_start_on else 'None'}</td>
<td nowrap="">${u",".join([p.product.name for p in w.products])}</td>
<td nowrap="">${w.shipping_address.last_name}</td>
<td nowrap="">${w.shipping_address.first_name}</td>
<td nowrap="">${w.shipping_address.last_name_kana}</td>
<td nowrap="">${w.shipping_address.first_name_kana}</td>
<td nowrap="">${w.shipping_address.prefecture}</td>
<td nowrap="">${w.shipping_address.city}</td>
<td nowrap="">${w.shipping_address.address_1}</td>
<td nowrap="">${w.shipping_address.address_2}</td>
<td nowrap="">${w.shipping_address.tel_1}</td>
<td nowrap="">${w.shipping_address.tel_2}</td>
<td nowrap="">${w.shipping_address.email_1}</td>
<td nowrap="">${w.shipping_address.email_2}</td>

</%def>


<%block name="style">
<link rel="stylesheet" type="text/css" href="/static/css/decentcolorpicker.css" />
<link rel="stylesheet" type="text/css" href="/static/css/performance.css" />
</%block>
<%block name="fulltitle">
Altair Backend -- ${lot.event.title}[${lot.name}]
</%block>
<%block name="javascript">
</%block>
<%block name="breadcrumbs">
  ${h.breadcrumbs(
      names=[u'イベント', lot.event.title, u'抽選', lot.name, u'申し込み状況'],
      urls=[
        request.route_path('events.index'),
        request.route_path('events.show', event_id=lot.event.id),
        request.route_path('lots.index', event_id=lot.event.id),
        request.route_path('lots.show', lot_id=lot.id),
      ]
  )}
</%block>
<div class="page-header">
  <h1>
    ${lot.event.title}<br />
    <small>${lot.name}</small>
  </h1>
</div>
<div class="content">
  ${h.flash_messages(request)}
</div>
${tabs.tabs(request)}
<div class="lot-entry-statuses">
<%include file="electing_statuses.html"/>

</div>

<div class="well">
  <form id="search" class="form-horizontal" method="POST">
    <fieldset>
      <legend>検索条件</legend>
      <table>
	<tbody>
          <tr>
            <th><label for="entry_no">${form.entry_no.label.text}</label></th>
            <td>${form.entry_no(maxlength=12)}</td>
	  </tr>
          <tr>
            <th><label for="tel">${form.tel.label.text}</label></th>
            <td>${form.tel(maxlength=255)}</td>
	  </tr>
          <tr>
            <th><label for="name">${form.name.label.text}</label></th>
            <td>${form.name(maxlength=255)}</td>
	  </tr>
          <tr>
            <th><label for="email">${form.email.label.text}</label></th>
            <td>${form.email(maxlength=255)}</td>
	  </tr>
          <tr>
            <th><label>${form.entried_from.label.text}</label></th>
            <td>
              ${form.entried_from()} 〜
              ${form.entried_to()}
            </td>
          </tr>
          <tr>
            <th><label for="include_canceled">${form.include_canceled.label.text}</label></th>
            <td>${form.include_canceled()}</td>
	  </tr>
          <tr>
	    <th>
	      <label for="electing">${form.electing.label.text}</label>
	    </th>
	    <td>
		${form.electing()}
	    </td>
	  </tr>
          <tr>
	    <th>
	      <label for="electing">${form.elected.label.text}</label>
	    </th>
	    <td>
		${form.elected()}
	    </td>
	  </tr>
          <tr>
	    <th>
	      <label for="electing">${form.rejecting.label.text}</label>
	    </th>
	    <td>
		${form.rejecting()}
	    </td>
	  </tr>
          <tr>
	    <th>
	      <label for="electing">${form.rejected.label.text}</label>
	    </th>
	    <td>
		${form.rejected()}
	    </td>
	  </tr>
          <tr>
            <th><label for="wish_order">${form.wish_order.label.text}</label></th>
            <td>${form.wish_order()}</td>
	  </tr>
	</tbody>
      </table>
      <button type="submit" name="search" class="btn">検索</button>
    </fieldset>
  </form>
</div>

<div>
%if wishes:
<table border="1" class="table" id="wish-search-results">
<thead>
<tr>
<th>&nbsp;</th>
<th>状態</th>
<th>決済方法</th>
<th>引取方法</th>
<th>申し込み番号</th>
<th>希望順序</th>
<th>申し込み日</th>
<th>席種</th>
<th>枚数</th>
<th>会場</th>
<th>公演コード</th>
<th>公演日</th>
<th>商品</th>
<th>配送先姓</th>
<th>配送先名</th>
<th>配送先姓(カナ)</th>
<th>配送先名(カナ)</th>
<th>都道府県</th>
<th>市区町村</th>
<th>住所1</th>
<th>住所2</th>
<th>電話番号1</th>
<th>電話番号2</th>
<th>メールアドレス1</th>
<th>メールアドレス2</th>
</tr>
</thead>
<tbody>
%for w in wishes:
<tr class="${'lot-wish-' + str(w.entry_no) + '-' + str(w.wish_order)}">
${self.lot_wish_row(request, w)}
</tr>
%endfor
</tbody>
</table>
%endif
</div>
<script>
var cancelUrl = "${cancel_url}";
var cancelElectingUrl = "${cancel_electing_url}";
var electingUrl = "${electing_url}";
var rejectingUrl = "${rejecting_url}"
var cancelRejectingUrl = "${cancel_rejecting_url}"
var statusUrl = "${status_url}"

$(function() {


  function rewrite_wishes(data) {
    for (var i = 0; i <  data.html.length; i++) {
      $("." + data.html[i][0]).html(data.html[i][1]);
    }

  }

  function update_status() {
    $.ajax({
      url: statusUrl,
      success: function(data, textStatus, xhr) {
        $(".lot-entry-statuses").html(data);
      }});
  }

  // 当選
  $('#wish-search-results').on('click', '.entry-elect-btn', function(e) {
     var entryNo = $(this).data("entryNo");
     var wishOrder = Number($(this).data("wishOrder"));
     $.ajax({
       url: electingUrl,
       data: {"entry_no": entryNo, "wish_order": wishOrder},
       dataType: "json",
       type: "POST",
       success: function(data, textStatus, xhr) {
           if (data.result == "OK") {
             if (data.html) {
               rewrite_wishes(data);
             } else {
                alert("申込番号" + entryNo + "-" + (wishOrder + 1) + " を当選予定にしました。");
             }
           } else if (data.result == "NG" && data.message) {
             alert(data.message);
           }
           update_status();
       }
     });
  });
  // キャンセル
  $('#wish-search-results').on('click', '.entry-cancel-btn', function(e) {
     var entryNo = $(this).data("entryNo");
     $.ajax({
       url: cancelUrl,
       data: {"entry_no": entryNo},
       dataType: "json",
       type: "POST",
       success: function(data, textStatus, xhr) {
           if (data.result == "OK") {
             if (data.html) {
               rewrite_wishes(data);
             } else {
               alert("申込番号" + entryNo + "をキャンセルしました。");
             }
           } else if (data.result == "NG" && data.message) {
             alert(data.message);
           }
           update_status();
       }
     });
  });
  // 当選予定キャンセル
  $('#wish-search-results').on('click', '.cancel-electing-btn', function(e) {
     var entryNo = $(this).data("entryNo");
     var wishOrder = Number($(this).data("wishOrder"));
     $.ajax({
       url: cancelElectingUrl,
       data: {"entry_no": entryNo, "wish_order": wishOrder},
       dataType: "json",
       type: "POST",
       success: function(data, textStatus, xhr) {
           if (data.result == "OK") {
             if (data.html) {
               rewrite_wishes(data);
             } else {
               alert("申込番号" + entryNo + "の当選予定をキャンセルしました。");
             }
           } else if (data.result == "NG" && data.message) {
             alert(data.message);
           }
           update_status();
       }
     });
  });
  // 落選予定
  $('#wish-search-results').on('click', '.entry-reject-btn', function(e) {
     var entryNo = $(this).data("entryNo");

     $.ajax({
       url: rejectingUrl,
       data: {"entry_no": entryNo},
       dataType: "json",
       type: "POST",
       success: function(data, textStatus, xhr) {
           if (data.result == "OK") {
             if (data.html) {
               rewrite_wishes(data);
             } else {
               alert("申込番号" + entryNo + "を落選予定にしました。");
             }
           } else if (data.result == "NG" && data.message) {
             alert(data.message);
           }
           update_status();
       }
     });
  });
  // 落選予定
  $('#wish-search-results').on('click', '.cancel-reject-btn', function(e) {
     var entryNo = $(this).data("entryNo");

     $.ajax({
       url: cancelRejectingUrl,
       data: {"entry_no": entryNo},
       dataType: "json",
       type: "POST",
       success: function(data, textStatus, xhr) {
           if (data.result == "OK") {
             if (data.html) {
               rewrite_wishes(data);
             } else {
               alert("申込番号" + entryNo + "の落選予定をキャンセルしました。");
             }
           } else if (data.result == "NG" && data.message) {
             alert(data.message);
           }
           update_status();
       }
     });
  });
});
</script>
