<%page args="performance" />
<%namespace file="./_venue_view.html" name="vv" />
<%namespace file="/common/helpers.html" name="ch" />

<style>
  .swatch {
    display: inline-block;
    width: 20px;
    height: 20px;
    margin: -6px 2px;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
  }

  #venue-editor .venue-editor-main .venue-editor-main-root {
    width: 100%;
  }

  #venue-editor .venue-editor-main .venue-editor-main-side {
    width: 0%;
  }

  .modal-backdrop.fade.in {
    opacity: 0.1;
  }
</style>


<div class="container-fluid pull-left">
  <form class="form-horizontal" id="sales_summary-form">
    <input type="hidden" name="performance_id" value="${performance.id}" />
    <div class="control-group">
      <label class="control-label" style="width: 60px;">販売区分</label>
      <div class="controls" style="margin-left: 80px;">
        <select name="sales_segment_id">
          <option value=""></option>
          % for sales_segment in performance.inner_sales_segments:
          <option value="${sales_segment.id}" ${'selected=""' if sales_segment.id == int(sales_segment_id or 0) else ''|n}>${sales_segment.name}</option>
          % endfor
        </select>
      </div>
    </div>
  </form>
</div>

<div class="container-fluid pull-right">
  <div class="row-fluid">
    <input id="sales-counter-button" type="button" class="btn btn-warning" style="vertical-align: baseline; font-size: 100%;" value="当日窓口発券モードにする" />
    <script type="text/javascript">
      $(function(){
        $('#sales-counter-button').click(function(){
        loadApplet();
        $(this).css('display', 'none');
        $('#sales-counter-label').css('display', 'inline');
        });
      });
    </script>

    <span id="sales-counter-label" class="label label-inverse" style="vertical-align: baseline; font-size: 100%; display:none;">発券用プリンタ</span>
    <%include file="_printer.html" />
  </div>
</div>
<div style="clear: both;"></div>

<div class="tabbable tabs-below tabs-above" id="seat-allocation-tab">
  <div class="tab-content"  id="seat-allocation-tab-content">
    <div class="tab-pane active" id="map">
      <div class="container-fluid">
        <div class="row-fluid">
          <%vv:venueeditor data_source="${data_source}">
            <%def name="toolbar_extra()">
            <div style="float:right">
              <a href="javascript:getOrderForm();" class="btn btn-primary btn">座席指定</a>
            </div>
            </%def>

            <%def name="post()">
<script type="text/javascript">
  function getOrderForm(stock_id) {
    var param = {'seats':[], 'stocks':[], 'performance_id':${performance.id}};
    var sales_segment_id = $('#sales_summary-form').find('select[name="sales_segment_id"]').val();
    if (sales_segment_id) param['sales_segment_id'] = sales_segment_id;
    if (stock_id) {
      param['stocks'].push(stock_id);
    } else {
      var selection = venueEditorRoot.venueeditor('selection');
      selection.each(function (seat) {
        param['seats'].push(seat.id);
        var stock_id = seat.get('stock').get('id');
        if ($.inArray(stock_id, param['stocks']) == -1)
          param['stocks'].push(stock_id);
      });
    }
    $.ajax({
      type: 'post',
      url: '${request.route_path('orders.reserve.form')}',
      data: JSON.stringify(param),
      dataType: 'html',
      success: function(data) {
        $('#reserve-form').html(data);
        $('#modal-reserve').modal({'backdrop':'static', 'keyboard':false});
        $('#modal-reserve').modal('show');
      },
      error: function(xhr, text) {
        var responseText = JSON.parse(xhr.responseText);
        var messages = responseText['message'] || xhr.statusText;
        $('.content').prepend('<div class="alert alert-error"><a class="close" data-dismiss="alert">&times;</a><h4 class="alert-heading">' + messages + '</h4></div>');
      }
    });
  }

  function confirmOrder() {
    var modal = $('#modal-reserve');
    modal.find('.modal-body .alert').remove();
    var param = {};
    $(modal.find('form').serializeArray()).each(function(i, v) {
      param[v.name] = v.value;
    });
    $.ajax({
      type: 'post',
      url: "${request.route_path('orders.reserve.confirm')}",
      data: JSON.stringify(param),
      dataType: 'html',
      success: function(data) {
        $('#modal-reserve').modal('hide');
        $('#reserve-form').html(data);
        $('#modal-reserve').modal({'backdrop':'static', 'keyboard':false});
        $('#modal-reserve').modal('show');
      },
      error: function(xhr, text) {
        var responseText = JSON.parse(xhr.responseText);
        var messages = responseText['message'] || xhr.statusText;
        var errors = '';
        if (typeof messages == 'string') {
          errors += '<li>' + messages + '</li>';
        } else {
          for (i in messages)
            errors += '<li>' + messages[i] + '</li>';
        }
        modal.find('.modal-body').prepend('<div class="alert alert-error"><ul>' + errors + '</ul></div>');
        modal.disableOnSubmit();
      }
    });
  }

  function completeOrder() {
    var modal = $('#modal-reserve');
    modal.find('.modal-body .alert').remove();
    var param = {};
    $(modal.find('form').serializeArray()).each(function(i, v) {
      param[v.name] = v.value;
    });
    if (window.ticketPrinterService) {
      param['with_enqueue'] = true;
    }
    $.ajax({
      type: 'post',
      url: "${request.route_path('orders.reserve.complete')}",
      contentType: 'application/json; charset=utf-8',
      dataType: 'json',
      data: JSON.stringify(param),
      success: function(result) {
        if (window.ticketPrinterService) {
          printOrder(result.order_id); // _printer.html
        }
        window.open('/orders/show/' + result.order_id, '_blank');
        $('#modal-reserve').modal('hide');
        venueEditorRoot.venueeditor('refresh');
        getSalesSummary();
      },
      error: function(xhr, text) {
        var responseText = JSON.parse(xhr.responseText);
        var messages = responseText['message'] || xhr.statusText;
        var errors = '';
        if (typeof messages == 'string') {
          errors += '<li>' + messages + '</li>';
        } else {
          for (i in messages)
            errors += '<li>' + messages[i] + '</li>';
        }
        modal.find('.modal-body').prepend('<div class="alert alert-error"><ul>' + errors + '</ul></div>');
        modal.disableOnSubmit();
      }
    });
  }

  function reselectOrder() {
    $.ajax({
      type: 'post',
      url: '${request.route_path('orders.reserve.reselect')}',
      dataType: 'html',
      success: function(data) {
        $('#modal-reserve').modal('hide');
      },
      error: function(xhr, text) {
        var responseText = JSON.parse(xhr.responseText);
        var message = responseText['message'] || xhr.statusText;
        $('.content').prepend('<div class="alert alert-error"><a class="close" data-dismiss="alert">&times;</a><h4 class="alert-heading">' + message + '</h4></div>');
        $('#modal-reserve').modal('hide');
      }
    });
  }

  function getSalesSummary() {
    var form = $('#sales_summary-form');
    var body = form.serialize();
    var table = '#sales-summary';
    var url = '${request.route_path('orders.sales_summary')}';
    $.ajax({
      type: 'post',
      url: url,
      dataType: 'html',
      data: body,
      success: function(data) {
        $('#sales-summary').effect("highlight", {color: '#DCDCDC'}, 1000);
        $('#sales-summary').html(data);
      }
    });
  }

  $(function() {
    $('#sales_summary-form').find('select[name="sales_segment_id"]').change(function() {
      var metadata = "${data_source.get('metadata')|n}"
      venueEditorRoot.data('venueeditor').dataSource.metadata = metadata + '&sales_segment_id=' + $(this).val();
      venueEditorRoot.venueeditor('load');
      getSalesSummary();
    });

    getSalesSummary();
  });
</script>
            </%def>
          </%vv:venueeditor>
        </div>
      </div>
    </div>
  </div>
</div>

<div>
  <%include file="_legend_seat_status.html" />
</div>
<div id="sales-summary"></div>
<div id="reserve-form"></div>
