<%inherit file="../layout.html" />
<%namespace file="/common/helpers.html" import="flash_messages" />
<%namespace file="/common/helpers.html" import="safe_strftime" />

<%block name="style">
<link rel="stylesheet" type="text/css" href="/static/css/kolorpicker.css" />
<link rel="stylesheet" type="text/css" href="/static/css/performance.css" />
<link rel="stylesheet" href="/static/js/demo/development-bundle/themes/base/jquery.ui.all.css" />
<script type="text/javascript" src="/static/js/jquery.kolorpicker.js"></script>
<script type="text/javascript" src="/static/js/demo/fashion.js"></script>
<script type="text/javascript" src="/static/js/demo/development-bundle/ui/jquery.ui.core.js"></script>
<script type="text/javascript" src="/static/js/demo/development-bundle/ui/jquery.ui.widget.js"></script>
<script type="text/javascript" src="/static/js/demo/development-bundle/ui/jquery.ui.button.js"></script>
<script type="text/javascript" src="/static/js/ticketing.performance.js"></script>
<script type="text/javascript" src="/static/js/ticketing.venue-editor.js"></script>
<style type="text/css">
  .canvas {
    height: 91%;
    margin: 0 0;
    padding: 0 0;
  }
  .ui-toolbar { padding: 2px 2px 2px 2px; height: 32px; }
  .ui-toolbar { margin: 0 0; }

  #venue-map {
    padding: 0;
  }
  #seat-map {
    padding: 0;
  }
</style>
</%block>

<script type="text/javascript">
var DRAWING_URL = "${request.route_path('api.get_drawing', venue_id=performance.venue.id)}" + "?" + Math.random();
var SEAT_DATA_URL = "${request.route_path('api.get_seats', venue_id=performance.venue.id)}" + "?" + Math.random();
var RENDERING_RULE_URL = "/static/js/demo/renderingRules.json" + "?" + Math.random();
</script>

<div class="row-fluid">
  <%include file="../parts/_menu.html" />

  <span class="span10">
    <div class="page-header">
      <h3>${performance.name}</h3>
    </div>

    <div class="content">
      ${flash_messages(request)}
    </div>

    <div class="span3">
      <table class="table table-bordered table-condensed">
        <tbody>
          <tr>
            <th>開場</th>
            <td>${safe_strftime(performance.open_on)}</td>
          </tr>
          <tr>
            <th>開演</th>
            <td>${safe_strftime(performance.start_on)}</td>
          </tr>
          <tr>
            <th>終演</th>
            <td>${safe_strftime(performance.end_on)}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="span6">
      <table class="table table-bordered table-condensed">
        <tbody>
          <tr>
            <th>公演コード</th>
            <td>${performance.code}</td>
          </tr>
          <tr>
            <th>会場</th>
            <td>${performance.venue.name}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="span1">
      <a class="btn" href="${request.route_path('performances.edit', performance_id=performance.id)}" >編集</a>
    </div>
  </span>

  <span class="span10">
    <div class="tabbable tabs-top" id="tabbable-content">
      <ul class="nav nav-tabs">
        <li class="active"><a href="#venue-designer" data-toggle="tab">会場／席種</a></li>
        <li><a href="#seat-allocation" data-toggle="tab">配券／配席</a></li>
        <li><a href="#product" data-toggle="tab">商品管理</a></li>
        <li><a href="#ticket-designer" data-toggle="tab">チケット券面</a></li>
      </ul>
      <div class="tab-content" id="tabbable-tab-content">
        <div class="tab-pane active" id="venue-designer">
          <%include file="./_venue_designer.html" />
        </div>
        <div class="tab-pane" id="seat-allocation">
          <%include file="./_seat_allocation.html" />
        </div>
        <div class="tab-pane" id="product">
          <%include file="./_product.html" />
        </div>
        <div class="tab-pane" id="ticket-designer">
          <%include file="./_ticket_designer.html" />
        </div>
      </div>
      <script type="text/javascript">
        (function() {
          var active_tab = null;
          function activate_tab() {
            var new_active_tab = $(this).find("#tabbable-tab-content > .tab-pane.active");
            if (active_tab) {
              switch (active_tab.attr('id')) {
              case 'venue-designer':
                $('#venue-map').venue_editor('remove');
                break;
              case 'seat-allocation':
                $('#seat-map').venue_editor('remove');
                break;
              }
            }
            switch (new_active_tab.attr('id')) {
            case 'venue-designer':
              $('#venue-map').venue_editor({
                drawing_url: DRAWING_URL,
                seat_data_url: SEAT_DATA_URL,
                rendering_rule_url: RENDERING_RULE_URL
              }).venue_editor('load');
              break;
            case 'seat-allocation':
              $('#seat-map').venue_editor({
                drawing_url: DRAWING_URL,
                seat_data_url: SEAT_DATA_URL,
                rendering_rule_url: RENDERING_RULE_URL
              }).venue_editor('load');
              break;
            case 'ticket-designer':
              TicketDesigner_adjustViewSize();
              break;
            }
            active_tab = new_active_tab;
          }
          activate_tab.call($("#tabbable-content").on('shown', activate_tab));
        })();
      </script>
    </div>
  </span>
</div>
