<%namespace file="/common/confirm_modal.html" import="delete_modal" />
<% import json %>
<script>
  $(function() {
    $('#delete').click(function(){
      $('#delete-modal').modal('toggle');
      $('#delete-modal #delete').attr('href', '/seat_types/delete/' + $('input[name=checked_id]:checked').val());
    });
  });

  function add() {
    $('#edit-modal').modal('toggle');
    $('#edit-modal #edit').attr('action', '/seat_types/new/' + ${performance.id});
  }

  function edit(seat_type_id, name, data) {
    $('#edit-modal').modal('toggle');
    $('#edit-modal #name').val(name);
    $('#edit-modal #signature').val(data.text);

    $('#edit-modal #fill_color').val(data.fill);
    $('#edit-modal #line_color').val(data.stroke.color);

    $('#edit-modal #line_thickness_' + data.stroke.width).attr('checked', true);
    $('#edit-modal #line_style_' + data.stroke.pattern).attr('checked', true);

    $('#edit-modal #edit').attr('action', '/seat_types/edit/' + seat_type_id);
  }

  $(window).resize(function(api){
    $("#venue-map").height($(window).height()-230);
  });

  $(document).ready(function(){
    $("#venue-map").height($(window).height()-230);
  });
</script>

<div class="container-fluid">
  <div class="row-fluid">
    <div class="span8" style="background-color: #999999">
      <div style="width:100%;  margin: 0 0 0 5px;" id="venue-map"></div>
    </div>
    <div class="span4">
      <div class="tab-pane" id="detail">
        <ul class="nav nav-pills">
          <li class="dropdown" id="seat-type-menu">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#seat-type-menu">
              席種<b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
              <li>
                <a href="javascript:add()"><i class="icon-plus"></i> 新規</a>
              </li>
              <li>
                <a id="delete" data-controls-modal="delete-modal" data-backdrop="true" data-keyboard="true">
                  <i class="icon-minus"></i> 削除
                </a>
              </li>
              <li class="divider"></li>
            </ul>
          </li>
          <li class="dropdown" id="venue-menu">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#venue-menu">
              会場図<b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
              <li>
                <i class="icon-plus"></i> 保存
              </li>
              <li class="divider"></li>
            </ul>
          </li>
        </ul>
      </div>

      <table class="table table-striped table-bordered table-condensed">
        <tbody>
          <tr>
          </tr>
          % for seat_type in performance.seat_types:
          <tr>
            <td><input name="checked_id" type="radio" value=${seat_type.id} /></td>
            <td>
              <a id="edit" href="javascript:edit(${seat_type.id}, '${seat_type.name|u}', ${json.dumps(seat_type.style)})">
              <%
                style = seat_type.style
                fill_color = 'FFFFFF';
                text = ''
                line_width = ''
                line_pattern = ''
                line_color = ''
                if style:
                    fill_color = style.get('fill')
                    text  = style.get('text')
                    stroke = style.get('stroke')
                    if stroke:
                        line_width = stroke.get('width')
                        line_pattern = stroke.get('pattern')
                        line_color = stroke.get('color')
              %>
              <span class="swatch" style="border: ${line_width}px ${line_pattern} #${line_color}; background-color: #${fill_color}; text-align: center">${text}</span>${seat_type.name}</a>
            </td>
            <td>
              ${len(seat_type.seats)}席
            </td>
          </tr>
          % endfor
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="edit-modal" class="modal fade">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">×</a>
        <h3>席種</h3>
    </div>

    <form id="edit" action="" method="POST">
        <div class="modal-body">
            <label>席種名</label>
            <input id="name" name="name" type="text" class="span3" value="">
            <label>記号</label>
            <input id="signature" name="signature" type="text" class="span3" value="">
            <label>塗りつぶし色</label>
            <input id="fill_color" name="fill_color" type="text" class="span3" value="">
            <label>線の色</label>
            <input id="line_color" name="line_color" type="text" class="span3" value="">
            <label>線の太さ</label>
            <div class="controls">
                <label class="checkbox inline"><input type="radio" name="line_thickness" id="line_thickness_1" value="1">1</label>
                <label class="checkbox inline"><input type="radio" name="line_thickness" id="line_thickness_2" value="2">2</label>
                <label class="checkbox inline"><input type="radio" name="line_thickness" id="line_thickness_3" value="3">3</label>
                <label class="checkbox inline"><input type="radio" name="line_thickness" id="line_thickness_4" value="4">4</label>
            </div>
            <label class="control-label" for="inlineCheckboxs">線の種類</label>
            <div class="controls">
                <label class="checkbox inline"><input type="radio" name="line_style" id="line_style_solid" value="solid">実線</label>
                <label class="checkbox inline"><input type="radio" name="line_style" id="line_style_double" value="double">2重線</label>
                <label class="checkbox inline"><input type="radio" name="line_style" id="line_style_dotted" value="dotted">破線</label>
                <label class="checkbox inline"><input type="radio" name="line_style" id="line_style_dashed" value="dashed">点線</label>
            </div>
        </div>

        <div class="modal-footer">
            <a href="#" class="btn" data-dismiss="modal">閉じる</a>
            <input class="btn" type="submit" value="保存"></a>
        </div>
    </form>
</div>

<script type="text/javascript">
$('#line_color').ColorPicker({
	onSubmit: function(hsb, hex, rgb, el) {
		$(el).val(hex);
		$(el).ColorPickerHide();
	},
	onBeforeShow: function () {
		$(this).ColorPickerSetColor(this.value);
	},
    onChange: function (hsb, hex, rgb) {
        $(this).css('backgroundColor', '#' + hex);
        $('#line_color').val(hex)
    },
    zIndex: 9999
})
$('#fill_color').ColorPicker({
	onSubmit: function(hsb, hex, rgb, el) {
		$(el).val(hex);
		$(el).ColorPickerHide();
	},
	onBeforeShow: function () {
		$(this).ColorPickerSetColor(this.value);
	},
    onChange: function (hsb, hex, rgb) {
        $(this).css('backgroundColor', '#' + hex);
        $('#fill_color').val(hex)
    },
    zIndex: 9999
})
.bind('keyup', function(){
	$(this).ColorPickerSetColor(this.value);
});

</script>

${delete_modal(u'選択した席種を削除します。よろしいですか？')}
