<%page args="event, performance=None" />
<%namespace file="/common/modal.html" import="delete_modal" />

<%block name="style">
<link rel="stylesheet" type="text/css" href="/static/css/kolorpicker.css" />
<script type="text/javascript" src="/static/js/jquery.kolorpicker.js"></script>
</%block>

<script type="text/javascript">
  function new_stock_type() {
    $('#modal-stock_type').modal('toggle');
  }
  function edit_stock_type(id) {
    var id = id || get_id('stock_type_id');
    if (!id) return;
    var el = '#stock_type-' + id;
    $('#modal-stock_type #id').val(id);
    $('#modal-stock_type #name').val($(el).attr('name'));
    if ($(el).attr('type') == '1') {
      $('#modal-stock_type #type').attr('checked', 'checked').change();
    }
    var data = JSON.parse($(el).attr('data'));
    if (data) {
      $('#modal-stock_type #text').val(data.text);
      $('#modal-stock_type #text_color').val(data.text_color);
      if (data.fill) {
        $('#modal-stock_type #fill_color').val(data.fill.color);
        $('#modal-stock_type #fill_type').val(data.fill.type);
        $('#modal-stock_type #fill_image').val(data.fill.image);
      }
      if (data.stroke) {
        $('#modal-stock_type #stroke_color').val(data.stroke.color);
        $('#modal-stock_type #stroke_width').val(data.stroke.width);
        $('#modal-stock_type #stroke_patten').val(data.stroke.pattern);
      }
    }
    $('#modal-stock_type').modal('toggle');
  }
  function delete_stock_type() {
    var id = get_id('stock_type_id');
    if (!id) return;
    $('#modal-delete #delete').attr('href', '/events/stock_types/delete/' + id);
    $('#modal-delete #message').text('選択した席種を削除します。よろしいですか？');
    $('#modal-delete').modal('toggle');
  }
  function save_stock_type() {
    var id = $('#modal-stock_type #id').val();
    var url = id ? '/events/stock_types/edit/' + id : '/events/stock_types/new/${event.id}';
    var param = {};
    $('#modal-stock_type :input').each(function(i, v) {
      param[v.name] = v.value;
    });
    $.post(
        url,
        param,
        function(data, status, xhr) {
          $('#modal-stock_type').modal('hide');
          $('#stock_types-form').html(data);
          $('#modal-stock_type').modal('show');
        },
        "html"
    );
  }

  % if performance:
  function stock_allocate() {
    var id = get_id('stock_type_id');
    if (!id) return;
    var el = '#stock_type-' + id;
    $('#modal-stock_allocation #stock_type_id').val(id);
    $('#modal-stock_allocation #performance_id').val(${performance.id});
    $('#modal-stock_allocation #quantity').val($(el).attr('quantity'));
    $('#modal-stock_allocation').modal('toggle');
  }
  function save_stock_allocation() {
    var url = '/events/stock_types/allocate/';
    var param = {};
    $('#modal-stock_allocation :input').each(function(i, v) {
      param[v.name] = v.value;
    });
    $.post(
        url,
        param,
        function(data, status, xhr) {
          $('#modal-stock_allocation').modal('hide');
          $('#stock_allocations-form').html(data);
          $('#modal-stock_allocation').modal('show');
        },
        "html"
    );
  }
  % endif
</script>

<div class="btn-group">
  <a href="javascript:new_stock_type()" class="btn">
    <i class="icon-plus"></i> 新規
  </a>
  <button class="btn dropdown-toggle" data-toggle="dropdown">
    <span class="caret"></span>
  </button>
  <ul class="dropdown-menu">
    <li>
      <a href="javascript:edit_stock_type();">
        <i class="icon-pencil"></i> 編集
      </a>
    </li>
    <li>
      <a href="javascript:delete_stock_type();" data-controls-modal="modal-delete" data-backdrop="true" data-keyboard="true">
        <i class="icon-minus"></i> 削除
      </a>
    </li>
    % if performance:
    <li>
      <a href="#">
        <i class="icon-ok"></i> 選択した座席を割り当てる
      </a>
    </li>
    <li>
      <a href="javascript:stock_allocate();">
        <i class="icon-pencil"></i> 在庫数を入力する
      </a>
    </li>
    % endif
  </ul>
</div>

${delete_modal()}