<%doc>
  pager template
</%doc>
<%!
  from webhelpers.paginate import Page
%>
<%def name="pager(items, url='%s')">
  % if isinstance(items, Page):
  <div class="pagination-centered">
    ${items.pager(format='$link_previous ~2~ $link_next',
                  link_attr={"class": "btn small"},
                  curpage_attr={"class": "btn primary small disabled"},
                  dotdot_attr={"class": "btn small disabled"},
                  onclick=url + "; return false;")}
  </div>
  % endif
</%def>

<%doc>
  checks validate errors, if any validate errors, adds as span
</%doc>
<%def name="validate_errors(f)">
  % for error in f.errors:
    <span class="help-inline">${error}</span> 
  % endfor
</%def>

<%def name="alert_message(f, escape=True)">
  % if f.errors:
    <div class="alert alert-error">
      <a class="close" data-dismiss="alert">&times;</a>
      <h4 class="alert-heading">エラー</h4>
      % for field in f:
        % if field.errors:
          <ul>
          % for e in field.errors:
            <li>
              % if field.label.text:
                ${field.label.text} :
              % endif
              % if escape:
                ${e}
              % else:
                ${e|n}
              % endif
            </li>
          % endfor
          </ul>
        % endif
      % endfor
    </div>
  % endif
</%def>

<%def name="flash_messages(request, type='alert-success')">
  % if request.session.peek_flash():
    <div class="alert ${type}">
      <a class="close" data-dismiss="alert">&times;</a>
      % for message in request.session.pop_flash():
        <h4 class="alert-heading">${message}</h4>
      % endfor
    </div>
  % endif
</%def>

<%def name="form_item(item, help=None, label=None, **options)">
  <% hide_on_new = getattr(item, 'hide_on_new', False) %>
  % if not getattr(getattr(item, 'form', None), 'new_form', False) or not hide_on_new:
  <% if hide_on_new: options['data-hide-on-new'] = 'hide-on-new' %>
  <div class="control-group ${'error' if item.errors else ''}">
    % if item.type != 'HiddenField':
      <label class="control-label">
        % if item.flags.required:
        <span style="color: #BA0000;padding-left: 5px; padding-right: 5px; font-size: 150%">*</span>
        % endif
        ${(help or u'')|n} ${label or item.label.text}
      </label>
    % endif
    <div class="controls">
      ${item(**options)}
      ${validate_errors(item)}
    </div>
  </div>
  % endif
</%def>

<%def name="safe_strftime(str, format='%Y-%m-%d %H:%M')">
${str and str.strftime(format) or ''}
</%def>

<%def name="seat_style(style)">
<%
  fill_color = '#FFFFFF'
  text_color = '#000'
  stroke_width = ''
  stroke_pattern = ''
  stroke_color = ''
  text = ''
  if style:
    fill = style.get('fill')
    if fill:
        fill_color = fill.get('color')
    text = style.get('text', '')
    text_color = style.get('text_color')
    stroke = style.get('stroke')
    if stroke:
        stroke_width = stroke.get('width')
        stroke_pattern = stroke.get('pattern')
        stroke_color = stroke.get('color')
%>
  <span class="swatch" style="text-color:${text_color}; border: ${stroke_width}px ${stroke_pattern} ${stroke_color}; background-color: ${fill_color}; text-align: center">${text}</span>
</%def>

<%def name="json(style)">
<% import json %>
${json.dumps(style)}
</%def>

<%!
  import locale
  locale.setlocale(locale.LC_ALL, "")
%>
<%def name="price_format(price)">
${locale.format("%d", price, grouping=True)}
</%def>

<%def name="breadcrumbs(names=[], urls=[], length=20)">
<ul class="breadcrumb">
  % for i in xrange(len(urls)):
  <li><a href="${urls[i]}">${names[i][:length]}${'...' if len(names[i]) > length else ''}</a><span class="divider">/</span></li>
  % endfor
  <li>${names[-1]}</li>
</ul>
</%def>
<%def name="sortable(column, paging=True)">
<%
from wtforms.fields.core import UnboundField
if isinstance(column, UnboundField):
  column_name = column.kwargs.get('name', '')
  column_label = column.kwargs.get('label', '')
else:
  column_name = column.name
  column_label = column.label.text
%>
% if paging:
<%
  sort_column = request.GET.get('sort')
  sort_direction = request.GET.get('direction')
  direction = 'desc' if (column_name == sort_column and sort_direction == 'asc') else 'asc'
  css_class = 'current ' + sort_direction if (column_name == sort_column) else ''
%>
  <a href="?sort=${column_name}&direction=${direction}" class="${css_class}">${column_label}</a>
% else:
  ${column_label}
% endif
</%def>

<%!
  from webhelpers.util import html_escape
  from pyramid.threadlocal import get_current_registry
%>
<%def name="action_button(actions, order=None, vertical=True, options=None, dropup=False)">
<%
  registry = get_current_registry()
  route_permission = registry.route_permission if hasattr(registry, 'route_permission') else None
  count = 0
  if order is None:
    order = actions.keys()

  def attrs_str():
    attrs = actions[key].get('attrs', {})
    attrs['class'] = attrs.get('class', u'')
    if count == 0 or not vertical:
      attrs['class'] += ' ' + u'btn'
    if key == 'delete':
      attrs['data-controls-modal'] = u'modal-delete'
      attrs['data-backdrop'] = u'true'
      attrs['data-keyboard'] = u'true'
    if options is not None:
      attrs['class'] += ' ' + options
    return ' '.join(u'%s="%s"' % (name, html_escape(value)) for name, value in attrs.iteritems())
%>
<div class="btn-group">
  % for key in order:
    <%
      if 'route_name' in actions[key]:
        if not route_permission:
          continue
        permission = route_permission.get(actions[key]['route_name'], None)
        if isinstance(permission, list):
          allowed = False
          for p in permission:
            if p and has_permission(p):
              allowed = True
              break
          if not allowed:
            continue
        else:
          if not permission or not has_permission(permission):
            continue
    %>
    % if vertical and count == 1:
    <button class="btn dropdown-toggle" data-toggle="dropdown">
      <span class="caret"></span>
    </button>
      % if dropup:
        <ul class="dropdown-menu bottom-up">
      % else:
        <ul class="dropdown-menu">
      % endif
    % endif
    % if vertical and count > 0:
      <li>
    % endif
        <a href="${actions[key]['url']}" ${attrs_str()|n}>
          <i class="${actions[key]['icon']}"></i> ${actions[key]['label']}
        </a>
    % if vertical and count > 0:
      </li>
    % endif
    <% count += 1 %>
  % endfor
  % if vertical and count > 0:
    </ul>
  % endif
</div>

</%def>

<%!
  from pyramid.security import has_permission as security_has_permission
  from pyramid.security import ACLAllowed
%>
<%def name="has_permission(permission)">
<%
  return isinstance(security_has_permission(permission, request.context, request), ACLAllowed)
%>
</%def>

<%def name="order_status(order)">
<%
  from ticketing.core.models import OrderCancelReasonEnum
%>
  % if order is None:
    <span></span>
  % elif order.status == 'canceled' and order.cancel_reason == str(OrderCancelReasonEnum.CallOff.v[0]):
    <span class="label label-important">キャンセル (中止)</span>
  % elif order.status == 'canceled':
    <span class="label label-important">キャンセル</span>
  % elif order.status == 'delivered':
    <span class="label label-success">配送済み</span>
  % elif order.status == 'ordered':
    <span class="label label-warning">受付済み</span>
  % endif
</%def>

<%def name="payment_status(order)">
  % if order is None:
    <span></span>
  % elif order.payment_status == 'refunding':
    <span class="label label-important">払戻予約</span>
  % elif order.payment_status == 'refunded':
    <span class="label label-info">払戻済み</span>
  % elif order.payment_status == 'paid':
    <span class="label label-success">入金済み</span>
  % else:
    <span class="label label-inverse">未入金</span>
  % endif
</%def>

<%def name="delivery_status(order)">
  % if order is None:
    <span></span>
  % elif order.delivered_at:
    <span class="label label-success">配送済み</span>
  % else:
    <span class="label label-inverse">未配送</span>
  % endif
</%def>
