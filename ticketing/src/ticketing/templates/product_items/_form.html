<%page args="performance" />

% if performance:
<script type="text/javascript">
  stock_holder2stocks = {
    % for stock_holder in performance.stock_holders:
      '${stock_holder.id}':[
        % for stock in stock_holder.stocks:
          ['${stock.id}', '${stock.seat_type.name}'],
        % endfor
      ],
    % endfor
  }

  $(function() {
    $('#modal-product_item-edit #stock_holders').change(function(){
      $('#modal-product_item-edit #stock_id').children().remove();
      stock_ids = stock_holder2stocks[$(this).val()];
      stock_id_node = window.document.getElementById('stock_id');
      if (stock_ids) {
        for (var i = 0; i < stock_ids.length; i++ ) {
          stock_id_node.options[i] = new Option(stock_ids[i][1], stock_ids[i][0]);
        }
        stock_id_node.selectedIndex = 0;
      }
    }).change();
  });

  function add_product_item(product_id) {
    var el = '#product-' + product_id;
    $('#modal-product_item-edit #product_id').val($(el + ' #id').text());
    $('#modal-product_item-edit #name').val($(el + ' #name').text());
    $('#modal-product_item-edit #price').val($(el + ' #price').text());
    $('#modal-product_item-edit #id').val('');
    $('#modal-product_item-edit #item_price').val('');
    $('#modal-product_item-edit #sales_segment').val($(el + ' #sales_segment').text());
    $('#modal-product_item-edit #stock_holders').removeAttr('disabled');
    $('#modal-product_item-edit #stock_id').removeAttr('disabled');
    $('#modal-product_item-edit').modal('toggle');
  }

  function edit_product_item(product_id, product_item_id) {
    var product = '#product-' + product_id;
    $('#modal-product_item-edit #product_id').val(product_id);
    $('#modal-product_item-edit #name').val($(product + ' #name').text());
    $('#modal-product_item-edit #price').val($(product + ' #price').text());
    $('#modal-product_item-edit #sales_segment').val($(product + ' #sales_segment').text());
    var product_item = '#product_item-' + product_item_id;
    $('#modal-product_item-edit #id').val(product_item_id);
    $('#modal-product_item-edit #item_price').val($(product_item + ' #price').text());
    $('#modal-product_item-edit #stock_holders').val($(product_item + ' #stock_holder').attr('value')).change();
    $('#modal-product_item-edit #stock_holders').attr('disabled', 'disabled');
    $('#modal-product_item-edit #stock_id').val($(product_item + ' #stock').attr('value'));
    $('#modal-product_item-edit #stock_id').attr('disabled', 'disabled');
    $('#modal-product_item-edit').modal('toggle');
  }

  function delete_product_item(product_item_id) {
    $('#modal-delete #delete').attr('href', '/products/delete_item/' + product_item_id);
    $('#modal-delete #message').text("${u'選択した在庫を削除します。よろしいですか？'}");
    $('#modal-delete').modal('toggle');
  }

  function save_product_item() {
    var id = $('#modal-product_item-edit #id').val();
    var url = id ? '/products/json.edit_item/' + id : '/products/json.new_item';
    $.ajax({
      type: "POST",
      url: url,
      data:{
        "id":id,
        "performance_id":${performance.id},
        "price":$('#modal-product_item-edit #item_price').val(),
        "product_id":$('#modal-product_item-edit #product_id').val(),
        "stock_id":$('#modal-product_item-edit #stock_id').val(),
      },
      dataType:'json',
      success: function(msg){
        if (msg['success'] == true) {
          location.href = '/events/performances/show/' + ${performance.id};
        } else {
          alert(msg['success'])
        }
      }
    });
  }
</script>

<div class="modal fade" id="modal-product_item-edit">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">×</a>
    <h3>商品</h3>
  </div>
  <form action="javascript:save_product_item();" method="POST">
    <div class="modal-body">
      <fieldset>
        <input id="performance_id" type="hidden" value="${performance.id}">
        <input id="product_id" type="hidden">
        <input id="id" type="hidden">
        <label>商品名</label>
        <input id="name" name="name" type="text" class="span3" disabled>
        <label>価格</label>
        <input id="price" name="price" type="text" class="span3" disabled>
        <label>販売条件</label>
        <input id="sales_segment" name="sales_segment" type="text" class="span3" disabled>
        <label>商品構成</label>
        <select id="stock_holders">
          % for stock_holder in performance.stock_holders:
            % if stock_holder.account.user_id == user.id:
              <option value="${stock_holder.id}">${stock_holder.name}</option>
            % endif
          % endfor
        </select>
        <select id="stock_id"></select>
        <label>価格</label>
        <input id="item_price" type="text" class="span3" placeholder="価格">
      </fieldset>
    </div>

    <div class="modal-footer">
      <a href="#" class="btn" data-dismiss="modal">閉じる</a>
      <input class="btn" type="submit" value="保存"></a>
    </div>
  </form>
</div>
% endif
