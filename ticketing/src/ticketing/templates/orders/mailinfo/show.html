<%inherit file="/layout_2cols.html" />
<%namespace file="/common/helpers.html" name="h" />

<div class="breadcrumbs">
${h.breadcrumbs(
  names=[u'トップ', u'購入情報', order.order_no, u'メール情報'],
  urls=[request.route_path('index'), request.route_path('orders.index'), request.route_path('orders.show', order_id=order.id)]
)}
</div>
<div class="page-header">
  <h1>メール情報</h1>
</div>

<div class="content">
  ${h.flash_messages(request)}
</div>

<div class="row-fluid">
  <div class="span6">
    <div class="page-header">
      <h3>予約情報</h3>
    </div>

    <table class="table table-striped table-bordered">
      <tr>
        <th class="span2">予約番号</th>
        <td class="span3">${order.order_no}</td>
      </tr>
      <tr>
        <th>ステータス</th>
        <td>
          % if order.status == 'refunded':
          <span class="label label-important">キャンセル (返金済)</span>
          % elif order.status == 'canceled':
          <span class="label label-important">キャンセル</span>
          % elif order.status == 'delivered':
          <span class="label label-success">配送済み</span>
          % elif order.status == 'paid':
          <span class="label label-warning">入金済み</span>
          % else:
          <span class="label label-inverse">未入金</span>
          % endif
        </td>
      </tr>
      <tr>
        <th>予約日時</th>
        <td>${h.safe_strftime(order.created_at)}</td>
      </tr>
      <tr>
        <th>決済日時</th>
        <td>
          % if order.paid_at:
            ${h.safe_strftime(order.paid_at)}
          % else:
            <span class="label label-inverse">未入金</span>
          % endif
        </td>
      </tr>
      <tr>
        <th>配送日時</th>
        <td>
          % if order.delivered_at:
            ${h.safe_strftime(order.delivered_at)}
          % else:
            <span class="label label-inverse">未配送</span>
          % endif
        </td>
      </tr>
      % if order.status == 'canceled':
      <tr>
        <th>キャンセル日時</th>
        <td>${h.safe_strftime(order.canceled_at)}</td>
      </tr>
      % endif
    </table>
    <div class="pull-right">
      <%include file="./_action_button.html" args="order=order, mail_form=mail_form, event=event" />
    </div>
  </div>

  <div class="span6">
    <div class="page-header">
      <h3>購入者</h3>
    </div>

    <table class="table table-striped table-bordered">
      <tr>
        <th class="span2">氏名</th>
        <td class="span3">
          % if order.user and order.user.user_profile:
            <% up = order.user.user_profile %>
            ${up.last_name} ${up.first_name} (${up.last_name_kana} ${up.first_name_kana})
          % endif
        </td>
      </tr>
      <tr>
        <th>ニックネーム</th>
        <td>
          % if order.user and order.user.user_profile:
            ${order.user.user_profile.nick_name or ''}
          % endif
        </td>
      </tr>
      <tr>
        <th>メールアドレス</th>
        <td>${order.shipping_address.email}</td>
      </tr>
      <tr>
        <th>購読メールマガジン</th>
        <%
          segment_name = []
          if order.user and order.user.mail_subscription:
            for ms in order.user.mail_subscription:
              if ms.segment.organization_id == order.organization_id:
                segment_name.append(ms.segment.name)
        %>
        <td>
          <ul>
          % for name in list(set(segment_name)):
            <li>${name}</li>
          % endfor
          </ul>
        </td>
      </tr>
    </table>
  </div>
</div>

