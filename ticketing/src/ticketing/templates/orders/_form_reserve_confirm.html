<%page args="form, cart" />
<%namespace file="/common/helpers.html" name="h" />

<style type="text/css">
  #modal-reserve .form-horizontal .control-group {
    margin-bottom: 5px;
  }
  #modal-reserve .form-horizontal .controls {
    padding-top: 5px;
  }
</style>

<script type="text/javascript">
  $(function() {
    if (window.ticketPrinterService) {
      $('#reserve-button').text('予約して発券する');
    }
    $('.draggable').draggable({scroll: true, handle:$('.draggable .modal-header')});
    $('#modal-reserve').disableOnSubmit();
    $('#modal-reserve').on('shown', function(){
      $('#reserve-button').attr('disabled', null); 
    });
  });
</script>

<div id="modal-reserve" class="modal hide draggable">
  <div class="modal-header">
    <h3>予約確認 -- ${performance.event.title}[${performance.name}]</h3>
  </div>

  <div class="modal-body">
    <form class="form-horizontal" action="javascript:completeOrder();" method="POST">
      <div class="content">
        <div class="alert alert-success">
          <h4 class="alert-heading">以下の内容で予約してよいですか？</h4>
        </div>
      </div>

      <table class="table table-striped table-bordered">
        <tr>
          <th colspan="2">商品</th>
          <th style="width: 80px; text-align: right;">単価</th>
          <th style="width: 80px; text-align: right;">個数</th>
        </tr>
        % for carted_product in cart.products:
        <tr>
          <td colspan="2">${carted_product.product.name}</td>
          <td style="text-align: right;">
            <span name="product_price-${carted_product.id}">${h.price_format(carted_product.product.price)}円</span>
          </td>
          <td style="text-align: right;">
            ${carted_product.quantity}
          </td>
        </tr>
          % for carted_product_item in carted_product.items:
        <tr>
          <td></td>
          <td>
            ${carted_product_item.product_item.stock_type.name}
            <ul>
              % for seat in carted_product_item.seats:
              <li>${seat.name}</li>
              % endfor
            </ul>
          </td>
          <td style="text-align: right;">
            ${h.price_format(carted_product_item.product_item.price)}円
          </td>
          <td style="text-align: right;">
            % if carted_product.product.seat_stock_type.quantity_only:
            <span name="product_quantity-${carted_product.id}">${carted_product.quantity}</span>
            % else:
            ${len(carted_product_item.seats)}
            % endif
          </td>
        </tr>
          % endfor
        % else:
        <tr>
          <td colspan="2">決済手数料 (${cart.payment_delivery_pair.payment_method.name})</td>
          <td style="text-align: right;">${h.price_format(cart.delivery_fee)}円</td>
          <td></td>
        </tr>
        <tr>
          <td colspan="2">引取手数料 (${cart.payment_delivery_pair.delivery_method.name})</td>
          <td style="text-align: right;">${h.price_format(cart.transaction_fee)}円</td>
          <td></td>
        </tr>
        <tr>
          <td colspan="2">システム利用料</td>
          <td style="text-align: right;">${h.price_format(cart.system_fee)}円</td>
          <td></td>
        </tr>
        <tr>
          <td colspan="2">合計金額</td>
          <td style="text-align: right;">${h.price_format(cart.total_amount)}円</td>
          <td></td>
        </tr>
        % endfor
      </table>

      <div class="control-group">
        <label class="control-label">${form.sales_segment_id.label.text}</label>
        <div class="controls">
          % for id, name in form.sales_segment_id.choices:
            % if id == form.sales_segment_id.data:
              ${name}
            % endif
          % endfor
        </div>
      </div>
      <div class="control-group">
        <label class="control-label">${form.payment_delivery_method_pair_id.label.text}</label>
        <div class="controls">
          % for id, name in form.payment_delivery_method_pair_id.choices:
            % if id == form.payment_delivery_method_pair_id.data:
              ${name}
            % endif
          % endfor
        </div>
      </div>
      % if form.payment_delivery_method_pair_id.data in form.payment_delivery_method_pair_id.sej_plugin_id:
      <div class="shipping-address">
        <div class="control-group">
          <label class="control-label">氏名</label>
          <div class="controls">
            ${form.last_name.data}
            ${form.first_name.data}
          </div>
        </div>
        <div class="control-group">
          <label class="control-label">氏名(カナ)</label>
          <div class="controls">
            ${form.last_name_kana.data}
            ${form.first_name_kana.data}
          </div>
        </div>
        <div class="control-group">
          <label class="control-label">TEL</label>
          <div class="controls">
            ${form.tel_1.data}
          </div>
        </div>
      </div>
      % endif

      ${h.form_item(form.sales_counter_payment_method_id)}
      ${h.form_item(form.note, rows=3, class_='span10')}
      ${h.form_item(form.performance_id)}
    </form>
  </div>

  <div class="modal-footer">
    <button onclick="javascript:reselectOrder(); return false;" class="btn secondary btn-close">戻る</button>
    <button onclick="$('#modal-reserve').find('form').submit(); return false;" class="btn danger" id="reserve-button">予約する</button>
  </div>
</div>
