<%page args="order, sort=None" />
<%namespace file="/common/helpers.html" name="h" />
<%namespace file="/common/modal.html" name="m" />

<script type="text/javascript">
  function cancel_order(id) {
    modal = $('#modal-delete');
    modal.find('#delete').attr('href', '/orders/cancel/' + id);
    message = '選択した予約をキャンセルします。よろしいですか？';
    % if order.printed_at or order.issued_at or order.issued:
      message += '<br><div class="alert alert-error">この予約は既に発券済み(または発券予約中)です。</div>'
    % endif
    modal.find('#message').html('<p>' + message + '</p>');
    modal.modal('toggle');
  }
  function edit_shipping_address() {
    var modal = $('#modal-edit-shipping_address');
    modal.modal('toggle');
  }
  function save_shipping_address() {
    var modal = '#modal-edit-shipping_address';
    var form = '#shipping_address-form';
    var url = '${request.route_path('orders.edit.shipping_address', order_id=order.id)}';
    post_modal_form(modal, form, url);
  }
  function edit_product() {
    var modal = $('#modal-edit-product');
    modal.modal('toggle');
  }
  function save_product() {
    var modal = '#modal-edit-product';
    var form = '#product-form';
    var url = '${request.route_path('orders.edit.product', order_id=order.id)}';
    post_modal_form(modal, form, url);
  }
  function save_note() {
    var param = {};
    var form = $('#note-form');
    form.find('.message').empty();
    $(form.find('form').serializeArray()).each(function(i, v) {
      param[v.name] = v.value;
    });
    $.ajax({
      type: 'post',
      url: '${request.route_path('orders.note', order_id=order.id)}',
      contentType: 'application/json; charset=utf-8',
      dataType: 'json',
      data: JSON.stringify(param),
      success: function(result) {
        form.find('.message').append('メモを保存しました');
      },
      error: function(xhr, text) {
        var responseText = JSON.parse(xhr.responseText);
        var messages = responseText['message'] || xhr.statusText
        var errors = '';
        if (typeof messages == 'string') {
          errors += '<li>' + messages + '</li>';
        } else {
          for (i in messages)
            errors += '<li>' + messages[i] + '</li>';
        }
        form.find('.message').append('<ul>' + errors + '</ul>');
      }
    });
  }
</script>

<%
actions = {
  'mailinfo':dict(
    label=u"メール",
    url=request.route_path('orders.mailinfo', order_id=order.id, action="show"),
    icon='icon-envelope',
    route_name='orders.mailinfo',
  ),
  'delivered':dict(
    label=u'配送済みにする',
    url=request.route_path('orders.delivered', order_id=order.id),
    icon='icon-ok',
    route_name='orders.delivered',
  ),
  'print':dict(
    label=u'発券する',
    url=request.route_path("orders.print.queue", order_id=order.id),
    attrs={
        "data-toggle": "modal",
        "data-target": "#PrintQueueModal",
        "class": "ajax-modal btn"
        },
    icon='icon-print',
    route_name='orders.print.queue',
  ),
  'force_print':dict(
    label=u'強制発券する',
    url=request.route_path("orders.print.queue", order_id=order.id),
    attrs={
        "data-toggle": "modal",
        "data-target": "#PrintQueueModal",
        "class": "ajax-modal btn"
        },
    icon='icon-print',
    route_name='orders.print.queue',
  ),
  'cancel':dict(
    label=u'キャンセル',
    url='javascript:cancel_order(%d);' % order.id,
    icon='icon-remove',
    attrs={ 'class': 'btn-danger' },
    route_name='orders.cancel',
  ),
  'edit_shipping_address':dict(
    label=u'編集',
    url='javascript:edit_shipping_address(%d);' % order.id,
    icon='icon-edit',
    route_name='orders.edit.shipping_address',
  ),
  'edit_product':dict(
    label=u'編集',
    url='javascript:edit_product(%d);' % order.id,
    icon='icon-edit',
    route_name='orders.edit.product',
  ),
  'note':dict(
    label=u'メモを保存',
    url='javascript:save_note(%d);' % order.id,
    icon='icon-pencil',
    route_name='orders.note',
  ),
}
sort = sort or ['mailinfo', 'delivered','cancel']

if 'mailinfo' in sort:
  if not order.shipping_address:
    sort.remove('mailinfo')
if 'cancel' in sort:
  if not order.can_cancel():
    sort.remove('cancel')
if 'delivered' in sort:
  if not order.can_cancel():
    sort.remove('delivered')
if 'print' in sort:
  if order.is_canceled():
    sort.remove('print')
  elif order.issued_at or order.queued:
    sort.remove('print')
    sort.append('force_print')
if sort:
  sort = iter(sort)
%>
${h.action_button(actions, sort, vertical=False)}

${m.delete_modal(label_delete=u'注文をキャンセルする (取消不可)', label_cancel=u'戻る')}
