<%inherit file="/layout_2cols.html" />
<%namespace file="/common/helpers.html" name="h" />

<%block name="javascript">
<script type="text/javascript" src="/static/js/fashion.js"></script>
<![if !(lt IE 9)]>
<script type="text/javascript" src="/static/js/fashion.svg.js"></script>
<![endif]>
<!--[if (lt IE 9)]> 
<script type="text/javascript" src="/static/js/fashion.vml.js"></script>
<![endif]-->
<script type="text/javascript" src="/static/js/ticketing.ticket-viewer.js"></script>
</%block>

<div class="breadcrumbs">
${h.breadcrumbs(
  names=[u'トップ', u'購入情報', order.performance.name, order.order_no],
  urls=[
    request.route_path('index'),
    request.route_path('orders.index'),
    request.route_path('performances.show', performance_id=order.performance_id) + '/order'
  ]
)}
</div>
<div class="page-header">
  <h1>購入情報</h1>
</div>

<div class="content">
  ${h.flash_messages(request)}
</div>

<div class="row-fluid">
  <div class="span6">
    <div class="page-header">
      <h3>予約情報</h3>
    </div>

    <table class="table table-striped table-bordered">
      <tr>
        <th class="span2">予約番号</th>
        <td class="span3">${order.order_no}</td>
      </tr>
      <tr>
        <th>ステータス</th>
        <td>
          % if order.status == 'refunded':
          <span class="label label-important">キャンセル (返金済)</span>
          % elif order.status == 'canceled':
          <span class="label label-important">キャンセル</span>
          % elif order.status == 'delivered':
          <span class="label label-success">配送済み</span>
          % elif order.status == 'paid':
          <span class="label label-warning">入金済み</span>
          % else:
          <span class="label label-inverse">未入金</span>
          % endif
        </td>
      </tr>
      <tr>
        <th>予約日時</th>
        <td>${h.safe_strftime(order.created_at)}</td>
      </tr>
      <tr>
        <th>決済日時</th>
        <td>
          % if order.paid_at:
            ${h.safe_strftime(order.paid_at)}
          % else:
            <span class="label label-inverse">未入金</span>
          % endif
        </td>
      </tr>
      <tr>
        <th>最終発券 (印字) 日時</th>
        <td>
          % if order.issued_at:
            ${h.safe_strftime(order.issued_at)}
          % else:
            -
          % endif
        </td>
      </tr>
      <tr>
        <th>発券済みフラグ</th>
        <td>
          % if order.issued:
            発券済み
            (<a href="#" data-toggle="modal" data-target="#ForceMarkUnissued">強制的に未発券に戻す</a>)
          % else:
            未発券
            (<a href="#" data-toggle="modal" data-target="#ForceMarkIssued">強制的に発券済にする</a>)
          % endif
        </td>
      </tr>
      <tr>
        <th>配送日時</th>
        <td>
          % if order.delivered_at:
            ${h.safe_strftime(order.delivered_at)}
          % else:
            <span class="label label-inverse">未配送</span>
          % endif
        </td>
      </tr>
      % if order.status == 'canceled':
      <tr>
        <th>キャンセル日時</th>
        <td>${h.safe_strftime(order.canceled_at)}</td>
      </tr>
      % endif
    </table>
    <div class="pull-right">
      <%
buttons = []
buttons.append('delivered')
buttons.append('mailinfo')
if not order.issued and not order.queued:
  buttons.append('print')
buttons.append('cancel')
%>
      <%include file="/orders/_action_button.html" args="order=order, sort=buttons" />
    </div>
  </div>

  <div class="span6">
    <div class="page-header">
      <h3>ユーザー情報</h3>
    </div>

    <% user = order.user %>
    <table class="table table-striped table-bordered">
      <tr>
        <th>ユーザーID</th>
        <td>
          % if user:
            ${user.id}
          % endif
        </td>
      </tr>
      <tr>
        <th>会員種別</th>
        <td>
          % if user and user.user_credential:
            ${user.user_credential[0].membership.name}
          % endif
        </td>
      </tr>
      <tr>
        <th>会員区分</th>
        <td>
          % if user and user.member:
            ${user.member.membergroup.name}
          % endif
        </td>
      </tr>
      <tr>
        <th>会員番号</th>
        <td>
          % if user and user.user_credential:
            ${user.user_credential[0].auth_identifier}
          % endif
        </td>
      </tr>
      <tr>
        <th class="span2">氏名</th>
        <td class="span3">
          % if user and user.user_profile:
            <% up = user.user_profile %>
            ${up.last_name} ${up.first_name} (${up.last_name_kana} ${up.first_name_kana})
          % endif
        </td>
      </tr>
      <tr>
        <th>ニックネーム</th>
        <td>
          % if user and user.user_profile:
            ${user.user_profile.nick_name or ''}
          % endif
        </td>
      </tr>
      <tr>
        <th>メールアドレス</th>
        <td>
          % if user and user.user_profile:
            ${user.user_profile.email}
          % endif
        </td>
      </tr>
      <tr>
        <th>購読メールマガジン</th>
        <td>
          <ul>
          % for name in list(set(mail_magazines)):
            <li>${name}</li>
          % endfor
          </ul>
        </td>
      </tr>
    </table>
  </div>
</div>

<div class="row-fluid">
  <div class="span6">
    <div class="page-header">
      <h3>配送情報</h3>
    </div>

    <% sa = order.shipping_address %>
    <table class="table table-striped table-bordered">
      <tr>
        <th class="span2">配送方法</th>
        <td class="span3">${order.payment_delivery_pair.delivery_method.name}</td>
      </tr>
      <tr>
        <th>氏名</th>
        <td>
          % if sa:
            ${sa.last_name} ${sa.first_name}
            % if sa.last_name_kana or sa.first_name_kana:
              (${sa.last_name_kana} ${sa.first_name_kana})
            % endif
          % endif
        </td>
      </tr>
      <tr>
        <th>住所</th>
        <td>
          % if sa:
            ${sa.zip} ${sa.country or ''} ${sa.prefecture} ${sa.city} ${sa.address_1} ${sa.address_2}
          % endif
        </td>
      </tr>
      <tr>
        <th>Tel</th>
        <td>
          % if sa:
            ${sa.tel_1}
          % endif
        </td>
      </tr>
      <tr>
        <th>メールアドレス</th>
        <td>
          % if sa:
            ${sa.email or ''}
          % endif
        </td>
      </tr>
    </table>
    <div class="pull-right">
      <%include file="/orders/_action_button.html" args="order=order, sort=['edit_shipping_address']" />
    </div>
    <div id="shipping_address-form">
      <%include file="/orders/_form_shipping_address.html" args="form=form_shipping_address" />
    </div>
  </div>

  <div class="span6">
    <div class="page-header">
      <h3>決済情報</h3>
    </div>

    <table class="table table-striped table-bordered">
      <tr>
        <th class="span2">決済方法</th>
        <td class="span3">${order.payment_delivery_pair.payment_method.name}</td>
      </tr>
      % if order.multicheckout_approval_no:
      <tr>
        <th>マルチ決済受領番号</th>
        <td>${order.multicheckout_approval_no}</td>
      </tr>
      % endif
    </table>
  </div>
</div>

<div class="row-fluid">
  <div class="span12">
    <div class="page-header">
      <h3>商品</h3>
    </div>

    % for i, ordered_product in enumerate(order.ordered_products):
      % if i == 0:
        <% performance = order.performance %>
        <table class="table table-striped table-bordered">
          <tr>
            <th class="span2">イベント</th>
            <td class="span6">${performance.event.title}</td>
          </tr>
          <tr>
            <th>公演名</th>
            <td>${performance.name}</td>
          </tr>
          <tr>
            <th>公演コード</th>
            <td>${performance.code}</td>
          </tr>
          <tr>
            <th>開演日時</th>
            <td>${performance.start_on or ''}</td>
          </tr>
          <tr>
            <th>会場</th>
            <td>${performance.venue.name}</td>
          </tr>
        </table>

        <p>※このアイコン<i class="icon-eye-open"></i>をクリックすると券面のプレビューができます</p>
        <table class="table table-striped table-bordered">
          <tr>
            <th colspan="2" class="span6">商品</th>
            <th class="span2">発券ステータス</th>
            <th class="span1">単価</th>
            <th class="span1">個数</th>
            <th class="span2">小計</th>
          </tr>
      % endif
          <tr>
            <td colspan="2">${ordered_product.product.name}</td>
            <td></td>
            <td style="text-align: right;">${h.price_format(ordered_product.price)}円</td>
            <td >${ordered_product.quantity}</td>
            <td style="text-align: right;">
              ${h.price_format(ordered_product.price * ordered_product.quantity)}円
            </td>
          </tr>
      % for i, ordered_product_item in enumerate(ordered_product.ordered_product_items):
          <tr>
            <td class="span2" style="text-align: right;">
              <span class="label label-info">${ordered_product_item.product_item.stock.stock_holder.name}</span>
            </td>
            <% attr = ordered_product_item.attributes.get('t_shirts_size') or '' %>
            <td class="span4">
              <a href="${request.route_path("orders.item.preview", order_id=order.id, item_id=ordered_product_item.id)}"
              data-toggle="modal" data-target="#PreviewModal"
              class="ajax-modal"
              >${ordered_product_item.product_item.stock_type.name} ${attr}<i class="icon-eye-open"></i></a>
              % if ordered_product_item.seats:
                <ul>
                % for seat in ordered_product_item.seats:
                  <li>${seat.name}</li>
                % endfor
                </ul>
              % endif
            </td>
            <td>
              %if ordered_product_item.issued_at:
                ${ordered_product_item.issued_at}
                <span alt="${ordered_product_item.issued_at}" class="label label-warning">済</span>
              %else:
                ${u"%(issued)s/%(total)s" % ordered_product_item.issued_at_status}
                <span class="label label-inverse">未発券</span>
              %endif
            </td>
            <td style="text-align: right;">${h.price_format(ordered_product_item.price)}円</td>
            <% quantity = len(ordered_product_item.seats) if ordered_product_item.seats else ordered_product.quantity %>
            <td>${quantity}</td>
            <td></td>
          </tr>
      % endfor
    % else:
          <tr>
            <td colspan="2">決済手数料</td>
            <td></td>
            <td></td>
            <td></td>
            <td style="text-align: right;">${h.price_format(order.transaction_fee)}円</td>
          </tr>
          <tr>
            <td colspan="2">配送手数料</td>
            <td></td>
            <td></td>
            <td></td>
            <td style="text-align: right;">${h.price_format(order.delivery_fee)}円</td>
          </tr>
          <tr>
            <td colspan="2">システム利用料</td>
            <td></td>
            <td></td>
            <td></td>
            <td style="text-align: right;">${h.price_format(order.system_fee)}円</td>
          </tr>
          <tr>
            <td colspan="2" class="span2"><strong>合計</strong></td>
            <td></td>
            <td></td>
            <td></td>
            <td style="text-align: right;"><strong>${h.price_format(order.total_amount)}円</strong></td>
          </tr>
        </table>
    % endfor
    <div class="pull-right">
      <%include file="/orders/_action_button.html" args="order=order, sort=['edit_product']" />
    </div>
    <div id="product-form">
      <%include file="/orders/_form_product.html" args="form=form_order, order=order" />
    </div>
  </div>
</div>

<% row = 0 %>
% for key, value in order.attributes.items():
  % if row == 0:
  <div class="row-fluid">
    <div class="span6">
      <table class="table table-striped table-bordered">
  % endif
        <tr>
          <%
            label = ''
            if key == 'sales_counter_payment_method_id':
              label = u'当日窓口決済'
              for (id, name) in form_order_reserve.sales_counter_payment_method_id.choices:
                if id == int(value):
                  value = name
                  break
          %>
          <th class="span3">${label}</th>
          <td class="span2">${value}</td>
        </tr>
        <% row += 1 %>
% else:
  % if row > 0:
      </table>
    </div>
  </div>
  % endif
% endfor

<% row = 0 %>
% for ordered_product in order.ordered_products:
  % for ordered_product_item in ordered_product.ordered_product_items:
    % for key, value in ordered_product_item.attributes.items():
      % if value and key in ['t_shirts_size', 'publicity', 'mail_permission', 'cont']:
        % if row == 0:
<div class="row-fluid">
  <div class="span6">
    <table class="table table-striped table-bordered">
        % endif
      <tr>
        <%
          label = ''
          if key == 't_shirts_size':
            label = u'Tシャツサイズ'
          elif key == 'publicity':
            label = u'メモリアルブックへの氏名掲載希望'
          elif key == 'mail_permission':
            label = u'メールマガジン配信'
            value = 'no' if value in ('no', 'n', '0', None) else 'yes'
          elif key == 'cont':
            label = u'新規/継続'
            value = u'新規' if value == 'no' else u'継続'
        %>
        <th class="span3">${label} (${key})</th>
        <td class="span2">${value}</td>
      </tr>
        <% row += 1 %>
      % endif
    % endfor
  % else:
    % if row > 0:
    </table>
  </div>
</div>
    % endif
  % endfor
% endfor


<div class="modal hide" id="PreviewModal">
</div>
<div class="modal hide" id="PrintQueueModal">
</div>
<div class="modal hide" id="ForceMarkIssued">
  <div class="modal-body">
    この注文を強制的に発券済に設定します。よろしいですか?
  </div>
  <form method="post" action="${request.route_path('orders.issue_status', order_id=order.id)}" style="margin: 0">
    <input type="hidden" name="issued" value="1" />
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal">キャンセル</button>
      <button class="btn btn-warning">設定する</a>
    </div>
  </form>
</div>
<div class="modal hide" id="ForceMarkUnissued">
  <div class="modal-body">
    この注文を強制的に未発券状態に設定します。よろしいですか?
  </div>
  <form method="post" action="${request.route_path('orders.issue_status', order_id=order.id)}" style="margin: 0">
    <input type="hidden" name="issued" value="0" />
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal">キャンセル</button>
      <button class="btn btn-warning">設定する</a>
    </div>
  </form>
</div>

<script type="text/javascript">
  $(function(){
## for preview modal
    // ajax modal
	$("a.ajax-modal[data-toggle=modal]").click(function(){
      $($(this).attr("data-target")).load($(this).attr("href"));
	});
  });
</script>

<div class="row-fluid">
  <div id="note-form" class="span6 well" style="padding-left: 10px;">
    <form style="margin: 0;">
      <textarea id="note" name="note" rows="3" style="width:100%;">${order.note or ''}</textarea>
    </form>
    <div class="message pull-left"></div>
    <div class="pull-right">
      <%include file="/orders/_action_button.html" args="order=order, sort=['note']" />
    </div>
  </div>
</div>
