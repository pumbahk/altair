<%inherit file="/layout_2cols.html" />
<%namespace file="/common/helpers.html" name="h" />

<div class="breadcrumbs">
${h.breadcrumbs(
  names=[u'トップ', u'購入情報', order.order_no],
  urls=[request.route_path('index'), request.route_path('orders.index')]
)}
</div>
<div class="page-header">
  <h1>購入情報</h1>
</div>

<div class="content">
  ${h.flash_messages(request)}
</div>

<div class="row-fluid">

  <div class="span6">
    <div class="page-header">
      <h3>受注情報</h3>
    </div>

    <table class="table table-striped table-bordered">
      <tr>
        <th class="span2">受注番号</th>
        <td class="span3">${order.order_no}</td>
      </tr>
      <tr>
        <th>ステータス</th>
        <td>
          % if order.status == 'canceled':
          <span class="label label-important">キャンセル</span>
          % elif order.status == 'delivered':
          <span class="label label-success">配送済み</span>
          % elif order.status == 'paid':
          <span class="label label-warning">入金済み</span>
          % else:
          <span class="label label-inverse">未入金</span>
          % endif
        </td>
      </tr>
      <tr>
        <th>受注日時</th>
        <td>${h.safe_strftime(order.created_at)}</td>
      </tr>
      <tr>
        <th>決済日時</th>
        <td>
          % if order.paid_at:
            ${h.safe_strftime(order.paid_at)}
          % else:
            <span class="label label-inverse">未入金</span>
          % endif
        </td>
      </tr>
      <tr>
        <th>配送日時</th>
        <td>
          % if order.delivered_at:
            ${h.safe_strftime(order.delivered_at)}
          % else:
            <span class="label label-inverse">未配送</span>
          % endif
        </td>
      </tr>
      % if order.status == 'canceled':
      <tr>
        <th>キャンセル日時</th>
        <td>${h.safe_strftime(order.canceled_at)}</td>
      </tr>
      % endif
    </table>
    <div class="pull-right">
      <%include file="/orders/_action_button.html" args="order=order" />
    </div>
  </div>

  <div class="span6">
    <div class="page-header">
      <h3>購入者</h3>
    </div>

    <table class="table table-striped table-bordered">
      <tr>
        <th>氏名</th>
        <% up = order.user.user_profile %>
        <td>${up.last_name} ${up.first_name} (${up.last_name_kana} ${up.first_name_kana})</td>
      </tr>
      <tr>
        <th>ニックネーム</th>
        <td>${order.user.user_profile.nick_name}</td>
      </tr>
      <tr>
        <th>メールアドレス</th>
        <td>${order.user.user_profile.email}</td>
      </tr>
    </table>
  </div>
</div>

<div class="row-fluid">
  <div class="span6">
    <div class="page-header">
      <h3>配送情報</h3>
    </div>

    <% sa = order.shipping_address %>
    <table class="table table-striped table-bordered">
      <tr>
        <th class="span2">配送方法</th>
        <td class="span3">${order.payment_delivery_pair.delivery_method.name}</td>
      </tr>
      <tr>
        <th>氏名</th>
        <td>${sa.last_name} ${sa.first_name} (${sa.last_name_kana} ${sa.first_name_kana})</td>
      </tr>
      <tr>
        <th>住所</th>
        <td>${sa.zip} ${sa.country or ''} ${sa.prefecture} ${sa.city} ${sa.address_1} ${sa.address_2}</td>
      </tr>
      <tr>
        <th>Tel</th>
        <td>${sa.tel_1}</td>
      </tr>
      <tr>
        <th>Fax</th>
        <td>${sa.fax or ''}</td>
      </tr>
    </table>
  </div>

  <div class="span6">
    <div class="page-header">
      <h3>決済情報</h3>
    </div>

    <table class="table table-striped table-bordered">
      <tr>
        <th class="span2">決済方法</th>
        <td class="span3">${order.payment_delivery_pair.payment_method.name}</td>
      </tr>
      % if order.multicheckout_approval_no:
      <tr>
        <th>マルチ決済受領番号</th>
        <td>${order.multicheckout_approval_no}</td>
      </tr>
      % endif
    </table>
  </div>
</div>

<div class="row-fluid">
  <div class="span12">
    <div class="page-header">
      <h3>商品</h3>
    </div>

    % for i, ordered_product in enumerate(order.ordered_products):
      % if i == 0:
        <table class="table table-striped table-bordered">
          <tr>
            <th class="span2">イベント</th>
            <td class="span6">${ordered_product.product.event.title}</td>
          </tr>
          <tr>
            <th>開始日時</th>
            <td>${ordered_product.ordered_product_items[0].product_item.performance.start_on}</td>
          </tr>
          <tr>
            <th>会場</th>
            <td>${ordered_product.ordered_product_items[0].product_item.performance.venue.name}</td>
          </tr>
        </table>

        <table class="table table-striped table-bordered">
          <tr>
            <th colspan="2" class="span8">商品名</th>
            <th class="span2">金額</th>
            <th class="span2">個数</th>
          </tr>
      % endif
          <tr>
            <td colspan="2">${ordered_product.product.name}</td>
            <td class="span2">${h.price_format(ordered_product.price)}円</td>
            <td class="span2">${h.price_format(ordered_product.quantity)}</td>
          </tr>
      % for i, ordered_product_item in enumerate(ordered_product.ordered_product_items):
          <tr>
            <td class="span4"></td>
            <td class="span4">${ordered_product_item.product_item.stock_type.name}</td>
            <td class="span2">${h.price_format(ordered_product_item.product_item.price)}円</td>
            <td class="span2">${h.price_format(ordered_product_item.product_item.quantity)}</td>
          </tr>
      % endfor
    % else:
          <tr>
            <td colspan="2" class="span2">決済手数料</td>
            <td colspan="2" class="span2">${h.price_format(order.transaction_fee)}円</td>
          </tr>
          <tr>
            <td colspan="2" class="span2">配送手数料</td>
            <td colspan="2" class="span2">${h.price_format(order.delivery_fee)}円</td>
          </tr>
          <tr>
            <td colspan="2" class="span2">システム利用料</td>
            <td colspan="2" class="span2">${h.price_format(order.system_fee)}円</td>
          </tr>
          <tr>
            <td colspan="2" class="span2"><strong>合計</strong></td>
            <td colspan="2" class="span2"><strong>${h.price_format(order.total_amount)}円</strong></td>
          </tr>
        </table>
    % endfor
  </div>
</div>
