<%namespace file="/common/helpers.html" import="form_item"/>

  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>preview</h3>
  </div>

  <div class="modal-body">
	<form id="preview_select">
	  ${form.ticket_format_id.label} ${form.ticket_format_id}
	  ${form.item_id}
	</form>

	<div id="drawing" style="height:200px;">
	</div>
  </div>

<script type="text/javascript" src="${request.static_url("ticketing:static/js/spin.js")}"></script>
<script type="text/javascript" src="${request.static_url("ticketing:static/js/altair/spinner.js")}"></script>
<script type="text/javascript" src="${request.static_url("ticketing:static/js/tickets/preview/preview_api.js")}"></script>
<script type="text/javascript">
$(function(){
  var cont = null;

  var url = "${request.route_path("orders.item.preview.getdata", item_id=item.id, ticket_format_id="__id__")}";
  var MAX_SIZE_OF_PREVIEW_ITEM = 2;

  var renderPreviewImage = function(results, names, start, end, root){
    for(var i = start; i < end; i++){
      var jsondata = results[i];
      root.append($("<h3>").text(names[i]));
      var wrap = $("<div>").attr("id", "diagram:"+i);
      root.append(wrap);
      svg_preview(wrap,
            "${request.route_path("tickets.preview.api", action="preview.base64")}", 
            {svg: jsondata["drawing"], ticket_format: jsondata["ticket_format_id"], type: jsondata["preview_type"]});
    }
  };

  var draw_viewer = function(url, ticket_format_id){
    $.getJSON(url.replace("__id__", ticket_format_id)).done(function(data){ 
      var root = $("#drawing");
      root.empty();
      var results = data.results;
      var names = data.names;

      var N = MAX_SIZE_OF_PREVIEW_ITEM;
      if(results.length <= N){
        renderPreviewImage(results, names, 0, results.length, root);
      }else{
        renderPreviewImage(results, names, 0, N, root);

        cont = function(){ 
          renderPreviewImage(results, names, N, results.length, root); 
        };
        var btn = $("<a>").text("続きをpreview ({0}/{1})".replace("{0}", String(N)).replace("{1}", String(results.length)));
        btn.click(function(){ 
          if(!!cont){
            cont();
          }
          cont = null; 
        });
        root.append(btn);
      }
    });
  };

  draw_viewer(url, $("#preview_select select[name='ticket_format_id']").val());
  $("#preview_select select[name='ticket_format_id']").change(function(){
    var ticket_format_id = $(this).val();
    draw_viewer(url, ticket_format_id);
  });
});
</script>
