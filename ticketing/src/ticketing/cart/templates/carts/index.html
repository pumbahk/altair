<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>チケット販売・イベントの予約 [音楽 / コンサート / 舞台 / スポーツ] - 楽天チケット</title>
<meta name="description" content="チケットの販売、イベントの予約は楽天チケットで！楽天チケットは演劇、バレエ、ミュージカルなどの舞台、クラシック、オペラ、ロックなどのコンサート、野球、サッカー、格闘技などのスポーツ、その他イベントなどのチケットのオンラインショッピングサイトです。" />
<meta name="keywords" content="チケット,演劇,クラシック,オペラ,コンサート,バレエ,ミュージカル,野球,サッカー,格闘技" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="content-script-type" content="text/javascript" />
<link rel="shortcut icon" href="${request.static_url('ticketing.cart:static/img/common/favicon.ico')}" />

<link rel="stylesheet" href="${request.static_url('ticketing.cart:static/css/import.css')}" type="text/css" media="all" />
<link rel="stylesheet" href="${request.static_url('ticketing.cart:static/css/custom.css')}" type="text/css" media="all" />

<script type="text/javascript" src="${request.static_url('ticketing.cart:static/js/fashion.js')}"></script>
<![if !(lt IE 9)]>
<script type="text/javascript" src="${request.static_url('ticketing.cart:static/js/fashion.svg.js')}" charset="utf-8"></script>
<![endif]>
<!--[if (lt IE 9)]>
<script type="text/javascript" src="${request.static_url('ticketing.cart:static/js/fashion.vml.js')}" charset="utf-8"></script>
<![endif]-->
<script type="text/javascript" src="${request.static_url('ticketing.cart:static/js/carts.js')}"></script>
<script type="text/javascript" src="${request.static_url('ticketing.cart:static/js/venue-viewer.js')}"></script>

<style type="text/css">
.modal {
	font-size: 150%;
}
</style>
<script type="text/javascript">
var selected = ${selected};
var venues_selection = ${venues_selection};
var upper_limit = ${upper_limit};
var order_url = "${order_url}";
var products_from_selected_date_url = "${products_from_selected_date_url}";
var cart_release_url = "${cart_release_url}";
var currentViewer = null;

function newMetadataLoaderFactory(url) {
  var conts = [], allData = null, first = true;
  return function createMetadataLoader(fetch) {
    return function metadataLoader(next, error) {
      conts.push({ fetch: fetch, next: next, error: error });
      if (first) {
        $.ajax({
          url: url,
          dataType: 'json',
          success: function(data) {
            allData = data;
            var _conts = conts;
            conts = [];
            for (var i = 0; i < _conts.length; i++)
              _conts[i].next(_conts[i].fetch(data));
          },
          error: function(xhr, text) {
            var message = "Failed to load " + key + " (reason: " + text + ")";
            var _conts = conts;
            conts = [];
            for (var i = 0; i < _conts.length; i++)
              _conts[i].error(message);
          }
        });
        first = false;
        return;
      } else {
        if (allData)
          next(fetch(allData));
      }
    };
  };
}

function createDataSource(params) {
  var factory = newMetadataLoaderFactory(params.data_source.seats);
  return {
    drawing: function (next, error) {
      $.ajax({
        url: params.data_source.venue_drawing,
        dataType: 'xml',
        success: function (data) { next(data); },
        error: function (xhr, text) {
          error("Failed to load drawing data (" + text + ")");
        }
      });
    },
    stockTypes: function (next, error) {
      var stock_types = {};
      for (var i = params.seat_types.length; --i >= 0;)
        stock_types[params.seat_types[i].id] = params.seat_types[i];
      next(stock_types);
    },
    info: factory(function (data) { return data['info']; }),
    seats: factory(function (data) { return data['seats']; }),
    areas: factory(function (data) { return data['areas']; }),
    seat_adjacencies: function (next, error, length) {
      var _params = $.extend(params, { length_or_range: length });
      $.ajax({
        url: util.build_route_path(params.data_source.seat_adjacencies._params),
        dataType: 'json',
        success: function (data) { next(data); },
        error: function (xhr, text) {
          error("Failed to load adjacency data (" + text + ")");
        }
      });
    },
    stock_types: function (next, error) {
      continuations.stock_types_loaded.continuation(next, error);
    }
  };
}

function get_current_quantity() {
  var num = 0;
  $.each($('#order-form select'), function(_,quantity) {num+=Number($(quantity).val())})
  return num;
}

$(function() {
  var currentStockTypeId = "";

  carts.init(venues_selection, selected, upper_limit, cart_release_url, {
    seat_type_selected: function (seat_type) {
      currentStockTypeId = seat_type.id;
      currentViewer && currentViewer.venueviewer('refresh');
    },
    seat_types_loaded: function (data) {
      if (currentViewer) {
        currentViewer
          .venueviewer({
            dataSource: createDataSource(data),
            callbacks: {
              selectable: function (viewer, seat) {
                if (currentStockTypeId == "")
                  return true;
                return seat.meta.stock_type_id == currentStockTypeId && seat.meta.status == 1;
              },
              click: function (viewer, seat, highlighted) {
                $.each(highlighted, function (id, seat) {
                  if (carts.appView.left_box.hasClass('focused')) {
                    carts.appView.select_seat_type(seat.type.id);
                  } else {
                    if (seat.selected()) {
                      seat.selected(false);
                    } else {
                      if (viewer.selectionCount < get_current_quantity()) {
                        seat.selected(true);
                      }
                    }
                  }
                });
              },
              select: function (viewer, selection) {
                $.each(selection, function (i, seat) {
                  console.log(seat);
                });
              }
            }
          })
          .venueviewer('load');
      }
    }
  });
})
</script>
</head>
<body id="settlement">
<p id="naviSkip"><a href="#main" tabindex="1" title="本文へジャンプ"><img src="${request.static_url('ticketing.cart:static/img/common/skip.gif')}" alt="本文へジャンプ" width="1" height="1" /></a></p>

<div id="container">

	<!-- ========== header ========== -->
	<div id="grpheader">
		<p id="siteID">
      <a href="http://www.rakuten.co.jp/"><img src="${request.static_url('ticketing.cart:static/img/common/header_logo_01.gif')}" alt="楽天チケット" class="serviceLogo" width="97" height="35" /></a>
      <a href="/"><img src="${request.static_url('ticketing.cart:static/img/common/header_logo_02.gif')}" alt="チケット" class="serviceTitle" width="88" height="23" /></a>
    </p>
	</div>
	<!-- ========== /header ========== -->
	
	<hr />

	<!-- ========== main ========== -->
	<div id="main">
		<h1><img src="${request.static_url('ticketing.cart:static/img/settlement/title_settlement.gif')}" alt="チケット購入" width="950" height="40" /></h1>
				${h.get_nickname(request)} さん
		<h2 id="ticketName">${event['title']}</h2>
		<ul id="ticketIcon">
			<li><img src="${request.static_url('ticketing.cart:static/img/detail/icon_select.gif')}" alt="座席選択可" width="80" height="30" /></li>
			<li><img src="${request.static_url('ticketing.cart:static/img/detail/icon_keep.gif')}" alt="おとなりキープ" width="80" height="30" /></li>
			<li><img src="${request.static_url('ticketing.cart:static/img/detail/icon_official.gif')}" alt="公式2次市場" width="80" height="30" /></li>
			<li><img src="${request.static_url('ticketing.cart:static/img/detail/icon_goods.gif')}" alt="先行グッズ予約" width="80" height="30" /></li>
			<li><img src="${request.static_url('ticketing.cart:static/img/detail/icon_event.gif')}" alt="イベントコミュニティ" width="80" height="30" /></li>
		</ul>
		<form id="form1" name="form1" method="post" action="">
			<div id="settlementSelectBox">
				<div id="settlementSelectBoxInner">
					<table summary="チケット購入の絞り込み">
						<tr>
							<th>日程</th>
							<td>
								<select name="select" id="date-select">
								%for d in dates:
									<option>${d}</option>
								%endfor
								</select>
							</td>
						</tr>
						<tr id="settlementSelectEnd">
							<th>会場</th>
							<td><select name="select2" id="venue-select">
								<option>○○○○</option>
							</select></td>
						</tr>
					</table>
				</div>
			</div>
		</form>
		<div id="settlementOperation" class="settlementBox2">
			<div class="settlementBoxInner2">
				<h2 id="hallName">
					<span id="performanceDate">12月3日 14:00</span>
					<span id="performanceVenue">幕張メッセイベントホール</span>
				</h2>
				<div class="settlementOperationPaneInner">
          <div class="settlementOperationPaneInnerContent">
            <div id="selectSeatType" class="focused">
              <h3 class="lead">席種をお選びください</h3>
              <div class="seatListContainer main">
                <ul id="seatTypeList">
                </ul>
              </div>
              <script type="text/javascript">
                (function () {
                  var selectSeatType = $('#selectSeatType');
                  var ul = selectSeatType.find('.seatListContainer ul');
                  var selected = ul.find("li.selected");
                  var ulTopOffset = ul.parent()[0].offsetTop;
                  var arrow = null, arrowAbsPos = null;
                  function updateArrowPos() {
                    if (arrow) {
                      var scrollY = ul.parent().scrollTop();
                      arrow.css({
                        right: "0px",
                        top: arrowAbsPos - scrollY + "px"
                      });
                    }
                  }
                  ul.parent().scroll(updateArrowPos);
                  function select(it) {
                    if (!selectSeatType.hasClass('focused'))
                      return;
                    if (!it) {
                      if (selected)
                        selected.removeClass('selected');
                      if (arrow)
                        arrow.remove();
                      selected = arrow = null;
                      return;
                    }
                    if (!it.hasClass('selected')) {
                      selected.removeClass('selected');
                      it.addClass('selected');
                      selected = it;
                      arrowAbsPos = it[0].offsetTop + ulTopOffset;
                      if (!arrow) {
                        arrow = $('<div></div>')
                          .addClass("arrow")
                          .appendTo(selectSeatType);
                      }
                      updateArrowPos();
                    }
                    var radio = it.find(':radio');
                    if (radio.length) {
                      radio[0].checked = true;
                      radio.change();
                    }
                  }
                  ul.delegate('li', 'click', function () {
                    select($(this));
                  });
                  ul.find("li:even").addClass("seatEven");
                  ul.find("li:odd").addClass("seatOdd");
                })();
              </script>
            </div>
            <div id="selectSeat" class="blur">
              <div class="selectSeatLeftPane">
                <div class="venueViewer">???</div>
                <script type="text/javascript">
                  currentViewer = $('#selectSeat .venueViewer');
                </script>
                <div>
                  <ul class="buttonSet">
                    <li><a href="javascript:void(0);" id="btn-selected-order"><img src="${request.static_url('ticketing.cart:static/img/settlement/btn_buy.shrunken.gif')}" alt="購入" /></a></li>
                  </ul>

                </div>
              </div>
              <div id="selectProduct" class="selectSeatRightPane">
                <h3 class="lead">購入枚数、購入方法をお選びください</h3>
                <form id="order-form" name="form2" method="post" action="" class="main">
                  <input type="hidden" name="performance_id" id="current-performance-id"/>
                  <dl>
                    <dt id="payment-seat-type"></dt>
                    <dd>
                      <ul id="payment-seat-products" class="productList">
                      </ul>
                    </dd>
                  </dl>
                  <fieldset style="display:none;" id="selected-seats">
                  </fieldset>
                  <ul class="buttonSet">
                    <li><a href="#"><img src="${request.static_url('ticketing.cart:static/img/settlement/btn_select_buy.shrunken.gif')}" alt="座席を選んで購入" /></a></li>
                  </ul>
                  <ul class="buttonSet">
                    <li><a href="javascript:void(0);" id="btn-order"><img src="${request.static_url('ticketing.cart:static/img/settlement/btn_entrust_buy.gif')}" alt="おまかせで購入" width="150px" /></a></li>
                  </ul>
                </form>
              </div>
            </div>
          </div>
				</div>
			</div>
		</div>
		<div class="settlementBox2" id="settlementEventDetail" style="clear:both">
			<div class="settlementBoxInner2">
				<h2><img src="${request.static_url('ticketing.cart:static/img/settlement/title_event.gif')}" alt="イベント詳細" width="106" height="29" /></h2>
				<table summary="イベント詳細情報">
					<tbody>
						<tr>
							<th scope="row">開催日時</th>
							<td id="performance_date"></td>
						</tr>
						<tr>
							<th scope="row">会場</th>
							<td id="venue"> ${", ".join(event['venues'])}</td>
						</tr>
						<tr>
							<th scope="row">販売期間</th>
							<td>
								${event['sales_start_on']}
								${event['sales_end_on']}
							</td>
						</tr>
						<tr>
							<th scope="row">席種・料金（税込）</th>
							<td id="pricelist">
								%for p in event['product']:
								${p.name} ： ${h.format_number(p.price)}円 <br/>
								%endfor
							</td>
						</tr>
					%for v in event_extra_info:
						<tr>
							<th scope="row">${v['label']}</th>
							<td>${v['content']|n}</td>
						</tr>
					%endfor
					</tbody>
				</table>
			</div>
		</div>
	</div>
	<!-- ========== /main ========== -->
	
<!-- /container --></div>

<div class="modal payment" id="order-error-template" style="display:none">
	<div class="modal-header">
	<h1><span>在庫がありません</span></h1>
	</div>
	<div class="modal-inner">
	<div class="modal-body">
		<img src="${request.static_url('ticketing.cart:static/img/settlement/error.gif')}" width="624" height="224" />
	</div>
	<div class="modal-footer">
		<button class="close-button btn-redo"></button>
<!--
		<ul id="errorBtn">
				<li><a href="#"><img src="${request.static_url('ticketing.cart:static/img/settlement/btn_wait.gif')}" alt="空席待ち" width="206" height="46" /></a></li>
				<li><a href="#"><img src="${request.static_url('ticketing.cart:static/img/settlement/btn_reselect.gif')}" alt="座席・枚数を選びなおす" width="206" height="46" /></a></li>
				<li id="errorBtnTop"><a href="#">イベントトップに戻る</a></li>
		</ul>
-->
	</div>
	</div>
</div>

<div class="modal payment" style="display:none" id="order-reserved">
		<div class="modal-header">
            <h3><span id="performance-name"></span></h3>
            <h4><span id="performance-name-sub"></span></h4>
	</div>
		<div class="modal-inner">
	<div class="modal-body">

		<img src="${request.static_url('ticketing.cart:static/img/settlement/total.gif')}" alt="合計金額" width="67" height="16"
			 style="margin-bottom:7px;">
		<table>
		<tbody>
			<tr class="last-child">
			<td id="cart-total-amount">￥</td>
			</tr>
		</tbody>
		</table>

		<p class="lead" style="margin-bottom:4px;">内訳</p>
		<table>
		<tbody id="contentsOfShopping">
		</tbody>
		</table>
	</div>
	<div class="modal-footer">
		<button class="cancel-button btn-redo"></button>
		<button class="confirm-button btn-buy"></button>
	</div>
	</div>
</div>
</body>
</html>
