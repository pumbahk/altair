<%inherit file="${context['main_template'].uri}" />
<div id="main">
        <h1><img src="${request.static_url('ticketing.lots:static/img/order/title_settlement.gif')}" alt="チケット申込" width="950" height="40" /></h1>
        
        %if request.session.peek_flash():
		<div>
            <ul>
            %for message in request.session.pop_flash():
                <li>${message}</li>
            %endfor
            </ul>
        </div>
        %endif
		<div class="settlementBox2" id="settlementEventDetail">
			<div class="settlementBoxInner2">
                <h2><img src="${request.static_url('ticketing.lots:static/img/settlement/title_event.gif')}" alt="イベント詳細" width="106" height="29" /></h2>
				<table summary="イベント詳細情報">
					<tr>
						<th scope="row">イベント名</th>
                        <td>${event.title}</td>
				    </tr>
					<tr>
						<th scope="row">申込受付期間</th>
                        <td>${h.japanese_datetime(sales_segment.start_at)}～${h.japanese_datetime(sales_segment.end_at)}</td>
				    </tr>
                    %if sales_segment.upper_limit:
					<tr>
					  <th scope="row">制限枚数</th>
                      <td>1希望の申込で${sales_segment.upper_limit}枚まで</td>
				  </tr>
                    %endif
					<tr>
					  <th scope="row">申込回数制限</th>
                      <td>${u"{0} 回".format(lot.entry_limit) if lot.entry_limit else u"無制限"}</td>
				  </tr>
					<tr>
					  <th scope="row">受付希望数</th>
                      <td>一度の申込で第${lot.limit_wishes}希望まで</td>
				  </tr>
                  %if lot.description:
					<tr>
					  <th scope="row">注意事項</th>
                      <td>${lot.description}</td>
				  </tr>
                  %endif
				</table>
			</div>
		</div>
       <div class="settlementBox2" id="settlementEventDetail">
			<div class="settlementBoxInner2">
                <h2><img src="${request.static_url('ticketing.lots:static/img/order/title_public.gif')}" alt="公演一覧" width="106" height="29" /></h2>

                %for performance in lot.performances:
				<table class="border" summary="イベント詳細情報">
					<tr>
                        <th colspan="2" scope="row"><span>${performance.name}</span></th>
					</tr>
					<tr class="none">
						<th scope="row">公演日</th>
                        <td>${h.japanese_datetime(performance.open_on)}開演</td>
				    </tr>
					<tr>
						<th scope="row">会場</th>
                        <td>${performance.venue.name}</td>
				    </tr>                    
				</table>
                %endfor

			</div>
		</div>
        <form method="post" action="${request.url}">        
			<div class="settlementBox">
			  <div class="settlementBoxInner">

                  <h2 class="title"><img src="${request.static_url('ticketing.lots:static/img/order/title_hope.gif')}" alt="希望選択" width="97" height="30" /></h2>
                
                  %for i in range(lot.limit_wishes):
		  <div class="settlementSelectBox">
				<div class="settlementSelectBoxInner02">
                    <!-- <p><strong>第一希望</strong><span>ディズニーライブ東京公演</span></p> -->
                <table summary="チケット購入の絞り込み" id="wish-cell-table-${i}">
						<tr>
							<th><label>公演日・会場</label></th>
                            <td><select name="performance-${i}" data-wishOrder="${i}" data-wishCellTableId="wish-cell-table-${i}"class="performance-select">
                              %for performance in lot.performances:
                              <option value="${performance.id}">${h.japanese_datetime(performance.open_on)} ${performance.venue.name}</option>
                                %endfor
							</select></td>
						</tr>
                        %for j, product in enumerate(products):
						<tr id="settlementSelectEnd" class="product-select-tr">
							<th>
                                %if j == 0:
                                <label>席種券種</label>
                                %else:
                                &nbsp;
                                %endif;
                            </th>
                            <td>
                            　<select name="product-quantity-${i}-${j}" >
                                <option></option>
                                %for k in range(sales_segment.upper_limit):
                                <option value="${k + 1}">${k + 1}</option>
                                %endfor
						  </select>　枚</td>
						</tr>
                        %endfor
					</table>
				</div>
			</div>
            %endfor

                
			  </div>
			</div>          

			<div class="settlementBox">
				<div class="settlementBoxInner">
                    <h2><img src="${request.static_url('ticketing.lots:static/img/order/title_how.gif')}" alt="お支払・お引取り方法選択" width="208" height="30" /></h2>
                    %for m in payment_delivery_pairs:
					<div class="settlementPayBox">
						<div class="settlementPayBoxInner">
							<table>
								<tr>
                                    <% checked = 'checked' if str(m.id) == payment_delivery_method_pair_id else '' %>
                                    <td class="settlementPayRadio"><input type="radio" name="payment_delivery_method_pair_id" id="radio" value="${m.id}" ${checked} /></td>
									<td><dl class="left">
                                            <dt>${m.payment_method.name}　${h.format_currency(m.transaction_fee)} (${h.fee_type(m.payment_method.fee_type)})</dt>
                                            <dd>${m.payment_method.description or '' | n}<br />
                                        </dd>
									</dl>
                                    <dl class=" left">
                                        <dt>${m.delivery_method.name}　${h.format_currency(m.delivery_fee)} (${h.fee_type(m.delivery_method.fee_type)})</dt>
                                        <dd>${m.delivery_method.description or '' | n}</dd>
									</dl>
                                    
                                    </td>
							    </tr>
							</table>
						</div>
					</div>
                    %endfor
				</div>
			</div>


			<div class="settlementBox">
				<div class="settlementBoxInner">
                    <h2><img src="${request.static_url('ticketing.lots:static/img/order/title_buyer.gif')}" alt="購入者情報" width="97" height="30" /></h2>
				<div id="settlementSelectBox">
				<div id="settlementSelectBoxInner02">
			  <table summary="お支払・お引取り方法選択">
						<tr>
							<th><label>購入者氏名（全角）</label></th>
					  <td>                        ${form['last_name']}
                        ${form['first_name']}
                        ${self.error(form, 'last_name')}
                        ${self.error(form, 'first_name')}
                      </td>
						</tr>
						<tr>
							<th><label>購入者氏名（カナ）</label></th>
					  <td>
                        ${form['last_name_kana']}
                        ${form['first_name_kana']}
                        ${self.error(form, 'last_name_kana')}
                        ${self.error(form, 'first_name_kana')}
						</tr>
						<tr>
							<th><label>メールアドレス</label></th>
					  <td>
                        ${form['email_1']}
                        ${self.error(form, 'email_1')}
                      </td>
						</tr>
						<tr>
							<th><label>メールアドレス（確認）</label></th>
					  <td>
                        ${form['email_1_confirm']}
                        ${self.error(form, 'email_1_confirm')}
                      </td>
						</tr>
						<tr>
							<th><label>電話番号（自宅）</label></th>
					  <td>
                        ${form['tel_1']}
                        ${self.error(form, 'tel_1')}
                    </td>
						</tr>
						<tr>
							<th><label>電話番号（携帯電話）</label></th>
					  <td>
                        ${form['mobile_tel']}
                        ${self.error(form, 'mobile_tel')}
						</tr>
						<tr>
							<th><label>配送先住所</label></th>
					  <td>
                          <table>
                              <tr><th><label>郵便番号</label></th>
                                  <td>
                                    ${form['zip']}
                                    ${self.error(form, 'zip')}
                                </td></tr>
                              <tr><th><label>都道府県</label></th>
                                  <td>
                                    ${form['prefecture']}
                                    ${self.error(form, 'prefecture')}
                                </td></tr>
                              <tr><th><label>市区町村</label></th>
                                  <td>
                                    ${form['city']}
                                    ${self.error(form, 'city')}
                              </td></tr>
                              <tr><th><label>住所１</label></th>
                                  <td>
                                    ${form['address_1']}
                                    ${self.error(form, 'address_1')}
                              </td></tr>
                              <tr><th><label>住所２</label></th>
                                  <td>
                                    ${form['address_2']}
                                    ${self.error(form, 'address_2')}
                              </td></tr>
                          </table>
                      </td>
						</tr>
					<tr>
							<th><label>生年月日</label></th>
					  <td><input name="textfield" type="text" id="textfield" size="10" /> 年　<input name="textfield" type="text" id="textfield" size="10" /> 月　<input name="textfield" type="text" id="textfield" size="10" /> 日</td>
				</tr>
				<tr>
                    <th><label>${form['sex'].label}</label></th>
					  <td>
                          %for subfields in form['sex']:
                          ${subfields}　${subfields.label}
                            %endfor
                    </td>
				</tr>
					<tr id="settlementSelectEnd">
							<th><label>メモ欄</label></th>
					  <td><textarea cols="50" rows="5"></textarea></td>
				</tr>
				  </table>
				</div>
			</div>

				</div>
			</div>
            <p class="align2"><input type="image" src="${request.static_url('ticketing.lots:static/img/settlement/btn_next.gif')}" alt="次へ" width="226" height="46" /></p>
  		</form>      

  </div>
<script>
var data = ${products_json | n};
var postedValues = ${posted_values | n};
var upperLimit = ${sales_segment.upper_limit};

$(function() {

    function refreshProducts(performanceSelect, values) {
        var products = data[$(performanceSelect).val()];
        var wishOrder = $(performanceSelect).data('wishorder');
        var wishCellTableId = $(performanceSelect).data('wishcelltableid');
        var rows = $("#" + wishCellTableId + " > tbody > tr.product-select-tr");
        rows.remove();
        if (!products) {
            return;
        }
        var html = product_select_tmpl({wishOrder: wishOrder, products: products, values: values});
        $("#" + wishCellTableId + " tbody").append(html);
    };

    var product_select_tmpl = _.template($('#product-select-tmpl').text());
    $(".performance-select").change(function() {
        refreshProducts($(this), {});
    });

    $(".performance-select").each(function(index, performanceSelect) {
        var postedPerformance = postedValues['performance-' + index];
        $(performanceSelect).val(postedPerformance);
        refreshProducts($(performanceSelect), postedValues);
    });

});
</script>
<script type="text/x-template" id="product-select-tmpl">
<%include file="_product_selection.html_" />
</script>
