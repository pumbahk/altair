<%inherit file="${context['main_template'].uri}" />
<div id="main">
  <h1><img src="${request.static_url('ticketing.lots:static/img/order/title_settlement.gif')}" alt="チケット申込" width="950" height="40" /></h1>
  %if request.session.peek_flash():
  <div style="border: 3px solid red; background: #FFEEEE; padding: 10px; margin: 10px;">
    <ul>
      %for message in request.session.pop_flash():
      <li>${message}</li>
      %endfor
    </ul>
  </div>
  %endif
  <div class="settlementBox2" id="settlementEventDetail">
    <div class="settlementBoxInner2">
      <h2><img src="${request.static_url('ticketing.lots:static/img/settlement/title_event.gif')}" alt="イベント詳細" width="106" height="29" /></h2>
      <table summary="イベント詳細情報">
        <tr>
          <th scope="row">イベント名</th>
          <td>${event.title}</td>
        </tr>
        <tr>
          <th scope="row">申込受付期間</th>
          <td>${h.japanese_datetime(sales_segment.start_at)}～${h.japanese_datetime(sales_segment.end_at)}</td>
        </tr>
        %if sales_segment.upper_limit:
        <tr>
          <th scope="row">制限枚数</th>
          <td>1希望の申込で${sales_segment.upper_limit}枚まで</td>
        </tr>
        %endif
        <tr>
          <th scope="row">申込回数制限</th>
          <td>${u"{0} 回".format(lot.entry_limit) if lot.entry_limit else u"無制限"}</td>
        </tr>
        <tr>
          <th scope="row">受付希望数</th>
          <td>一度の申込で第${lot.limit_wishes}希望まで</td>
        </tr>
        %if lot.description:
        <tr>
          <th scope="row">注意事項</th>
          <td>${lot.description}</td>
        </tr>
        %endif
      </table>
    </div>
  </div>
  <div class="settlementBox2" id="settlementEventDetail">
    <div class="settlementBoxInner2">
      <h2><img src="${request.static_url('ticketing.lots:static/img/order/title_public.gif')}" alt="公演一覧" width="106" height="29" /></h2>
      %for performance in lot.performances:
      <table class="border" summary="イベント詳細情報">
        <tr>
          <th colspan="2" scope="row"><span>${performance.name}</span></th>
        </tr>
        <tr class="none">
          <th scope="row">公演日</th>
          <td>${h.japanese_datetime(performance.start_on)}開演</td>
        </tr>
        <tr>
          <th scope="row">会場</th>
          <td>${performance.venue.name}</td>
        </tr>                    
      </table>
      %endfor
    </div>
  </div>

  <form method="post" id="wishForm" action="${request.url}">        
    <div class="settlementBox">
      <div class="settlementBoxInner">
        <h2 class="title"><img src="${request.static_url('ticketing.lots:static/img/order/title_hope.gif')}" alt="希望選択" width="97" height="30" /></h2>
        %for i in range(lot.limit_wishes):
        <div class="settlementSelectBox">
          <div class="settlementSelectBoxInner02">
            <p><strong>第${i + 1}希望</strong></p>
            <table class="chooser" summary="希望する公演と券種の選択" id="wish-cell-table-${i}">
              <tr>
                %if len(performance_map) == 1:
                <th>
                %else:
                <th rowspan="2">
                %endif
                  <label>公演日・会場</label>
                </th>
                %if len(performance_map) == 1:
                <input type="hidden" name="performanceName-${i}" value="${performance_map[0][1]}" />
                <td colspan="2">
                %else:
                <td colspan="2">
                  <select name="performanceName-${i}" data-wishOrder="${i}" data-wishCellTableId="wish-cell-table-${i}" class="performance-name-select">
                  %for performance_name, _ in performance_map:
                  <option value="${performance_name}">${performance_name}</option>
                  %endfor
                  </select>
                </td>
              </tr>
              <tr>
                <td colspan="2">
                %endif
                  <select name="performanceDate-${i}" data-wishOrder="${i}" data-wishCellTableId="wish-cell-table-${i}" class="performance-date-select">
                  %for performance in performances:
                  <option value="${performance.id}">${h.japanese_datetime(performance.start_on)}</option>
                  %endfor
                  </select>
                </td>
              </tr>
            </table>
          </div>
        </div>
        %endfor
      </div>
    </div>          

    <div class="settlementBox">
      <div class="settlementBoxInner">
        <h2><img src="${request.static_url('ticketing.lots:static/img/order/title_how.gif')}" alt="お支払・お引取り方法選択" width="208" height="30" /></h2>
        %for m in payment_delivery_pairs:
        <div class="settlementPayBox">
          <div class="settlementPayBoxInner">
            <table>
              <tr>
                <% checked = 'checked' if str(m.id) == payment_delivery_method_pair_id else '' %>
                <td class="settlementPayRadio"><input type="radio" name="payment_delivery_method_pair_id" id="radio" value="${m.id}" ${checked} /></td>
                <td>
                  <dl class="left">
                    <dt>${m.payment_method.name}　${h.format_currency(m.transaction_fee)} (${h.fee_type(m.payment_method.fee_type)})</dt>
                    <dd>${m.payment_method.description or '' | n}<br /></dd>
                  </dl>
                  <dl class="left">
                    <dt>${m.delivery_method.name}　${h.format_currency(m.delivery_fee)} (${h.fee_type(m.delivery_method.fee_type)})</dt>
                    <dd>${m.delivery_method.description or '' | n}</dd>
                  </dl>
                </td>
              </tr>
            </table>
          </div>
        </div>
        %endfor
      </div>
    </div>

    <div class="settlementBox">
      <div class="settlementBoxInner">
        <h2><img src="${request.static_url('ticketing.lots:static/img/order/title_buyer.gif')}" alt="購入者情報" width="97" height="30" /></h2>
        <div class="settlementSelectBox">
          <div class="settlementSelectBoxInner02">
            <table summary="お支払・お引取り方法選択">
              <tr>
                <th><label>購入者氏名（全角）</label></th>
                <td>
                  ${form['last_name']}
                  ${form['first_name']}
                  ${self.error(form, 'last_name')}
                  ${self.error(form, 'first_name')}
                </td>
              </tr>
              <tr>
                <th><label>購入者氏名（カナ）</label></th>
                <td>
                  ${form['last_name_kana']}
                  ${form['first_name_kana']}
                  ${self.error(form, 'last_name_kana')}
                  ${self.error(form, 'first_name_kana')}
                </td>
              </tr>
              <tr>
                <th><label>メールアドレス</label></th>
                <td>
                  ${form['email_1']}
                  ${self.error(form, 'email_1')}
                </td>
              </tr>
              <tr>
                <th><label>メールアドレス（確認）</label></th>
                <td>
                  ${form['email_1_confirm']}
                  ${self.error(form, 'email_1_confirm')}
                </td>
              </tr>
              <tr>
                <th><label>電話番号（自宅）</label></th>
                <td>
                  ${form['tel_1']}
                  ${self.error(form, 'tel_1')}
                </td>
              </tr>
              <%doc>
              <tr>
                <th><label>電話番号（携帯電話）</label></th>
                <td>
                  ${form['mobile_tel']}
                  ${self.error(form, 'mobile_tel')}
                </td>
              </tr>
              </%doc>
              <tr>
                <th><label>配送先住所</label></th>
                <td>
                  <table>
                    <tr>
                      <th><label>郵便番号</label></th>
                      <td>
                        ${form['zip']}
                        ${self.error(form, 'zip')}
                      </td>
                    </tr>
                    <tr>
                      <th><label>都道府県</label></th>
                      <td>
                        ${form['prefecture']}
                        ${self.error(form, 'prefecture')}
                      </td>
                    </tr>
                    <tr>
                      <th><label>市区町村</label></th>
                      <td>
                        ${form['city']}
                        ${self.error(form, 'city')}
                      </td>
                    </tr>
                    <tr>
                      <th><label>住所１</label></th>
                      <td>
                        ${form['address_1']}
                        ${self.error(form, 'address_1')}
                      </td>
                    </tr>
                    <tr>
                      <th><label>住所２</label></th>
                      <td>
                        ${form['address_2']}
                        ${self.error(form, 'address_2')}
                      </td>
                    </tr>
                  </table>
                </td>
              </tr>
              <tr>
                <th><label>生年月日</label></th>
                <td>
                  ${form['year']} 年
                　${form['month']} 月
                　${form['day']} 日
                  ${self.error(form, 'year')}
                </td>
              </tr>
              <tr>
                <th><label>${form['sex'].label}</label></th>
                <td>
                  %for subfields in form['sex']:
                    ${subfields}　${subfields.label}
                  %endfor
                </td>
              </tr>
              <tr id="settlementSelectEnd">
                <th><label>メモ欄</label></th>
                <td>${form['memo'](cols=50, rows=5)} ${self.error(form, 'error')}</td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
    <p class="align2"><input type="image" src="${request.static_url('ticketing.lots:static/img/settlement/btn_next.gif')}" alt="次へ" width="226" height="46" /></p>
  </form>      
</div>
<script type="text/x-template" id="product-select-tmpl">
<%include file="_product_selection.html_" />
</script>
<script>
var data = ${products_json | n};
var postedValues = ${posted_values | n};
var upperLimit = ${sales_segment.upper_limit};
var performanceMap = ${h.tojson(performance_map)|n};

(function($wishForm) {
    function refreshProducts(dateSelect) {
        var products = data[$(dateSelect).val()];
        var wishOrder = $(dateSelect).data('wishorder');
        var wishCellTableId = $(dateSelect).data('wishcelltableid');
        var rows = $("#" + wishCellTableId + " tr.product-select-tr");
        rows.remove();
        if (!products) {
            return;
        }
        var html = product_select_tmpl({wishOrder: wishOrder, products: products});
        $("#" + wishCellTableId + " tbody").append(html);
    }

    function refreshDateSelection(performanceNameSelect, dateSelect) {
        var selectedPerformanceName = performanceNameSelect.val();
        for (var i = 0; i < performanceMap.length; i++) {
          if (performanceMap[i][0] == selectedPerformanceName) {
            choices = performanceMap[i][1];
          }
        }
        dateSelect.empty();
        for (var i = 0; i < choices.length; i++) {
          var choice = choices[i];
          dateSelect.append($('<option></option>').attr('value', choice.id).text(choice.start_on_str));
        }
    }

    function getPerformanceIdFromProductId(productId) {
        for (var performanceId in data) {
            var datum = data[performanceId];
            for (var i = 0; i < datum.length; i++) {
                if (datum[i].id == productId)
                    return performanceId;
            }
        }
    }

    var PRODUCT_ID_RE = /^product-id-(\d+)-(\d+)$/;
    function updateSelection(values) {
        for (var key in values) {
            matches = PRODUCT_ID_RE.exec(key)
            if (matches) {
                var wishOrder = matches[1], wishedProductOrder = matches[2];
                var productId = values[key];
                var performanceId = getPerformanceIdFromProductId(productId);
                var performanceNameSelect = $wishForm.find('select.performance-name-select[data-wishOrder="' + wishOrder + '"]');
                var dateSelect = $wishForm.find('select.performance-date-select[data-wishOrder="' + wishOrder + '"]');
                if (!dateSelect.find('option[value="' + performanceId + '"]').length) {
                    var performanceName = null;
                    for (var i = 0; i < performanceMap.length; i++) {
                        var performances = performanceMap[i][1];
                        for (var j = 0; j < performances.length; j++) {
                            if (performances[j].id == performanceId) {
                                performanceName = performanceMap[i][0];
                                break;
                            }
                        }
                    }
                    if (performanceName) {
                        performanceNameSelect.val(performanceName);
                        refreshDateSelection(performanceNameSelect, dateSelect);
                        dateSelect.val(performanceId);
                        refreshProducts(dateSelect);
                    }
                }

                var quantityFieldName = 'product-quantity-' + wishOrder + '-' + wishedProductOrder;
                var quantity = values[quantityFieldName];
                $wishForm.find('select[name="' + quantityFieldName + '"]').val(quantity);
            }
        }
    }

    var product_select_tmpl = _.template($('#product-select-tmpl').text());
    $(".performance-name-select").change(function() {
        var performanceNameSelect = $(this);
        var wishOrder = performanceNameSelect.data('wishorder');
        var dateSelect = $wishForm.find('select.performance-date-select[data-wishOrder="' + wishOrder + '"]');
        refreshDateSelection(performanceNameSelect, dateSelect);
        refreshProducts(dateSelect);
    });
    $(".performance-date-select").change(function() {
        refreshProducts($(this));
    });

    $(function() { 
        $(".performance-name-select").each(function(_, n) {
            var performanceNameSelect = $(n);
            var wishOrder = performanceNameSelect.data('wishorder');
            var dateSelect = $wishForm.find('select.performance-date-select[data-wishOrder="' + wishOrder + '"]');
            refreshDateSelection(performanceNameSelect, dateSelect);
        });
        $(".performance-date-select").each(function(_, n) {
            refreshProducts($(n));
        });
        updateSelection(postedValues);
    });
})($('#wishForm'));
</script>
