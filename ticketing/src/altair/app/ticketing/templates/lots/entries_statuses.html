<%page args="lot_status" />

<%def name="render_subtotal(product)">
    <%
        stock_type_status = None
        for status in stock_type_wishes_status:
            if status.stock_type.id == product.seat_stock_type.id and status.performance.id == product.performance.id:
                stock_type_status = status
                break
    %>
    % if stock_type_status:
    <tr bgcolor="grey">
        <td colspan="4" align="right">${stock_type_status.stock_type.name}合計</td>
        <td>${stock_type_status.entry_quantity}</td>
        %for i in range(lot_status.lot.limit_wishes):
            <td>${stock_type_status.wish_statuses[i].entry_quantity}</td>
        %endfor
        <td>${stock_type_status.elected_quantity}</td>
        <td>${stock_type_status.ordered_quantity}</td>
        <td>${stock_type_status.reserved_quantity if between_lot_start_and_payment_due else u"0"}</td>
        <td>${stock_type_status.canceled_quantity}</td>
    </tr>
    % else:
    <tr bgcolor="grey">
        <td colspan="4" align="right">${product.seat_stock_type.name}合計</td>
        <td>0</td>
        %for i in range(lot_status.lot.limit_wishes):
            <td>0</td>
        %endfor
        <td>0</td>
        <td>0</td>
        <td>0</td>
        <td>0</td>
    </tr>
    % endif
</%def>

<div>
  <h4>件数ベース</h4>
  <table border="1" bordercolor="#808080" width="98%" style="border-collapse:collapse;">
    <tr style="background-color:#dcdcdc;">
      <th>申込件数</th>
      <th>当選件数</th>
      <th>決済件数</th>
      <th>予約件数</th>
      <th>キャンセル・流れ</th>
    </tr>
    <tr>
      <td>${lot_status.total_entries}</td>
      <td>${lot_status.elected_count}</td>
      <td>${lot_status.ordered_count}</td>
      <td>${lot_status.reserved_count}</td>
      <td>${lot_status.canceled_count}</td>
    </tr>
  </table>

  <h4>枚数ベース</h4>
  <table border="1" bordercolor="#808080" width="98%" style="border-collapse:collapse;">
    <tr style="background-color:#dcdcdc;">
      <th rowspan="2">公演日時</th>
      <th rowspan="2">会場</th>
      <th rowspan="2">席種</th>
      <th rowspan="2">商品</th>
      <th rowspan="2">申込総枚数</th>
      <th colspan="${lot_status.lot.limit_wishes}">希望順位内訳枚数</th>
      <th rowspan="2">当選枚数</th>
      <th rowspan="2">決済済枚数</th>
      <th rowspan="2">予約枚数</th>
      <th rowspan="2">キャンセル・流れ枚数</th>
    </tr>
    <tr>
      %for i in range(lot_status.lot.limit_wishes):
      <th>第${i+1}希望</th>
      %endfor
    </tr>
    <% products = lot_status.products_status %>
      % for product in products:
        <tr>
            <td>${vh.datetime(product.performance.start_on, with_weekday=True)}</td>
            <td>${product.performance.venue.name}</td>
            <td>${product.seat_stock_type.name}</td>
            <td>${product.name}</td>
            <td>${product_dict[product.id].entry_quantity if product.id in product_dict else u"0"}</td>
            %for i in range(lot_status.lot.limit_wishes):
                <td>${product_dict[product.id].wish_statuses[i].entry_quantity if product.id in product_dict else u"0"}</td>
            %endfor
            <td>${product_dict[product.id].elected_quantity if product.id in product_dict else u"0"}</td>
            <td>${product_dict[product.id].ordered_quantity if product.id in product_dict else u"0"}</td>
            %if between_lot_start_and_payment_due:
                <td>${product_dict[product.id].reserved_quantity if product.id in product_dict else u"0"}</td>
            %else:
                <td>0</td>
            %endif
            <td>${product_dict[product.id].canceled_quantity if product.id in product_dict else u"0"}</td>
        </tr>
        ${render_subtotal(product)}
      % endfor

        <tr>
            <td colspan="4">合計</td>
            <td>${lot_status.total_quantity or 0}</td>
            %for i in range(lot_status.lot.limit_wishes):
                <td>${lot_status.wish_statuses[i].quantity or 0}</td>
            %endfor
            <td>${sum([st.elected_quantity for st in stock_type_wishes_status])}</td>
            <td>${sum([st.ordered_quantity for st in stock_type_wishes_status])}</td>
            %if between_lot_start_and_payment_due:
                <td>${sum([st.reserved_quantity for st in stock_type_wishes_status])}</td>
            %else:
                <td>0</td>
            %endif
            <td>${sum([st.canceled_quantity for st in stock_type_wishes_status])}</td>
        </tr>
  </table>


</div>
