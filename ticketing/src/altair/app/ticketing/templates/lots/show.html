<%inherit file="/layout_2cols.html" />
<%namespace file="/common/helpers.html" name="ch" />
<%namespace file="_entries_tabs.html" name="tabs" />

<%block name="style">
<link rel="stylesheet" type="text/css" href="/static/css/decentcolorpicker.css" />
<link rel="stylesheet" type="text/css" href="/static/css/performance.css" />
</%block>

<%block name="fulltitle">
Altair Backend -- ${lot.event.title}[${lot.name}]
</%block>

<%block name="javascript">
</%block>

<%block name="breadcrumbs">
  ${ch.breadcrumbs(
      names=[u'イベント', lot.event.title, u'抽選', lot.name],
      urls=[
        request.route_path('events.index'),
        request.route_path('events.show', event_id=lot.event.id),
        request.route_path('lots.index', event_id=lot.event.id),
      ]
  )}
</%block>

<div class="page-header">
  <h1>
    ${lot.event.title}<br />
    <small>${lot.name}</small>
  </h1>
</div>

${tabs.tabs(request)}

<div class="row-fluid">
  <div class="span9">
    <table class="table table-bordered table-condensed">
      <tbody>
        <tr>
          <th>抽選期間</th>
          <td>${vh.datetime(lot.start_at)} ${vh.datetime(lot.end_at)}</td>
        </tr>
        <tr>
          <th>希望上限</th>
          <td>${lot.limit_wishes}</td>
        </tr>
        <tr>
          <th>申込上限</th>
          <td>${lot.entry_limit}</td>
        </tr>
        <tr>
          <th>抽選結果発表予定日</th>
          <td>
              ${lot.lotting_announce_datetime}
              % if h.timezone_label(lot):
                (${h.timezone_label(lot)})
              % endif
          </td>
        </tr>
        <tr>
          <th>認証方法</th>
          <td>${lot.auth_type or u'なし'}</td>
        </tr>
        <tr>
          <th>抽選カートURL</th>
          <td><a href="${agreement_lots_cart_url}">${agreement_lots_cart_url}</a></td>
        </tr>
        <tr>
          <th>同意抽選カートURL</th>
          <td><a href="${lots_cart_url}">${lots_cart_url}</a></td>
        </tr>
       </tbody>
    </table>
    <a class="btn" href="${request.route_url('lots.edit', lot_id=lot.id)}">編集</a>
  </div>
</div>

<hr>

<%
  from altair.app.ticketing.core.models import ReportFrequencyEnum, ReportPeriodEnum 
  from altair.app.ticketing.formatter import Japanese_Japan_Formatter
  formatter = Japanese_Japan_Formatter()
%>
<h3>レポートメール送信設定</h3>
%if report_settings:
<table class="table table-striped table-bordered table-condensed">
  <tbody>
    <tr>
      <th>名前</th>
      <th>メールアドレス</th>
      <th>メール通知頻度</th>
      <th>送信曜日</th>
      <th>送信時間</th>
      <th>送信期間</th>
      <th>対象</th>
      <th>レポート対象期間</th>
      <th></th>
    </tr>
    %for rs in report_settings:
    <tr>
      <td>${rs.name or ''}</td>
      <td>${rs.email}</td>
      <td>${''.join([enum.v[1] for enum in ReportFrequencyEnum if enum.v[0] == rs.frequency])}</td>
      <td><%doc>${''.join([dow[1] for dow in form_report_mail.day_of_week.choices if rs.day_of_week == dow[0]])}</%doc>${formatter.format_weekday(rs.day_of_week - 1) if rs.day_of_week else ''}</td>
      <td>${u'%s時' % rs.time if rs.time else ''}</td>
      <td>${vh.term(rs.start_on, rs.end_on, without_minute=True)}</td>
      <td>${u'抽選' if rs.lot_id else u'イベント'}</td>
      <td>${''.join([enum.v[1] for enum in ReportPeriodEnum if enum.v[0] == rs.period])}</td>
      <td>
        <form class="pull-left" action="${request.route_url('lot.entries.delete_report_setting', setting_id=rs.id, **request.matchdict)}" method="post" onsubmit="return confirm('削除してよろしいですか？')">
          <button type="submit" class="btn">削除</button>
        </form>
        <form class="pull-left" action="${request.route_url('lot.entries.send_report_setting', setting_id=rs.id, **request.matchdict)}" method="post" onsubmit="return confirm('レポートメールを送信します。よろしいですか？')">
          <button type="submit" class="btn">送信</button>
        </form>
      </td>
    </tr>
    %endfor
  </tbody>
</table>
%endif
<a href="${request.route_url('lot.entries.new_report_setting', **request.matchdict)}" class="btn">新規</a>

<hr>

<h3>決済引取方法</h3>
<form action="${request.url}" method="post">
  <table class="table table-bordered table-condensed">
    <thead>
      <tr>
        <th>&nbsp;</th>
        <th>決済方法</th>
        <th>引取方法</th>
        <th>状態</th>
      </tr>
    </thead>
    <tbody>
    %for pdmp in lot.sales_segment.sales_segment_group.payment_delivery_method_pairs:
      <tr>
        <td><input type="checkbox" name="pdmp_id" value="${pdmp.id}" ${u"checked" if pdmp in lot.sales_segment.payment_delivery_method_pairs else u""} /></td>
        <td>${pdmp.payment_method.name}</td>
        <td>${pdmp.delivery_method.name}</td>
        <td>${u"有効" if pdmp in lot.sales_segment.payment_delivery_method_pairs else u"無効"}</td>
      </tr>
    %endfor
    </tbody>
  </table>
  <div class="btn-group">
    <button type="submit" name="action-update-pdmp" class="btn">更新</button>
  </div>
</form>

<hr>

<%include file="/lots/_product_list.html" args="lot=lot"/>

<hr>

<h3>商品明細</h3>
<div style="overflow-x: scroll;">
  <table id="products-grid"></table>
</div>
<button id="sales-segment-save_button" class="btn">保存</button>
<button id="sales-segment-clear_button" class="btn">リセット</button>
<%
  import json
  grid = json.dumps(product_grid)
%>
<script>
$(function() {
  $.fn.linkFormatter = function(cellvalue, options, rowObject) {
    var link = '';
    /*
    if (!rowObject.level) {
      link += '<a href="javascript:addRow(' + "'" + options.gid + "'," + options.rowId + ');"><i class="icon-plus"></i></a>';
    }
    */
    if (rowObject.product_item) {
      link += '<a href="javascript:deleteRow(' + "'" + options.gid + "'," + options.rowId + ');"><i class="icon-trash"></i></a>';
    }
    /*
    if (rowObject.ticket_bundle && rowObject.ticket_bundle.id) {
      link += '<a href="javascript:preview_ticket(' + rowObject.product_item.id + ')"><i class="icon-eye-open"></i></a>';
    }
    */
    return link;
  };

  var productGrid = ${grid|n};
  var grid = $('#products-grid')

  productGrid.colModel.push({
    "label": ' ',
    "name": 'link',
    "width": 80,
    formatter:grid.linkFormatter
  });

  productGrid['afterSaveCell'] = function (id, name, val, iRow, iCol){
    grid.setCell(id, name, '', {background:'#F89406'});
    grid.setRetainChanges();
  };

  grid.jqGrid(productGrid);

  var showDialog = function(title, msg, cls) {
    var modal = $('#modal-alert');
    var message = $('<div>').addClass('alert '+cls).html(msg);
    modal.find('.modal-header > h3').text(title);
    modal.find('#message').empty().append(message);
    modal.modal('show');
  };

  var showSuccessDialog = function() {
     var title = '保存完了';
     var msg = '編集内容を保存しました';
     showDialog(title, msg, 'alert-success');
  };

  function deleteRow(gid, rowId) {
    var grid = $('#' + gid);
    grid.setCell(rowId, 'stock_holder_id', '', {background:'#BD362F'});
    grid.setCell(rowId, 'product_item_name', '', {background:'#BD362F'});
    grid.setCell(rowId, 'product_item_price', '', {background:'#BD362F'});
    grid.setCell(rowId, 'product_item_quantity', '', {background:'#BD362F'});
    grid.setCell(rowId, 'stock_quantity', '', {background:'#BD362F'});
    grid.setCell(rowId, 'stock_status_quantity', '', {background:'#BD362F'});
    grid.setCell(rowId, 'ticket_bundle_id', '', {background:'#BD362F'});
    grid.setCell(rowId, 'deleted', true);
    var row = new Object();
    row['id'] = rowId;
    grid.setRetainChanges([row]);
  }

  $('#sales-segment-clear_button').click(function(){
    grid.clearRetainChanges();
  });

  $('#sales-segment-save_button').click(function(){
    $.ajax({
      type: 'POST',
      url: productGrid.editurl,
      data: JSON.stringify(grid.getRetainChanges()),
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      success: function (response, textStatus, xhr) {
          showSuccessDialog();
          grid.clearRetainChanges();
      },
      error: function (xhr, textStatus, errorThrown) {
        var response_text = JSON.parse(xhr.responseText);
        var message = response_text.message;
        var rows = '';
        if (response_text['rows']) {
          for (col in response_text.rows.errors) {
            var col_name = grid.getColumnLabel(grid, col);
            col_name = (col_name ? col_name + ':' : '');
            rows += '<li>(' + response_text.rows.rowid + '行目) ' + col_name + response_text.rows.errors[col] + '</li>';
          }
        }
        showDialog("エラー", message + '<ul>' + rows + '</ul>', 'alert-error');
      }
    });
  });
});
</script>

<div id="modal-alert" class="modal hide">
  <div class="modal-header">
    <a href="#" class="close" data-dismiss="modal">&times;</a>
    <h3></h3>
  </div>
  <div class="modal-body">
    <p id="message"></p>
  </div>
  <div class="modal-footer">
    <a href="javascript:void(0);" onclick="$('#modal-alert').modal('hide');" class="btn secondary">閉じる</a>
  </div>
</div>
