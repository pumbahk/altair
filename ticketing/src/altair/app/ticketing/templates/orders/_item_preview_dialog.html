<%namespace file="/common/helpers.html" import="form_item"/>

  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>preview</h3>
  </div>

  <div class="modal-body">
	<form id="preview_select">
	  ${form.ticket_format_id.label} ${form.ticket_format_id}
	  ${form.item_id}
	</form>
   <p>※ チケット様式は印刷に利用可能なものが選択可能です。何も表示されない場合には変更してみてください</p>

	<div id="drawing" style="height:200px;">

	</div>
  </div>

<script type="text/javascript" src="${request.static_url("altair.app.ticketing:static/js/spin.js")}"></script>
<script type="text/javascript" src="${request.static_url("altair.app.ticketing:static/js/altair/spinner.js")}"></script>
<script type="text/javascript" src="${request.static_url("altair.app.ticketing:static/js/tickets/preview/preview_api.js")}"></script>
<script type="text/javascript">
$(function(){
  var cont = null;

  var url = "${request.route_path("orders.item.preview.getdata", item_id=item.id, ticket_format_id="__id__")}";
  var MAX_SIZE_OF_PREVIEW_ITEM = 2;

  var renderPreviewImage = function(results, names, start, end, root){
    var i = start;
    if(i>=end){
      return ;
    }
    var jsondata = results[i];
    var wrap = $("<div>").attr("id", "diagram:"+i);
    var url = "${request.route_path("tickets.preview.api", action="preview.base64")}"; 
    var params = {svg: jsondata["drawing"], ticket_format: jsondata["ticket_format_id"], type: jsondata["preview_type"]};
    root.append($("<h3>").text(names[i]));
    root.append(wrap);
    svg_preview(wrap, url, params).done(function(){
      // stretch
      var wrapperArea = $("#PreviewModal");
      var wrapperHeight = wrapperArea.height();
      var wrapperContent = wrapperArea.find(".modal-body");
      var contentHeight = wrapperContent.height();
      var descriptionHeight = 70;
      if(wrapperHeight < (contentHeight+descriptionHeight)){
        wrapperArea.height(contentHeight+descriptionHeight);
      }
      return renderPreviewImage(results, names, i+1, end, root);
    });
  };

  var draw_viewer = function(url, ticket_format_id){
    $.getJSON(url.replace("__id__", ticket_format_id)).done(function(data){ 
      var root = $("#drawing");
      root.empty();
      var results = data.results;
      var names = data.names;

      var N = MAX_SIZE_OF_PREVIEW_ITEM;
      if(results.length <= N){
        renderPreviewImage(results, names, 0, results.length, root);
      }else{
        renderPreviewImage(results, names, 0, N, root);

        cont = function(){ 
          renderPreviewImage(results, names, N, results.length, root); 
        };
        var btn = $("<a>").text("続きをpreview ({0}/{1})".replace("{0}", String(N)).replace("{1}", String(results.length)));
        btn.click(function(){ 
          if(!!cont){
            cont();
          }
          cont = null; 
        });
        root.append(btn);
      }
    });
  };

  draw_viewer(url, $("#preview_select select[name='ticket_format_id']").val());
  $("#preview_select select[name='ticket_format_id']").change(function(){
    var ticket_format_id = $(this).val();
    draw_viewer(url, ticket_format_id);
  });
});
</script>
