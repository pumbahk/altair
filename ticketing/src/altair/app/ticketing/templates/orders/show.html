<%inherit file="/layout_2cols.html" />
<%namespace file="/common/helpers.html" name="ch" />
<style type="text/css">
.table.point-grant-history span.error {
  color: #f00;
  font-weight: bold;
}
</style>
<%block name="breadcrumbs">
${ch.breadcrumbs(
  names=[u'トップ', u'購入情報', order_current.performance.name, order_current.order_no],
  urls=[
    request.route_path('index'),
    request.route_path('orders.index'),
    request.route_path('performances.show', performance_id=order_current.performance_id) + '/order'
  ]
)}
</%block>
<div class="page-header">
  <h1>購入情報</h1>
</div>

<div class="tabbable tabs-below" id="tabbable-content">
  <div class="tab-content" id="tabbable-tab-content">
    % for i, order in enumerate(order_history):
    <div class="tab-pane ${'active' if i == 0 else ''}" id="order_history-${order.id}">
      <div class="row-fluid">
        <div class="span6">
          <div class="page-header">
            <h3>予約情報</h3>
          </div>
          <%include file="./_show_order_table.html" args="order=order,vh=vh,HH=HH"/>
          % if i == 0:
          <div class="pull-right">
            <%include file="/orders/_action_button.html"
              args="order=order, sort=['mailinfo', 'paid', 'unpaid', 'delivered', 'cancel', 'refund', 'print', 'delete']" />
          </div>
          <div id="refund-form">
            <%include file="/orders/refund/_form.html" args="form=form_refund" />
          </div>
          % endif
        </div>

        <div class="span6">
          <div class="page-header">
            <h3>ユーザー情報</h3>
          </div>
          <%include file="./_show_user_table.html" args="user=order.user"/>
        </div>
      </div>

      <div class="row-fluid">
        <div class="span6">
          <div class="page-header">
            <h3>配送情報</h3>
          </div>
          <%include file="./_show_shipping_table.html" args="order=order,shipping_address=order.shipping_address"/>

          % if i == 0:
          <div class="pull-right">
            <%include file="/orders/_action_button.html" args="order=order, sort=['edit_shipping_address']" />
          </div>
          <div id="shipping_address-form">
            <%include file="/orders/_form_shipping_address.html" args="form=form_shipping_address" />
          </div>
          % endif
        </div>

        <div class="span6">
          <div class="page-header">
            <h3>決済情報</h3>
          </div>
          <%include file="./_show_payment_table.html" args="order=order,checkout=order.checkout,sej_order=sej_order" />

          % if sej_order:
          <div class="pull-right">
            <form action="${sej_order.exchange_sheet_url}" method="POST">
              <input type="hidden" name="iraihyo_id_00" value="${sej_order.exchange_sheet_number}">
              <input type="submit" name="submit" value="引換票を表示" class="btn"/>
            </form>
          </div>
          % endif
        </div>
      </div>

      <div class="row-fluid">
        <div class="span12">
          <div class="page-header">
            <h3>商品</h3>
          </div>
          <%include file="./_show_product_table.html"/ args="order=order,performance=order.performance,objects_for_describe_product_item=objects_for_describe_product_item" />
          % if i == 0:
          <div class="pull-right">
            <%include file="/orders/_action_button.html" args="order=order, sort=['edit_product']" />
          </div>
          <div id="product-form">
            <%include file="/orders/_form_product.html" args="form=form_order, order=order" />
          </div>
          % endif
        </div>
      </div>

      <% row = 0 %>
      % for key, value in order.attributes.items():
        % if row == 0:
        <div class="row-fluid">
          <div class="span6">
            <table class="table table-striped table-bordered">
        % endif
              <tr>
                <%
                  label = ''
                  if key == 'sales_counter_payment_method_id':
                    label = u'当日窓口決済'
                    for (id, name) in form_order_reserve.sales_counter_payment_method_id.choices:
                      if id == int(value):
                        value = name
                        break
                %>
                <th class="span3">${label}</th>
                <td class="span2">${value}</td>
              </tr>
              <% row += 1 %>
      % else:
        % if row > 0:
            </table>
          </div>
        </div>
        % endif
      % endfor

      <div class="row-fluid">
        <div class="span6">
          <table class="table table-striped table-bordered">
            % for label, key, value in ordered_product_attributes:
            <tr>
              <th class="span3">${label} (${key})</th>
              <td class="span2">${value}</td>
            </tr>
            % endfor
          </table>
        </div>
      </div>

      ## 補助文言の追加
      <div class="row-fluid">
        <div class="span12">
          <div class="page-header">
            <h3>券面補助文言の追加</h3>
          </div>
          <form id="order-attributes-form" method="POST" action="javascript:save_order_attributes('${request.route_path("orders.memo_on_order", order_id=order.id)}')">
            <div class="message pull-left"></div>
            ## TODO: remove magic number
            %for i in range(1,4):
              <% attr_name = "memo_on_order{}".format(i) %>
              <label>補助文言${i}:<input name="${attr_name}" value="order.attributes.get(attr_name,'')"/></label>
            %endfor
            <input type="submit" value="補助文言を保存">
          </form>
        </div>
      </div>

      <div class="row-fluid">
        <div class="span12">
          <div class="page-header">
            <h3>ポイント付与履歴</h3>
          </div>
          <table class="table table-striped table-bordered point-grant-history">
            <thead>
              <tr>
                <th>エントリ作成日時</th>
                <th>付与日時</th>
                <th>ポイント種別</th>
                <th>付与ポイント</th>
                <th>付与状況</th>
              </tr>
            </thead>
            <tbody>
            % for point_grant_history_entry in order.point_grant_history_entries:
              <tr${u' class="error"' if point_grant_history_entry.granted_at and point_grant_history_entry.grant_status != '' else u''|n}>
                <td>${point_grant_history_entry.created_at}</td>
                <td>${point_grant_history_entry.granted_at or u'未'}</td>
                <td>${lh.format_point_type(point_grant_history_entry.user_point_account.type)}</td>
                <td>${point_grant_history_entry.amount} (${point_grant_history_entry.granted_at and point_grant_history_entry.granted_amount or u'-'})</td>
                <td>${lh.format_grant_status(point_grant_history_entry.granted_at and point_grant_history_entry.grant_status)}</td>
              </tr>
            % endfor
            </tbody>
          </table>
        </div>
      </div>

      <div class="row-fluid">
        <div id="note-form" class="span6 well" style="padding-left: 10px;">
          <form style="margin: 0;">
            <textarea id="note" name="note" rows="3" style="width:100%;" ${'disabled="disabled"' if i != 0 else ''}>${order.note or ''}</textarea>
          </form>
          % if i == 0:
          <div class="message pull-left"></div>
          <div class="pull-right">
            <%include file="/orders/_action_button.html" args="order=order, sort=['note']" />
          </div>
          % endif
        </div>
      </div>
    </div>
    % endfor
  </div>

  <ul class="nav nav-tabs">
    % for i, order in enumerate(order_history):
    <li class="${'active' if i == 0 else ''}">
      <a href="#order_history-${order.id}" data-toggle="tab">
        % if i == 0:
          最新
        % else:
          履歴${order.branch_no}
        % endif
      </a>
    </li>
    % endfor
  </ul>
</div>

<div class="modal hide" id="PreviewModal">
</div>
<script type="text/javascript">
$(function(){
// stretch size
  var uniwin = {
      width: window.innerWidth || document.documentElement.clientWidth
          || document.body.offsetWidth,
      height: window.innerHeight || document.documentElement.clientHeight
          || document.body.offsetHeight
  };
  var w = uniwin.width*0.7;
  var h = uniwin.height*0.7;
  var $e = $("#PreviewModal");
  $e.width(w).height(h).css("margin-left",-(w/2));
});
</script>

<div class="modal hide" id="PrintQueueModal">
</div>
<div class="modal hide" id="ForceMarkIssued">
  <div class="modal-body">
    この注文を強制的に発券済に設定します。よろしいですか?
  </div>
  <form method="post" action="${request.route_path('orders.issue_status', order_id=order.id)}" style="margin: 0">
    <input type="hidden" name="issued" value="1" />
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal">キャンセル</button>
      <button class="btn btn-warning">設定する</a>
    </div>
  </form>
</div>
<div class="modal hide" id="ForceMarkUnissued">
  <div class="modal-body">
    この注文を強制的に未発券状態に設定します。よろしいですか?
  </div>
  <form method="post" action="${request.route_path('orders.issue_status', order_id=order.id)}" style="margin: 0">
    <input type="hidden" name="issued" value="0" />
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal">キャンセル</button>
      <button class="btn btn-warning">設定する</a>
    </div>
  </form>
</div>

<div class="modal hide" id="ForceChangeUndelivered">
  <div class="modal-body">
    この注文を強制的に未配送にしますか？
  </div>
  <form method="post" action="${request.route_path('orders.undelivered', order_id=order.id)}" style="margin: 0">
    <div class="modal-footer">
      <button class="btn" data-dismiss="modal">キャンセル</button>
      <button class="btn btn-warning">設定する</a>
    </div>
  </form>
</div>

<script type="text/javascript">
  $(function(){
    // ajax modal
    $("a.ajax-modal[data-toggle=modal]").click(function(){
      $($(this).attr("data-target")).load($(this).attr("href"));
    });
  });
</script>
