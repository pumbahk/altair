<%page args="order, sort=None" />
<%namespace file="/common/helpers.html" name="ch" />
<%namespace file="/common/modal.html" name="m" />

<script type="text/javascript">
  function cancel_order(id) {
    var modal = $('#modal-confirm');
    var form = modal.find('form');
    form.attr('action', '/orders/cancel/' + id);
    form.find('input[type=submit]').val('注文をキャンセルする (取消不可)');
    var message = '選択した予約をキャンセルします。よろしいですか？';
    % if order.printed_at or order.issued_at or order.issued:
      message += '<br><div class="alert alert-error">この予約は既に発券済み(または発券予約中)です。</div>'
    % endif
    modal.find('.message').html('<p>' + message + '</p>');
    modal.modal('toggle');
  }
  function delete_order(id) {
    var modal = $('#modal-delete');
    modal.find('#delete').attr('href', '/orders/delete/' + id).text('注文を非表示にする (取消不可)');
    var message = '選択した予約を非表示にします。よろしいですか？';
    message += '<br><div class="alert alert-error">この操作を行うとこの予約情報は閲覧できなくなります。</div>'
    modal.find('#message').html('<p>' + message + '</p>');
    modal.modal('toggle');
  }
  function refund_order_confirm(id) {
    var modal = $('#modal-refund');
    modal.modal('toggle');
  }
  function refund_order() {
      var modal = '#modal-refund';
      var form = '#refund-form';
      var url = '${request.route_path('orders.refund.immediate', order_id=order.id)}';
      post_modal_form(modal, form, url);
  }
  function edit_shipping_address() {
    var modal = $('#modal-edit-shipping_address');
    modal.modal('toggle');
  }
  function save_shipping_address() {
    var modal = '#modal-edit-shipping_address';
    var form = '#shipping_address-form';
    var url = '${request.route_path('orders.edit.shipping_address', order_id=order.id)}';
    post_modal_form(modal, form, url);
  }
  function edit_product() {
    var modal = $('#modal-edit-product');
    modal.modal('toggle');
  }
  function save_product() {
    var modal = '#modal-edit-product';
    var form = '#product-form';
    var url = '${request.route_path('orders.edit.product', order_id=order.id)}';
    post_modal_form(modal, form, url);
  }
  function save_order_attributes(){
    var param = {};
    var form = $('#order-attributes-form');
    form.find('.message').empty();
    $(form.serializeArray()).each(function(i, v) {
      param[v.name] = v.value;
    });
    $.ajax({
      type: 'post',
      url: '${request.route_path('orders.memo_on_order', order_id=order.id)}',
      contentType: 'application/json; charset=utf-8',
      dataType: 'json',
      data: JSON.stringify(param),
      success: function(result) {
        form.find('.message').append('補助文言を保存しました');
      },
      error: function(xhr, text) {
        var responseText = JSON.parse(xhr.responseText);
        var messages = responseText['message'] || xhr.statusText
        form.find('.message').text(messages);
      }
    });
  }
  function save_note() {
    var param = {};
    var form = $('#note-form');
    form.find('.message').empty();
    $(form.find('form').serializeArray()).each(function(i, v) {
      param[v.name] = v.value;
    });
    $.ajax({
      type: 'post',
      url: '${request.route_path('orders.note', order_id=order.id)}',
      contentType: 'application/json; charset=utf-8',
      dataType: 'json',
      data: JSON.stringify(param),
      success: function(result) {
        form.find('.message').append('メモを保存しました');
      },
      error: function(xhr, text) {
        var responseText = JSON.parse(xhr.responseText);
        var messages = responseText['message'] || xhr.statusText
        var errors = '';
        if (typeof messages == 'string') {
          errors += '<li>' + messages + '</li>';
        } else {
          for (i in messages)
            errors += '<li>' + messages[i] + '</li>';
        }
        form.find('.message').append('<ul>' + errors + '</ul>');
      }
    });
  }
</script>

<%
actions = {
  'mailinfo':dict(
    label=u"メール",
    url=request.route_path('orders.mailinfo', order_id=order.id, action="show"),
    icon='icon-envelope',
    route_name='orders.mailinfo',
  ),
  'paid':dict(
    label=u'入金済みにする',
    url=request.route_path('orders.change_status', order_id=order.id, status='paid'),
    icon='icon-ok',
    route_name='orders.change_status',
  ),
  'unpaid':dict(
    label=u'未入金に戻す',
    url=request.route_path('orders.change_status', order_id=order.id, status='unpaid'),
    icon='icon-ok',
    route_name='orders.change_status',
  ),
  'delivered':dict(
    label=u'配送済みにする',
    url=request.route_path('orders.delivered', order_id=order.id),
    icon='icon-ok',
    route_name='orders.delivered',
  ),
  'print':dict(
    label=u'発券する',
    url=request.route_path("orders.print.queue.dialog", order_id=order.id),
    attrs={
        "data-toggle": "modal",
        "data-target": "#PrintQueueModal",
        "class": "ajax-modal btn"
        },
    icon='icon-print',
    route_name='orders.print.queue',
  ),
  'force_print':dict(
    label=u'強制発券する',
    url=request.route_path("orders.print.queue.dialog", order_id=order.id),
    attrs={
        "data-toggle": "modal",
        "data-target": "#PrintQueueModal",
        "class": "ajax-modal btn"
        },
    icon='icon-print',
    route_name='orders.print.queue',
  ),
  'cancel':dict(
    label=u'キャンセル',
    url='javascript:cancel_order(%d);' % order.id,
    icon='icon-remove',
    attrs={'class': 'btn-danger'},
    route_name='orders.cancel',
  ),
  'refund':dict(
    label=u'払戻',
    url='javascript:refund_order_confirm(%d);' % order.id,
    icon='icon-remove',
    attrs={'class': 'btn-danger'},
    route_name='orders.refund.immediate',
  ),
  'edit_shipping_address':dict(
    label=u'編集',
    url='javascript:edit_shipping_address(%d);' % order.id,
    icon='icon-edit',
    route_name='orders.edit.shipping_address',
  ),
  'edit_product':dict(
    label=u'編集',
    url='javascript:edit_product(%d);' % order.id,
    icon='icon-edit',
    route_name='orders.edit.product',
  ),
  'note':dict(
    label=u'メモを保存',
    url='javascript:save_note(%d);' % order.id,
    icon='icon-pencil',
    route_name='orders.note',
  ),
  'delete':dict(
    label=u'非表示',
    url='javascript:delete_order(%d);' % order.id,
    icon='icon-remove',
    attrs={'class': 'btn-danger'},
    route_name='orders.delete',
  ),
}
sort = sort or ['mailinfo', 'delivered', 'cancel', 'refund']

if 'mailinfo' in sort:
  if not order.shipping_address:
    sort.remove('mailinfo')
if 'paid' in sort:
  if not order.can_change_status('paid'):
    sort.remove('paid')
if 'unpaid' in sort:
  if not order.can_change_status('unpaid'):
    sort.remove('unpaid')
if 'cancel' in sort:
  if not order.can_cancel():
    sort.remove('cancel')
if 'refund' in sort:
  if not order.can_refund():
    sort.remove('refund')
if 'delivered' in sort:
  if not order.can_deliver():
    sort.remove('delivered')
if 'print' in sort:
  if order.is_canceled():
    sort.remove('print')
  elif order.issued or order.queued:
    sort.remove('print')
    sort.append('force_print')
if 'delete' in sort:
  if not order.can_delete():
    sort.remove('delete')
if sort:
  sort = iter(sort)
%>
${HH.action_button(actions, sort, vertical=False)}

${m.confirm_modal()}
${m.delete_modal(label_cancel=u'戻る')}
