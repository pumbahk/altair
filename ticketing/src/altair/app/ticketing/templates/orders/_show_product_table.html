<%page args="order,performance,objects_for_describe_product_item"/>

%for ordered_product, item_list in objects_for_describe_product_item:
%if loop.first:
  <table class="table table-striped table-bordered">
    <tr>
      <th class="span2">イベント</th>
      <td class="span6">${performance.event.title}</td>
    </tr>
    <tr>
      <th>公演名</th>
      <td>${performance.name}</td>
    </tr>
    <tr>
      <th>公演コード</th>
      <td>${performance.code}</td>
    </tr>
    <tr>
      <th>開演日時</th>
      <td>${performance.start_on or ''}</td>
    </tr>
    <tr>
      <th>会場</th>
      <td>${performance.venue.name}</td>
    </tr>
  </table>

  <p>※このアイコン<i class="icon-eye-open"></i>をクリックすると券面のプレビューができます。(<a href="${request.route_path("orders.cover.preview", order_id=order.id)}" data-toggle="modal" data-target="#PreviewModal" class="ajax-modal">表紙のpreview</a>)</p>

  <form action="${request.route_path("orders.print.queue.each", order_id=order.id)}" method="POST">
    <button class="btn"><i class="icon-print"></i>チケットを指定して発券</button>

  <table class="table table-striped table-bordered  nested-checkbox">
    <tr>
      <th colspan="2" class="span6">商品</th>
      <th class="span2">発券ステータス</th>
      <th class="span1">単価</th>
      <th class="span1">個数</th>
      <th class="span2">小計</th>
    </tr>
%endif
  <tr>
    <td colspan="2">
      %if ordered_product.product.sales_segment:
        <span class="label label-info">${ordered_product.product.sales_segment.name}</span>
      %endif
      ${ordered_product.product.name}
    </td>
    <td></td>
    <td style="text-align: right;">${vh.price(ordered_product.price)}</td>
    <td >${ordered_product.quantity}</td>
    <td style="text-align: right;">
      ${vh.price(ordered_product.price * ordered_product.quantity)}
    </td>
  </tr>

  %for ordered_product_item, seat_list in item_list:
  <tr>
    <td class="span2" style="text-align: right;">
      <span class="label label-info">${ordered_product_item.product_item.stock.stock_holder.name}</span>
    </td>

    <td class="span4">
      <input type="checkbox" name="item_id" value="${ordered_product_item.id}"/>
      <a href="${request.route_path("orders.item.preview", order_id=order.id, item_id=ordered_product_item.id)}" data-toggle="modal" data-target="#PreviewModal" class="ajax-modal">
        ${ordered_product_item.product_item.stock_type.name} ${ordered_product_item.attributes.get('t_shirts_size') or ''}<i class="icon-eye-open"></i>
      </a>
      <ul>
    %for i,((seat, token), ticket_list) in enumerate(seat_list):
     <li>
       <input type="checkbox" name="token_id" value="${token}"/>
       %if seat:
          ${seat.name}
       %else:
          ${ordered_product_item.product_item.name}-${i+1}
       %endif
       <ul>
       %for ticket in ticket_list:
       <li>
         <input type="checkbox" name="candidate_id" value="${token}@${seat.id if seat else None}@${ordered_product_item.id}@${ticket.id}"/>         
         ${ticket.name}
       </li>
       %endfor
       </ul>
     </li>
    %endfor
      </ul>
   </td>
    <td>
      %if ordered_product_item.issued_at or ordered_product_item.printed_at:
        ${ordered_product_item.issued_at or ordered_product_item.printed_at}
        <span alt="${ordered_product_item.issued_at}" class="label label-warning">済</span>
        %for operator_name in list(set([ph.operator.name for ph in ordered_product_item.print_histories if ph.operator])):
          <div>作業者: ${operator_name}</div>
        %endfor
      %else:
        ${u"%(issued)s/%(total)s" %ordered_product_item.issued_at_status}
        <span class="label label-inverse">未発券</span>
      %endif
    </td>
    <td style="text-align: right;">${vh.price(ordered_product_item.price)}</td>
    <td>${ordered_product_item.quantity}</td>
    <td></td>
  </tr>
  %endfor
%if loop.last:
    <tr>
      <td colspan="2">決済手数料</td>
      <td></td>
      <td></td>
      <td></td>
      <td style="text-align: right;">${vh.price(order.transaction_fee)}</td>
    </tr>
    <tr>
      <td colspan="2">引取手数料</td>
      <td></td>
      <td></td>
      <td></td>
      <td style="text-align: right;">${vh.price(order.delivery_fee)}</td>
    </tr>
    <tr>
      <td colspan="2">システム利用料</td>
      <td></td>
      <td></td>
      <td></td>
      <td style="text-align: right;">${vh.price(order.system_fee)}</td>
    </tr>
    %if order.special_fee_name:
    <tr>
      <td colspan="2">${order.special_fee_name}</td>
      <td></td>
      <td></td>
      <td></td>
      <td style="text-align: right;">${vh.price(order.special_fee)}</td>
    </tr>
    %endif
    <tr>
      <td colspan="2" class="span2"><strong>合計</strong></td>
      <td></td>
      <td></td>
      <td></td>
      <td style="text-align: right;"><strong>${vh.price(order.total_amount)}</strong></td>
    </tr>
  </table>
</form>
%endif
%endfor

<script>
  $(function(){
    $('.nested-checkbox input[type="checkbox"]').on("click",function(e){
      var $e = $(e.currentTarget);
      if(!!$e.attr("checked")){
        $e.siblings("ul").find("input[type='checkbox']").attr("checked","checked");
      }else{
        $e.siblings("ul").find("input[type='checkbox']").attr("checked", null);
      }
    });
  });
</script>
