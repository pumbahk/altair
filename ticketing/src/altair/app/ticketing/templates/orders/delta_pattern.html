<%inherit file="/layout_2cols.html"/>
<%namespace file="/common/helpers.html" name="ch" />
<!-- font-awesome -->
<link href="/static/css/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet"></link>
<%
  import json
  patterns_js = json.dumps(patterns)
%>

<%block name="breadcrumbs">
  ${ch.breadcrumbs(
    names=[u'トップ', u'予約検索'],
    urls=[request.route_path('index')]
  )}
</%block>

<style type="text/css">
  .page-header h3 {
    color: red;
  }
  .page-header div b {
    color: red;
  }

  /* setting-area */
  .setting-area {
    width: 500px;
  }
  span.sub-title {
    font-weight: 600;
  }

  /* pattern-settings */
  .pattern-settings {
    margin-bottom: 15px;
  }
  form#pattern-settings {
    margin: 0 auto;
    width: 100%;
  }
  #saved-patterns,
  #pattern-name {
    width: 428px;
    height: 16px;
    margin: 5px auto;
    padding: 3.2px 6px;

    -ms-box-sizing:content-box;
    -moz-box-sizing:content-box;
    box-sizing:content-box;
    -webkit-box-sizing:content-box;
  }
  #saved-patterns {
    border-radius: 4px;
  }
  .setting-btn {
    margin: 5px auto;
  }
  .setting-btn a {
    border-radius: 4px !important;
  }
  .setting-btn a:not(:first-child):not(:last-child) {
    margin: 0 5px;
  }

  /* column-options-settings */
  #available-columns, #selected-columns {
    width: 198px;
    height: 348px;
    margin: 0;
  }
  td.in-out-column,
  td.up-down-column {
    width: 36px;
    padding: 0 2px;
  }



  #save-pattern,
  #available-pattern {
    padding: 0 20px;
  }
  #available-pattern ul {
    list-style-type: none;
    padding: 0;
    margin: auto;
  }
</style>

<div class="page-header">
  <h1>予約検索</h1>
</div>
<div class="page-header">
  <h3>使用上の注意</h3>
  <div>この購入情報ダウンロード機能は<b>デルタ版</b>で、<b>試験段階</b>です。</div>
  <div>
    そのため<b>仕様が変更になる事もあります</b>し、<b>正しく動作しない事もあります</b>。ご注意ください。
  </div>
  <div>安定した機能をご希望の方は
    <b>既存の購入情報検索機能をお使いください</b>。
  </div>
</div>

<div class="main-body">
  <div>
    <h3>ダウンロードパターン設定</h3>
  </div>
  <div class="setting-area">
    <div class="pattern-settings">
      <span class="sub-title">パターン名</span>
      <form id="pattern-settings">
        <select id="saved-patterns">
          <option value="">ダウンロードパターンを選んでください</option>
          % if patterns:
            % for key, val in patterns.items():
              <option value="${key}">${key}</option>
            % endfor
          % endif
        </select>
        <input type="text" id="pattern-name" name="pattern-name">
      </form>
      <div class="setting-btn btn-group">
        <a id="add-pattern" class="btn">新規登録</a>
        <a id="update-pattern" class="btn">上書き保存</a>
        <a id="del-pattern" class="btn btn-danger">削除</a>
      </div>
    </div>
    <div class="cloumn-settings">
      <span class="sub-title">ダウンロード</span>
      <form id="column-settings">
      <table>
        <tbody>
          <tr>
            <td>
              <select id="available-columns" multiple="multiple">
                % for key, val in japanese_columns.items():
                  <option value="${key}">${val}</option>
                % endfor
              </select>
            </td>
            <td class="in-out-column">
              <a class="btn fa fa-arrow-circle-right" id="in-column"></a>
              <br />
              <a class="btn fa fa-arrow-circle-left" id="out-column"></a>
            </td>
            <td>
              <select id="selected-columns" multiple="multiple" name="selected_columns"></select>
            </td>
            <td class="up-down-column">
              <a class="btn fa fa-arrow-circle-up" id="up-column"></a>
              <br />
              <a class="btn fa fa-arrow-circle-down" id="down-column"></a>
            </td>
          </tr>
        </tbody>
      </table>
      </form>
      <a id="clear-setting-area" class="btn">選択をクリア</a>
    </div>
  </div>
</div>

<script type="text/javascript">
    var patterns = ${patterns_js|n};

    /* パターンにcolumnの登録/削除を変更 */
    function move_columns(src_selector, dst_selector){
        var src_columns = $(src_selector);
        var dst_columns = $(dst_selector);

        var src_options = src_columns.find('option:selected');
        src_options.each(function (ii, src_option){
            var new_option = $('<option value=""></option>');
            new_option\
                .attr('value', src_option.value)\
                .text(src_option.text)\
                .appendTo(dst_columns);
            src_option.remove();
        });
    }

    /* columnの出力順序を変更*/
    function move_column_order(selector, direction){
        var columns = $(selector);
        var options = columns.find('option:selected');

        var move = function(option){
            if (direction == 'up'){
                $(option).prev().before(option);
            }else if(direction == 'down'){
                $(option).next().after(option);
            }else{
                console.log('ValueError: unexpected argument value(direction): ' + direction);
            }
        }

        options.each(function (ii, option){
            move(option);
        });
    }

    /* selected columnsの内容をクリアする */
    function clear_selected_columns() {
        var selected_item = $('#selected-columns option').remove();
        selected_item.appendTo('#available-columns');
    }

    /* 操作内容をajaxでbackendに送って、backendの処理結果によってsuccess_funcかerror_funcを実行する */
    function post_pattern(post_content, success_func, error_func) {
      $.ajax({
        url: "${request.route_url('orders.delta.pattern.operate')}",
        type: "POST",
        data: post_content,
        success: function(json) {
          success_func(json);
        },
        error: function(json) {
          error_func(json);
        }
      });
    }

    $(document).ready(function() {
        /* 最初にアクセスするか再読み込む時の初期化 */
        $('select#saved-patterns').val("");
        $('input#pattern-name').val("");
        clear_selected_columns();


        /* columnの追加 */
        $('#in-column').on('click', function(event){
            move_columns('#available-columns', '#selected-columns');
            $('select#saved-patterns').val("");
        });

        /* columnの削除 */
        $('#out-column').on('click', function(event){
            move_columns('#selected-columns', '#available-columns');
            $('select#saved-patterns').val("");
        });

        /* columnの順序を1つ前にする */
        $('#up-column').on('click', function(event){
            move_column_order('#selected-columns', 'up');
            $('select#saved-patterns').val("");
        });

        /* columnの順序を1つ後ろにする */
        $('#down-column').on('click', function(event){
            move_column_order('#selected-columns', 'down');
            $('select#saved-patterns').val("");
        });

        /* クリアボタン */
        $('#clear-setting-area').on('click', function() {
            $('select#saved-patterns').val("");
            $('input#pattern-name').val("");
            clear_selected_columns();
        });

        /* ブルダウンの選択された項目に紐づく項目をselected columnsに入れる */
        $('select#saved-patterns').on('change', function() {
            clear_selected_columns();
            var pattern_name = $(this).val();
            $('#pattern-name').val(pattern_name);

            if (pattern_name in patterns) {
                var saved_options = patterns[pattern_name];
                saved_options.forEach(function(val) {
                    var option = $('#available-columns option').filter(function() {return this.value === val}).remove();
                    option.appendTo($('#selected-columns'));
                });
            }
        });

        /* 操作 */
        /* パターンの新規登録 */
        $('a#add-pattern').on('click', function() {

            var pattern_name = $('input#pattern-name').val().trim();

            if (!pattern_name) {
                alert("保存するパターン名を記入ください。");
                $('#pattern_name').val("");
                return;
            } else if (pattern_name in patterns) {
                alert("保存したいパターン名はすでに存在していますので、別のパターン名を設定か「上書き保存」ボタンで保存してください。");
                return;
            }

            if ($('#selected-columns option').length === 0) {
                alert("ダウンロード項目を選んでください。");
                return;
            }

            var selected_items = "";
            $('#selected-columns option').each( function () {
                selected_items += $(this).val() + ",";
            });

            var post_content = {
                'organization_id': ${request.context.organization.id},
                'pattern_name': pattern_name,
                'pattern_content': selected_items,
                'op_type': 'add'
            };

            post_pattern(post_content,
                function(json) {
                    patterns[pattern_name] = json[pattern_name];
                    var option = $('<option value=' + pattern_name + '>' + pattern_name + '</option>');
                    option.appendTo($('select#saved-patterns'));
                    $('select#saved-patterns').val(pattern_name);
                    alert("ダウンロードパターンを追加しました。");
                },
                function(json) {
                    alert("ダウンロードパターンの追加が失敗しました。");
                    console.log(json["emsg"]);
                }
            );
        });

        /* パターンの更新 */
        $('a#update-pattern').on('click', function() {
            var pattern_name = $('input#pattern-name').val().trim();
            if (!pattern_name) {
                alert("更新したいパターン名を設定してから更新してください。");
                return;
            } else if (!pattern_name in patterns) {
                alert("更新したいパターンの記録はないため、新規登録で登録してください。");
                $('select#saved-patterns').val("");
                return;
            } else {
                var res = window.confirm("パターン「" + pattern_name + "」を更新しますか？");
                if (res == false) { return; }
            }

            if ($('#selected-columns option').length === 0) {
                alert("ダウンロード項目を選んでください。");
                return;
            }

            var selected_items = "";
                $('#selected-columns option').each( function () {
                selected_items += $(this).val() + ",";
            });

            var post_content = {
                'organization_id': ${request.context.organization.id},
                'pattern_name': pattern_name,
                'pattern_content': selected_items,
                'op_type': 'update'
            };

            post_pattern(post_content,
                function(json) {
                    patterns[pattern_name] = json[pattern_name];
                    alert("ダウンロードパターンを更新しました。");
                    $('select#saved-patterns').val(pattern_name);
                },
                function(json) {
                    alert("ダウンロードパターンの更新が失敗しました。");
                    console.log(json["emsg"]);
                }
            );

        });

        /* パターンの削除 */
        $('a#del-pattern').on('click', function() {
            var pattern_name = $('select#saved-patterns').val().trim();

            if (!pattern_name) {
                alert("パターンを選んでから削除してください。");
                $('select#saved-patterns').val("");
                return;
            } else {
                var res = window.confirm("パターン「" + pattern_name + "」を削除しますか？");
                if (res == false) { return; }
            }
            var post_content = {
                "organization_id": ${request.context.organization.id},
                "pattern_name": pattern_name,
                'op_type': 'del'
            }

            post_pattern(post_content,
                function(json) {
                    delete patterns[pattern_name];
                    $('select#saved-patterns option[value="' + pattern_name + '"]').remove();
                    $('select#saved-patterns').val("");
                    $('input#pattern-name').val("");
                    clear_selected_columns()
                    alert("ダウンロードパターン「" + pattern_name + "」を削除しました。");
                },
                function(json) {
                    alert("ダウンロードパターンの削除が失敗しました。");
                    console.log(json["emsg"]);
                }
            );

        });
    });
</script>