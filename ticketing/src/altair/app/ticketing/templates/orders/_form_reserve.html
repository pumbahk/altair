<%page args="form, seats" />
<%namespace file="/common/helpers.html" name="ch" />

<style type="text/css">
  #modal-reserve .product_quantity {
    width: 80px;
    padding: 2px;
    margin: 0;
  }
  #modal-reserve input {
    width: 120px;
  }
  #modal-reserve .form-horizontal .control-group {
    margin-bottom: 5px;
  }
  #modal-reserve .form-horizontal ul {
    padding-top: 5px;
  }
</style>

<script type="text/javascript">
  $(function() {
    if (window.ticketPrinterService) {
      var pm_id = ${form.get_defalut_sales_counter_payment_method()};
      if (pm_id) $('#sales_counter_payment_method_id').val(pm_id);
    }
    % if seats:
    if ($('[id^=product_quantity]').length == 1) {
      $('[id^=product_quantity]:first').val(${len(seats)});
    }
    % endif
    $('#payment_delivery_method_pair_id').change(function(){
      var shipping_address = $('.shipping-address');
      if ($.inArray(parseInt($(this).val()), ${form.payment_delivery_method_pair_id.sej_plugin_id}) == -1) {
        shipping_address.css('display', 'none');
      } else {
        shipping_address.css('display', 'block');
      }
    }).change();
    $('.draggable').draggable({scroll: true, handle:$('.draggable .modal-header')});
    $('#modal-reserve').disableOnSubmit();

    // pager (see:templates/performances/_reservation.html)
    pager = new Pager("#modal-reserve", "reserve");
    pager.$el.find("#reserve-tab").on("click", function(){pager.next("reserve");});
    pager.$el.find("#reserve-next").on("click", function(){pager.next("memo");});
    pager.$el.find("#memo-tab").on("click", function(){pager.next("memo");});
    pager.$el.find("#memo-prev").on("click", function(){pager.next("reserve");});
    $("#modal-reserve").bind("*onFailure", function(){pager.next("reserve");});
  });
</script>

<div id="modal-reserve" class="modal hide draggable">
  <div class="modal-header">
    <h3>予約する -- ${performance.event.title}[${performance.name}]</h3>
  </div>

  <div class="modal-body">
    <%doc>
    wizard形式にする前にタブ化する
    [購入情報入力|文言・メモ入力|購入情報確認|文言・メモ入力確認]
    </%doc>

    <ul class="nav nav-tabs" style="margin-bottom:10px;">
      <li class="active"><a id="reserve-tab">購入情報入力</a></li>
      <li><a id="memo-tab">文言・メモ入力</a></li>
      <li><a>購入情報確認</a></li>
      <li><a>文言・メモ入力確認</a></li>
    </ul>

    ${ch.alert_message(form)}

    <form class="form-horizontal" action="javascript:confirmOrder();">
    <div class="memo-area" style="display:none">
      ${ch.form_item(form.note, rows=3, class_='span10')}
      %for field in form_order_edit_attribute:
        ${ch.form_item(field, class_='span10', style="width:80%")}
      %endfor
    </div>
    <div class="reserve-area">
      % if form.products.choices:
      <script type="text/javascript">
        $(function() {
          var product_quantity = [];
          % for product in form.products.choices:
            var el = 'input[name="product_quantity-${product[0]}"]';
            product_quantity.push(el);
            $(el).data('price', ${product[1]['price']}).addClass('product_quantity');
          % endfor
          product_quantity = $(product_quantity.join(','));

          product_quantity.focusout(function(){
            var total_price = 0;
            var total_quantity = 0;
            product_quantity.each(function () {
              var price = $(this).data('price');
              var quantity = parseInt($(this).val());
              quantity = (isNaN(quantity) || quantity < 0) ? 0 : quantity;
              total_price += price * quantity;
              total_quantity += quantity;
            });

            total_price = String(total_price);
            while(total_price != (total_price = total_price.replace(/^(-?\d+)(\d{3})/, "$1,$2")));

            $('span[name="total-price"]').text(total_price + '円');
            $('span[name="total-quantity"]').text(total_quantity);
          });
        });
      </script>
      <table class="table table-striped table-bordered">
        <tr>
          <th>商品</th>
          <th>単価</th>
          <th style="width: 80px;">個数</th>
        </tr>
        % for product in form.products.choices:
        <tr>
          <td>${product[1]['name']} (${product[1]['sales_segment']})</td>
          <td>${vh.price(product[1]['price'])}</td>
          <td><input id="product_quantity-${product[0]}" name="product_quantity-${product[0]}" type="text" value=""></td>
        </tr>
        % endfor
        <tr>
          <td>合計</td>
          <td><span name="total-price"></span></td>
          <td><span name="total-quantity"></span></td>
        </tr>
      </table>
      % endif

      <div class="control-group">
        <label class="control-label">予約する座席 (${u'座席指定 %s席' % len(seats) if seats else u'おまかせ'})</label>
        <div class="controls">
          <ul>
            % for seat in seats:
            <li>${seat.name}</li>
            % endfor
          </ul>
        </div>
      </div>

      <script type="text/javascript">
        $(function(){
          $("#modal-reserve select[name='sales_segment_id']").change(function(){
            var modal = $('#modal-reserve');
            modal.find('.modal-body .alert').remove();
            var params = {performance_id: ${performance.id}, sales_segment_id: $(this).val()};
            $.ajax({
              type: 'post',
              url: '${request.route_path('orders.reserve.form.reload')}',
              data: JSON.stringify(params),
              dataType: 'html',
              success: function(data) {
                $('#modal-reserve').modal('hide');
                $('#reserve-form').html(data);
                $('#modal-reserve').modal({'backdrop':'static', 'keyboard':false});
                $('#modal-reserve').modal('show');
              },
              error: function(xhr, text) {
                $('#modal-reserve').find('.modal-body').prepend('<div class="alert alert-error"><ul>エラーが発生しました</ul></div>');
              }
            });
          });
        });
      </script>
      ${ch.form_item(form.sales_segment_id, class_='span10')}
      ${ch.form_item(form.payment_delivery_method_pair_id, class_='span10')}
      <div class="shipping-address">
        <div class="control-group">
          <div class="controls">
            <p style="color: #BA0000;">※ コンビニ決済およびコンビニ受取は、払込票番号・引換票を発行する為に購入者情報が必要です。</p>
          </div>
        </div>
        <div class="control-group">
          <label class="control-label">氏名</label>
          <div class="controls">
            ${form.last_name}
            ${form.first_name}
          </div>
        </div>
        <div class="control-group">
          <label class="control-label">氏名(カナ)</label>
          <div class="controls">
            ${form.last_name_kana}
            ${form.first_name_kana}
          </div>
        </div>
        ${ch.form_item(form.tel_1)}
      </div>

      ${ch.form_item(form.sales_counter_payment_method_id, class_='span10')}
      <div class="control-group">
        <div class="controls">
          <p>※ 当日窓口決済を選択すると、予約のステータスが「入金済み」になります</p>
        </div>
      </div>
      ${ch.form_item(form.performance_id)}
    </div>
    </form>
  </div>

  <div class="modal-footer">
    <div class="reserve-area">
      <button onclick="javascript:reselectOrder(); return false;" class="btn secondary btn-close">戻る</button>
      <button id="reserve-next" class="btn danger">メモ・文言を設定する</button>
      <button onclick="$('#modal-reserve').find('form').submit(); return false;" class="btn danger">確認する</button>
    </div>
    <div class="memo-area" style="display:none">
      <button id="memo-prev" class="btn secondary btn-close">戻る</button>
      <button onclick="$('#modal-reserve').find('form').submit(); return false;" class="btn danger">確認する</button>
    </div>
  </div>
</div>
