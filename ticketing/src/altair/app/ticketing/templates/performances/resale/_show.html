<%page args="performance, stats" />
<%namespace file="/common/helpers.html" name="ch" />
<%namespace file="_helpers.html" name="rh" />

<style type="text/css">
  ul {
    list-style: none;
    margin: 0 auto;
    padding: 0;
  }
  .resale-segment-list-box {
    padding: 0;
    margin: 20px auto;
  }
  .resale-segment-list-box ul li * {
    display: inline-block;
  }
  /* modal-bg */
  #modal-bg {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100vw;
    height: 100vh;
    background: #000;
    opacity: 0.3;
  }
  /* modal-error-msgs-box */
  .modal-error-msgs-box {
    padding: 0;
    margin: 10px auto;
    text-align: center;
  }
  .modal-error-msgs-box ul li {
    color: #b94a48;
    font-weight: bold;
    font-size: 1rem;
  }
  /* request-search */
  .request-search-nav {
    margin-left: 0 !important;
  }
  .request-search-nav .navbar-text:not(:first-child) {
    margin-left: 5px !important;
  }
  /* resale-request-list-box */
  .resale-request-list-box table {
    table-layout: fixed;
  }
  .resale-request-list-box table thead th {
    white-space: nowrap;
  }
  /* modal-resale-request */
  .modal-resale-request-bank-info table th {
    width: 50%;
  }
  /* modal-resale-request-export */
  .modal-resale-request-export table th:first-child {
    width: 30%;
  }
  /* unknow exception modal */
  .modal-unknown-exception .modal-body-content h4 {
    color: #b94a48;
    font-weight: bold;
    font-size: 1rem;
  }
</style>

<div id="main">
  <div class="title">
    <h4>リセール詳細</h4>
  </div>
  <div class="content">
    <div class="wrap-content">
      <div class="resale-segment-list-box">
        % if not resale_segments:
        <button onclick="open_modal_create_or_update_resale_segment($(this), 'create')" class="btn btn-important resale-segment-add-btn"><i class="icon-plus"></i>登録</button>
        % endif
        <ul id="resale-segment-list" data-selected_resale_segment_id="${selected_resale_segment_id}">
          <li class="resale-segment-message-box"></li>
          % for resale_segment in resale_segments:
          <li class="resale-segment-detail-box">
            ${rh.build_resale_segment_content(resale_segment)}
          </li>
          % endfor
        </ul>
      </div>
      <hr/>

      <div class="title">
        <h4>リセールリクエストリスト</h4>
      </div>
      <div class="navbar span5 request-search-nav">
        <div class="navbar-inner">
          <div class="container">
            <form method="get" class="navbar-search pull-left form-inline">
              <div>
                <span class="navbar-text">
                  ${search_form.order_no.label}
                  ${search_form.order_no(class_="search-query input-medium")}
                </span>
                <button type="submit">検索</button>
                <button type="button" onclick="open_modal_export_bank_info()">エクスポート</button>
              </div>
              <div>
                <span class="navbar-text">
                  <strong>ステータス：</strong>
                </span>
                <span class="navbar-text">
                  ${search_form.waiting.label}
                  ${search_form.waiting(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.sold.label}
                  ${search_form.sold(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.back.label}
                  ${search_form.back(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.cancel.label}
                  ${search_form.cancel(class_="search-query input-medium")}
                </span>
              </div>
              <div>
                <span class="navbar-text">
                  <strong>連携ステータス：</strong>
                </span>
                <span class="navbar-text">
                  ${search_form.not_sent.label}
                  ${search_form.not_sent(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.sent.label}
                  ${search_form.sent(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.fail.label}
                  ${search_form.fail(class_="search-query input-medium")}
                </span>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="clearfix"></div>
      % if resale_requests:
      <div class="resale-request-list-box">
        <table class="table table-striped table-bordered">
          <thead>
          <tr>
              <th>
                  ステータス
              </th>
              <th>
                  リクエスト日時
              </th>
              <th>
                  予約番号
              </th>
              <th >
                  席種
              </th>
              <th>
                  商品明細名
              </th>
              <th>
                  座席名
              </th>
              <th>
                  リセール振込情報
              </th>
          </tr>
          </thead>
          <tbody>
          % for (resale_request, ordered_product_item_token) in resale_requests:
          <%
          order = ordered_product_item_token.item.ordered_product.order
          %>
          <tr id="resale-request-${resale_request.id}" data-resale_request_id="${resale_request.id}" data-status="${resale_request.status}">
            <td>
              ${rh.build_resale_request_status_content(resale_request)}
            </td>
            <td>
              ${resale_request.created_at}
            </td>
            <td>
              <a target="_blank" href="${request.route_path('orders.show', order_id=order.id)}">${order.order_no}</a>
            </td>
            <td>
              ${ordered_product_item_token.item.product_item.stock_type.name}
            </td>
            <td>
              ${ordered_product_item_token.item.product_item.name}
            </td>
            <td>
              <% seat_name = ordered_product_item_token.seat.name if ordered_product_item_token.seat else "-" %>
              ${seat_name}
            </td>
            <td>
              <button onclick="open_modal_show_bank_info(${resale_request.id})"><i class="icon-th-list"></i></button>
            </td>
          </tr>
          % endfor
          </tbody>
        </table>
      </div>
        ${ch.pager(resale_requests)}
      % else:
      <div>
        <h4>リセールリクエストリストの情報は見つかりませんでした。</h4>
      </div>
      % endif
    </div>
  </div>
</div>

<!-- modals -->
<div id="modal-bg" class="hide"></div>
<div id="base-modal" class="modal hide">
  <div class="modal-header">
    <h3></h3>
  </div>
  <div class="modal-body">
    <div class="wrap-modal-body">
      <div class="modal-error-msgs-box"><ul class="hide"></ul></div>
      <div class="modal-body-content"></div>
    </div>
  </div>
  <div class="modal-footer">
    <div class="btn-area">
    </div>
  </div>
</div>
<!-- modals -->
<!-- templates -->
<div id="reuse-box" class="hide">
<form id="reuse-item-1" class="form-horizontal" method="POST">
  ${ch.form_item(form.resale_segment_id)}
  ${ch.form_item(form.performance_id)}
  ${ch.form_item(form.resale_start_at)}
  ${ch.form_item(form.resale_end_at)}
  ${ch.form_item(form.start_at)}
  ${ch.form_item(form.end_at)}
</form>
<form id="reuse-item-2" class="form-horizontal" method="POST">
  ${ch.form_item(form.resale_segment_id)}
  ${ch.form_item(form.performance_id)}
  ${ch.form_item(form.resale_performance_id)}
  <input type="hidden" name="start_at">
  <input type="hidden" name="end_at">
</form>
</div>

<h5 id="resale-segment-li-template"></h5>

<div id="resale-request-btn-group-template-1" class="btn-group hide">
  <button class="btn btn-small btn-reset" onclick="operate_resale_request($(this), 'waiting')">リセット</button>
  <button class="btn btn-small btn-warning btn-send" onclick="open_modal_send_resale_request_to_orion($(this), false)">連携</button>
</div>
<div id="resale-request-btn-group-template-2" class="btn-group hide">
  <button class="btn btn-small btn-primary" onclick="operate_resale_request($(this), 'sold')">リセール</button>
  <button class="btn btn-small btn-info" onclick="operate_resale_request($(this), 'back')">返却</button>
  <button class="btn btn-small btn-danger" onclick="operate_resale_request($(this), 'cancel')">キャンセル</button>
</div>
<!-- templates -->

<script type="text/javascript">
  // --- common start ---
  if (String.prototype.format === undefined) {
      String.prototype.format = function(arg) {
          let rep_fn = undefined;
          if (typeof arg === "object") {
              rep_fn = function(m, k) { return arg[k]; };
          } else {
              let args = arguments;
              rep_fn = function(m, k) { return args[parseInt(k)]; };
          }
          return this.replace(/\{(\w+)\}/g, rep_fn);
      }
  }

  function concat_datetime(y, m, d, H, M, S) {
      if (!y && !m && !d && !H && !M) {return null;}
      if (!H) {H = "00"}
      if (!M) {M = "00"}
      if (!S) {S = "00"}
      return "{0}-{1}-{2} {3}:{4}:{5}".format(y, m, d, H, M, S);
  }

  function split_datetime(datetime) {
      let items = datetime.split(' '),
          date = items[0],
          time = items[1],
          ret = {};

      items = date.split('-');
      ret['y'] = items[0];
      ret['m'] = items[1];
      ret['d'] = items[2];

      items = time.split(':');
      ret['H'] = items[0];
      ret['M'] = items[1];
      ret['S'] = items[2];

      return ret;
  }

  function get_current_local_datetime() {
      let now = new Date();
      return concat_datetime(
          now.getFullYear(),
          now.getMonth() + 1,
          now.getDate(),
          now.getHours(),
          now.getMinutes(),
          now.getSeconds()
      )
  }

  function flush_result_message(message) {
      let element = $(".resale-segment-message-box");
      element.empty();
      element.append(
          $("<div>").addClass("flushed_msgs")
              .append($("<h4>").text(message).css("color", "#b94a48").css("margin", "0"))
              .append($("<i>").addClass("icon-remove-sign"))
              .on('click', function () {
                  this.remove();
              })
          )
  }

  function handle_exception(xhr) {
      let ret = {},
          status = "",
          emsgs = "";

      try {
          ret = JSON.parse(xhr.responseText);
      } catch (e) {
          status = xhr.status;
          if (status === 404) {
              emsgs = "該当内容は見つかりませんでした。"
          } else if (status === 500) {
              emsgs = "システムエラーでした。"
          } else {
              emsgs = xhr.statusText;
          }
          ret = {
              "status": status,
              "emsgs": emsgs
          };
      }

      return ret;
  }
  // --- common end ---

  // --- modal start ---
  function clear_modal_error_messages(modal) {
      modal.find(".modal-error-msgs-box ul").empty().hide();
      modal.find(".control-group").removeClass("error");
  }
  function clear_model_content(modal) {
      clear_modal_error_messages(modal);
      modal.find("[id^=reuse-item-]").each(function () {
          $(this).detach().appendTo("#reuse-box");
      });
      modal.find(".modal-header h3").text("");
      modal.find(".modal-body-content").empty();
      modal.find(".btn-area").empty();
      modal.removeAttr("class").addClass("modal");
  }
  function open_modal() {
      let modal = $("#base-modal");
      modal.find("button").on("click", function() {$(this).attr("disabled", true)});
      modal.show();
      $("#modal-bg").show();
  }
  function close_modal() {
      let modal = $("#base-modal");
      clear_model_content(modal);
      modal.hide();
      $("#modal-bg").hide();
  }

  //// modal for creating or updating resale segment
  function open_modal_create_or_update_resale_segment(button, action) {
      let modal = $("#base-modal"),
          header_text = action === "create"? "リセール区分追加":"リセール区分編集",
          onclick_method = action === "create"? "create_resale_segment()":"update_resale_segment()",
          form = $("#reuse-item-1").detach(),
          data = undefined,
          resale_start_at = undefined,
          resale_end_at = undefined,
          start_at = undefined,
          end_at = undefined;

      if (action === "update") {
          data = $(".resale-segment__info").data();
          form.find("#resale_segment_id").val(data['resale_segment_id']);

          if (data['resale_start_at'] !== undefined) {
            resale_start_at = split_datetime(data['resale_start_at']);
            form.find("#resale_start_at\\.year").val(resale_start_at.y);
            form.find("#resale_start_at\\.month").val(resale_start_at.m);
            form.find("#resale_start_at\\.day").val(resale_start_at.d);
            form.find("#resale_start_at\\.hour").val(resale_start_at.H);
            form.find("#resale_start_at\\.minute").val(resale_start_at.M);
            form.find("#resale_start_at\\.second").val(resale_start_at.S);
          }

          if (data['resale_end_at'] !== undefined) {
            resale_end_at = split_datetime(data['resale_end_at']);
            form.find("#resale_end_at\\.year").val(resale_end_at.y);
            form.find("#resale_end_at\\.month").val(resale_end_at.m);
            form.find("#resale_end_at\\.day").val(resale_end_at.d);
            form.find("#resale_end_at\\.hour").val(resale_end_at.H);
            form.find("#resale_end_at\\.minute").val(resale_end_at.M);
            form.find("#resale_end_at\\.second").val(resale_end_at.S);
          }

          start_at = split_datetime(data['start_at']);
          end_at = split_datetime(data['end_at']);

          form.find("#start_at\\.year").val(start_at.y);
          form.find("#start_at\\.month").val(start_at.m);
          form.find("#start_at\\.day").val(start_at.d);
          form.find("#start_at\\.hour").val(start_at.H);
          form.find("#start_at\\.minute").val(start_at.M);
          form.find("#start_at\\.second").val(start_at.S);

          form.find("#end_at\\.year").val(end_at.y);
          form.find("#end_at\\.month").val(end_at.m);
          form.find("#end_at\\.day").val(end_at.d);
          form.find("#end_at\\.hour").val(end_at.H);
          form.find("#end_at\\.minute").val(end_at.M);
          form.find("#end_at\\.second").val(end_at.S);
      }
      modal.find(".modal-header h3").text(header_text);
      modal.find(".modal-body-content").append(form);
      modal.find(".btn-area")
          .append($("<button onclick='close_modal()' class='btn secondary btn-close'>キャンセル</button>"))
          .append($("<button class='btn btn-danger'>保存</button>").attr("onclick", onclick_method));
      open_modal();
  }

  //// modal for creating or updating resale performance id
  function open_modal_create_or_update_resale_performance(button, action) {
      var modal = $("#base-modal"),
          header_text = action === "create"? "リセール公演登録":"リセール公演編集",
          onclick_method = "add_or_update_resale_performance_id()",
          form = $("#reuse-item-2").detach(),
          data = $(".resale-segment__info").data();

          form.find("#resale_segment_id").val(data['resale_segment_id']);
          form.find("input[name=start_at]").val(data['start_at']);
          form.find("input[name=end_at]").val(data['end_at']);

      if (action === "update") {
          form.find("#resale_performance_id").val(data['resale_performance_id']);
      }
      modal.find(".modal-header h3").text(header_text);
      modal.find(".modal-body-content").append(form);
      modal.find(".btn-area")
          .append($("<button onclick='close_modal()' class='btn secondary btn-close'>キャンセル</button>"))
          .append($("<button class='btn btn-danger'>確認</button>").attr("onclick", onclick_method));
      open_modal();
  }

  //// modal for showing bank information of a resale request
  function open_modal_show_bank_info(resale_request_id) {
      var modal = $("#base-modal");
      modal.addClass("modal-resale-request-bank-info");
      modal.find(".modal-header h3").text("リセール振込情報");
      modal.find(".modal-body-content").append(
          $("<table class=\"table table-striped table-bordered\"></table>")
              .append($("<thead><tr><th>項目</th><th>内容</th></tr></thead>"))
              .append($("<tbody></tbody>")
                  .append($("<tr><td>銀行コード</td><td id=\"info-bank_code\"></td></tr>"))
                  .append($("<tr><td>支店コード</td><td id=\"info-bank_branch_code\"></td></tr>"))
                  .append($("<tr><td>口座種別</td><td id=\"info-account_type\"></td></tr>"))
                  .append($("<tr><td>口座番号</td><td id=\"info-account_number\"></td></tr>"))
                  .append($("<tr><td>名義人</td><td id=\"info-account_holder_name\"></td></tr>"))
                  .append($("<tr><td>振込額</td><td id=\"info-total_amount\"></td></tr>"))
              )
      );
      modal.find(".btn-area")
          .append($("<button onclick=\"close_modal()\" class=\"btn secondary btn-close\">閉じる</button>"));
      $.ajax({
          url: "/resale/api/requests/" + resale_request_id,
          type: "GET",
          success: function(data) {
              for (key in data) {
                  if (data.hasOwnProperty(key)) {
                      modal.find("#info-" + key ).text(data[key]);
                  }
              }
              open_modal();
          },
          error: function(xhr) {
              let ret = handle_exception(xhr),
                  modal = $("#base-modal");
                  ul = modal.find(".modal-error-msgs-box ul");

              if ("status" in ret) {
                  ul.append($("<li>").text("{0} - {1}".format(ret["status"],ret["emsgs"])));
              }
              if ("start_at" in ret) {
                  for (var i = 0; i < ret["start_at"].length; i++) {
                      ul.append($("<li>").text(ret["start_at"][i]));
                  }
              }
              ul.show();
              open_modal();
          }
      });
  }

  //// modal for exporting bank information of the resale requests
  function open_modal_export_bank_info() {
      let modal = $("#base-modal"),
          order_no = $("#order_no").val().trim(),
          status_list = get_resale_request_status_verbose(),
          sent_status_list = get_resale_request_sent_status_verbose();

      if (order_no === "") {order_no = "条件なし";}

      modal.addClass("modal-resale-request-export");
      modal.find(".modal-header h3").text("エクスポート");
      modal.find(".modal-body-content")
          .append(
              $("<p>下記の条件でリセールリクエストをエクスポートは大丈夫でしょうか？</p>")
          )
          .append(
              $("<table class=\"table table-striped table-bordered\"></table>")
                  .append($("<thead><tr><th>条件</th><th>内容</th></tr></thead>"))
                  .append($("<tbody></tbody>")
                      .append($("<tr><td>予約番号</td><td id=\"condition-order_no\">{0}</td></tr>".format(order_no)))
                      .append($("<tr><td>ステータス</td><td id=\"condition-status\">{0}</td></tr>".format(status_list.join(','))))
                      .append($("<tr><td>連携ステータス</td><td id=\"condition-sent_status\">{0}</td></tr>".format(sent_status_list.join(','))))
                  )
          );
      modal.find(".btn-area")
          .append($("<button onclick=\"close_modal()\" class=\"btn secondary btn-close\">キャンセル</button>"))
          .append($("<button onclick=\"export_resale_request()\" class=\"btn btn-primary\">エクスポート</button>"));
      open_modal();
  }

  //// modal for sending resale requests to orion
  function open_modal_send_resale_request_to_orion(button, all) {
      let modal = $("#base-modal"),
          resale_segment_id = undefined,
          resale_request_id = undefined;
      if (all) {
          resale_segment_id = button.siblings("h5").data("resale_segment_id");
          modal.find(".modal-header h3").text("リセールリクエスト一括連携");
          modal.find(".modal-body-content").append(
              $("<p>リセールリクエスト一括連携したら、対象のリセールリクエストのステータスを変更できなくなります。</p>")
          );
          modal.find(".btn-area")
          .append($("<button onclick=\"close_modal()\" class=\"btn secondary btn-close\">キャンセル</button>"))
          .append($("<button onclick=\"send_all_resale_request_to_orion({0})\" class=\"btn btn-danger send-to-orion\">連携</button>".format(resale_segment_id)));
      } else {
          resale_request_id = button.parents("tr").data("resale_request_id");
          modal.find(".modal-header h3").text("リセールリクエスト連携");
          modal.find(".modal-body-content").append(
              $("<p>リセールリクエスト連携したら、該当リセールリクエスト（ID: {0}）のステータスを変更できなくなります。</p>".format(resale_request_id))
          );
          modal.find(".btn-area")
          .append($("<button onclick=\"close_modal()\" class=\"btn secondary btn-close\">キャンセル</button>"))
          .append($("<button onclick=\"send_resale_request_to_orion({0})\" class=\"btn btn-danger\">連携</button>".format(resale_request_id)));
      }
      open_modal();
  }

  //// modal for unknown exception notification
  function open_modal_unknown_exception_notification(ret) {
      let modal = $("#base-modal");
      close_modal();
      modal.addClass("modal-unknown-exception");
      modal.find(".modal-header h3").text("予想外エラーが発生してしまいました。");
      modal.find(".modal-body-content").empty().append($("<h4>{0} - {1}</h4>".format(ret['status'], ret['emsgs'])));
      modal.find(".btn-area")
          .append($("<button onclick=\"close_modal()\" class=\"btn secondary btn-close\">確定</button>"));
      open_modal();
  }

  // --- modal end ---

  // --- operation functions start ---
  function update_send_button_status(button, status) {
      if (status === "sent") {
          button.removeClass("btn-danger btn-warning");
          button.addClass("btn-inverse");
          button.attr("disabled", true);
          button.html("<i class=\"icon-refresh icon-white\"></i>連携済み");
      } else if (status === "send_required") {
          button.removeClass("btn-warning btn-inverse");
          button.addClass("btn-danger");
          button.attr("disabled", false);
          button.html("<i class=\"icon-refresh icon-white\"></i>再連携必須");
      } else {
          button.removeClass("btn-warning btn-inverse");
          button.addClass("btn-danger");
          button.attr("disabled", false);
          button.html("<i class=\"icon-refresh icon-white\"></i>連携失敗");
      }
  }

  function update_display(resale_segment_id, resale_performance_id, resale_start_at, resale_end_at, start_at, end_at) {

    let li = $(".resale-segment-detail-box");
    li.empty();

    let h5_temp = $("#resale-segment-li-template").clone().removeAttr("id").removeClass("hide");

    h5_temp.attr("id", "resale-segment-" + resale_segment_id)
      .attr("class", "resale-segment__info")
      .data('resale_segment_id', resale_segment_id)
      .data('resale_performance_id', resale_performance_id)
      .data('resale_start_at', resale_start_at)
      .data('resale_end_at', resale_end_at)
      .data('start_at', start_at)
      .data('end_at', end_at);

    let buttonDom = $("<li>")
        .append($("<button class=\"btn\" onclick=\"open_modal_create_or_update_resale_segment($(this), 'update')\"><i class=\"icon-pencil\"></i>編集</button>\n"));

    if (resale_performance_id) {
        buttonDom.append($("<button class=\"btn\" onclick=\"open_modal_create_or_update_resale_performance($(this), 'update')\"><i class=\"icon-pencil\"></i>リセール公演ID編集</button>\n"));
    } else {
        buttonDom.append($("<button class=\"btn\" onclick=\"open_modal_create_or_update_resale_performance($(this), 'create')\"><i class=\"icon-pencil\"></i>リセール公演ID登録</button>\n"));
    }

    buttonDom.append($("<button class=\"btn btn-warning btn-send\" onclick=\"send_resale_segment_to_orion($(this))\"><i class=\"icon-refresh icon-white\"></i>連携</button>"));

    let content = $("<ul style=\"display:table\">")
        .append($("<li style=\"display:table-row\">リセール開始日時：" + resale_start_at + "</li>"))
        .append($("<li style=\"display:table-row\">リセール終了日時：" + resale_end_at + "</li>"))
        .append($("<li style=\"display:table-row\">申込開始日時：" + start_at + "</li>"))
        .append($("<li style=\"display:table-row\">申込終了日時：" + end_at + "</li>"))
        .append($("<br/>"))
        .append(buttonDom);

    if (resale_performance_id) {
        content.prepend($("<li style=\"display:table-row\">リセール連携公演ID：{0}</li>".format(resale_performance_id)))
    }

    h5_temp.append(content);
    h5_temp.appendTo(li);
  }

  function create_data_from_dom(form) {
      return {
            "performance_id": parseInt(form.find("#performance_id").val()),
            "resale_start_at": concat_datetime(
                form.find("#resale_start_at\\.year").val(),
                form.find("#resale_start_at\\.month").val(),
                form.find("#resale_start_at\\.day").val(),
                form.find("#resale_start_at\\.hour").val(),
                form.find("#resale_start_at\\.minute").val()),
            "resale_end_at": concat_datetime(
                form.find("#resale_end_at\\.year").val(),
                form.find("#resale_end_at\\.month").val(),
                form.find("#resale_end_at\\.day").val(),
                form.find("#resale_end_at\\.hour").val(),
                form.find("#resale_end_at\\.minute").val()),
            "start_at": concat_datetime(
                form.find("#start_at\\.year").val(),
                form.find("#start_at\\.month").val(),
                form.find("#start_at\\.day").val(),
                form.find("#start_at\\.hour").val(),
                form.find("#start_at\\.minute").val()),
            "end_at": concat_datetime(
                form.find("#end_at\\.year").val(),
                form.find("#end_at\\.month").val(),
                form.find("#end_at\\.day").val(),
                form.find("#end_at\\.hour").val(),
                form.find("#end_at\\.minute").val())
          };
  }

  function create_resale_segment() {
      let modal = $("#base-modal"),
          form = modal.find("form"),
          url = "/resale/api/segments/create",
          data = create_data_from_dom(form);
      clear_modal_error_messages(modal);

      $.ajax({
          url: url,
          type: "POST",
          data: data,
          success: function(data) {
              $("ul#resale-segment-list").append($("<li class=\"resale-segment-detail-box\"></li>"));
              update_display(data["id"], data["resale_performance_id"], data["resale_start_at"], data["resale_end_at"], data["start_at"], data["end_at"]);
              $(".resale-segment-add-btn").remove();
              flush_result_message("リセールセッグメントが作成されました。");
              close_modal();
          },
          error: function(xhr) {
              let ret = handle_exception(xhr),
                  ul = modal.find(".modal-error-msgs-box ul"),
                  i = undefined;

              if ("status" in ret) {
                  ul.append($("<li>").text("{0} - {1}".format(ret["status"],ret["emsgs"])));
              }
              if ('start_at' in ret) {
                  for (i = 0; i < ret['start_at'].length; i++) {
                      ul.append($("<li>").text(ret['start_at'][i]));
                  }
              }
              if ('end_at' in ret) {
                  for (i = 0; i < ret['end_at'].length; i++) {
                      ul.append($("<li>").text(ret['end_at'][i]));
                  }
              }
              Object.keys(ret).forEach(function(key) {
                  $("label[for=" + key + "]").parents(".control-group").addClass("error");

              });
              ul.show();
              modal.find("button").prop("disabled", false);
          }
      })
  }

  function update_resale_segment() {
      let modal = $("#base-modal");
      let form = modal.find("form");
      let resale_segment_id = form.find("#resale_segment_id").val();
      let url = "/resale/api/segments/{0}/update".format(resale_segment_id);
      let data = create_data_from_dom(form);
      data["sent_status"] = 3;
      data["sent_at"] = get_current_local_datetime();
      clear_modal_error_messages(modal);
      $.ajax({
          url: url,
          type: "PUT",
          data: data,
          success: function(data) {
              update_display(data["id"], data["resale_performance_id"], data["resale_start_at"], data["resale_end_at"], data["start_at"], data["end_at"]);
              update_send_button_status($(".resale-segment-detail-box").find(".btn-send"), 'send_required');
              flush_result_message("リセールセグメントが更新されました。");
              close_modal();
          },
          error: function(xhr) {
              let ret = handle_exception(xhr),
                  ul = modal.find(".modal-error-msgs-box ul"),
                  i = undefined;

              if ("status" in ret) {
                  ul.append($("<li>").text("{0} - {1}".format(ret["status"],ret["emsgs"])));
              }
              if ("start_at" in ret) {
                  for (i = 0; i < ret["start_at"].length; i++) {
                      ul.append($("<li>").text(ret["start_at"][i]));
                  }
              }
              if ("end_at" in ret) {
                  for (i = 0; i < ret["end_at"].length; i++) {
                      ul.append($("<li>").text(ret["end_at"][i]));
                  }
              }
              Object.keys(ret).forEach(function(key) {
                  $("label[for=" + key + "]").parents(".control-group").addClass("error");

              });
              ul.show();
          }
      })
  }

  function add_or_update_resale_performance_id() {
      var modal = $("#base-modal"),
          form = modal.find("form"),
          resale_segment_id = form.find("#resale_segment_id").val(),
          url = "/resale/api/segments/{0}/update".format(resale_segment_id),
          data = {
            "performance_id": parseInt(form.find("#performance_id").val()),
            "resale_segment_id": resale_segment_id,
            "start_at": form.find("input[name=start_at]").val(),
            "end_at": form.find("input[name=end_at]").val(),
            "resale_performance_id": parseInt(form.find("#resale_performance_id").val())
          };

      clear_modal_error_messages(modal);
      $.ajax({
          url: url,
          type: "PUT",
          data: data,
          success: function(data) {
              update_display(data["id"], data["resale_performance_id"], data["resale_start_at"], data["resale_end_at"], data["start_at"], data["end_at"]);
              update_send_button_status($(".resale-segment-detail-box").find(".btn-send"), 'send_required');
              flush_result_message("リセール公演を連携しました。");
              close_modal();
          },
          error: function(xhr) {
              var ret = handle_exception(xhr),
                  ul = modal.find(".modal-error-msgs-box ul"),
                  i = undefined;
              if ("status" in ret) {
                  ul.append($("<li>").text("{0} - {1}".format(ret["status"],ret["emsgs"])));
              }
              if ('resale_performance_id' in ret) {
                  for (i = 0; i < ret['resale_performance_id'].length; i++) {
                      ul.append($("<li>").text(ret['resale_performance_id'][i]));
                  }
              }
              Object.keys(ret).forEach(function(key) {
                  $("label[for=" + key + "]").parents(".control-group").addClass("error");

              });
              ul.show();
              modal.find("button").prop("disabled", false);
          }
      })
  }

  function send_resale_segment_to_orion(button) {
      let resale_segment_id = $(".resale-segment__info").data("resale_segment_id");
      let performance_id = parseInt("${performance.id}");
      let url = "${request.route_path('performances.resale.send_resale_segment_to_orion')}";

      $.ajax({
          url: url,
          type: "POST",
          data: {"performance_id": performance_id, "resale_segment_id": resale_segment_id},
          success: function(data) {
              var success_list = data['success_list'],
                  fail_list = data['fail_list'],
                  send_button = undefined,
                  i = undefined;

              for (i = 0; i < success_list.length; i++) {
                  send_button = $("#resale-segment-" + success_list[i]).find(".btn-send");
                  console.log(send_button);
                  update_send_button_status(send_button, 'sent');
              }
              for (i = 0; i < fail_list.length; i++) {
                  send_button = $("#resale-segment-" + fail_list[i]).find(".btn-send");
                  update_send_button_status(send_button, 'fail');
              }
              flush_result_message("リセールセグメント情報がOrionに送信されました。");
          },
          error: function(xhr) {
              let ret = handle_exception(xhr);
              if (button) {
                  update_send_button_status(button, 'fail');
              } else {
                  $("h5[id*='resale-segment-']").each(function() {
                      let button = $(this).find(".btn-send");
                      update_send_button_status(button, 'fail');
                  })
              }
              flush_result_message(ret);
          }
      });
  }

  function build_status_content(td, action) {
      let span = $('<span class="label"></span>');
      td.empty();
      if (action === "sold") {
          span.addClass("label-success")
              .text("（仮）リセール");
      } else if (action === "back") {
          span.addClass("label-info")
              .text("（仮）返却");
      } else if (action === "cancel") {
          span.addClass("label-important")
              .text("（仮）キャンセル");
      }

      if (action === "waiting") {
          td.append(
              $("#resale-request-btn-group-template-2").clone()
                  .removeAttr("id")
                  .removeClass("hide")
          );
      } else {
          td.append(span).append(" ")
            .append(
                $("#resale-request-btn-group-template-1").clone()
                    .removeAttr("id")
                    .removeClass("hide")
            );
      }
  }

  function operate_resale_request(button, action) {
      let td = button.parents("td"),
          resale_request_id = button.parents("tr").data("resale_request_id"),
          status_code = {"waiting": 1, "sold": 2, "back": 3, "cancel": 4};
      $.ajax({
          url: "${request.route_path('performances.resale.requests.operate')}",
          type: "POST",
          data: {
              "resale_request_id": resale_request_id,
              "action": action
          },
          success: function() {
              build_status_content(td, action);
              td.parent().data("status", status_code[action]);
          },
          error: function(xhr) {
              let ret = handle_exception(xhr);
              open_modal_unknown_exception_notification(ret);
          }
      });
  }

  function send_resale_request_to_orion(resale_request_id) {
      let tr = $("#resale-request-{0}".format(resale_request_id));
      $.ajax({
          url: "${request.route_path('performances.resale.send_resale_request_to_orion')}",
          type: "POST",
          data: {
              "resale_request_id": resale_request_id
          },
          success: function(data) {

              if (data['result'] === "OK") {
                  let span = tr.find("span"),
                      btn_group = tr.find(".btn-group");
                  span.text(span.text().replace("（仮）", ""));
                  btn_group.remove();
              } else {
                  tr.find("button.btn-send").text("連携失敗").removeClass("btn-warning").addClass("btn-danger");
              }
              close_modal();
          },
          error: function(xhr) {
              let ret = handle_exception(xhr);
              open_modal_unknown_exception_notification(ret);
          }
      });
  }

  function send_all_resale_request_to_orion(resale_segment_id) {
      let modal = $("#base-modal"),
          h5 = $("#resale-segment-{0}".format(resale_segment_id));
      $.ajax({
          url: "${request.route_path('performances.resale.send_all_resale_request_to_orion')}",
          type: "POST",
          data: {
              "resale_segment_id": resale_segment_id
          },
          success: function(data) {
              console.log(data);
              if (data['result'] === "OK") {
                  modal.find(".modal-body-content p").text("リセールリクエスト一括連携しました。");
              } else {
                  modal.find(".modal-body-content p").text(data["emsgs"]);
              }
              modal.find("button.send-to-orion")
                  .attr("disabled", false)
                  .text("確認")
                  .attr("onclick", "location.reload()");
          },
          error: function(xhr) {
              let ret = handle_exception(xhr),
                  ul = modal.find(".modal-error-msgs-box ul");
              clear_modal_error_messages(modal);
              ul.append($("<li>").text("{0}".format(ret["emsgs"])));
              ul.show();
              modal.find("button.send-to-orion").remove();
          }
      });
  }

  function get_resale_request_status() {
      let status_list = [];
      if ($("#waiting").is(":checked")) status_list.push(1);
      if ($("#sold").is(":checked")) status_list.push(2);
      if ($("#back").is(":checked")) status_list.push(3);
      if ($("#cancel").is(":checked")) status_list.push(4);
      return status_list;
  }

  function get_resale_request_sent_status() {
      let sent_status_list = [];
      if ($("#not_sent").is(":checked")) sent_status_list.push(1);
      if ($("#sent").is(":checked")) sent_status_list.push(2);
      if ($("#fail").is(":checked")) sent_status_list.push(4);
      return sent_status_list;
  }

  function build_export_url() {
      let baseUrl = "/resale/api/requests/export",
          resale_segment_id = $(".resale-segment-list-box ul").data("selected_resale_segment_id"),
          order_no = $("#order_no").val().trim(),
          status_list = get_resale_request_status(),
          sent_status_list = get_resale_request_sent_status();
      var filter_list = [];

      filter_list.push("filter[resale_segment_id]=" + resale_segment_id);

      if (order_no !== "") {
          filter_list.push("order_no=" + order_no);
      }

      if (status_list.length !== 0) {
          filter_list.push("filter[status]=" + status_list.join(","));
      }

      if (sent_status_list.length !== 0) {
          filter_list.push("filter[sent_status]=" + sent_status_list.join(","));
      }

      return baseUrl + "?" + filter_list.join("&");
  }

  function get_resale_request_status_verbose() {
    let status_list = get_resale_request_status(),
        status_verbose_list = [];

    if (status_list.length === 0) {
      status_verbose_list.push("条件なし")
    } else if (status_list.length === 4) {
      status_verbose_list.push("全部")
    } else {
      if ($("#waiting").is(":checked")) status_verbose_list.push("リセール中");
      if ($("#sold").is(":checked")) status_verbose_list.push("リセール");
      if ($("#back").is(":checked")) status_verbose_list.push("返却");
      if ($("#cancel").is(":checked")) status_verbose_list.push("キャンセル");
    }
      return status_verbose_list;
  }

  function get_resale_request_sent_status_verbose() {
    let sent_status_list = get_resale_request_sent_status(),
        status_verbose_list = [];

    if (sent_status_list.length === 0) {
      status_verbose_list.push("条件なし")
    } else if (sent_status_list.length === 4) {
      status_verbose_list.push("全部")
    } else {
      if ($("#not_sent").is(":checked")) status_verbose_list.push("未連携");
      if ($("#sent").is(":checked")) status_verbose_list.push("連携済み");
      if ($("#fail").is(":checked")) status_verbose_list.push("連携失敗");
    }
    return status_verbose_list;
  }

  function export_resale_request() {
      url = build_export_url();
      close_modal();
      window.location = url;
  }
  // --- operation functions start ---
</script>