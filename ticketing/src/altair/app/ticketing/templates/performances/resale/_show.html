<%page args="performance, stats" />
<%namespace file="/common/helpers.html" name="ch" />
<%namespace file="_helpers.html" name="rh" />

<style>
  ul {
    list-style: none;
    margin: 0 auto;
    padding: 0;
  }
  .resale-segment-list-box {
    padding: 0;
    margin: 20px auto;
  }
  .resale-segment-list-box ul li * {
    display: inline-block;
  }
  /* modal-bg */
  #modal-bg {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100vw;
    height: 100vh;
    background: #000;
    opacity: 0.3;
  }
  /* modal-error-msgs-box */
  .modal-error-msgs-box {
    padding: 0;
    margin: 10px auto;
    text-align: center;
  }
  .modal-error-msgs-box ul li {
    color: #b94a48;
    font-weight: bold;
    font-size: 1rem;
  }
  /* request-search */
  .request-search-nav {
    margin-left: 0 !important;
  }
  .request-search-nav .navbar-text:not(:first-child) {
    margin-left: 5px !important;
  }
  /* resale-request-list-box */
  .resale-request-list-box table thead th {
    white-space: nowrap;
  }
  /* modal-resale-request */
  #modal-resale-request table th {
    width: 50%;
  }
  /* modal-resale-request-export */
  #modal-resale-request-export table th:first-child {
    width: 30%;
  }
</style>

<div id="main">
  <div class="title">
    <h4>リセール</h4>
  </div>
  <div class="content">
    <div class="wrap-content">
      <div class="resale-segment-list-box">
        % if not resale_segments:
        <button onclick="open_resale_segment_form_for_create()" class="btn btn-important resale-segment-add-btn"><i class="icon-plus"></i>登録</button>
        % endif
        <ul>
          % for resale_segment in resale_segments:
          <li>
            ${rh.build_resale_segment_content(resale_segment)}
          </li>
          % endfor
        </ul>
      </div>
      <hr/>

      <div class="title">
        <h4>リセールリクエストリスト</h4>
      </div>
      <div class="navbar span5 request-search-nav">
        <div class="navbar-inner">
          <div class="container">
            <form method="get" class="navbar-search pull-left form-inline">
              <div>
                <span class="navbar-text">
                  ${search_form.order_no.label}
                  ${search_form.order_no(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.account_holder_name.label}
                  ${search_form.account_holder_name(class_="search-query input-medium")}
                </span>
                <button type="submit">検索</button>
                <button type="button" onclick="open_resale_request_export_modal()">エクスポート</button>
              </div>
              <div>
                <span class="navbar-text">
                  <strong>ステータス：</strong>
                </span>
                <span class="navbar-text">
                  ${search_form.waiting.label}
                  ${search_form.waiting(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.sold.label}
                  ${search_form.sold(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.back.label}
                  ${search_form.back(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.cancel.label}
                  ${search_form.cancel(class_="search-query input-medium")}
                </span>
              </div>
              <div>
                <span class="navbar-text">
                  <strong>連携ステータス：</strong>
                </span>
                <span class="navbar-text">
                  ${search_form.not_sent.label}
                  ${search_form.not_sent(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.sent.label}
                  ${search_form.sent(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.send_required.label}
                  ${search_form.send_required(class_="search-query input-medium")}
                </span>
                <span class="navbar-text">
                  ${search_form.fail.label}
                  ${search_form.fail(class_="search-query input-medium")}
                </span>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="clearfix"></div>
      % if resale_requests:
      <div class="resale-request-list-box">
        <table class="table table-striped table-bordered">
          <thead>
          <tr>
              <th>
                  ステータス
              </th>
              <th>
                  リクエスト日時
              </th>
              <th>
                  予約番号
              </th>
              <th >
                  席種
              </th>
              <th>
                  商品明細名
              </th>
              <th>
                  座席名
              </th>
              <th>
                  リセール振込情報
              </th>
          </tr>
          </thead>
          <tbody>
          % for (resale_request, ordered_product_item_token) in resale_requests:
          <%
          order = ordered_product_item_token.item.ordered_product.order
          %>
          <tr id="resale-request-${resale_request.id}" data-resale_request_id="${resale_request.id}" data-status="${resale_request.status}">
            <td>
              ${rh.build_resale_request_status_content(resale_request)}
            </td>
            <td>
              ${resale_request.created_at}
            </td>
            <td>
              <a target="_blank" href="${request.route_path('orders.show', order_id=order.id)}">${order.order_no}</a>
            </td>
            <td>
              ${ordered_product_item_token.item.product_item.stock_type.name}
            </td>
            <td>
              ${ordered_product_item_token.item.product_item.name}
            </td>
            <td>
              ${ordered_product_item_token.seat.name if ordered_product_item_token.seat else "-"}
            </td>
            <td>
              <button onclick="show_resale_request_bank_info(${resale_request.id})"><i class="icon-th-list"></i></button>
            </td>
          </tr>
          % endfor
          </tbody>
        </table>
      </div>
        ${ch.pager(resale_requests)}
      % else:
      <div>
        <h4>リセールリクエストリストの情報は見つかりませんでした。</h4>
      </div>
      % endif
    </div>
  </div>
</div>

<!-- modals -->
<div id="modal-bg" class="hide"></div>
<div id="modal-resale-segment-form" class="modal hide">
  <div class="modal-header">
    <h3>リセール区分登録</h3>
  </div>
  <div class="modal-body">
    <div class="wrap-modal-body">
      <div class="modal-error-msgs-box hide">
        <ul></ul>
      </div>
      <form class="form-horizontal" method="POST">
        ${ch.form_item(form.resale_segment_id)}
        ${ch.form_item(form.performance_id)}
        ${ch.form_item(form.start_at)}
        ${ch.form_item(form.end_at)}
      </form>
    </div>
  </div>
  <div class="modal-footer">
    <div class="reserve-area">
      <button onclick="close_modal_resale_segment($(this).parents('.modal'))" class="btn secondary btn-close">キャンセル</button>
      <button class="btn btn-danger create_or_update">確認する</button>
    </div>
  </div>
</div>

<div id="modal-resale-request" class="modal hide">
  <div class="modal-header">
    <h3>リセール振込情報</h3>
  </div>
  <div class="modal-body">
    <div class="modal-error-msgs-box hide">
      <ul></ul>
    </div>
    <div class="wrap-modal-body">
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>項目</th>
            <th>内容</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>銀行コード</td>
            <td id="bank_code-info"></td>
          </tr>
          <tr>
            <td>支店コード</td>
            <td id="bank_branch_code-info"></td>
          </tr>
          <tr>
            <td>口座番号</td>
            <td id="account_number-info"></td>
          </tr>
          <tr>
            <td>名義人</td>
            <td id="account_holder_name-info"></td>
          </tr>
          <tr>
            <td>振込額</td>
            <td id="total_amount-info"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="modal-footer">
    <div class="reserve-area">
      <button onclick="close_modal_resale_request($(this).parents('.modal'))" class="btn secondary btn-close">閉じる</button>
    </div>
  </div>
</div>

<div id="modal-resale-request-export" class="modal hide">
  <div class="modal-header">
    <h3>エクスポート</h3>
  </div>
  <div class="modal-body">
    <div class="wrap-modal-body">
      <p>下記の条件でリセールリクエストをエクスポートは大丈夫でしょうか？</p>
      <table class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>条件</th>
            <th>内容</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>予約番号</td>
            <td id="condition-order_no"></td>
          </tr>
          <tr>
            <td>名義人</td>
            <td id="condition-account_holder_name"></td>
          </tr>
          <tr>
            <td>ステータス</td>
            <td id="condition-status"></td>
          </tr>
          <tr>
            <td>連携ステータス</td>
            <td id="condition-sent_status"></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="modal-footer">
    <div class="reserve-area">
      <button onclick="close_modal_resale_request_export($(this).parents('.modal'))" class="btn secondary btn-close">キャンセル</button>
      <button onclick="export_resale_request($(this).parents('.modal'))" class="btn btn-primary create_or_update">エクスポート</button>
    </div>
  </div>
</div>

<div id="modal-send-resale-request-to-orion" class="modal hide">
  <div class="modal-header">
    <h3></h3>
  </div>
  <div class="modal-body">
    <div class="wrap-modal-body">
      <div class="modal-error-msgs-box hide">
        <ul></ul>
      </div>
      <p></p>
    </div>
  </div>
  <div class="modal-footer">
    <div class="reserve-area">
      <button onclick="close_modal_send_resale_request_to_orion($(this).parents('.modal'))" class="btn secondary btn-close">キャンセル</button>
      <button class="btn btn-danger send-to-orion">連携</button>
    </div>
  </div>
</div>

<!-- modals -->
<!-- templates -->
<li id="resale-segment-li-template" class="hide">
  <h4></h4>
  <button class="btn" onclick="open_resale_segment_form_for_update($(this))"><i class="icon-pencil"></i>編集</button>
  <button class="btn btn-warning" onclick="send_resale_segment_to_orion($(this))"><i class="icon-refresh icon-white"></i>連携</button>
</li>

<button id="resale-request-reset-btn-template" class="btn btn-small hide" onclick="operate_resale_request($(this), 'waiting')">リセット</button>
<div id="resale-request-btn-group-template-1" class="btn-group hide">
  <button class="btn btn-small btn-reset" onclick="operate_resale_request($(this), 'waiting')">リセット</button>
  <button class="btn btn-small btn-warning btn-send" onclick="open_send_resale_request_to_orion_modal($(this), false)">連携</button>
</div>
<div id="resale-request-btn-group-template-2" class="btn-group hide">
  <button class="btn btn-small btn-primary" onclick="operate_resale_request($(this), 'sold')">リセール</button>
  <button class="btn btn-small btn-info" onclick="operate_resale_request($(this), 'back')">返却</button>
  <button class="btn btn-small btn-danger" onclick="operate_resale_request($(this), 'cancel')">キャンセル</button>
</div>
<!-- templates -->
<script type="text/javascript">
  if (String.prototype.format === undefined) {
      String.prototype.format = function(arg) {
          var rep_fn = undefined;
          if (typeof arg === "object") {
              rep_fn = function(m, k) { return arg[k]; };
          } else {
              var args = arguments;
              rep_fn = function(m, k) { return args[parseInt(k)]; };
          }
          return this.replace(/\{(\w+)\}/g, rep_fn);
      }
  }

  function concat_datetime(y, m, d, H, M, S) {
      if (!y && !m && !d && !H && !M) {return null;}
      if (!H) {H = "00"}
      if (!M) {M = "00"}
      if (!S) {S = "00"}
      return "{0}-{1}-{2} {3}:{4}:{5}".format(y, m, d, H, M, S);
  }

  function split_datetime(datetime) {
    var items = datetime.split(' '),
        date = items[0],
        time = items[1],
        ret = {};

    items = date.split('-');
    ret['y'] = items[0];
    ret['m'] = items[1];
    ret['d'] = items[2];

    items = time.split(':');
    ret['H'] = items[0];
    ret['M'] = items[1];
    ret['S'] = items[2];

    return ret;
  }

  function get_current_local_datetime() {
      var now = new Date();
      return concat_datetime(
          now.getFullYear(),
          now.getMonth() + 1,
          now.getDate(),
          now.getHours(),
          now.getMinutes(),
          now.getSeconds()
      )
  }

  function clear_modal_error_status(modal) {
      var msgs_box = modal.find(".modal-error-msgs-box");
      msgs_box.find("ul").empty();
      modal.find(".control-group").removeClass("error");
      msgs_box.hide();
  }

  function close_modal_resale_segment(modal) {
      $("#modal-bg").hide();
      clear_modal_error_status(modal);
      modal.hide();
  }

  function close_modal_resale_request(modal) {
      $("#modal-bg").hide();
      clear_modal_error_status(modal);
      modal.find("td[id]").text("");
      modal.hide();
  }

  function close_modal_resale_request_export(modal) {
      $("#modal-bg").hide();
      modal.find("td[id]").text("");
      modal.hide();
  }

  function close_modal_send_resale_request_to_orion(modal) {
      $("#modal-bg").hide();
      modal.hide();
  }

  function flush_result_message(ul, message) {
      ul.prepend(
          $("<li>").addClass("flushed_msgs")
                   .append($("<h4>").text(message).css("color", "#b94a48").css("margin", "0"))
                   .append($("<i>").addClass("icon-remove-sign"))
                   .on('click' , function() {
                       this.remove();
                    })
      );
  }

  function handle_exception(xhr) {
      var ret = {},
          status = "",
          emsgs = "";

      try {
          ret = JSON.parse(xhr.responseText);
      } catch (e) {
          status = xhr.status;
          if (status === 404) {
              emsgs = "該当内容は見つかりませんでした。"
          } else if (status === 500) {
              emsgs = "システムエラーでした。"
          } else {
              emsgs = xhr.statusText;
          }
          ret = {
              "status": status,
              "emsgs": emsgs
          };
      }

      return ret;
  }

  function update_send_button_status(button, status) {
      if (status === "sent") {
          button.removeClass("btn-danger btn-warning");
          button.addClass("btn-inverse");
          button.attr("disabled", true);
          button.html("<i class=\"icon-refresh icon-white\"></i>連携済み");
      } else if (status === "send_required") {
          button.removeClass("btn-warning btn-inverse");
          button.addClass("btn-danger");
          button.attr("disabled", false);
          button.html("<i class=\"icon-refresh icon-white\"></i>再連携必須");
      } else {
          button.removeClass("btn-warning btn-inverse");
          button.addClass("btn-danger");
          button.attr("disabled", false);
          button.html("<i class=\"icon-refresh icon-white\"></i>連携失敗");
      }
  }

  function create_resale_segment() {
      var modal = $('#modal-resale-segment-form'),
          form = modal.find('form'),
          url = "/resale/api/segments/create",
          data = {
            "performance_id": parseInt(form.find("#performance_id").val()),
            "start_at": concat_datetime(
                form.find("#start_at\\.year").val(),
                form.find("#start_at\\.month").val(),
                form.find("#start_at\\.day").val(),
                form.find("#start_at\\.hour").val(),
                form.find("#start_at\\.minute").val()),
            "end_at": concat_datetime(
                form.find("#end_at\\.year").val(),
                form.find("#end_at\\.month").val(),
                form.find("#end_at\\.day").val(),
                form.find("#end_at\\.hour").val(),
                form.find("#end_at\\.minute").val())
          };
      clear_modal_error_status(modal);
      $.ajax({
          url: url,
          type: "POST",
          data: data,
          success: function(data) {
              var ul = $(".resale-segment-list-box ul"),
                  li = $("#resale-segment-li-template").clone().removeAttr("id").removeClass("hide"),
                  h4 = li.find("h4");

              h4.text("開始日時：" + data["start_at"] + " 終了日時：" + data["end_at"])
                .attr("id", "resale-segment-" + data["id"])
                .data('resale_segment_id', data["id"])
                .data('start_at', data["start_at"])
                .data('end_at', data["end_at"]);

              li.appendTo(ul);
              flush_result_message(ul, "リセールセッグメントが作成されました。");
              $(".resale-segment-add-btn").remove();
              close_modal_resale_segment(modal);
          },
          error: function(xhr) {
              var ret = handle_exception(xhr),
                  ul = $(".modal-error-msgs-box ul"),
                  i = undefined;

              if ("status" in ret) {
                  ul.append($("<li>").text("{0} - {1}".format(ret["status"],ret["emsgs"])));
              }
              if ('start_at' in ret) {
                  for (i = 0; i < parsed_data['start_at'].length; i++) {
                      ul.append($("<li>").text(parsed_data['start_at'][i]));
                  }
              }
              if ('end_at' in ret) {
                  for (i = 0; i < parsed_data['end_at'].length; i++) {
                      ul.append($("<li>").text(parsed_data['end_at'][i]));
                  }
              }
              Object.keys(parsed_data).forEach(function(key) {
                  $("label[for=" + key + "]").parents(".control-group").addClass("error");

              });
              $(".modal-error-msgs-box").show();
          }
      })
  }

  function update_resale_segment() {
      var modal = $('#modal-resale-segment-form'),
          form = modal.find('form'),
          resale_segment_id = form.find("#resale_segment_id").val(),
          url = "/resale/api/segments/{0}/update".format(resale_segment_id),
          data = {
            "start_at": concat_datetime(
                form.find("#start_at\\.year").val(),
                form.find("#start_at\\.month").val(),
                form.find("#start_at\\.day").val(),
                form.find("#start_at\\.hour").val(),
                form.find("#start_at\\.minute").val()),
            "end_at": concat_datetime(
                form.find("#end_at\\.year").val(),
                form.find("#end_at\\.month").val(),
                form.find("#end_at\\.day").val(),
                form.find("#end_at\\.hour").val(),
                form.find("#end_at\\.minute").val()),
            "sent_status": 3,
            "sent_at": get_current_local_datetime()
          };
      clear_modal_error_status(modal);
      $.ajax({
          url: url,
          type: "PUT",
          data: data,
          success: function(data) {
              var resale_segment_id = data["id"],
                  h4 = $("h4#resale-segment-" + resale_segment_id),
                  button = h4.siblings(".btn-send");

              h4.text("開始日時：" + data["start_at"] + " 終了日時：" + data["end_at"])
                  .data('start_at', data["start_at"])
                  .data('end_at', data["end_at"]);
              update_send_button_status(button, 'send_required');
              flush_result_message(h4.parents("ul"), "リセールセッグメントが更新されました。");
              close_modal_resale_segment(modal);
          },
          error: function(xhr) {
              var ret = handle_exception(xhr),
                  ul = $(".modal-error-msgs-box ul"),
                  i = undefined;

              if ("status" in ret) {
                  ul.append($("<li>").text("{0} - {1}".format(ret["status"],ret["emsgs"])));
              }
              if ("start_at" in ret) {
                  for (i = 0; i < ret["start_at"].length; i++) {
                      ul.append($("<li>").text(ret["start_at"][i]));
                  }
              }
              if ("end_at" in ret) {
                  for (i = 0; i < ret["end_at"].length; i++) {
                      ul.append($("<li>").text(ret["end_at"][i]));
                  }
              }
              Object.keys(ret).forEach(function(key) {
                  $("label[for=" + key + "]").parents(".control-group").addClass("error");

              });
              $(".modal-error-msgs-box").show();
          }
      })
  }

  function open_resale_segment_form_for_create() {
      var modal = $("#modal-resale-segment-form"),
          submit_button = modal.find("button.create_or_update");
      submit_button.attr("onclick", "create_resale_segment()");
      modal.show();
      $("#modal-bg").show();
  }

  function open_resale_segment_form_for_update(elem) {
      var modal = $("#modal-resale-segment-form"),
          data = elem.parent().find('h4').data(),
          resale_segment_id = data['resale_segment_id'],
          start_at = split_datetime(data['start_at']),
          end_at = split_datetime(data['end_at']),
          form = modal.find("form");

      form.find("#resale_segment_id").val(resale_segment_id);
      form.find("#start_at\\.year").val(start_at.y);
      form.find("#start_at\\.month").val(start_at.m);
      form.find("#start_at\\.day").val(start_at.d);
      form.find("#start_at\\.hour").val(start_at.H);
      form.find("#start_at\\.minute").val(start_at.M);
      form.find("#start_at\\.second").val(start_at.S);

      form.find("#end_at\\.year").val(end_at.y);
      form.find("#end_at\\.month").val(end_at.m);
      form.find("#end_at\\.day").val(end_at.d);
      form.find("#end_at\\.hour").val(end_at.H);
      form.find("#end_at\\.minute").val(end_at.M);
      form.find("#end_at\\.second").val(end_at.S);

      modal.find("button.create_or_update").attr("onclick", "update_resale_segment()");
      $("#modal-bg").show();
      modal.show();
  }

  function send_resale_segment_to_orion(button) {
      var h4 = button.siblings("h4"),
          resale_segment_id = h4.data("resale_segment_id"),
          performance_id = parseInt("${performance.id}"),
          url = "${request.route_path('performances.resale.send_resale_segment_to_orion')}";
      $.ajax({
          url: url,
          type: "POST",
          data: {"performance_id": performance_id, "resale_segment_id": resale_segment_id},
          success: function(data) {
              var success_list = data['success_list'],
                  fail_list = data['fail_list'],
                  send_button = undefined,
                  i = undefined;

              for (i = 0; i < success_list.length; i++) {
                  send_button = $("#resale-segment-" + success_list[i]).siblings(".btn-send");
                  update_send_button_status(send_button, 'sent');
              }
              for (i = 0; i < fail_list.length; i++) {
                  send_button = $("#resale-segment-" + fail_list[i]).siblings(".btn-send");
                  update_send_button_status(send_button, 'fail');
              }
              flush_result_message(h4.parents("ul"), "リセールセッグメント情報はOrionに送信されました。");
          },
          error: function(xhr) {
              var ret = handle_exception(xhr);
              if (button) {
                  update_send_button_status(button, 'fail');
              } else {
                  $("h4[id*='resale-segment-']").each(function() {
                      var button = $(this).siblings(".btn-send");
                      update_send_button_status(button, 'fail');
                  })
              }
              flush_result_message(h4.parents("ul"), ret);
          }
      });
  }

  function show_resale_request_bank_info(resale_request_id) {
      $.ajax({
          url: "/resale/api/requests/" + resale_request_id,
          type: "GET",
          success: function(data) {
              var modal = $("#modal-resale-request");
              for (key in data) {
                  if (data.hasOwnProperty(key)) {
                      modal.find("#" + key + "-info").text(data[key]);
                  }
              }
              modal.show();
              $("#modal-bg").show();
          },
          error: function(xhr) {
              var ret = handle_exception(xhr),
                  modal = $("#modal-resale-request");
                  ul = modal.find(".modal-error-msgs-box ul");

              if ("status" in ret) {
                  ul.append($("<li>").text("{0} - {1}".format(ret["status"],ret["emsgs"])));
              }
              if ("start_at" in ret) {
                  for (var i = 0; i < ret["start_at"].length; i++) {
                      ul.append($("<li>").text(ret["start_at"][i]));
                  }
              }
              modal.find(".modal-error-msgs-box").show();
              modal.show();
              $("#modal-bg").show();
          }
      });
  }

  function build_status_content(td, action) {
      var span = $('<span class="label"></span>');
      td.empty();
      if (action === "sold") {
          span.addClass("label-success")
              .text("（仮）リセール");
      } else if (action === "back") {
          span.addClass("label-info")
              .text("（仮）返却");
      } else if (action === "cancel") {
          span.addClass("label-important")
              .text("（仮）キャンセル");
      }

      if (action === "waiting") {
          td.append(
              $("#resale-request-btn-group-template-2").clone()
                  .removeAttr("id")
                  .removeClass("hide")
          );
      } else {
          td.append(span).append(" ")
            .append(
                $("#resale-request-btn-group-template-1").clone()
                    .removeAttr("id")
                    .removeClass("hide")
            );
      }
  }

  function operate_resale_request(button, action) {
      var td = button.parents("td"),
          resale_request_id = button.parents("tr").data("resale_request_id"),
          status_code = {"waiting": 1, "sold": 2, "back": 3, "cancel": 4};
      $.ajax({
          url: "${request.route_path('performances.resale.requests.operate')}",
          type: "POST",
          data: {
              "resale_request_id": resale_request_id,
              "action": action
          },
          success: function() {
              build_status_content(td, action);
              td.parent().data("status", status_code[action]);
          },
          error: function(xhr) {
              var ret = handle_exception(xhr);
          }
      });
  }

  function open_send_resale_request_to_orion_modal(button, all) {
      var modal = $("#modal-send-resale-request-to-orion"),
          resale_segment_id = undefined,
          resale_request_id = undefined;
      if (all) {
          resale_segment_id = button.siblings("h4").data("resale_segment_id");
          modal.find(".modal-header h3").text("リセールリクエスト一括連携");
          modal.find(".modal-body p").text("リセールリクエスト一括連携したら、対象のリセールリクエストのステータスを変更できなくなります。");
          modal.find("button.send-to-orion").attr("onclick", "send_all_resale_request_to_orion({0})".format(resale_segment_id));
      } else {
          resale_request_id = button.parents("tr").data("resale_request_id");
          modal.find(".modal-header h3").text("リセールリクエスト連携");
          modal.find(".modal-body p").text("リセールリクエスト連携したら、該当リセールリクエスト（ID: {0}）のステータスを変更できなくなります。".format(resale_request_id));
          modal.find("button.send-to-orion").attr("onclick", "send_resale_request_to_orion({0})".format(resale_request_id));
      }
      $("#modal-bg").show();
      modal.show();
  }

  function send_resale_request_to_orion(resale_request_id) {
      var modal = $("#modal-send-resale-request-to-orion"),
          tr = $("#resale-request-{0}".format(resale_request_id));
      $.ajax({
          url: "${request.route_path('performances.resale.send_resale_request_to_orion')}",
          type: "POST",
          data: {
              "resale_request_id": resale_request_id
          },
          success: function(data) {

              if (data['success_list'].length > 0) {
                  var span = tr.find("span"),
                      btn_group = tr.find(".btn-group");
                  span.text(span.text().replace("（仮）", ""));
                  btn_group.remove();
              } else {
                  tr.find("button.btn-send").text("連携失敗").removeClass("btn-warning").addClass("btn-danger");
              }
              close_modal_send_resale_request_to_orion(modal);
          },
          error: function(xhr) {
              var ret = handle_exception(xhr);
          }
      });
  }

  function send_all_resale_request_to_orion(resale_segment_id) {
      var modal = $("#modal-send-resale-request-to-orion"),
          h4 = $("#resale-segment-{0}".format(resale_segment_id));
      $.ajax({
          url: "${request.route_path('performances.resale.send_resale_request_to_orion')}",
          type: "POST",
          data: {
              "resale_segment_id": resale_segment_id
          },
          success: function() {
              modal.find(".modal-body p").text("リセールリクエスト一括連携しました。");
              modal.find("button.send-to-orion")
                  .text("確認")
                  .attr("onclick", "location.reload()");
          },
          error: function(xhr) {
              var ret = handle_exception(xhr);
              console.log(h4.parents("ul"));
              flush_result_message(h4.parents("ul"), ret["emsgs"]);
          }
      });
  }

  function get_resale_request_status() {
      var status_list = [];
      if ($("#waiting").is(":checked")) status_list.push(1);
      if ($("#sold").is(":checked")) status_list.push(2);
      if ($("#back").is(":checked")) status_list.push(3);
      if ($("#cancel").is(":checked")) status_list.push(4);
      return status_list;
  }

  function get_resale_request_sent_status() {
      var sent_status_list = [];
      if ($("#not_sent").is(":checked")) sent_status_list.push(1);
      if ($("#sent").is(":checked")) sent_status_list.push(2);
      if ($("#send_required").is(":checked")) sent_status_list.push(3);
      if ($("#fail").is(":checked")) sent_status_list.push(4);
      return sent_status_list;
  }

  function build_export_url() {
      var baseUrl = "/resale/api/requests/export",
          resale_segment_id = $($(".resale-segment-list-box").find("h4")[1]).data("resale_segment_id"),
          order_no = $("#order_no").val().trim(),
          account_holder_name = $("#account_holder_name").val().trim(),
          status_list = get_resale_request_status(),
          sent_status_list = get_resale_request_sent_status(),
          filter_list = [];

      if (status_list.length === 0 && sent_status_list === 0 && order_no === "" && account_holder_name === "") {
          return baseUrl + "?" + "filter[resale_segment_id]=" + resale_segment_id;
      }

      if (order_no !== "") {
          filter_list.push("order_no=" + order_no);
      }

      if (account_holder_name !== "") {
          filter_list.push("filter[account_holder_name]=" + account_holder_name);
      }

      if (status_list.length !== 0) {
          filter_list.push("filter[status]=" + status_list.join(","));
      }

      if (sent_status_list.length !== 0) {
          filter_list.push("filter[sent_status]=" + sent_status_list.join(","));
      }

      return baseUrl + "?" + filter_list.join("&");

  }

  function get_resale_request_status_verbose() {
    var status_list = get_resale_request_status(),
        status_verbose_list = [];

    if (status_list.length === 0) {
      status_verbose_list.push("条件なし")
    } else if (status_list.length === 4) {
      status_verbose_list.push("全部")
    } else {
      if ($("#waiting").is(":checked")) status_verbose_list.push("リセール中");
      if ($("#sold").is(":checked")) status_verbose_list.push("リセール");
      if ($("#back").is(":checked")) status_verbose_list.push("返却");
      if ($("#cancel").is(":checked")) status_verbose_list.push("キャンセル");
    }
      return status_verbose_list;
  }

  function get_resale_request_sent_status_verbose() {
    var sent_status_list = get_resale_request_sent_status(),
        status_verbose_list = [];

    if (sent_status_list.length === 0) {
      status_verbose_list.push("条件なし")
    } else if (sent_status_list.length === 4) {
      status_verbose_list.push("全部")
    } else {
      if ($("#not_sent").is(":checked")) status_verbose_list.push("未連携");
      if ($("#sent").is(":checked")) status_verbose_list.push("連携済み");
      if ($("#send_required").is(":checked")) status_verbose_list.push("再連携必須");
      if ($("#fail").is(":checked")) status_verbose_list.push("連携失敗");
    }
    return status_verbose_list;
  }

  function open_resale_request_export_modal() {
      var modal = $("#modal-resale-request-export"),
          order_no = $("#order_no").val().trim(),
          account_holder_name = $("#account_holder_name").val().trim(),
          status_list = get_resale_request_status_verbose(),
          sent_status_list = get_resale_request_sent_status_verbose();

      if (order_no === "") {
          order_no = "条件なし";
      }
      if (account_holder_name === "") {
          account_holder_name = "条件なし";
      }
      modal.find("#condition-order_no").text(order_no);
      modal.find("#condition-account_holder_name").text(account_holder_name);
      modal.find("#condition-status").text(status_list.join(', '));
      modal.find("#condition-sent_status").text(sent_status_list.join(', '));
      modal.show();
      $("#modal-bg").show();
  }

  function export_resale_request(modal) {
      close_modal_resale_request_export(modal);
      url = build_export_url();
      window.location = url;
  }
</script>