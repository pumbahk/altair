<%page args="form, settings" />
<%namespace file="/common/helpers.html" name="ch" />
<%! from altair.app.ticketing.discount_code.models import DiscountCodeSetting, CodeOrganizerEnum %>
<%! from altair.app.ticketing.discount_code.forms import DiscountCodeSettingForm %>

<%def name="show_reason(reasons)">
    <ul>
        % for reason in reasons:
            <li>${reason}</li>
        % endfor
    </ul>
</%def>

<p>※ 状態が「無効」になっている場合は、アイコンをクリックすると理由が表示されます。</p>
<p>※ クーポン・割引コードは<strong>販売単位が1の商品にのみ適用</strong>できます。ペアシート・ボックス席などには適用できません。</p>
<div style="margin-right: 10px;">
    <div class="btn-group ">
        <a href="javascript:new_setting();" class="btn">
            <i class="icon-plus"></i>新規
        </a>
    </div>
</div>

<div class="row-fluid" style="margin-top: 30px;">
    <div class="span10">

        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th class="span1" style="text-align: center">
                    ${HH.label_text_for(DiscountCodeSetting.id)}
                </th>
                <th class="span1" style="text-align:center;">
                    ${HH.label_text_for(DiscountCodeSettingForm.status)}
                    ${ch.help(form.status, u"「有効」にならない限り、チケット購入時にクーポン・割引コード入力画面は表示されません。")|n}
                </th>
                <th class="span1" style="text-align: center">
                    頭4文字
                </th>
                <th class="span2">
                    ${ch.sortable(form.name)}
                </th>
                <th class="span1" style="text-align: center">
                    対象公演数
                </th>
                <th class="span3">
                    有効期間
                </th>
                <th class="span1">
                    ${ch.sortable(form.issued_by)}
                    ${ch.help(form.issued_by, u"「自社」の場合は「コード一覧」機能でコードの生成や管理が可能です。")|n}
                </th>
                <th class="span2"></th>
            </tr>
            </thead>
            <tbody>
                % for setting in settings.items:
                    <tr id="code-${setting.id}">
                        <td style="text-align: center">${setting.id}</td>
                        <td style="text-align: center;">
                            % if setting.available_status == True:
                                <span class="badge badge-info">有　効</span>
                            % else:
                                <span class="badge badge-warning" rel="popover"
                                      data-original-title="無効になっている理由"
                                      data-content="${show_reason(setting.available_status)}">無　効</span>
                            % endif
                        </td>
                        <td style="text-align: center;">
                            ${setting.first_4_digits if setting.first_4_digits else '-'}
                        </td>
                        <td>${setting.name}</td>
                        <td style="text-align: center;">${setting.target_count}</td>
                        <td>
                            %if setting.start_at or setting.end_at:
                            %if setting.start_at:
                                ${vh.datetime(setting.start_at, with_weekday=True)}
                            %endif
                                〜
                            %if setting.end_at:
                                ${vh.datetime(setting.end_at, with_weekday=True)}
                            %endif
                            %else:
                                指定なし
                            %endif
                        </td>
                        <td>${''.join([enum.v[1] for enum in CodeOrganizerEnum if enum.v[0] == setting.issued_by])}</td>
                        <td style="width: 1%; white-space: nowrap;">
                                <%include file="/discount_code/settings/_action_button.html" args="setting=setting, small=True, split=True"/>
                        </td>
                    </tr>
                % endfor
            </tbody>
        </table>
        ${ch.pager(settings)}
    </div>
</div>

