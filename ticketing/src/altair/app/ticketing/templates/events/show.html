<%inherit file="/layout_2cols.html" />
<%namespace file="/common/helpers.html" name="ch" />

<script>
// ajax modal
$(function(){
  $("a.id-action").click(function() {
    var form = $(this).closest('form');
    var pk = form.find("input:radio:checked, input:checkbox:checked").val();
    if(!pk){ return false; }
    $(this).attr("href", $(this).attr("data-base-url").replace("__id__", pk));
    return true;
  });

	$("a.ajax-modal[data-toggle=modal]").click(function(){
    $($(this).attr("data-target")).load($(this).attr("href"));
	});
});
</script>

<%block name="breadcrumbs">
  ${ch.breadcrumbs(
      names=[u'イベント', event.title],
      urls=[request.route_path('events.index')]
  )}
</%block>

<%block name="style">
<link rel="stylesheet" type="text/css" href="/static/css/decentcolorpicker.css" />
<script type="text/javascript" src="/static/js/jquery.decentcolorpicker.js"></script>
</%block>


<script>
  $(function() {
    $('[rel=popover]').popover()
  });
</script>

<div class="page-header">
  <h1 style="word-wrap: break-word;">${event.title}</h1>
</div>

<table class="table table-bordered fullwidth">
  <tbody>
    <tr>
      <th class="span3">${form.title.label.text}</th>
      <td>${event.title}</td>
    </tr>
    <tr>
      <th>${form.abbreviated_title.label.text}</th>
      <td>${event.abbreviated_title}</td>
    </tr>
    <tr>
      <th>${form.code.label.text}</th>
      <td>${event.code}</td>
    </tr>
    <tr>
      <th>${form.account_id.label.text}</th>
      <td>${event.account.name} 様</td>
    </tr>
    <tr>
      <th>
        販売開始日時
        <span class="help-inline">
          <a rel="popover" data-original-title="販売開始日時" data-content="登録済みの商品のうち最初の販売開始日時">
            <i class="icon-question-sign"></i>
          </a>
        </span>
      </th>
      <td>${vh.datetime(event.sales_start_on, with_weekday=True)}</td>
    </tr>
    <tr>
      <th>
        販売終了日時
        <span class="help-inline">
          <a rel="popover" data-original-title="販売終了日時" data-content="登録済みの商品のうち最後の販売終了日時">
            <i class="icon-question-sign"></i>
          </a>
        </span>
      </th>
      <td>${vh.datetime(event.sales_end_on, with_weekday=True)}</td>
    </tr>
    <tr>
      <th>初回公演日時</th>
      <td>
        ${vh.datetime(event.first_start_on, with_weekday=True)}
        % if event.first_performance:
        (<a href="${request.route_path('performances.show', event_id=event.id, performance_id=event.first_performance.id)}">
         ${event.first_performance.venue.name} 公演 </a>)
        % endif
      </td>
    </tr>
    <tr>
      <th>最終公演日時</th>
      <td>
        ${vh.datetime(event.final_start_on, with_weekday=True)}
        % if event.final_performance:
        (<a href="${request.route_path('performances.show', event_id=event.id, performance_id=event.final_performance.id)}">
         ${event.final_performance.venue.name} 公演 </a>)
        % endif
      </td>
    </tr>
    %if event.setting:
      %for (k, _), (label, v) in HH.describe_iter(event.setting):
        <tr>
          <th>${label}</th>
          <td colspan="7">${v or u'-'}</td>
        </tr>
      %endfor
    %endif
    <tr>
      <th>
        カートURL
        <span class="help-inline">
          <a rel="popover" data-original-title="カートURL" data-content="購入カートのURL">
            <i class="icon-question-sign"></i>
          </a>
        </span>
      </th>
      <td>
        <a href="${cart_url}">${cart_url}</a>  (<a href="${cart_now_cart_url}">時間指定してカート購入</a>)
      </td>
    </tr>
    <tr>
      <th>
        同意カートURL
        <span class="help-inline">
          <a rel="popover" data-original-title="カートURL" data-content="同意購入カートのURL">
            <i class="icon-question-sign"></i>
          </a>
        </span>
      </th>
      <td>
        <a href="${agreement_url}">${agreement_url}</a>  (<a href="${cart_now_cart_url}">時間指定してカート購入</a>)
      </td>
    </tr>
  </tbody>
</table>

<%include file="/events/_action_button.html" args="event=event, order=['edit', 'delete', 'copy']" />

<div class="btn-group" style="float: left;">
  % if event.cms_send_at:
    % if event.updated_at > event.cms_send_at:
      <a class="btn btn-warning" href="javascript:send_event(${event.id});" style="margin-left: 10px;">
        <i class="icon-refresh icon-white"></i> CMSへ送信
      </a>
    % else:
      <a class="btn btn-inverse" href="javascript:send_event(${event.id});" style="margin-left: 10px;">
        <i class="icon-refresh icon-white"></i> CMSへ送信
      </a>
    % endif
  % else:
    <a class="btn btn-warning" href="javascript:send_event(${event.id});" style="margin-left: 10px;">
        <i class="icon-refresh icon-white"></i> CMSへ送信
    </a>
  % endif
</div>

<div class="btn-group" style="float: left;">
  <a class="btn" href="${request.route_path('reports.index', event_id=event.id)}" style="margin-left: 10px;">
    帳票
  </a>
</div>

<div class="btn-group" style="float: left;">
  <a class="btn" href="${request.route_path('events.tickets.index', event_id=event.id)}" style="margin-left: 10px;">
	券面
  </a>
</div>

<div class="btn-group" style="float: left;">
  <a class="btn" href="${request.route_path('events.mailinfo.index', event_id=event.id)}" style="margin-left: 10px;">
	メール
  </a>
</div>
<div class="btn-group" style="float: left;">
  <a class="btn" href="${request.route_path('orders.index', _query=dict(event_id=event.id))}" style="margin-left: 10px;">
	購入情報
  </a>
</div>
<div class="btn-group" style="float: left;">
  <a class="btn" href="${request.route_path('lots.index', event_id=event.id)}" style="margin-left: 10px;">
	抽選
  </a>
</div>
<div class="btn-group" style="float: left;">
  <a class="btn" href="${request.route_path('sales_reports.event', event_id=event.id)}" style="margin-left: 10px;">
	売上レポート
  </a>
</div>
<div class="btn-group" style="float: left;">
  <a class="btn" href="${request.route_path('events.print_progress.show', event_id=event.id)}" style="margin-left: 10px;">
	発券進捗状況確認
  </a>
</div>

%if event.organization_id == 15:
<!-- 楽天チケットのみ -->
<div class="btn-group" style="float: left;">
  <a class="btn" href="${request.route_path('augus.events.show', event_id=event.id)}" style="margin-left: 10px;">
    オーガス連携
  </a>
</div>
%endif

% if event.organization.setting.famiport_enabled:
<div class="btn-group" style="float: left;">
  <a class="btn" href="${request.route_path('events.famiport.performance_groups.index', event_id=event.id)}" style="margin-left: 10px;">
    ファミポート連携
  </a>
</div>
% endif

<%include file="./_send_event_mixin.html" />

<div style="clear: left;"></div>

<hr />

<div id="stock_types">
  <h3>席種</h3>
  <div style="margin-top: 20px;">
    <%include file="/stock_types/_list.html" args="stock_types=event.stock_types, limit=10" />
    <%include file="/stock_types/_action_button.html" args="event=event" />
    <div id="stock_types-form">
      <%include file="/stock_types/_form.html" args="form=form_stock_type" />
    </div>
  </div>
</div>

<hr />

<div id="stock_holders">
  <h3>配券先</h3>
  <div style="margin-top: 20px;">
    <%include file="/stock_holders/_list.html" args="form=form_stock_holder, stock_holders=event.stock_holders, limit=10" />
    <%include file="/stock_holders/_action_button.html" args="event=event" />
    <div id="stock_holders-form">
    <%include file="/stock_holders/_form.html" args="form=form_stock_holder" />
    </div>
  </div>
</div>

<hr />

<div id="sales_segment_groups">
  <h3>販売区分グループ</h3>
  <div style="margin-top: 20px;">
    <form>
    <%include file="/sales_segment_groups/_list.html" args="form=form_sales_segment_group, sales_segment_groups=event.sales_segment_groups, limit=10" />
    <%include file="/sales_segment_groups/_action_button.html" />
    </form>
    <div id="sales_segment_groups-form">
      <%include file="/sales_segment_groups/_modal.html" args="modal_id='modal-sales_segment_group', event=event" />
    </div>
  </div>
</div>
<br/>
<hr style="clear:both"/>

<div id="performances">
  <h3>パフォーマンス</h3>
  <div style="margin-top: 20px;">
    <%include file="/performances/_list.html" args="form=form_performance, performances=performances, limit=10, event=event" />
    <%include file="/performances/_action_button.html" args="event=event" />
    <script type="text/javascript">
      var is_sending = {};
      $("#send_event").click(function(e){
        var $e = $(e.currentTarget);
        if(is_sending[$e.attr("href")]){
          return false;
        }
        is_sending[$e.attr("href")] = true;
        $('#modal-send_event').modal('hide');
        setTimeout(function(){
          is_sending[$e.attr("href")] = false;
        }, 20000);
        return true
      })
    </script>
  </div>
</div>
