<%inherit file="/layout_2cols.html"/>
<%namespace file="/common/helpers.html" name="ch" />
<%
  performance = performance_reporter.performance
  form = performance_reporter.form
%>
<%block name="breadcrumbs">
  ${ch.breadcrumbs(
      names=[u'トップ', u'売上レポート', u'イベント', u'公演'],
      urls=[
        request.route_path('index'),
        request.route_path('sales_reports.index'),
        request.route_path('sales_reports.event', event_id=performance_reporter.performance.event_id)
      ]
  )}
</%block>

<div class="page-header">
  <h2>売上レポート 公演</h2>
</div>

<div class="well well-small">
  <%include file="/sales_reports/_report_settings.html"
            args="form=form, form_report_setting=form_report_setting, performance=performance, report_settings=report_settings" />
</div>

<h3>開催日: ${vh.datetime(performance.start_on)}　${performance.name}</h3>

<%
  sales_segments = performance_reporter.sort_index()
  if len(sales_segments) > 1:
    sales_segments = [''] + sales_segments
%>
% for ss_idx, sales_segment in enumerate(sales_segments):
  <%
    if ss_idx == 0 and len(sales_segments) > 1:
      reporter = performance_reporter.total
      ss_name = u'公演合計'
    else:
      reporter = performance_reporter.get_reporter(sales_segment)
      ss_name = sales_segment.name
  %>
  <h4>会場: ${performance.venue.name}</h4>
  <h4>${ss_name}</h4>
  % if reporter:
  <table class="table table-bordered table-condensed">
    % if form.limited_from.data or form.limited_to.data:
    <tr>
      <th colspan="6"></th>
      <th colspan="4">累計</th>
      <th colspan="4">
        ${vh.term(form.limited_from.data, form.limited_to.data)}
      </th>
    </tr>
    % endif
    <tr>
      <th style="width: 16%;">席種</th>
      <th style="width: 8%;">配券先</th>
      <th style="width: 16%;">商品</th>
      <th style="width: 8%;">価格</th>
      <th style="width: 4%;">配席数</th>
      <th style="width: 4%;">残数</th>
      <th style="width: 4%;">受付</th>
      <th style="width: 4%;">未入金</th>
      <th style="width: 4%;">入金済</th>
      <th style="width: 8%;">小計</th>
      % if form.limited_from.data or form.limited_to.data:
      <th style="width: 4%;">受付</th>
      <th style="width: 4%;">未入金</th>
      <th style="width: 4%;">入金済</th>
      <th style="width: 8%;">小計</th>
      % endif
    </tr>
    <%
      group_key = None
      if ss_idx == 0 and len(sales_segments) > 1:
        sorted_records = reporter.sort_and_merge_data()
      else:
        sorted_records = reporter.sort_data()
      import itertools
      stock_type_ids = [r.stock_type_id for r in sorted_records]
      stock_type_id_count = dict([(k, len(list(g))) for k, g in itertools.groupby(stock_type_ids)])
    %>
    % for record_data in sorted_records:
      <%
        if group_key == record_data.group_key():
          continue
        group_key = record_data.group_key()
        count = len(reporter.group_key_to_reports(group_key))
      %>
      % for i, record in enumerate(reporter.group_key_to_reports(group_key)):
    <tr>
        % if i == 0:
          % if record.stock_type_id in stock_type_id_count:
      <td rowspan="${stock_type_id_count.get(record_data.stock_type_id)}">${record.stock_type_name}</td>
            <% del stock_type_id_count[record.stock_type_id] %>
          % endif
      <td rowspan="${count}" style="border-left: 1px solid #ddd;">${record.stock_holder_name}</td>
        % endif
      <td>${record.product_name}</td>
      <td class="price">${vh.price(record.product_price)}</td>
        % if i == 0:
      <td rowspan="${count}" class="numeric">${vh.number(record.stock_quantity) or ''}</td>
      <td rowspan="${count}" class="numeric">${vh.number(record.vacant_quantity) or ''}</td>
        % endif
      <td class="numeric">${vh.number(record.total_paid_quantity + record.total_unpaid_quantity) or ''}</td>
      <td class="numeric">${vh.number(record.total_unpaid_quantity) or ''}</td>
      <td class="numeric">${vh.number(record.total_paid_quantity) or ''}</td>
      <td class="price">${vh.price((record.total_paid_quantity + record.total_unpaid_quantity) / record.sales_unit * record.product_price)}</td>
        % if form.limited_from.data or form.limited_to.data:
      <td class="numeric">${vh.number(record.paid_quantity + record.unpaid_quantity) or ''}</td>
      <td class="numeric">${vh.number(record.unpaid_quantity) or ''}</td>
      <td class="numeric">${vh.number(record.paid_quantity) or ''}</td>
      <td class="price">${vh.price((record.paid_quantity + record.unpaid_quantity) / record.sales_unit * record.product_price)}</td>
        % endif
    </tr>
      % endfor
    % endfor
    <% total = reporter.total %>
    <tr>
      <td colspan="4">合計</td>
      <td class="numeric">${vh.number(total.stock_quantity) or ''}</td>
      <td class="numeric">${vh.number(total.vacant_quantity) or ''}</td>
      <td class="numeric">${vh.number(total.total_paid_quantity + total.total_unpaid_quantity) or ''}</td>
      <td class="numeric">${vh.number(total.total_unpaid_quantity) or ''}</td>
      <td class="numeric">${vh.number(total.total_paid_quantity) or ''}</td>
      <td class="price">${vh.price(total.total_sum_amount) or ''}</td>
    % if form.limited_from.data or form.limited_to.data:
      <td class="numeric">${vh.number(total.paid_quantity + total.unpaid_quantity) or ''}</td>
      <td class="numeric">${vh.number(total.unpaid_quantity) or ''}</td>
      <td class="numeric">${vh.number(total.paid_quantity) or ''}</td>
      <td class="price">${vh.price(total.sum_amount) or ''}</td>
    % endif
    </tr>
  </table>
  % else:
  <p style="margin-left: 30px; margin-top: 20px;">商品がありません</p>
  % endif
% endfor
