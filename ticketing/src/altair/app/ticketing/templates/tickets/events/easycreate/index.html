<%inherit file="/layout_2cols.html" />
<%namespace file="/common/helpers.html" name="ch" />

<%block name="breadcrumbs">
${ch.breadcrumbs(
  names=[u'イベント', event.title, u'券面', u'券面簡易作成'],
  urls=[request.route_path('events.index'),
        request.route_path('events.show', event_id=event.id),
        request.route_path('events.tickets.index', event_id=event.id)]
)}
</%block>

## todo:moveto helpers
<%block name="style">
<style type="text/css">
  .input-group { padding: 10px; }
  .input-group label { display: inline-block; margin-left:1px;}
  .input-group input[type="radio"] {margin-left:3px;}
  .input-group input[type="radio"]:nth-child(1) {margin-left:0px;}
  .input-group input[type="checkbox"] {margin-left:3px;}
  .input-group input[type="checkbox"]:nth-child(1) {margin-left:0px;}
</style>
</%block>

<%def name="radio_group(form, attrname, required=True)">
<div class="control-group">
${getattr(form,attrname).label(class_="required control-label")}
<div class="controls ">
<div class="input-group" id="${attrname}">
%for f in getattr(form,attrname):
  %if f.checked:
    ${f(checked="checked")} ${f.label}
  %else:
    ${f} ${f.label}
  %endif
%endfor
</div>
</div>
</div>
</%def>

<%def name="checkbox_group_list(form, attrname_list, required=True)">
<div class="control-group">
<div class="controls ">
<div class="input-group">
%for attrname in attrname_list:
  <% f = getattr(form,attrname) %>
  ${f(id=attrname)} ${f.label}
%endfor
</div>
</div>
</div>
</%def>

<h3>チケット券面</h3>
<div class="row-fluid">
<div class="span4">
<div class="setting-area">

${radio_group(choice_form, "preview_type")}
${ch.form_item(choice_form.templates)}
</div>
</div>

<div class="span5">
<div class="submit-area">
<form method="POST" action="${request.route_path("events.tickets.easycreate",event_id=event.id)}">
${ch.form_item(upload_form.name)}
${radio_group(upload_form,"preview_type")}
${ch.form_item(upload_form.ticket_format_id)}
${checkbox_group_list(upload_form, ["always_reissueable","priced","cover_print"])}
${ch.form_item(upload_form.drawing)}
<input type="submit" value="券面を作成"/>
</form>
</div>
</div>
</div>

<script type="text/javascript" src="${request.static_url("altair.app.ticketing:static/js/tickets/easycreate/app.js")}"></script>
<script type="text/javascript" src="${request.static_url("altair.app.ticketing:static/js/tickets/easycreate/helpers.js")}"></script>
<script type="text/javascript">
// loading component, the trigger is preview type radio button of above area.
app.BrokerData = {
  component: {value: null, writable: true},
  setting: {value: null, writable: true},
  submit: {value: null, writable: true}
}
app.broker = Object.create(app.BrokerModule, app.BrokerData);

$(function(){
  app.ComponentAreaData = {
    broker: {value: app.broker},
    $el: {value: $(".component-area"), writable: false},
    ticket_formats_iterable: {value: [], writable: true},
    preview_type: {value: "", writable: true},
    loadcomponent_url: {value: "${request.route_path("events.tickets.easycreate.loadcomponent", event_id=event.id, preview_type="__previewtype")}"},
    gettingtemplate_url: {value: "${request.route_path("events.tickets.easycreate.gettingtemplate", event_id=event.id, preview_type="__previewtype")}"},
    gettingformat_url: {value: "${request.route_path("events.tickets.easycreate.gettingformat", event_id=event.id, preview_type="__previewtype")}"},
    gettingsvg_url: {value: "${request.route_path("events.tickets.easycreate.gettingsvg", event_id=event.id, ticket_id="__ticket_id", preview_type="__previewtype")}"},
  };

  app.SettingAreaData = {
    broker: {value: app.broker},
    $el: {value: $(".setting-area"), writable: false}
  }

  app.SubmitAreaData = {
    broker: {value: app.broker},
    $el: {value: $(".submit-area"), writable: false}
  }

  app.setting = Object.create(app.SettingAreaModule, app.SettingAreaData);
  app.submit = Object.create(app.SubmitAreaModule, app.SubmitAreaData);
  app.component = Object.create(app.ComponentAreaModule, app.ComponentAreaData);

  app.broker.setting = app.setting;
  app.broker.submit = app.submit;
  app.broker.component = app.component;

  // binding observer event
  var radio_btn = app.setting.$el.find('input[name="preview_type"]:radio');
  radio_btn.on("change", function(e){ app.setting.onChangePreviewType($(this))});

  var select_btn = app.setting.$el.find('select[name="templates"]');
  select_btn.on("change", function(e){ app.setting.onChangeTicketTemplate($(this))});

  app.submit.$el.find("form:first").on("submit", function(){app.submit.onSubmit($(this));})


  //fisrt time invokeing onesself
  app.setting.onChangePreviewType(radio_btn)
     .then(function(){app.setting.onChangeTicketTemplate(select_btn);})


});

</script>

<div class="component-area">
xxxx
</div>
