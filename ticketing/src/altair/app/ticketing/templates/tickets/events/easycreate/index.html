<%inherit file="/layout_2cols.html" />
<%namespace file="/common/helpers.html" name="ch" />

<%block name="breadcrumbs">
${ch.breadcrumbs(
  names=[u'イベント', event.title, u'券面', u'券面簡易作成'],
  urls=[request.route_path('events.index'),
        request.route_path('events.show', event_id=event.id),
        request.route_path('events.tickets.index', event_id=event.id)]
)}
</%block>

## todo:moveto helpers
<%block name="style">
<style type="text/css">
  .input-group { padding: 10px; }
  .input-group label { display: inline-block; margin-left:1px;}
  .input-group input[type="radio"] {margin-left:3px;}
  .input-group input[type="radio"]:nth-child(1) {margin-left:0px;}
  .input-group input[type="checkbox"] {margin-left:3px;}
  .input-group input[type="checkbox"]:nth-child(1) {margin-left:0px;}

/* steps */
  .wizard {margin-left: 20px; margin-bottom:10px;}
  .wizard a {padding: 5px 6px 5px; margin-right: 5px; background: #EFEFE1; position: relative; display: inline-block; }
  .wizard a:before { width: 0; height: 0; border-top: 14px inset transparent; border-bottom: 15px inset transparent; border-left: 16px solid #FFFFF4; position: absolute; content: ""; top: 0; left: 0; }
  .wizard a:after { width: 0; height: 0; border-top: 14px inset transparent; border-bottom: 15px inset transparent; border-left: 16px solid #EFEFE1; position: absolute; content: ""; top: 0; right: -15px; z-index: 2; }
  .wizard a:first-child:before{ border: none; }
  .wizard .badge { margin: 0 5px 0 18px; position: relative; top: -1px; }
  .wizard a:first-child .badge { margin-left: 0; }
  .wizard .current { background: #75A843; color: #FFFFFF; }
  .wizard .current:after { border-left-color: #75A843; }

/* message */
  .message { display: block; margin-left: 30px; position: absolute; top: 45px; left: 350px; z-index: 10; }
  .message-row {height:0px;}

/* description */
  .description-box { padding: 10px;}
  .userhandle-box { padding: 10px;}
</style>
</%block>

<%def name="radio_group(form, attrname, required=True)">
<div class="control-group">
${getattr(form,attrname).label(class_="required control-label")}
<div class="controls ">
<div class="input-group" id="${attrname}">
%for f in getattr(form,attrname):
  %if f.checked:
    ${f(checked="checked")} ${f.label}
  %else:
    ${f} ${f.label}
  %endif
%endfor
</div>
</div>
</div>
</%def>

<%def name="checkbox_group_list(form, attrname_list, required=True)">
<div class="control-group">
<div class="controls ">
<div class="input-group">
%for attrname in attrname_list:
  <% f = getattr(form,attrname) %>
  ${f(id=attrname)} ${f.label}
%endfor
</div>
</div>
</div>
</%def>

<h3>チケット券面</h3>

<div class="userhandle-area">
  <div class="wizard">
    <a href="#" id="wizard-nav0" class="wizard-nav current" data-toggle="#userhandle0"><span class="badge">1.</span> レンダリング方法選択</a>
    <a href="#" id="wizard-nav1" class="wizard-nav" data-toggle="#userhandle1"><span class="badge badge-inverse">2.</span> 文言変更</a>
    <a href="#" id="wizard-nav2" class="wizard-nav" data-toggle="#userhandle2"><span class="badge">3.</span> 登録データ設定</a>
    <a href="#" id="wizard-nav3" class="wizard-nav" data-toggle="#userhandle3"><span class="badge">4.</span> 登録された券面一覧</a>
  </div>

  <div class="row-fluid">
    <div id="userhandle0" class="userhandle">
        <div class="setting-area hero-unit span4">
        ${radio_group(choice_form, "preview_type")}
        ${ch.form_item(choice_form.templates)}
        </div>
        <div class="description-box span5">
          <h4>1. レンダリング方法を指定してください。</h4>
          <ul>
            <li>インナー発券 --- 通常利用する券面です。previewにかかる時間が短いです</li>
            <li>SEJ発券 ---  SEJ引取の際に利用するする券面です。previewにかかる時間はとても長いです</li>
          </ul>
          <h4>2. 券面テンプレートを指定してください</h4>
          <p>システムに券面の雛型となるデータが格納されています。preview結果を見ながら左の選択欄で設定してください</p>
          <div class="userhandle-box">
            <a class="btn js-handle-btn" href="#" data-toggle="#wizard-nav1">次へ</a>
          </div>
        </div>
    </div>
    <div id="userhandle1" class="userhandle" style="display:none">
      <div class="descriptioin-area span6 hero-unit">
      </div>
        <div class="description-box span5">
          <div class="userhandle-box">
            <a class="btn js-handle-btn" href="#" data-toggle="#wizard-nav0">戻る</a>
            <a class="btn js-handle-btn" href="#" data-toggle="#wizard-nav2">次へ</a>
          </div>
        </div>
    </div>
    <div id="userhandle2" class="userhandle" style="display:none">
        <div class="submit-area hero-unit span5">
        <form method="POST" action="${request.route_path("events.tickets.easycreate",event_id=event.id)}">
        ${ch.form_item(upload_form.name)}
        ${radio_group(upload_form,"preview_type")}
        ${ch.form_item(upload_form.ticket_format_id)}
        ${checkbox_group_list(upload_form, ["always_reissueable","priced","cover_print"])}
        ${ch.form_item(upload_form.drawing)}
        <input type="submit" value="券面を作成"/>
        </form>
        </div>
        <div class="description-box span5">
          <div class="userhandle-box">
            <a class="btn js-handle-btn" href="#" data-toggle="#wizard-nav1">戻る</a>
          </div>
        </div>
    </div>
  </div>
</div>

<script type="text/javascript" src="${request.static_url("altair.app.ticketing:static/js/tickets/easycreate/app.js")}"></script>
<script type="text/javascript" src="${request.static_url("altair.app.ticketing:static/js/tickets/easycreate/helpers.js")}"></script>
<script type="text/javascript">
// loading component, the trigger is preview type radio button of above area.
app.BrokerData = {
  component: {value: null, writable: true},
  setting: {value: null, writable: true},
  submit: {value: null, writable: true}
}
app.broker = Object.create(app.BrokerModule, app.BrokerData);

$(function(){
  app.ComponentAreaData = {
    broker: {value: app.broker},
    $el: {value: $(".component-area"), writable: false},
    ticket_formats_iterable: {value: [], writable: true},
    preview_type: {value: "", writable: true},
    loadcomponent_url: {value: "${request.route_path("events.tickets.easycreate.loadcomponent", event_id=event.id, preview_type="__previewtype")}"},
    gettingtemplate_url: {value: "${request.route_path("events.tickets.easycreate.gettingtemplate", event_id=event.id, preview_type="__previewtype")}"},
    gettingformat_url: {value: "${request.route_path("events.tickets.easycreate.gettingformat", event_id=event.id, preview_type="__previewtype")}"},
    gettingsvg_url: {value: "${request.route_path("events.tickets.easycreate.gettingsvg", event_id=event.id, ticket_id="__ticket_id", preview_type="__previewtype")}"},
  };

  app.UserHandleAreaData = {
    broker: {value: app.broker},
    $el: {value: $(".userhandle-area"),writable: false}
  };

  app.SettingAreaData = {
    broker: {value: app.broker},
    $el: {value: $(".setting-area"), writable: false}
  }

  app.SubmitAreaData = {
    broker: {value: app.broker},
    $el: {value: $(".submit-area"), writable: false}
  }

  app.userhandle = Object.create(app.UserHandleAreaModule,app.UserHandleAreaData);
  app.setting = Object.create(app.SettingAreaModule, app.SettingAreaData);
  app.submit = Object.create(app.SubmitAreaModule, app.SubmitAreaData);
  app.component = Object.create(app.ComponentAreaModule, app.ComponentAreaData);

  app.broker.setting = app.setting;
  app.broker.submit = app.submit;
  app.broker.component = app.component;

  // binding observer event
   app.userhandle.$el.find("a.wizard-nav").on("click", function(e){app.userhandle.onClickNavigation($(this)); return false;});
   app.userhandle.$el.find("a.js-handle-btn").on("click", function(e){app.userhandle.onClickHandleButton($(this)); return false;});

  var radio_btn = app.setting.$el.find('input[name="preview_type"]:radio');
  radio_btn.on("change", function(e){ app.setting.onChangePreviewType($(this))});

  var select_btn = app.setting.$el.find('select[name="templates"]');
  select_btn.on("change", function(e){ app.setting.onChangeTicketTemplate($(this))});

  app.submit.$el.find("form:first").on("submit", function(){app.submit.onSubmit($(this)); return false;})


  //fisrt time invokeing onesself
  app.setting.onChangePreviewType(radio_btn)
     .then(function(){app.setting.onChangeTicketTemplate(select_btn);})


});

</script>

<div class="component-area">
xxxx
</div>
