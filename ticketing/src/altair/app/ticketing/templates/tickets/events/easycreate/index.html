<%inherit file="/layout_2cols.html" />
<%namespace file="/common/helpers.html" name="ch" />

<%block name="breadcrumbs">
${ch.breadcrumbs(
  names=[u'イベント', event.title, u'券面', u'券面簡易作成'],
  urls=[request.route_path('events.index'),
        request.route_path('events.show', event_id=event.id),
        request.route_path('events.tickets.index', event_id=event.id)]
)}
</%block>
<%block name="style">
<style type="text/css">
  .radio-group { padding: 10px; }
  .radio-group label { display: inline-block; margin-left:1px;}
  .radio-group input[type="radio"] {margin-left:3px;}
  .radio-group input[type="radio"]:nth-child(1) {margin-left:0px;}
</style>
</%block>

<h3>チケット券面</h3>
<div class="setting-area">
<form>
<div class="control-group">
${choice_form.preview_type.label(class_="required control-label")}
<div class="controls ">
<div class="radio-group" id="preview_type">
%for f in choice_form.preview_type:
  ${f} ${f.label}
%endfor
</div>
</div>
</div>

${ch.form_item(choice_form.templates)}
<script type="text/javascript">

// Module needs {"loadcomponent_url","gettingsvg_url","gettingtemplate_url", "select_template"}
var BrokerModule = {
  onChangePreviewType: function($el){
    var val = $el.val();
    this.preview_type = val;
    var load_url = this.loadcomponent_url.replace("__previewtype", val);
    var getting_url = this.gettingtemplate_url.replace("__previewtype", val);
    return this.gettingNewTemplates(getting_url)
        .then(function(){return this.loadingComponent(load_url)}.bind(this));
  },
  loadingComponent: function(url){
    return $.get(url).fail(
      function(){ $(".component-area").text("error: url="+url)}
    ).done(
      function(html){ $(".component-area").html(html); }
    );
  },
  gettingNewTemplates: function(url){
    var html_template = this.select_template;
    return $.get(url).fail(
      function(){ $(".component-area").text("error: url="+url)}
    ).done(
      function(data){ $('.setting-area select[name="templates"]').html(html_template({"iterable": data.iterable}));}
    );
  },
  onChangeTicketTemplate: function($el){
    var val = $el.val();
    var url = this.gettingsvg_url.replace("__ticket_id", val).replace("__previewtype", this.preview_type);

    return this.sendingSVGViaRequest(url);
  },
  sendingSVGViaRequest: function(url){
    return $.get(url).fail(
      function(){ $(".component-area").text("error: url="+url);}
    ).done(
      function(data){
        //xxxx global variable: this variable create after loading component
        window.appView.loadSVG(data.svg, data.preview_type);
    });
  }
};

<%! fmt = '''<% _.each(iterable, function(d){%><option value="<%= d.value %>"><%= d.label %></option> <%});%>''' %>
var BrokerData = {
  select_template: {value: _.template('${fmt|n}')},
  preview_type: {value: "", writable: true},
  loadcomponent_url: {value: "${request.route_path("events.tickets.easycreate.loadcomponent", event_id=event.id, preview_type="__previewtype")}"},
  gettingtemplate_url: {value: "${request.route_path("events.tickets.easycreate.gettingtemplate", event_id=event.id, preview_type="__previewtype")}"},
  gettingsvg_url: {value: "${request.route_path("events.tickets.easycreate.gettingsvg", event_id=event.id, ticket_id="__ticket_id", preview_type="__previewtype")}"},
};

// loading component, the trigger is preview type radio button of above area.
(function(form){
  var broker = Object.create(BrokerModule, BrokerData)

  var radio_btn = form.find('input[name="preview_type"]:radio');
  radio_btn.on("change", function(e){ broker.onChangePreviewType($(this))});

  var select_btn = form.find('select[name="templates"]');
  select_btn.on("change", function(e){broker.onChangeTicketTemplate($(this))});
})($("script:last").parent());
</script>
</form>

<div class="component-area">
  
</div>

<div class="submit-area">
  
</div>
