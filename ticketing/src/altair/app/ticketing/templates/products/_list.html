<%page args="products=None, performance=None, sales_segment=None, limit=None" />
<%namespace file="/common/helpers.html" name="ch" />
<%namespace file="/product_items/_action_button.html" name="b" />
<%namespace file="altair.viewhelpers:subview.html" name="sb"/>

<% from altair.app.ticketing.core.models import Product %>
% if performance or sales_segment:
<%
from altair.app.ticketing.core.models import StockHolder, Stock

## sales_segments
if performance is not None:
    sales_segments = sorted(performance.sales_segments, key=lambda x:(x.order, x.name))
elif sales_segment:
    sales_segments = [sales_segment]
%>

<script type="text/javascript">
  $(function() {
    $('#use-grid-editor').change(function() {
      if ($.cookie('grid-editor')) {
        $('.product-table').hide();
        $('.grid-editor').show();
        $(this).text('旧商品登録フォームを使う');
      } else {
        $('.product-table').show();
        $('.grid-editor').hide();
        $(this).text('新商品登録フォームを使う');
      }
    }).change();
    $('#use-grid-editor').click(function() {
      if ($.cookie('grid-editor')) {
        $.cookie('grid-editor', null, {path:'/', expires:7});
      } else {
        $.cookie('grid-editor', 'hide', {path:'/', expires:7});
      }
      $(this).change();
    });
  });
</script>
<div id="use-grid-editor" class="label label-warning pull-right" style="width: 200px; margin-bottom: 5px; text-align: center;"></div>

## 新商品登録フォーム
<script type="text/javascript">
  (function($) {
    $.fn.setRetainChanges = function(cells) {
      if (this.data('retainedChanges') == undefined) {
        this.data('retainedChanges', {});
      }
      var retainedChanges = this.data('retainedChanges');
      cells = cells || this.getChangedCells('dirty');
      for (var i=0; i<cells.length; i++) {
        if (!retainedChanges[cells[i].id]) {
          retainedChanges[cells[i].id] = {};
        }
        retainedChanges[cells[i].id] = $.extend(retainedChanges[cells[i].id], cells[i]);
      }
      this.data('retainedChanges', retainedChanges);
    };
    $.fn.getRetainChanges = function(type) {
      type = type || 'row';
      if (type == 'row') {
        var rows = [];
        if (this.data('retainedChanges') != undefined) {
          var retainedChanges = this.data('retainedChanges');
          for (var k in retainedChanges) {
            rows.push($.extend({id:k}, this.getRowData(k)));
          }
        }
        return rows;
      }
      if (type == 'cell') {
        var cells = []
        if (this.data('retainedChanges') != undefined) {
          var retainedChanges = this.data('retainedChanges');
          for (var k in retainedChanges) {
            cells.push(retainedChanges[k]);
          }
        }
        return cells;
      }
    };
    $.fn.clearRetainChanges = function() {
      this.data('retainedChanges', {});
      this.setGridParam({datatype:'json', treedatatype:'json'}).trigger('reloadGrid');
      this.setGridParam({treedatatype:'local'});
    };
    $.fn.getColumnLabel = function(grid, columnName) {
      var cm = grid.jqGrid('getGridParam','colModel');
      for (var i=0; i<cm.length; i++) {
        if (cm[i].name == columnName) return grid.jqGrid('getGridParam','colNames')[i];
      }
    };
    $.fn.linkFormatter = function(cellvalue, options, rowObject) {
      var link = '';
      if (!rowObject.level) {
        link += '<a href="javascript:addRow(' + "'" + options.gid + "'," + options.rowId + ');"><i class="icon-plus"></i></a>';
      }
      if (rowObject.product_item) {
        link += '<a href="javascript:deleteRow(' + "'" + options.gid + "'," + options.rowId + ');"><i class="icon-trash"></i></a>';
      }
      if (rowObject.ticket_bundle && rowObject.ticket_bundle.id) {
        link += '<a href="javascript:preview_ticket(' + rowObject.product_item.id + ')"><i class="icon-eye-open"></i></a>';
      }
      return link;
    };
  })(jQuery);

  function addRow(gid, rowId) {
    var grid = $('#' + gid);
    var row = grid.getRowData(rowId);
    if (!row.level) {
      grid.setCell(rowId, 'parent', 'null');
      grid.setCell(rowId, 'level', 0);
      grid.setCell(rowId, 'isLeaf', false);
      grid.setCell(rowId, 'expanded', true);
      grid.setCell(rowId, 'loaded', true);
    }

    var data ={
      product_id:row.product_id,
      product_name:'(複数在庫商品)'
    }
    grid.addChildNode(undefined, rowId, data);
  }
  function deleteRow(gid, rowId) {
    var grid = $('#' + gid);
    grid.setCell(rowId, 'stock_holder_id', '', {background:'#BD362F'});
    grid.setCell(rowId, 'product_item_name', '', {background:'#BD362F'});
    grid.setCell(rowId, 'product_item_price', '', {background:'#BD362F'});
    grid.setCell(rowId, 'product_item_quantity', '', {background:'#BD362F'});
    grid.setCell(rowId, 'stock_quantity', '', {background:'#BD362F'});
    grid.setCell(rowId, 'stock_status_quantity', '', {background:'#BD362F'});
    grid.setCell(rowId, 'ticket_bundle_id', '', {background:'#BD362F'});
    grid.setCell(rowId, 'deleted', true);
    var row = new Object();
    row['id'] = rowId;
    grid.setRetainChanges([row]);
  }
</script>

<div class="tabbable tabs-top grid-editor">
  <ul class="nav nav-tabs">
    % for i, sales_segment in enumerate(sales_segments):
    <li class="${'active' if i == 0 else ''}"><a  id="product_editor${sales_segment.id}" href="#sales-segment-tab-${sales_segment.id}" data-toggle="tab">${sales_segment.name}</a></li>
    % endfor
  </ul>

  <div class="tab-content">
    <p>※このアイコン<i class="icon-eye-open"></i>をクリックすると券面のプレビューができます</p>
    % for i, sales_segment in enumerate(sales_segments):
    <div class="tab-pane ${'active' if i == 0 else ''}" id="sales-segment-tab-${sales_segment.id}">
      <%sb:react_subview
         target="product_editor${unicode(sales_segment.id)}"
         url="${request.route_path('products.sub.newer.show', sales_segment_id=sales_segment.id)}"
         data="${dict(i=i)}"
      />
    </div>
    % endfor
  </div>
</div>
% endif

## 旧商品登録フォーム
<div class="tabbable tabs-top product-table">
  <ul class="nav nav-tabs">
  % for i, sales_segment in enumerate(sales_segments):
    <li class="${'active' if i == 0 else ''}"><a id="product_table${sales_segment.id}" href="#sales-segment-${sales_segment.id}" data-toggle="tab">${sales_segment.name}</a></li>
    % endfor
  </ul>
  <div class="tab-content" id="tabbable-tab-content">
    <p>※このアイコン<i class="icon-eye-open"></i>をクリックすると券面のプレビューができます</p>
    % for i, sales_segment in enumerate(sales_segments):
    <div class="tab-pane ${'active' if i == 0 else ''}" id="sales-segment-${sales_segment.id}">
      <%sb:react_subview
         target="product_table${unicode(sales_segment.id)}"
         url="${request.route_path('products.sub.older.show',sales_segment_id=sales_segment.id)}"
         data="${dict(i=i)}"
      />
    </div>
    % endfor
  </div>
</div>
## パフォーマンス指定あり
  <script type="text/javascript" src="${request.static_url("altair.app.ticketing:static/js/spin.js")}"></script>
  <script type="text/javascript" src="${request.static_url("altair.app.ticketing:static/js/altair/spinner.js")}"></script>
  <script type="text/javascript" src="${request.static_url("altair.app.ticketing:static/js/tickets/modal/api.js")}"></script>
  <script type="text/javascript"></script>

  <div id="preview_ticket_modal"></div>

## アラートダイアログ
<div id="modal-alert" class="modal hide">
  <div class="modal-header">
    <a href="#" class="close" data-dismiss="modal">&times;</a>
    <h3></h3>
  </div>
  <div class="modal-body">
    <p id="message"></p>
  </div>
  <div class="modal-footer">
    <a href="javascript:void(0);" onclick="$('#modal-alert').modal('hide');" class="btn secondary">閉じる</a>
  </div>
</div>
