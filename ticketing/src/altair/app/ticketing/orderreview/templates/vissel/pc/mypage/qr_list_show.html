<%page args="order, h, orgid, sendqrmailtokenlist, tokens" />
<%namespace file="altair.app.ticketing.orderreview:templates/__commons__/skidata_qr/helper.html" name="skidata_helper" />
<%! from altair.app.ticketing.skidata.models import SkidataPropertyEntry %>

<script>
$(function(){
    //.accordion1の中のp要素がクリックされたら
	$('.accordion p').click(function(){
    　$(this).next().slideToggle();
	});
});
</script>

<main>
  <div class="login-page">
    <div class="contents">
      <section class="bg-contents">
        <div class="inner wrap">
          <table class="login-tbl">
            <tr>
              <td class="login-box login-fun">
                <section>
                  <div class="inner">
                    <div class="sub-contents">
                      <h4 class="sub-ttl tac" style="color:#585858">${_(u'受付番号:')}${order.order_no}</h4>
                        <div class="orderreview-list-wrap">
                          <ul class="orderreview-list">
                            % if tokens:
                              % for token in tokens:
                                <li style="padding: 0">
                                  <table class="orderreview-tbl">
                                    <tr>
                                      <th>
                                        <ul class="sate-list">
                                          % if token.resale_request:
                                            <li class="${h.get_resale_status_style(token)}" style="width: 100%">
                                              ${token.resale_request.resale_status_label}
                                            </li>
                                          % else:
                                            <p></p>
                                          %endif
                                        </ul>
                                      </th>
                                      <td class="payment-detail">
                                        <form id="${order.order_no}" name="${order.order_no}" action="" method="POST">
                                          <input type="hidden" name="order_no" value="${order.order_no}" />
                                          <input type="hidden" name="tel" value="${order.shipping_address.tel_1}" />
                                          <input type="hidden" name="token" value="${token.id if token else ""}" />

                                          <div class="payment-detail-box">
                                            <p>${token.item.product_item.name}</p>
                                            % if token.seat:
                                              <p>${token.seat.name}</p>
                                            %endif
                                            <% sentemailinfos = token.skidata_barcode.emails%>
                                            <% finalflg = True%>
                                            % if sentemailinfos:
                                              <% finalsendinfo = sentemailinfos[0] %>
                                              % if finalsendinfo:
                                                <p style="font-size: 9px; color:red">最終送信時刻：${finalsendinfo.sent_at}</p>
                                                <p style="font-size: 9px;color:red">最終送信先：${finalsendinfo.to_address}</p>
                                              % endif

                                              <ul class="accordion">
                                                <li style="border-bottom:0;padding: 0;">
                                                  <p>送信履歴</p>
                                                  <ul class="inner">
                                                    % for sentemailinfo in sentemailinfos:
                                                      <span style="font-size: 9px;">送信時刻：${sentemailinfo.sent_at}<br></span>
                                                      <span style="font-size: 9px;">送信先：${sentemailinfo.to_address}<br></span>
                                                    % endfor
                                                  </ul>
                                                </li>
                                              </ul>
                                            % endif
                                          </div>
                                        </form>
                                      </td>
                                      <td class="confirm-box">
                                      % if token.resale_request is None or (token.resale_request and not token.resale_request.has_send_to_resale_status):
                                        ${skidata_helper.build_btn_to_show_qr_ticket(token.skidata_barcode, btn_label=u'QR表示', btn_cls=u'payment-confirm-btn')}
                                      % endif
                                      </td>
                                    </tr>
                                  </table>
                                </li>
                              % endfor
                            % endif
                            <li style="border-bottom: 0px">
                              <p align="center" style="font-size: 18px;"><strong>QRコードをメールで送る</strong></p>
                              <table class="orderreview-tbl">
                                <form method="post" action="${request.route_path('order_review.qr_send')}">
                                  <input type="hidden" name="order_no" value="${order.order_no}" />
                                  <input type="hidden" name="tel" value="${order.shipping_address.tel_1}" />
                                  <input type="hidden" name="subject" value="【イーグルスチケット】発券用QRコードのご送付" />
                                  <input type="hidden" name="skidataflg" value="1" />
                                  <tr>
                                    <td align="center">
                                      <select  name="token" align="center" style="-webkit-appearance: menulist;-moz-appearance: menulist;">
                                      % for sendqrmailtoken in sendqrmailtokenlist:
                                        <option value="${sendqrmailtoken.id}">
                                          % if sendqrmailtoken.seat:
                                            ${sendqrmailtoken.seat.name}
                                          % else:
                                            ${sendqrmailtoken.item.product_item.name}
                                          % endif
                                        </option>
                                      % endfor
                                      </select>
                                    </td>
                                  </tr>
                                  <tr>
                                    <td width="50%"><br></td>
                                  </tr>
                                  <tr>
                                    <td align="center">
                                      <input type="email" name="mail" class="input-email" placeholder="メールアドレスを入力してください。">
                                    </td>
                                  </tr>
                                  <tr>
                                    <td align="center">
                                      <input type="submit" name="send" value="送信する" style="min-width:50%;" class="btn btn-vissel" />
                                    </td>
                                  </tr>
                                </form>
                              </table>
                            </li>
                          </ul>
                        </div>
                    </div>
                  </div>
                </section>
              </td>
            </tr>
          </table>
        </div>
      </section>
    </div>
  </div>
</main>
