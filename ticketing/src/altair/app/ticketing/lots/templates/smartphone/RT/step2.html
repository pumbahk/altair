<%inherit file="${context['main_template'].uri}" />
<div id="main">
  <h1><img src="${request.static_url('altair.app.ticketing.lots:static/img/order/title_settlement.gif')}" alt="チケット申込" width="950" height="40" /></h1>
  %if request.session.peek_flash():
  <div style="border: 3px solid red; background: #FFEEEE; padding: 10px; margin: 10px;">
    <ul>
      %for message in request.session.pop_flash():
      <li>${message}</li>
      %endfor
    </ul>
  </div>
  %endif

  <form method="post" id="wishForm" action="${request.route_path('lots.entry.sp_step3', event_id=event.id, lot_id=lot.id)}">
    % for cnt, wish in enumerate(wishes):
      <%
        wish_order = wish['wished_products'][0]['wish_order']
        performance_id = wishes[cnt]['performance_id']
        product_id = wish['wished_products'][0]['product_id']
        quantity = wish['wished_products'][0]['quantity']
      %>
      <input type="hidden" name="wish_order-${wish_order}-performance_id" value="${performance_id}"/>
      <input type="hidden" name="wish_order-${wish_order}-product_id" value="${product_id}"/>
      <input type="hidden" name="wish_order-${wish_order}-quantity" value="${quantity}"/>
    % endfor

    <div class="settlementBox">
      <div class="settlementBoxInner">
        <h2><img src="${request.static_url('altair.app.ticketing.lots:static/img/order/title_how.gif')}" alt="お支払・お引取り方法選択" width="208" height="30" /></h2>
        %for m in payment_delivery_pairs:
        <div class="settlementPayBox">
          <div class="settlementPayBoxInner">
            <table>
              <tbody>
                <tr>
                  <% checked = 'checked' if str(m.id) == payment_delivery_method_pair_id else '' %>
                  <td class="settlementPayRadio"${u' rowspan="2"' if m.system_fee > 0 or m.special_fee > 0 else u''|n}><input type="radio" name="payment_delivery_method_pair_id" id="radio" value="${m.id}" ${checked} /></td>
                  <td>
                    <dl class="left">
                      <dt>${m.payment_method.name}　${h.format_currency(m.transaction_fee)} (${h.fee_type(m.payment_method.fee_type)})</dt>
                      <dd>${m.payment_method.description or '' | n}<br /></dd>
                    </dl>
                    <dl class="left">
                      <dt>${m.delivery_method.name}　${h.format_currency(m.delivery_fee)} (${h.fee_type(m.delivery_method.fee_type)})</dt>
                      <dd>${m.delivery_method.description or '' | n}</dd>
                    </dl>
                  </td>
                </tr>
                % if m.system_fee > 0 or m.special_fee > 0:
                <tr>
                  <td colspan="2">
                    <dl>
                      <dt>利用料・手数料</dt>
                      <dd>
                        <dl>
                        %if m.system_fee > 0:
                          <dt>システム利用料</dt>
                          <dd class="paymentFee_${h.format_number(m.transaction_fee)}">
                            <span class="paymentFee">${h.format_currency(m.system_fee)}</span>
                            <span class="paymentFeeType">(${h.fee_type(m.system_fee_type)})</span>
                          </dd>
                        %endif
                        %if m.special_fee > 0:
                          <dt>${m.special_fee_name}</dt>
                          <dd class="paymentFee_${h.format_number(m.transaction_fee)}">
                            <span class="paymentFee">${h.format_currency(m.special_fee)}</span>
                            <span class="paymentFeeType">(${h.fee_type(m.special_fee_type)})</span>
                          </dd>
                        %endif
                        </dl>
                        <div class="description">上記の利用料・利用料がかかります。</div>
                      </dd>
                    </dl>
                  </td>
                </tr>
                % endif
              </tbody>
            </table>
          </div>
        </div>
        %endfor
      </div>
    </div>

    <div class="settlementBox">
      <div class="settlementBoxInner">
        <h2><img src="${request.static_url('altair.app.ticketing.lots:static/img/order/title_buyer.gif')}" alt="購入者情報" width="97" height="30" /></h2>
        <div class="settlementSelectBox">
          <div class="settlementSelectBoxInner02">
            <table summary="お支払・お引取り方法選択">
              <tr>
                <th><label>購入者氏名（全角）</label></th>
                <td>
                  <div class="form-field">
                    ${form['last_name'].label} ${form['last_name']}
                    ${self.error(form, 'last_name')}
                  </div>
                  <div class="form-field">
                    ${form['first_name'].label} ${form['first_name']}
                    ${self.error(form, 'first_name')}
                  </div>
                </td>
              <tr>
                <th><label>購入者氏名（カナ）</label></th>
                <td>
                  <div class="form-field">
                    ${form['last_name_kana'].label} ${form['last_name_kana']}
                    ${self.error(form, 'last_name_kana')}
                  </div>
                  <div class="form-field">
                    ${form['first_name_kana'].label} ${form['first_name_kana']}
                    ${self.error(form, 'first_name_kana')}
                  </div>
                </td>
              </tr>
              <tr>
                <th>メールアドレス</th>
                <td>
                  <div class="form-field">
                    ${form['email_1'].label}
                    ${form['email_1']}
                    ${self.error(form, 'email_1')}
                  </div>
                  <div class="form-field">
                    ${form['email_1_confirm'].label}
                    ${form['email_1_confirm']}
                    ${self.error(form, 'email_1_confirm')}
                  </div>
                </td>
              </tr>
              <tr>
                <th>電話番号</th>
                <td>
                  <div class="form-field">
                    ${form['tel_1'].label}
                    ${form['tel_1']}
                    ${self.error(form, 'tel_1')}
                  </div>
                  <div class="form-field">
                    ${form['tel_2'].label}
                    ${form['tel_2']}
                    ${self.error(form, 'tel_2')}
                  </div>
                </td>
              </tr>
              <tr>
                <th><label>配送先住所</label></th>
                <td>
                  <% path = request.static_url('altair.app.ticketing.cart:static/js/zipdata') %>
                  <div class="form-field">
                    ${form['zip'].label}
                    ${form['zip'](onKeyUp="AjaxZip3.zip2addr('" + path + "', 'zip','','prefecture','city','', 'address_1');")}
                    ${self.error(form, 'zip')}
                  </div>
                  <div class="form-field">
                    ${form['prefecture'].label}
                    ${form['prefecture']}
                    ${self.error(form, 'prefecture')}
                  </div>
                  <div class="form-field">
                    ${form['city'].label}
                    ${form['city']}
                    ${self.error(form, 'city')}
                  </div>
                  <div class="form-field">
                    ${form['address_1'].label}
                    ${form['address_1'](style="width: 30em")}
                    ${self.error(form, 'address_1')}
                  </div>
                  <div class="form-field">
                    ${form['address_2'].label}
                    ${form['address_2'](style="width: 30em")}
                    ${self.error(form, 'address_2')}
                  </div>
                </td>
              </tr>
              <tr>
                <th>生年月日</th>
                <td>
                  ${form['year']} 年
                　${form['month']} 月
                　${form['day']} 日
                  ${self.error(form, 'year')}
                </td>
              </tr>
              <tr>
                <th>${form['sex'].label}</th>
                <td>
                  ${form['sex']}
                  ${self.error(form, 'sex')}
                </td>
              </tr>
              <tr class="settlementSelectEnd">
                <th>メモ欄</th>
                <td>${form['memo'](cols=50, rows=5)} ${self.error(form, 'error')}</td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
    <p class="align2"><input type="image" src="${request.static_url('altair.app.ticketing.lots:static/img/settlement/btn_next.gif')}" alt="次へ" width="226" height="46" /></p>
  </form>      
</div>
