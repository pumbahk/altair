<%inherit file="./base.html"/>
<% from altair.app.ticketing.core.models import PointUseTypeEnum %>

<%block name="javascript">
  <script type="text/javascript" src="${request.static_url('altair.app.ticketing.cart:static/js/disable_on_submit.js')}"></script>
  <script type="text/javascript">
    $(function() {
      $('#form1').disableOnSubmit('input[type=submit][name!="back"]');
    });
    function validateBeforeSubmit() {
      var inputPointElement = document.getElementById('input_point');
      inputPointElement.setCustomValidity("");

      if (document.getElementById('partial_use').checked) {

        var validated_msg = '「利用ポイント数」を入力してください。';
        if (inputPointElement.value) {

          inputPointElement.value = replaceValidChar(inputPointElement.value);
          validated_msg = /^\d+$/.test(inputPointElement.value)
                  ? (parseInt(inputPointElement.value) >= 50 ? '' : '50ポイント以上を入力してください。')
                  : '「利用ポイント数」には半角数字を入力してください。';
        }
        inputPointElement.setCustomValidity(validated_msg);
      }
    }
    function replaceValidChar(val) {
      return val.replace(/[\s　]+/g, '').replace(/[０-９]/g, function (s) { return String.fromCharCode(s.charCodeAt(0) - 0xFEE0); });
    }
  </script>
</%block>
<%block name='css'>
<style type="text/css">
  .point-use-box {
    margin: 20px auto 0 auto;
    padding: 5px;
    width: 95%;
    border: 1px solid #ccc;
  }
  .point-use-box .title {
    font-size: 15px;
    padding: 5px;
  }
  .point-use-box .content {
    font-size: 13px;
    margin-left: 5px;
    padding: 5px;
  }
  .point-use-box .content .point-use-list {
    display: flex;
    align-items: center;
    padding: 10px 0;
  }
  .point-use-box .content .point-use-list:first-child {
    padding: 0 0 10px;
  }
  .point-use-box .content label span {
    margin: 0 5px;
  }
  .point-use-notice .sub-title {
    font-size: 12px;
    padding: 5px;
  }
  .point-use-notice ul {
    padding: 5px 5px 5px 23px;
  }
  .point-use-notice ul li {
    font-size: 10px;
    list-style-type: disc;
    padding: 3px;
  }
  .crimson {
    color: #DC143C;
  }
  input[type='radio'] {
    position: relative;
    bottom: 1px;
  }
  input[type='text'] {
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
    border: 1px solid #CCC;
    background: #f4f3f1;
    height: 30px;
    width: 120px;
    padding-left: 5px;
  }
  input[type=text]::-webkit-input-placeholder,
  input[type=text]::placeholder {
    padding-left: 3px;
  }
  input[type=text]:-ms-input-placeholder {
    padding-left: 3px;
  }
  .fixed-font-size {
    font-size: 15px;
  }
</style>
</%block>

% if request.session.peek_flash():
  % for message in request.session.pop_flash():
  <div class="error fixed-font-size">${message}</div>
  % endfor
% endif

<form id="form1" action="${request.url}" method="post">
  <div class="confirmBox">
    <h2>${__(u'お買い物内容')}</h2>
    <p class="purchase-title">${cart.performance.event.title} ${cart.performance.name} ${h.performance_datetime(cart.performance, i18n)}(${__(u'予定')}) ${cart.performance.venue.name}</p>
    <div class="confirmBoxInner">
      <table id="contentsOfShopping" summary="${__(u'席種、金額などのお買い物内容')}">
        <tbody>
          % for product in cart.items:
          <tr>
            % if len(product.items) == 1:
            <th scope="row"><img src="${view_context.static_url('pc/images/icon_dummy.gif')}" alt="" width="21" height="21" /> ${product.product.name}</th>
            <td><strong>${product.seat_quantity}</strong>${__(u'枚')}</td>
            % else:
            <th scope="row"><img src="${view_context.static_url('pc/images/icon_dummy.gif')}" alt="" width="21" height="21" /> ${product.product.name}</th>
            <td>×<strong>${product.quantity}</strong></td>
            % endif
            <td>
              % if product.product.sales_segment.setting.display_seat_no:
                % for seat in product.seats:
                  ${seat['name']}<br/>
                % endfor
              % endif
            </td>
            <td class="align1" width="25%">￥${h.format_number(product.product.price * product.quantity)}</td>
          </tr>
          % endfor
          <tr>
            <th scope="row" colspan="3">${__(u'決済手数料')}</th>
            <td class="align1">￥${h.format_number(cart.transaction_fee)}</td>
          </tr>
          <tr>
            <th scope="row" colspan="3">${__(u'発券/引取手数料')}</th>
            <td class="align1">￥${h.format_number(cart.delivery_fee)}</td>
          </tr>
          <tr>
            <th scope="row" colspan="3">${__(u'システム利用料')}</th>
            <td class="align1">￥${h.format_number(cart.system_fee)}</td>
          </tr>
          %if cart.special_fee > 0:
          <tr>
            <th scope="row" colspan="3">${cart.special_fee_name}</th>
            <td class="align1">￥${h.format_number(cart.special_fee)}</td>
          </tr>
          %endif
          <tr class="purchase-table-total">
            <th scope="row" colspan="3" class="fs14">${__(u'合計金額')}</th>
            <td class="align1">￥${h.format_number(cart.total_amount)}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="confirmBox">
    <h2>${__(u'ポイント入力')}</h2>
	  <div class="confirmBoxInner">
      <div class="point-use-box">
        <div class="title">ポイント残高</div>
        <div class="content">${cart.shipping_address.last_name} ${cart.shipping_address.first_name} さんの通常ポイント残高	　:　<span class="crimson">${h.format_number(fix_point)}</span> ポイント（円）</div>
      </div>
      <% label_style = '' if is_point_available else 'style="opacity: 0.5;"' %>
      <div class="point-use-box">
        <div class="title">利用方法</div>
        <ul class="content">
          <li class="point-use-list">
            <label for="partial_use" ${label_style|n}>
              % if is_point_available and len(form.input_point.errors) == 0:
              <input id="partial_use" name="point_use_type" type="radio" value="${PointUseTypeEnum.PartialUse.v}">
              % elif is_point_available:
              <input id="partial_use" name="point_use_type" type="radio" value="${PointUseTypeEnum.PartialUse.v}" checked>
              % else:
              <input id="partial_use" name="point_use_type" type="radio" value="${PointUseTypeEnum.PartialUse.v}" disabled>
              % endif
              <span>一部のポイントを使う</span>
            </label>

            <label for="input_point" ${label_style|n}>
              % if is_point_available:
                ${form.input_point(maxlength='6', placeholder=u'1000 <半角数字>', oninput='this.setCustomValidity("");', onclick='$("#partial_use").prop("checked", true)')}
              % else:
                ${form.input_point(maxlength='6', placeholder=u'1000 <半角数字>', disabled='')}
              % endif
              ポイント
            </label>
            <div style="position: relative; bottom: 1px;">
              % if cart.transaction_fee > 0:
              （利用上限ポイント：${h.format_number(cart.max_available_point)}）
              % endif
              <span class="crimson">※50ポイント以上よりご利用可能です</span>
            </div>
          </li>

          <li class="point-use-list">
            <label for="all_use" ${label_style|n}>
              <input id="all_use" name="point_use_type" type="radio" value="${PointUseTypeEnum.AllUse.v}" ${'' if is_point_available else 'disabled'}>
              <span>全てのポイントを使う</span>
            </label>
          </li>

          <li class="point-use-list">
            <label for="no_use">
              <input id="no_use" name="point_use_type" type="radio" value="${PointUseTypeEnum.NoUse.v}" ${'' if len(form.input_point.errors) > 0 else 'checked'}>
              <span>ポイントを利用しない</span>
            </label>
          </li>

        </ul>
      </div>
      <div class="point-use-box point-use-notice">
        <div class="sub-title">＜ご注意＞</div>
        <ul>
          <li class="crimson">決済手数料を除いた合計金額がポイントの利用上限となります。決済手数料を除いた合計金額分のポイントをご利用の場合、決済手数料は0円となります。</li>
          <li class="crimson">「全てのポイントを使う」を選択した場合、ご注文時点の利用可能な全てのポイントが利用ポイントとして確定いたします。</li>
          <li>1回のお支払い上限、1ヶ月のご利用上限については&nbsp;<a href="https://point.rakuten.co.jp/guidance/usemethod/" target="_blank">ポイント利用方法</a>&nbsp;をご確認ください。</li>
          <li>利用ポイント以外に不足金額が発生する場合は、選択されたお支払い方法でのお買い物になります。</li>
        </ul>
      </div>
    </div>
  </div>

  ${form.fix_point}
  ${form.sec_able_point}
  ${form.order_max_point}
  <div style="text-align: center; margin: auto; width: 100%;">
    <input class="align2" type="submit" value="次へ" alt="次へ" onclick="validateBeforeSubmit()" style="width: 25%"/>
  </div>
</form>

% if request.organization.setting.sitecatalyst_use:
<!--SiteCatalyst-->
<%
    sc = {"pagename": "point_use"}
%>
<%include file="../includes/sc_basic.html" args="sc=sc" />
<!--/SiteCatalyst-->
% endif