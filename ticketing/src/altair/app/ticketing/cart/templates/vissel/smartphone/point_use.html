<%inherit file="./base.html"/>
<% from altair.app.ticketing.core.models import PointUseTypeEnum %>

<%block name="javascript">
  <script type="text/javascript" src="${request.static_url('altair.app.ticketing.cart:static/js/disable_on_submit.js')}"></script>
  <script type="text/javascript">
    $(function() {
      $('#form1').disableOnSubmit('input[type=submit][name!="back"]');
    });
    function validateBeforeSubmit() {
      var inputPointElement = $('#input_point');
      inputPointElement[0].setCustomValidity("");

      if ($('#partial_use').is(':checked')) {

        var validated_msg = "${__(u'「利用ポイント数」を入力してください。')}";
        if (inputPointElement.val()) {
          inputPointElement.val(replaceValidChar(inputPointElement.val()));
          validated_msg = /^\d+$/.test(inputPointElement.val())
                  ? (parseInt(inputPointElement.val()) >= ${min_point} ? '' : "${__(u'{}ポイント以上を入力してください。').format(min_point)}")
                  : "${__(u'「利用ポイント数」には半角数字を入力してください。')}";
        }
        inputPointElement[0].setCustomValidity(validated_msg);
      }
    }
    function replaceValidChar(val) {
      return val.replace(/[\s　]+/g, '').replace(/[０-９]/g, function (s) { return String.fromCharCode(s.charCodeAt(0) - 0xFEE0); });
    }
  </script>
</%block>
<%block name='css'>
<style type="text/css">
  th {
      text-align: left;
  }
  .point-use-box {
    margin: 10px auto 0 auto;
    padding: 3px;
    width: 95%;
    border: 1px solid #ccc;
  }
  .point-use-box .title {
    font-size: 14px;
    padding: 3px;
  }
  .point-use-box .content {
    font-size: 12px;
    margin-left: 5px;
    padding: 3px;
  }
  .point-use-box .content .point-use-list {
    display: flex;
    align-items: center;
    padding: 6px 0;
  }
  .point-use-box .content .point-use-list:first-child {
    padding: 0 0 6px;
  }
  .point-use-box .content label span {
    margin: 0 3px;
  }
  .point-use-notice .sub-title {
    font-size: 12px;
    padding: 3px;
  }
  .point-use-notice ul {
    padding: 0 5px 3px 23px;
    margin-top: 0;
  }
  .point-use-notice ul li {
    list-style-type: disc;
    padding: 2px;
    font-size: 12px;
  }
  .crimson {
    color: #DC143C;
  }
  .input-point-form {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    margin-left: 20px;
  }
  input[type=radio] {
    position: relative;
    top: 2px;
  }
  input[type=text] {
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
    border: 1px solid #CCC;
    background: #f4f3f1;
    height: 40px;
    width: 130px;
    padding-left: 5px;
  }
  input[type=text]::-webkit-input-placeholder,
  input[type=text]::placeholder {
    font-size: 13px;
    position: relative;
    bottom: 1px;
    left: 5px;
  }
  input[type=text]:-ms-input-placeholder {
    font-size: 13px;
    position: relative;
    bottom: 1px;
    left: 5px;
  }
</style>
</%block>

<form id="form1" name="form1" action="${request.url}" method="post">
  <div class="confirm-wrap">
    <h2 class="heading_simple_line">${__(u'お買い物内容')}</h2>

    <div class="purchase-wrap" style="margin: auto; width: 95%;">
      <div class="purchase-title">
        <p>${cart.performance.event.title}</p>
        <p>${h.performance_datetime(cart.performance, i18n)}(予定) ${cart.performance.venue.name}</p>
      </div>
      <table class="purchase-table" summary="${__(u'席種、金額などのお買い物内容')}">
        <tbody>
          %for product in cart.items:
          <tr>
            <th scope="row">${product.product.name}</th>
            % if len(product.items) == 1:
              <td nowrap><strong>${product.seat_quantity}</strong>枚</td>
            % else:
              <td nowrap>×<strong>${product.quantity}</strong>枚</td>
            % endif
            <td>￥${h.format_number(product.product.price * product.quantity)}</td>
          </tr>
          %endfor

          <tr>
            <th scope="row" colspan="2">${__(u'決済手数料')}</th>
            <td>￥${h.format_number(cart.transaction_fee)}</td>
          </tr>
          <tr>
            <th scope="row" colspan="2">${__(u'発券/引取手数料')}</th>
            <td>￥${h.format_number(cart.delivery_fee)}</td>
          </tr>
          <tr>
            <th scope="row" colspan="2">${__(u'システム利用料')}</th>
            <td>￥${h.format_number(cart.system_fee)}</td>
          </tr>
          %if cart.special_fee > 0:
            <tr>
              <th scope="row" colspan="2">${cart.special_fee_name}</th>
              <td>￥${h.format_number(cart.special_fee)}</td>
            </tr>
          %endif
          <tr class="purchase-table-total">
            <th scope="row" colspan="2">${__(u'合計金額')}</th>
            <td>￥${h.format_number(cart.total_amount)}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="confirm-wrap">
    <h2 class="heading_simple_line">${__(u'ポイント入力')}</h2>
    % if request.session.peek_flash():
      % for message in request.session.pop_flash():
      <div class="sp-error">${message}</div>
      % endfor
    % endif
    <div class="point-use-box">
      <div class="title">${__(u'ポイント残高')}</div>
      <div class="content">${__(u"{} {} さんの通常ポイント残高").format(cart.shipping_address.last_name, cart.shipping_address.first_name)|n}</div>
      % if has_user_point_data:
      <div class="content" style="text-align: right"><span class="crimson">${h.format_number(fix_point)}</span> ${__(u'ポイント（円）')}</div>
      % else:
      <div class="content" style="text-align: right">- ${__(u'ポイント（円）')}</div>
      % endif
    </div>
    <% label_style = '' if is_point_available else 'style="opacity: 0.5;"' %>
    <div class="point-use-box">
      <div class="title">${__(u'利用方法')}</div>
      <ul class="content">
        <li class="point-use-list">
          <label for="partial_use" ${label_style|n}>
            % if is_point_available and len(form.input_point.errors) == 0:
            <input id="partial_use" name="point_use_type" type="radio" value="${PointUseTypeEnum.PartialUse.v}">
            % elif is_point_available:
            <input id="partial_use" name="point_use_type" type="radio" value="${PointUseTypeEnum.PartialUse.v}" checked>
            % else:
            <input id="partial_use" name="point_use_type" type="radio" value="${PointUseTypeEnum.PartialUse.v}" disabled>
            % endif
            ${__(u'一部のポイントを使う')}
            % if cart.transaction_fee > 0:
              （${__(u'利用上限ポイント')}：${h.format_number(cart.max_available_point)}）
            % endif
          </label>
        </li>

        <li class="point-use-list">
          <label for="input_point" class="input-point-form" ${label_style|n}>
            % if is_point_available:
              ${form.input_point(maxlength='6', placeholder=__(u'1000 <半角数字>'), oninput='this.setCustomValidity("");', onclick='$("#partial_use").prop("checked", true)')}
            % else:
              ${form.input_point(maxlength='6', placeholder=__(u'1000 <半角数字>'), disabled='')}
            % endif
            <span style="position: relative; top: 10px">${__(u'ポイント')}</span>
          </label>
        </li>

        % if has_user_point_data:
        <li class="point-use-list crimson" style="margin-left: 20px;">${__(u'※{}ポイント以上よりご利用可能です').format(min_point)}</li>
        % endif

        <li class="point-use-list">
          <label for="all_use" ${label_style|n}>
            <input id="all_use" name="point_use_type" type="radio" value="${PointUseTypeEnum.AllUse.v}" ${'' if is_point_available else 'disabled'}>
            <span>${__(u'全てのポイントを使う')}</span>
          </label>
        </li>

        <li class="point-use-list">
          <label for="no_use">
            <input id="no_use" name="point_use_type" type="radio" value="${PointUseTypeEnum.NoUse.v}" ${'' if len(form.input_point.errors) > 0 else 'checked'}>
            <span>${__(u'ポイントを利用しない')}</span>
          </label>
        </li>

      </ul>
    </div>
    <div class="point-use-box point-use-notice">
      <div class="sub-title">＜ご注意＞</div>
      <ul>
        <li class="crimson">${__(u'決済手数料を除いた合計金額がポイントの利用上限となります。決済手数料を除いた合計金額分のポイントをご利用の場合、決済手数料は0円となります。')}</li>
        <li class="crimson">${__(u'「全てのポイントを使う」を選択した場合、ご注文時点の利用可能な全てのポイントが利用ポイントとして確定いたします。')}</li>
        <li>${__(u'1回のお支払い上限、1ヶ月のご利用上限については <a href="{}" target="_blank">ポイント利用方法</a> をご確認ください。').format("https://point.rakuten.co.jp/guidance/usemethod/")|n}</li>
        <li>${__(u'利用ポイント以外に不足金額が発生する場合は、選択されたお支払い方法でのお買い物になります。')}</li>
      </ul>
    </div>
  </div>

  <p class="confirm-btnBox" style="margin-top: 5px; padding-bottom: 20px">
    <input onclick="validateBeforeSubmit();" class="btn btn-primary" type="submit" value="${_(u'次へ')}">
  </p>
</form>

% if request.organization.setting.sitecatalyst_use:
<!--SiteCatalyst-->
<%
    sc = {"pagename": "point_use"}
%>
<%include file="../includes/sc_basic.html" args="sc=sc" />
<!--/SiteCatalyst-->
% endif