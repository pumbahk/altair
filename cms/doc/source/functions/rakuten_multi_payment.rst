.. _function_rakuten_multipayment:

楽天カードマルチ決済サービス
========================================

:資料の在り処: DropBoxの楽天KCディレクトリ

接続仕様について
----------------------------------------

楽天マルチ決済サービスへの接続しようとして、以下の２つの方式がある。

+ JavaAPI方式
+ WebAPI方式

このうちWebAPI方式を利用する。(http://dev.ticketstar.jp/redmine-altair/issues/151)

:資料の在り処: 楽天KC/マルチ決済サービスドキュメント/10.接続仕様/20.WebAPI方式

登録情報
----------------------------------------

.. csv-table::
   :header: 入力項目, 入力値

   店舗コード, "<undefined>"
   "ユーザ ID", "<undefined>>"
   "パスワード", "<undefined>"

.. todo:: 店舗コード、ユーザID,パスワードをもらう

WEBサービス認証方法
----------------------------------------

WEBサービスでは、httpのBasic認証を利用する。
**認証に必要なユーザID/Passwordは、マルチ決済サービスのユーザ管理機能で作成可能** 。

機能の一覧と実行方法
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

実行方法と機能の一覧のまとめ(カード決済のみ)

[BaseURI]
   https://payment.rakuten-card.co.jp:9480/gh-ws/1.0/storecd/[店舗コード]

.. note:: [店舗コード]とは 楽天カード(決済代行会社) か ゙発番する番号(10 桁) のこと

.. csv-table:: 機能一覧の一覧と実行方法
   :header: 機能,URI,"http method", Request, Response
   :widths: 5,10,5,5,5

   カード有効性チェック, "[BASE URI]/card/OrderNo/[受注番号]/Check", POST, reqCard.xml, resCard.xml
   オーソリ, "[BASE URI]/card/OrderNo/[受注番号]/Auth", POST, reqCard.xml, resCard.xml
   オーソリ取消, "[BASE URI]/card/OrderNo/[受注番号]/AuthCan", POST, -, resCard.xml
   売上, "[BASE URI]/card/OrderNo/[受注番号]/Sales", POST, -, resCard.xml
   売上取消, "[BASE URI]/card/OrderNo/[受注番号]/SalesCan", POST, -, resCard.xml
   取引照会, "[BASE URI]/card/OrderNo/[受注番号]", GET, -, resCardInquiry.xml

.. note:: “Content-Type” に “application/xhtml+xml;charset=UTF-8” を指定

API接続仕様(カード決済のみ)
----------------------------------------

.. note:: ここに書かれているのはカード決済に関する情報のみ。それ以外のAPIの情報を知りたい場合には元の資料に参照のこと

提供するAPI

+ 3.1.1 オーソリ依頼/カード有効性チェック
+ 3.1.2 オーソリ取消/売上/売上取消
+ 3.1.3 カード決済取引照会

3.1.1 オーソリ依頼/カード有効性チェック
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

カード有効性チェックのリクエストxmlサンプル(reqCard.xml)

.. literalinclude:: ../xml/card/CardCheck_ReqCard.xml
   :language: xml

.. csv-table:: カード有効性チェックのリクエスト引数意味
   :header: " ",エレメントタグ,必須,属性,桁数,備考
   :widths: 3,3,1,8,8,10

   Order, ItemCd, " ", 半角英数字, "3 バイト固定", 商品コード ※ :ref:`コード定義<ap104>` 参照 
   " ", ItemName, " ", 全半角文字, "44 バイト以下", 商品名
   " ", OrderYMD, " ", 半角数字, "8 バイト固定", "注文年月日 ※当日以前 (yyyymmdd)"
   " ", SalesAmount, " ", 半角数字, "7 バイト以下", "売上金額 ※0 円以上 9,999,999 円以下"
   " ", TaxCarriage, " ", 半角数字, "7 バイト以下", "税送料 ※税送料を設定しない場合 0 を設定"
   " ", FreeData, " ", "半角英数字 (- . _ )", "32 バイト以下", 任意設定項目
   " ", ClientName, " ", 全角英数字, "40 バイト以下", "購入者名 ※全角文字である"
   " ", MailAddress, "△", 半角英数字, "100 バイト以下", "購入者メールアドレス ※メール送信する場合必須 ※メールアドレス形式であること"
   " ", MailSend, "○", 半角数字, "1 バイト固定", "メール送信フラグ ※ :ref:`コード定義<ap118>` 参照 "
   Card, CardNo, "○", 半角数字, "13 バイト以上 16 バイト以下", カード番号
   " ", CardLimit, "○", 半角数字, "4 バイト固定", "カード有効期限 (yymm)"
   " ", CardHolderName, " ", "英数大文字記号( . / - [SPACE] )", "42 バイト以下", "カード名義人"
   " ", PayKindCd, " ", 半角数字, "2 バイト以下", "支払区分コード ※ :ref:`コード定義<ap102>`  参照 "
   " ", PayCount, "△", 半角数字, "2 バイト以下", "支払回数 ※支払区分コードが「61:分割」の場合に必須 ※ :ref:`コード定義<ap103>`  参照 "
   " ", SecureKind, "○", 半角数字, "1 バイト固定", "セキュリティ認証方式 ※ :ref:`コード定義<ap107>`  参照 "
   SecureCd, Code, "△", 半角数字, "3 バイト以上 4 バイト以下", "セキュリティコート"
   Secure3D, Mvn, "△", 半角英数字, "10 バイト固定", "メッセージバージョンナンハ"
   " ", Xid, "△", 半角英数字, "28 バイト固定", トランザクション ID
   " ", Ts, "△", 半角英数字, "1 バイト固定", "トランザクションステータス"
   " ", ECI, "△", 半角英数字, "2 バイト固定", ECI
   " ", CAVV, "△", 半角英数字, "28 バイト固定", "CAVV"
   " ", CavvAlgorithm, "△", 半角英数字, "1 バイト固定", "CAVV アルゴリズム"
   " ", CardNo, "△", 半角英数字, "13 バイト以上 16 バイト以下", "カード番号"

.. note::

   <SecureCd> セキュリティコード認証 ※CVV2/CVC2/CAV2/4DBC を利用する場合に設定

   <Secure3D> 3D セキュア認証項目 ※3D セキュア認証を利用する場合に設定

レスポンスxmlサンプル(resCard.xml)

.. literalinclude:: ../xml/card/CardCheck_ResCard.xml
   :language: xml


3.1.2 オーソリ取消/売上/売上取消
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

3.1.3 カード決済取引照会
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

接続テスト
----------------------------------------

接続テスト用の資料が用意されている Dropbox

TBD

詳細
----------------------------------------

楽天カード マルチ決済サービス API 説明書(第 1.7 版)

.. csv-table::
   :header: 用語, 意味
   :widths: 10,30

   オーソリ, "カード会社へショップ側がそのカードの利用を認めても良いか承認を得る行為。利用カードの有効性を確認し 、有効な場合、取引金額(購入金額)分の与信枠の空きがあるかを確認。空きがある場合、当該金額相当分を 確保し、承認番号を取得する。"
   オーソリOK, オーソリの結果、カード会社から承認番号が発行された状態。
   オーソリNG, オーソリの結果、カード会社から承認番号が発行されなかった状態。
   オーソリエラー, ネットワーク障害、カード番号の不備等により、カード会社にオーソリ情報を送信できなかった状態。
   売上, クレジットカード会社に対し、クレジット売上請求を送信する。
   アプリケーション, APIを利用するプログラム。
   "収納依頼(コンビニ)", コンビニ決済するための収納番号を発番依頼する。
   "収納依頼(ペイジー)", ペイジー決済するための収納情報を発番依頼する。
   電子マネー決済, "iD決済 ・ Edy決済 するための決済登録依頼する。"

.. note:: 受注番号はユニークなものを販売サイト側で用意する。

	 受注番号は、店舗様にて発番して下さい。また、マルチ決済サービスでは、受注番号で取引を一意とします。そのため、同一の受注番号で、以 下の処理を重複して依頼することは出来ません。

	 + カード有効性チェック 
	 + オーソリ 
	 + 収納依頼(コンビニ決済) 
	 + 収納依頼(ペイジー決済) 
	 + 決済依頼(電子マネー決済)

.. note:: 商品のステータスが狂う場合があるらしいので、必ず、決済ステータスはAPIを使って問い合わせて同期する。

   照会処理を実施し取得した決済ステータスを正とする。

   取引状況の確認について
   マルチ決済サービスでは、店舗様の取引を決済ステータスで取引状況を管理します。
   依頼処理の結果を取得できなかった場合等、店舗様の決済ステータスと楽天カードマルチ決済サービスシステム内の決済ステータスに差異 が発生する可能性があるため、依頼処理実施後は、照会処理を実施して最新の決済ステータスを取得することを推奨します。通常は、依頼結果 と照会結果の決済ステータスは同一です。


.. note::
   楽天カード マルチ決済サービス 共通 説明書((第 1.2 版)::

	 2.2 APIユーザの作成について 実店舗を利用した疎通テストを行う際は、必ずAPIユーザを作成する必要があります。 以下の手順で API ユーザの作成を行ってください。

.. todo:: 疎通テストの前にAPIユーザを作成する。


.. note::

   6.3 タイムアウトの設定について 提携サイト様システムとマルチ決済システムとの通信タイムアウト時間は、「90 秒」以上を設定してください。(楽天カード マルチ決済サービス 共通 説明書((第 1.2 版))

.. note::

   6.4 文字コードについて マルチ決済システムで利用する文字コードは「Shift-JIS」となっております。(楽天カード マルチ決済サービス 共通 説明書((第 1.2 版))

.. note::

   決済サービスのURLが変更されている(http://dev.ticketstar.jp/redmine-altair/issues/153)。::

	 kc -> rakutencard

   適宜読み替える必要がある。
