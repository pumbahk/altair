## performancelist widget output template
## 

<%
from altaircms.plugins.widget.performancelist import helpers as myhelpers
from datetime import datetime 
import logging
now = datetime.now()
logger = logging.getLogger(__name__)
%>
<div class="detailBox">
  <div style="float:right; margin-right:20px;">
    <form>
      <input type="checkbox" id="form-showUnavailablePerformances"><label for="form-showUnavailablePerformances" class="subdescribe">販売終了した公演も表示</label>
    </form>
  </div>
  <hr/>

<table id="performanceList" summary="公演‥開催一覧" class="info">
  <thead>
    <tr>
      <th>公演名</th><th>公演日時</th><th>会場</th><th></th>
    </tr>
  </thead>
  <tbody>
    % for i, (venue, p) in enumerate(myhelpers.PerformanceGrid.create(performances)):
    <% performance = p.values %>
    <tr>
      <td scope="row"><span class="serial">${i+1}</span> ${performance.title}</td>
        %if widget.mask_performance_date:
          <td width="27%"> - </td>
        %else:
          <td width="27%">${myhelpers.performance_describe_date(performance)} <br/> ${myhelpers.performance_describe_time(performance)}</td>
        %endif

        %if venue:
        <td rowspan="${venue.rowspan}" width="25%">${venue.values}</td>
        %endif
        <td width="10%" class="last"> 
          <% end_on_candidates = [s.end_on for s in performance.sales if s.end_on] %>
          %if not end_on_candidates:
            <% logger.warn("performance=%s does not have salessegment. ignored (performance list widget)" % performance.id)%>
          %elif max(end_on_candidates) >= now:
            <a href="${h.link.get_purchase_page_from_performance(request, performance)}" class="purchase-small">購入する</a>
          %else:
            <span  class="endPerformance">販売終了</span>
          %endif
        </td>
    </tr>
  % endfor
  </tbody>
</table>
</div>

<script type="text/javascript">
  var toggleEndPerformance = function toggleEndPerformance(clicked){
    if(clicked){
      $("#performanceList").find(".endPerformance").parents("tr").show();
    }else {
      $("#performanceList").find(".endPerformance").parents("tr").hide();
    }
  };
  if(!$("body").data("togglePerformance")){
    $("body").data("togglePerformance",true);
    $("#form-showUnavailablePerformances").on("change", function(){
      var clicked = $(this).attr("checked") == "checked";
      toggleEndPerformance(clicked);
    });
  }
  toggleEndPerformance(false);
  $("#form-showUnavailablePerformances:checked").attr("checked",null);
</script>
