/** @file vml.js { */Fashion.Backend.VML=function(){function m(){var a=b.document.namespaces;a[i]||a.add(i,j),b.document.createStyleSheet().addRule(i+"\\:*","behavior:url(#default#VML)")}function n(a){var c=b.document.createElement(i+":"+a);return c}function o(a){return[a.a,a.c,a.b,a.d,a.e,a.f].join(",")}function p(a){var b=[];for(var c=0;c<a.length;c++){var d=a[c];switch(d[0]){case"M":b.push("m",(d[1]*l).toFixed(0),(d[2]*l).toFixed(0));break;case"L":b.push("l",(d[1]*l).toFixed(0),(d[2]*l).toFixed(0));break;case"C":b.push("c",(d[1]*l).toFixed(0),(d[2]*l).toFixed(0),(d[3]*l).toFixed(0),(d[4]*l).toFixed(0),(d[5]*l).toFixed(0),(d[6]*l).toFixed(0));break;case"Z":b.push("x");break;case"R":case"T":case"S":case"Q":case"A":}}return b.push("e"),b.join(" ")}function q(a){return a.join(" ")}function r(a,b,c){return a.push("<",i,":",c,' unselectable="on"',' __fashion__id="',b,'"'),a}function s(a,b){return a.push("</",i,":",b,">"),a}function t(a,b){var c=b.wrapper._position,d=b.wrapper._size,e=new VMLFillAndStroke;return b._buildVMLStyle(e),e.setStyle({position:"absolute",display:"block",margin:0,padding:0,width:d.x+"px",height:d.y+"px",left:c.x+"px",top:c.y+"px"}),e.appendHTML(a),a}function u(a){var b=a.node.childNodes;for(var c=b.length;--c>=0;){var d=b[c];switch(d.tagName.toLowerCase()){case"fill":a.fill=d;break;case"stroke":a.stroke=d}}return a}function v(c,d){var e=new a.MouseEvt;e.type=d.type,e.target=c.wrapper;var f=d.which,h=d.button;!f&&h!==void 0&&(f=h&1?1:h&2?3:h&4?2:0);switch(f){case 0:e.left=e.middle=e.right=!1;break;case 1:e.left=!0;break;case 2:e.middle=!0;break;case 3:e.right=!0}var i,j=b.document,k=j.body;return i={x:d.clientX+k.scrollLeft,y:d.clientY+k.scrollTop},c instanceof B?(e.physicalPosition=g(i,c.getViewportOffset()),e.logicalPosition=c.convertToLogicalPoint(e.physicalPosition)):(e.physicalPosition=g(i,c.drawable.getViewportOffset()),e.logicalPosition=c.drawable.convertToLogicalPoint(e.physicalPosition),e.offsetPosition=g(e.logicalPosition,c.wrapper._position)),e}var a=this,b=a.window,c=a._lib._class,d=a._lib.escapeXMLSpecialChars,e=a._lib.__assert__,f=a._lib.addPoint,g=a._lib.subtractPoint,h=a.Backend.Refresher;if(a.browser.identifier!=="ie")return null;var i="v",j="urn:schemas-microsoft-com:vml",k="#default#VML",l=1e4,w=function(){function b(a){return typeof a=="string"?a:typeof a=="boolean"?a?"t":"f":a.toString()}var e=c("VMLOMMarkupBuilder",{props:{innerAttrs:null,outerAttrs:null},methods:{init:function(a){this.tagName=a},setInnerAttribute:function(a,b){this.innerAttrs||(this.innerAttrs={}),this.innerAttrs[a]=b},setOuterAttribute:function(a,b){this.outerAttrs||(this.outerAttrs={}),this.outerAttrs[a]=b},appendHTML:function(a){if(this.outerAttrs)for(var c in this.outerAttrs)a.outer.push(" ",c,'="',d(b(this.outerAttrs[c])),'"');if(this.innerAttrs){a.inner.push("<",i,":",this.tagName);for(var c in this.innerAttrs)a.inner.push(" ",c,'="',d(b(this.innerAttrs[c])),'"');a.inner.push(" />")}},assign:function(a){if(this.outerAttrs)for(var b in this.outerAttrs)a.outer[b]=this.outerAttrs[b];if(this.innerAttrs)for(var b in this.innerAttrs)a.inner[b]=this.innerAttrs[b]}}});return VMLFillAndStroke=c("VMLFillAndStroke",{props:{fill:null,stroke:null,styles:{}},methods:{init:function(){this.fill=new e("fill"),this.stroke=new e("stroke")},setStyle:function(a,b){if(typeof a=="object"&&b===void 0)for(var c in a)this.styles[c]=a[c];else this.styles[a]=b},assignToElement:function(a){if(this.fill){var b=a.fill;this.fill.innerAttrs&&!b&&(b=n(this.fill.tagName)),this.fill.assign({outer:a.node,inner:b}),b&&!a.fill&&(a.node.appendChild(b),a.fill=b)}if(this.stroke){var c=a.stroke;this.stroke.innerAttrs&&!c&&(c=n(this.stroke.tagName)),this.stroke.assign({outer:a.node,inner:c}),c&&!a.stroke&&(a.node.appendChild(c),a.stroke=c)}for(var d in this.styles)a.node.style[d]=this.styles[d]},appendHTML:function(a){var b=[];this.fill.appendHTML({outer:a,inner:b}),this.stroke.appendHTML({outer:a,inner:b});if(this.styles){var c=[];for(var e in this.styles)c.push(e.replace(/[A-Z]/,function(a){return"-"+a.toLowerCase()}),":",this.styles[e],";");a.push(" style",'="',d(c.join("")),'"')}a.push(">"),a.push.apply(a,b)}}}),c("BaseVML",{props:{drawable:null,_elem:null,wrapper:null,_refresher:null,_handledEvents:{mousedown:!1,mouseup:!1,mousemove:!1,mouseover:!1,mouseout:!1}},class_props:{_refresher:(new h).setup({preHandler:function(b){return this.drawable?this._elem?b:(this._elem=this.newElement(this.drawable._vg),b&a.DIRTY_EVENT_HANDLERS):b},handlers:[[a.DIRTY_TRANSFORM,function(){var a=this.wrapper._transform;if(a){var b=this.wrapper._transform.isScaling();b?(this._elem.skew&&(this._elem.node.removeChild(this._elem.skew),this._elem.skew=null),this._elem.node.coordOrigin=(-a.e*l).toFixed(0)+","+(-a.f*l).toFixed(0),this._elem.node.coordSize=(l/b.x).toFixed(0)+","+(l/b.y).toFixed(0)):(this._elem.skew||(this._elem.skew=n("skew"),this._elem.node.appendChild(this._elem.skew)),this._elem.node.coordOrigin="",this._elem.node.coordSize=l+","+l,this._elem.skew.matrix=o(a),this._elem.skew.on=!0)}else this._elem.skew&&(this._elem.node.removeChild(this._elem.skew),this._elem.skew=null)}],[a.DIRTY_STYLE,function(){var a=new VMLFillAndStroke;this._buildVMLStyle(a),a.assignToElement(this._elem)}],[a.DIRTY_VISIBILITY,function(){this._elem.node.style.display=this.wrapper._visibility?"block":"none"}],[a.DIRTY_EVENT_HANDLERS,function(){for(var a in this._handledEvents){var b=this._handledEvents[a],c=this.wrapper.handler&&this.wrapper.handler.handles(a);!b&&c?(this.drawable._handleEvent(a),this._handledEvents[a]=!0):b&&!c&&(this.drawable._unhandleEvent(a),this._handledEvents[a]=!1)}}]]})},methods:{init:function(a){this.wrapper=a,this._refresher=this.constructor._refresher;var b=this},dispose:function(){this.drawable?this.drawable.remove(this):this._removed()},_removed:function(){if(this._elem){for(var a in this._handledEvents)this._handledEvents[a]&&this.drawable._unhandleEvent(a);this._elem.__fashion__id=null,this._elem=null}this.drawable=null},newElement:function(a){return null},refresh:function(a){this._refresher.call(this,a)},_buildVMLStyle:function(b){function d(a){var b=c.fill.colors[0],d=c.fill.colors[c.fill.colors.length-1];a.setInnerAttribute("color2",b[1]._toString(!0)),a.setInnerAttribute("color",d[1]._toString(!0)),b[0]==0&&d[0]==1&&(a.setInnerAttribute("opacity2",b[1].a/255),a.setInnerAttribute("opacity",d[1].a/255));var e=[];for(var f=c.fill.colors.length;--f>=0;){var g=c.fill.colors[f];e.push((g[0]*100).toFixed(0)+"% "+g[1]._toString(!0))}a.setInnerAttribute("colors",e.join(","))}var c=this.wrapper._style,e=b.fill,f=b.stroke;c.fill?(c.fill instanceof a.FloodFill?c.fill.color.a==255?e.setOuterAttribute("fillColor",c.fill.color._toString(!0)):(e.setInnerAttribute("type","solid"),e.setInnerAttribute("color",c.fill.color._toString(!0)),e.setInnerAttribute("opacity",c.fill.color.a/255)):c.fill instanceof a.LinearGradientFill?(d(e),e.setInnerAttribute("type","gradient"),e.setInnerAttribute("method","sigma"),e.setInnerAttribute("angle",(c.fill.angle*360).toFixed(0))):c.fill instanceof a.RadialGradientFill?(d(e),e.setInnerAttribute("type","gradientRadial"),e.setInnerAttribute("focusPosition",c.fill.focus.x+" "+c.fill.focus.y)):c.fill instanceof a.ImageTileFill&&(e.setInnerAttribute("type","tile"),e.setInnerAttribute("src",c.fill.imageData.url)),e.setOuterAttribute("filled",!0)):e.setOuterAttribute("filled",!1),c.stroke?(c.stroke.color.a==255&&!c.stroke.pattern?(f.setOuterAttribute("strokeColor",c.stroke.color._toString(!0)),f.setOuterAttribute("strokeWeight",c.stroke.width)):(f.setInnerAttribute("color",c.stroke.color._toString(!0)),f.setInnerAttribute("opacity",c.stroke.color.a/255),f.setInnerAttribute("weight",c.stroke.width),c.stroke.pattern&&f.setInnerAttribute("dashStyle",c.stroke.pattern.join(" "))),f.setOuterAttribute("stroked",!0)):f.setOuterAttribute("stroked",!1),b.setStyle("cursor",c.cursor?c.cursor:"normal")}}})}(),x=c("CircleVML",{parent:w,class_props:{_refresher:(new h(w._refresher)).setup({moreHandlers:[[a.DIRTY_POSITION,function(){var a=this.wrapper._position;this._elem.node.style.left=a.x+"px",this._elem.node.style.top=a.y+"px"}],[a.DIRTY_SIZE,function(){var a=this.wrapper._size;this._elem.node.style.width=a.x+"px",this._elem.node.style.height=a.y+"px"}]]})},methods:{newElement:function(a){var b=this.wrapper._position,c=this.wrapper._size,d=r([],this.wrapper.id,"oval");return t(d,this),s(d,"oval"),a.node.insertAdjacentHTML("beforeEnd",d.join("")),u({node:a.node.lastChild,fill:null,stroke:null,skew:null})}}}),y=function(){function b(a,b,c){var d=l,e=(c.x||0)*d/b.x;return ry=(c.y||0)*d/b.y,a.push("at0,0,",e*2,",",ry*2,",",e,",0,0,",ry),a.push("l0,",d-ry),a.push("at0,",d-ry*2,",",e*2,",",d,",0,",d-ry,",",e,",",d),a.push("l",d-e,",",d),a.push("at",d-e*2,",",d-ry*2,",",d,",",d,",",d-e,",",d,",",d,",",d-ry),a.push("l",d,",",ry),a.push("at",d-e*2,",0,",d,",",ry*2,",",d,",",ry,",",d-e,",",0),a.push("x"),a}var d={rect:{buildElement:function(){var a=r([],this.wrapper.id,"rect");return t(a,this),s(a,"rect"),a},update:function(){}},roundrect:{buildElement:function(){var a=r([],this.wrapper.id,"roundrect");return a.push(' arcsize="',(this.wrapper._corner.x||0)/this.wrapper._size.x,'"'),t(a,this),s(a,"roundrect"),a},update:function(){this._elem.arcSize=(this.wrapper._corner.x||0)/this.wrapper._size.x}},shape:{buildElement:function(){var a=this.wrapper._position,c=r([],this.wrapper.id,"shape");return c.push(' path="'),b(c,this.wrapper._size,this.wrapper._corner),c.push('"'),t(c,this),s(c,"shape"),c},update:function(){this._elem.path=b([],this.wrapper._size,this.wrapper._corner).join("")}}};return c("RectVML",{parent:w,props:{_handler:null},class_props:{_refresher:(new h(w._refresher)).setup({moreHandlers:[[a.DIRTY_POSITION,function(){var a=this.wrapper._position;this._elem.node.style.left=a.x+"px",this._elem.node.style.top=a.y+"px"}],[a.DIRTY_SIZE|a.DIRTY_SHAPE,function(){var a=this.wrapper._size,b=this.determineImpl();if(b===this._handler)this._elem.node.style.width=a.x+"px",this._elem.node.style.height=a.y+"px",b.update.call(this);else{var c=document.createElement("div"),d=this._elem;c.innerHTML=b.buildElement.call(this).join("");var e=c.firstChild,f=d.node.parentNode;f.insertBefore(e,d.node),f.removeChild(d.node),this._handler=b,this._elem={node:e,fill:e.firstChild,stroke:e.firstChild?e.firstChild.nextSibling:null,skew:null}}}]]})},methods:{determineImpl:function(){var a=this.wrapper._size,b=this.wrapper._corner;return b.x==b.y&&a.x==a.y?b.x==0?d.rect:d.roundrect:d.shape},newElement:function(a){var b=this._handler=this.determineImpl(),c=b.buildElement.call(this);return a.node.insertAdjacentHTML("beforeEnd",c.join("")),u({node:a.node.lastChild,fill:null,stroke:null,skew:null})}}})}(),z=c("PathVML",{parent:w,class_props:{_refresher:(new h(w._refresher)).setup({moreHandlers:[[a.DIRTY_SHAPE,function(){this._elem.node.setAttribute("path",p(this.wrapper._points))}],[a.DIRTY_POSITION,function(){var a=this.wrapper._position;this._elem.node.style.left=a.x+"px",this._elem.node.style.top=a.y+"px"}]]})},methods:{newElement:function(a){var b=this.wrapper._position,c=["<",i,":shape",' unselectable="on"',' __fashion__id="',this.wrapper.id,'"',' coordsize="',l,",",l,'" ',' path="',p(this.wrapper._points),'"'],d=new VMLFillAndStroke;return this._buildVMLStyle(d),d.setStyle({position:"absolute",display:"block",width:"1px",height:"1px",margin:0,padding:0,left:b.x+"px",top:b.y+"px"}),d.appendHTML(c),c.push("</",i,":shape",">"),a.node.insertAdjacentHTML("beforeEnd",c.join("")),u({node:a.node.lastChild,fill:null,stroke:null,skew:null})}}}),A=c("TextVML",{parent:w,class_props:{_refresher:(new h(w._refresher)).setup({moreHandlers:[[a.DIRTY_POSITION,function(){var a=this.wrapper._position;this._elem.node.style.left=a.x+"px",this._elem.node.style.top=a.y+"px"}],[a.DIRTY_SIZE,function(){var a=this.wrapper._size;this._elem.node.style.width=a.x+"px",this._elem.node.style.height=a.y+"px"}],[a.DIRTY_SHAPE,function(){this._elem.textpath.fontSize=this.wrapper._fontSize+"px",this._elem.textpath.fontFamily=this.wrapper._fontFamily,this._elem.textpath.string=this.wrapper._text}]]})},methods:{newElement:function(a){var b=["<",i,":line",' unselectable="on"',' __fashion__id="',this.wrapper.id,'"',' from="0,0" to="1,0"'],c=new VMLFillAndStroke;c.setStyle({position:"absolute",width:"1px",height:"1px",left:this.wrapper._position.x+"px",top:this.wrapper._position.y+"px"}),this._buildVMLStyle(c),c.appendHTML(b),b.push("<",i,':path textpathok="t" />',"<",i,':textpath string="',d(this.wrapper._text),'" on="t"',' style="',"font-size:",this.wrapper._fontSize,"px;","font-family:",d(this.wrapper._fontFamily),";",'v-text-align:left" />',"</",i,":line",">"),a.node.insertAdjacentHTML("beforeEnd",b.join(""));var e=a.node.lastChild;return u({node:e,fill:null,stroke:null,skew:null,textpath:e.lastChild})}}}),B=c("DrawableVML",{props:{_vg:null,_content:null,_viewport:null,_viewportInnerSize:{x:0,y:0},_capturingShape:null,_handledEvents:{mousedown:[!1,0,null],mouseup:[!1,0,null],mousemove:[!1,0,null],mouseover:[!1,0,null],mouseout:[!1,0,null]},_scrollPosition:{x:0,y:0},_currentEvent:null,_eventFunc:null,_captureEventFunc:null,_scrollEventFunc:null,_refresher:null},class_props:{_refresher:(new h).setup({preHandler:function(){!this._viewport.parentNode!=this.wrapper.target&&this.wrapper.target.appendChild(this._viewport)},handlers:[[a.DIRTY_SIZE,function(){var a=this.wrapper._viewport_size;this._viewport.style.width=a.x+"px",this._viewport.style.height=a.y+"px",this._updateContentSize()}],[a.DIRTY_TRANSFORM,function(){var a=this.wrapper._transform;if(a){var b=this.wrapper._transform.isScaling();if(b){this._vg.skew&&(this._vg.node.removeChild(this._vg.skew),this._vg.skew=null);var c=this.wrapper._transform.apply(this.wrapper._content_size);this._vg.node.coordOrigin=-a.e*l+","+ -a.f*l,this._vg.node.coordSize=l/b.x+","+l/b.y}else this._vg.skew||(this._vg.skew=n("skew"),this._vg.node.appendChild(this._vg.skew)),this._vg.node.coordOrigin=null,this._vg.node.coordSize=l+","+l,this._vg.skew.matrix=o(a),this._vg.skew.on=!0}else this._vg.node.removeChild(this._vg.skew),this._vg.skew=null;this._updateContentSize()}],[a.DIRTY_EVENT_HANDLERS,function(){for(var a in this._handledEvents){var b=this._handledEvents[a][0],c=this.wrapper.handler.handles(a);!b&&c?(this._handleEvent(a),this._handledEvents[a][0]=!0):b&&!c&&(this._unhandleEvent(a),this._handledEvents[a][0]=!1)}}]]})},methods:{init:function(b){this.wrapper=b,this._refresher=this.constructor._refresher;var c=this;this._eventFunc=function(a){if(c._capturingShape&&c._capturingShape!==c)return!1;var b=a.srcElement,d=b.__fashion__id,e=void 0;c._currentEvent=a;if(d){var f=c.wrapper._elements[d];f.handler&&(e=f.handler.dispatch(v(f.impl,a)))}return e!==!1&&c._handledEvents[a.type][0]&&c.wrapper.handler&&(e=c.wrapper.handler.dispatch(v(c,a))),c._currentEvent=null,e},this._captureEventFunc=function(a){return c._capturingShape.wrapper.handler.dispatch(v(c._capturingShape,a))},this._scrollEventFunc=function(a){c._scrollPosition=c.wrapper._inverse_transform.apply({x:parseInt(c._viewport.scrollLeft),y:parseInt(c._viewport.scrollTop)})},this._viewport=this._buildViewportElement(),a._lib._bindEvent(this._viewport,"scroll",this._scrollEventFunc),this._content=this._buildContentElement(),this._viewport.appendChild(this._content),this._vg=this._buildRoot(),this._content.appendChild(this._vg.node)},dispose:function(){this._viewport&&this._viewport.parentNode&&this._viewport.parentNode.removeChild(this._viewport),this._viewport=null,this._content=null,this._vg=null,this._wrapper=null},refresh:function(a){this._refresher.call(this,a)},scrollPosition:function(c){if(c){c=clipPoint(c,{x:0,y:0},g(this.wrapper._content_size,this.wrapper._inverse_transform.apply(this._viewportInnerSize))),this._scrollPosition=c;if(b.readyState=="complete"){var d=this.wrapper._transform.apply(c);this._viewport.scrollLeft=d.x,this._viewport.scrollTop=d.y}else{var e=this;a._lib._bindEvent(b,"load",function(){a._lib._unbindEvent(b,"load",arguments.callee);var c=e.wrapper._transform.apply(e._scrollPosition);e._viewport.scrollLeft=c.x,e._viewport.scrollTop=c.y})}return c}return this._scrollPosition},append:function(a){a.drawable=this},remove:function(a){this._capturingShape==a&&this.releaseMouse(a),this._vg&&a._elem&&this._vg.node.removeChild(a._elem.node),a._removed(a)},anchor:function(){},getViewportOffset:function(){return a.Backend.getDomOffsetPosition(this._viewport)},captureMouse:function(b){var c=this;if(this._capturingShape)throw new a.AlreadyExists("The shape is already capturing.");var c=this;c._currentEvent.cancelBubble=!0;for(var d in b._handledEvents)this._viewport.offsetParent.attachEvent("on"+d,this._captureEventFunc);this._capturingShape=b},releaseMouse:function(b){var c=b.handler;if(this._capturingShape!=b)throw new a.NotFound("The shape is not capturing.");for(var d in b._handledEvents)this._viewport.offsetParent.detachEvent("on"+d,this._captureEventFunc);this._capturingShape=null},convertToLogicalPoint:function(a){return f(this.scrollPosition(),this.wrapper._inverse_transform.apply(a))},_updateContentSize:function(){var a=this.wrapper._viewport_size,b=this.wrapper._transform.apply(this._scrollPosition),c=this.wrapper._transform.apply(this.wrapper._content_size);this._content.style.width=c.x+"px",this._content.style.height=c.y+"px",this._viewport.scrollLeft=b.x,this._viewport.scrollTop=b.y,this._viewport.style.overflow=c.x<=a.x&&c.y<=a.y?"hidden":"scroll",this._viewportInnerSize={x:this._viewport.clientWidth,y:this._viewport.clientHeight}},_buildRoot:function(){var a=n("group");return a.style.cssText="position:absolute;display:block;margin:0;padding:0;width:"+l+"px;height:"+l+"px",a.coordSize=l+","+l,{node:a,skew:null}},_buildContentElement:function(){var a=b.document.createElement("div");return a.style.cssText="position:absolute;left:0px;top:0px;display:block;margin:0;padding:0;overflow:hidden;",a},_buildViewportElement:function(){var a=b.document.createElement("div");return a.style.cssText="position:relative;display:block;margin:0;padding:0;overflow:hidden;",a},_handleEvent:function(a){var b=this._handledEvents[a];e(b),b[1]++==0&&this._content.attachEvent("on"+a,b[2]=this._eventFunc)},_unhandleEvent:function(a){var b=this._handledEvents[a];e(b);if(b[1]==0)return;--b[1]==0&&(this._content.detachEvent("on"+a,b[2]),b[2]=null)}}});return m(),{Circle:x,Rect:y,Path:z,Text:A,Drawable:B}}.call(Fashion);