/** @file svg.js { */Fashion.Backend.SVG=function(){function m(a){return b.document.createElementNS(k,a)}function n(a){return b.document.createTextNode(a)}function o(a){return"matrix("+[a.get(0),a.get(1),a.get(2),a.get(3),a.get(4),a.get(5)].join()+")"}function p(a){return a.join(" ").replace(/,/g," ")}function q(c,d){var e=new a.MouseEvt;e.type=d.type,e.target=c.wrapper;var f=d.which,h=d.button;!f&&h!==void 0&&(f=h&1?1:h&2?3:h&4?2:0);switch(f){case 0:e.left=e.middle=e.right=!1;break;case 1:e.left=!0;break;case 2:e.middle=!0;break;case 3:e.right=!0}var i;if(typeof d.pageX!="number"&&typeof d.clientX=="number"){var j=d.target.ownerDocument||b.document,k=j.documentElement,l=j.body;i={x:d.clientX+(k&&k.scrollLeft||l&&l.scrollLeft||0)-(k&&k.clientLeft||l&&l.clientLeft||0),y:d.clientY+(k&&k.scrollTop||l&&l.scrollTop||0)-(k&&k.clientTop||l&&l.clientTop||0)}}else i={x:d.pageX,y:d.pageY};return c instanceof A?(e.screenPosition=g(i,c.getViewportOffset()),e.logicalPosition=c.convertToLogicalPoint(e.screenPosition),e.physicalPosition=c.convertToPhysicalPoint(e.screenPosition)):(e.screenPosition=g(i,c.drawable.getViewportOffset()),e.logicalPosition=c.drawable.convertToLogicalPoint(e.screenPosition),e.physicalPosition=c.drawable.convertToPhysicalPoint(e.screenPosition),e.offsetPosition=g(e.logicalPosition,c.wrapper._position)),e}function w(a){return(new DOMParser).parseFromString('<?xml version="1.0" ?><svg xmlns="'+k+'" '+'xmlns:xlink="'+l+'">'+a+"</svg>","text/xml").documentElement.firstChild}var a=this,b=a.window,c=a._lib._class,d=a._lib.escapeXMLSpecialChars,e=a._lib.__assert__,f=a._lib.addPoint,g=a._lib.subtractPoint,h=a._lib.clipPoint,i=a.Backend.Refresher,j=a.Backend.TransformStack,k="http://www.w3.org/2000/svg",l="http://www.w3.org/1999/xlink",r=c("BaseSVG",{props:{drawable:null,_elem:null,def:null,wrapper:null,_handledEvents:{mousedown:null,mouseup:null,mousemove:null,mouseover:null,mouseout:null},_eventFunc:null,_refresher:null,_transformStack:null,_transformUpdated:!1},class_props:{_refresher:(new i).setup({preHandler:function(){if(!this.drawable)return;this._elem||(this._elem=this.newElement(),this.drawable._vg.appendChild(this._elem))},postHandler:function(){this._updateTransform()},handlers:[[a.DIRTY_ZINDEX,function(){this.drawable._depthManager.add(this)}],[a.DIRTY_TRANSFORM,function(){this.wrapper._transform?this._transformStack.add("last","wrapper",this.wrapper._transform):this._transformStack.remove("wrapper"),this._transformUpdated=!0}],[a.DIRTY_STYLE,function(){var b=this._elem,c=this.wrapper._style;if(c.fill){if(c.fill instanceof a.FloodFill)b.setAttribute("fill",c.fill.color.toString(!0)),b.setAttribute("fill-opacity",c.fill.color.a/255);else if(c.fill instanceof a.LinearGradientFill||c.fill instanceof a.RadialGradientFill||c.fill instanceof a.ImageTileFill){var d=this.drawable._defsManager.get(c.fill);b.setAttribute("fill","url(#"+d.id+")"),this.def&&this.def.delRef(),this.def=d,d.addRef()}}else b.setAttribute("fill","none");c.stroke?(b.setAttribute("stroke",c.stroke.color.toString(!0)),b.setAttribute("stroke-opacity",c.stroke.color.a/255),b.setAttribute("stroke-width",c.stroke.width),c.stroke.pattern&&c.stroke.pattern.length>1&&b.setAttribute("stroke-dasharray",c.stroke.pattern.join(" "))):b.setAttribute("stroke","none"),b.style.cursor=c.cursor}],[a.DIRTY_VISIBILITY,function(){this._elem.style.display=this.wrapper._visibility?"block":"none"}],[a.DIRTY_EVENT_HANDLERS,function(){if(!this.wrapper.handler)return;for(var a in this._handledEvents){var b=this.wrapper.handler.handles(a),c=this._handledEvents[a];!c&&b?(this._elem.addEventListener(a,this._eventFunc,!1),this._handledEvents[a]=this._eventFunc):c&&!b&&(this._elem.removeEventListener(a,c,!1),this._handledEvents[a]=null)}}]]})},methods:{init:function(a){this.wrapper=a,this._refresher=this.constructor._refresher,this._transformStack=new j;var b=this;this._eventFunc=function(a){return b.drawable._capturingShape&&b.drawable._capturingShape!=b?!0:(b.wrapper.handler.dispatch(q(b,a)),!1)}},dispose:function(){this.drawable?this.drawable.remove(this):this._removed()},_removed:function(){this.def&&(this.def.delRef(),this.def=null),this._elem=null,this.drawable=null},newElement:function(){return null},refresh:function(a){this._refresher.call(this,a)},_updateTransform:function(){if(!this._transformUpdated)return;var a=this._transformStack.get();a?this._elem.setAttribute("transform",o(a)):this._elem.removeAttribute("transform"),this._transformUpdated=!1}}}),s=c("CircleSVG",{parent:r,class_props:{_refresher:(new i(r._refresher)).setup({moreHandlers:[[a.DIRTY_POSITION|a.DIRTY_SIZE,function(){var a=this.wrapper._position,b=this.wrapper._size;this._elem.setAttribute("rx",b.x/2+"px"),this._elem.setAttribute("ry",b.y/2+"px"),this._elem.setAttribute("cx",a.x+b.x/2+"px"),this._elem.setAttribute("cy",a.y+b.y/2+"px")}]]})},methods:{newElement:function(){return m("ellipse")}}}),t=c("RectSVG",{parent:r,class_props:{_refresher:(new i(r._refresher)).setup({moreHandlers:[[a.DIRTY_POSITION,function(){var a=this.wrapper._position;this._elem.setAttribute("x",a.x+"px"),this._elem.setAttribute("y",a.y+"px")}],[a.DIRTY_SIZE,function(){var a=this.wrapper._size;this._elem.setAttribute("width",a.x+"px"),this._elem.setAttribute("height",a.y+"px")}],[a.DIRTY_SHAPE,function(){var a=this.wrapper._corner,b=this.wrapper._size;this._elem.setAttribute("rx",a?a.x:0),this._elem.setAttribute("ry",a?a.y:0)}]]})},methods:{newElement:function(){return m("rect")}}}),u=c("PathSVG",{parent:r,class_props:{_refresher:(new i(r._refresher)).setup({moreHandlers:[[a.DIRTY_SHAPE,function(){this._elem.setAttribute("d",p(this.wrapper._points))}],[a.DIRTY_POSITION,function(){this._transformStack.add("first","path-position",a.Matrix.translate(this.wrapper._position)),this._transformUpdated=!0}]]})},methods:{newElement:function(){return m("path")}}}),v=c("TextSVG",{parent:r,class_props:{_refresher:(new i(r._refresher)).setup({moreHandlers:[[a.DIRTY_POSITION,function(){var a=this.wrapper._position;this._elem.setAttribute("x",a.x+"px"),this._elem.setAttribute("y",a.y+"px")}],[a.DIRTY_SIZE,function(){var a=this.wrapper._size;this._elem.setAttribute("width",a.x+"px"),this._elem.setAttribute("height",a.y+"px")}],[a.DIRTY_SHAPE,function(){this._elem.setAttribute("font-size",this.wrapper._fontSize+"px"),this._elem.setAttribute("font-family",this.wrapper._fontFamily),this._elem.firstChild&&this._elem.removeChild(this._elem.firstChild),this._elem.appendChild(n(this.wrapper._text))}]]})},methods:{newElement:function(){return m("text")}}}),x=c("Def",{props:{manager:null,id:null,node:null,xml:null,refcount:1},methods:{init:function(a,b,c,d){this.manager=a,this.node=b,this.xml=c,this.id=d},dispose:function(){this.manager&&this.manager.remove(this),this.manager=null,this.xml=null,this.node=null,this.id=null},addRef:function(){++this.refcount},delRef:function(){--this.refcount<=0&&this.dispose()}}}),y=function(){var b={LinearGradientFill:function(a){var b=a.angle%1,c=b<0?1+b:b,d=Math.PI*c*2,e=Math.cos(d),f=Math.sin(d);a.angle<.125||a.angle>=.875?(f/=e,e=1):a.angle>=.125&&a.angle<.375?(e/=f,f=1):a.angle>=.375&&a.angle<.625?(f/=-e,e=-1):a.angle>=.625&&a.angle<.875&&(e/=f,f=-1);var g=e/2+.5,h=f/2+.5,i=-g+1,j=-h+1,k=["<linearGradient",' x1="',i*100,'%"',' y1="',j*100,'%"',' x2="',g*100,'%"',' y2="',h*100,'%"',' gradientUnits="objectBoundingBox">'],l=a.colors;for(var m=0;m<l.length;m++)k.push('<stop offset="',l[m][0]*100,'"',' stop-color="',l[m][1].toString(!0),'"',' stop-opacity="',l[m][1].a/255,'"'," />");return k.push("</linearGradient>"),[k.join(""),null]},RadialGradientFill:function(a){var b=['<radialGradient cx="50%" cy="50%" r="50%"',' fx="',a.focus.x,'"',' fy="',a.focus.y,'"',' gradientUnits="objectBoundingBox">'],c=a.colors;for(var d=0;d<c.length;d++)b.push('<stop offset="',c[d][0]*100,'"',' stop-color="',c[d][1].toString(!0),'"',' stop-opacity="',c[d][1].a/255,'"'," />");b.push("</radialGradient>");var e=b.join("");return[e,null]},ImageTileFill:function(a){var b=['<pattern width="0" height="0" patternUnits="userSpaceOnUse">','<image xlink:href="',d(a.imageData.url),'" width="0" height="0" />',"</pattern>"].join("");return[b,function(b){a.imageData.size(function(a){b.setAttribute("width",a.width),b.setAttribute("height",a.height),b.firstChild.setAttribute("width",a.width),b.firstChild.setAttribute("height",a.width)})}]}};return c("DefsManager",{props:{node:null,nodes:{},dynamicNodes:{}},methods:{init:function(a){this.node=a},nextId:function(){var a;do a="__svg__def"+(Math.random()*2147483648|0);while(this.node.ownerDocument.getElementById(a));return a},get:function(c){var d=c.constructor["%%CLASSNAME%%"],e=b[d];if(!e)throw new a.NotSupported(d+" is not supported by SVG backend");var f=e(c),c=this.nodes[f[0]];if(!c){var g=this.nextId(),h=w(f[0]);f[1]&&f[1](h),h.setAttribute("id",g),h=this.node.ownerDocument.adoptNode(h),c=new x(this,h,f[0],g),this.node.appendChild(h),this.nodes[f[0]]=c}return c},remove:function(a){delete this.nodes[a.xml]}}})}(),z=c("DepthManager",{props:{root:null,depth:[]},methods:{init:function(a){this.root=a},add:function(a){var b=0,c=this.depth.length;while(b!=c){var d=b+c>>1;this.depth[d].wrapper._zIndex<a.wrapper._zIndex?b=d+1:c=d}var e=!1;while(b<this.depth.length&&this.depth[b].wrapper._zIndex==a.wrapper._zIndex){if(this.depth[b].wrapper.id==a.wrapper.id){e=!0;break}b++}this.depth.splice(b,e,a);if(a._elem){var f=null;for(var g=b+1;g<this.depth.length;g++){f=this.depth[g]._elem;if(f)break}a._elem.parentNode.insertBefore(a._elem,f)}}}}),A=c("DrawableSVG",{props:{prefix:"svg",wrapper:null,_defsManager:null,_depthManager:null,_svg:null,_vg:null,_viewport:null,_viewportInnerSize:null,_capturingShape:null,_handledEvents:{mousedown:null,mouseup:null,mousemove:null,mouseout:null},_eventFunc:null,_captureEventFunc:null,_refresher:null},class_props:{_refresher:(new i).setup({preHandler:function(){!this._viewport.parentNode!=this.wrapper.target&&this.wrapper.target.appendChild(this._viewport)},handlers:[[a.DIRTY_SIZE,function(){var a=this.wrapper._viewport_size;this._viewport.style.width=a.x+"px",this._viewport.style.height=a.y+"px",this._updateContentSize()}],[a.DIRTY_TRANSFORM,function(){this._vg.setAttribute("transform",o(this.wrapper._transform)),this._updateContentSize()}],[a.DIRTY_EVENT_HANDLERS,function(){for(var a in this._handledEvents){var b=this.wrapper.handler.handles(a),c=this._handledEvents[a];!c&&b?(this._svg.addEventListener(a,this._eventFunc,!1),this._handledEvents[a]=this._eventFunc):c&&!b&&(this._svg.removeEventListener(a,c,!1),this._handledEvents[a]=null)}}]]})},methods:{init:function(a){this.wrapper=a,this._refresher=this.constructor._refresher;var b=this;this._eventFunc=function(a){return b._capturingShape&&b._capturingShape!==b?!0:(a.stopPropagation(),b.wrapper.handler.dispatch(q(b,a)),!1)},this._captureEventFunc=function(a){var c=b._capturingShape._handledEvents[a.type];return c?c(a):!0};var c=this._buildViewportElement(),d=this._buildSvgElement();c.appendChild(d);var e=m("defs");d.appendChild(e);var f=m("g");d.appendChild(f),this._defsManager=new y(e),this._depthManager=new z(f),this._viewport=c,this._svg=d,this._vg=f},dispose:function(){this._viewport&&this._viewport.parentNode&&this._viewport.parentNode.removeChild(this._viewport),this._viewport=null,this._svg=null,this._vg=null,this._wrapper=null,this._defsManager=null,this._depthManager=null},refresh:function(a){this._refresher.call(this,a)},scrollPosition:function(a){if(a){a=h(a,{x:0,y:0},g(this.wrapper._content_size,this.wrapper._inverse_transform.apply(this._viewportInnerSize)));var b=this.wrapper._transform.apply(a);return this._viewport.scrollLeft=b.x,this._viewport.scrollTop=b.y,a}return this.wrapper._inverse_transform.apply({x:this._viewport.scrollLeft,y:this._viewport.scrollTop})},append:function(a){a.drawable=this},remove:function(a){this._capturingShape==a&&this.releaseMouse(a),this._vg&&a._elem&&this._vg.removeChild(a._elem),a._removed(a)},anchor:function(){},getViewportOffset:function(){return a.Backend.getDomOffsetPosition(this._viewport)},captureMouse:function(b){var c=this;if(this._capturingShape)throw new a.AlreadyExists("The shape is already capturing.");for(var d in b._handledEvents)this._viewport.offsetParent.addEventListener(d,this._captureEventFunc,!0);this._capturingShape=b},releaseMouse:function(b){if(this._capturingShape!=b)throw new a.NotFound("The shape is not capturing.");for(var c in b._handledEvents)this._viewport.offsetParent.removeEventListener(c,this._captureEventFunc,!0);this._capturingShape=null},convertToLogicalPoint:function(a){return f(this.scrollPosition(),this.wrapper._inverse_transform.apply(a))},convertToPhysicalPoint:function(a){return f(this.wrapper._transform.apply(this.scrollPosition()),a)},_updateContentSize:function(){var a=this.wrapper._viewport_size,b=this.wrapper._transform.apply(this.wrapper._content_size);this._svg.setAttribute("width",b.x+"px"),this._svg.setAttribute("height",b.y+"px"),this._svg.style.width=b.x+"px",this._svg.style.height=b.y+"px",this._viewport.style.overflow=b.x<=a.x&&b.y<=a.y?"hidden":"scroll",this._viewportInnerSize={x:this._viewport.clientWidth,y:this._viewport.clientHeight}},_buildSvgElement:function(){var a=m("svg");return a.setAttribute("version","1.1"),a.setAttribute("style",["margin: 0","padding: 0","-moz-user-select: none","-khtml-user-select: none","-webkit-user-select: none","-ms-user-select: none","user-select: none"].join(";")),a},_buildViewportElement:function(){var a=b.document.createElement("div");return a.setAttribute("style",["margin: 0","padding: 0"].join(";")),a}}});return{Circle:s,Rect:t,Path:u,Text:v,Drawable:A}}.call(Fashion);